ARM GAS  tinyBasic.s 			page 1


   1              	/****************************************************************************
   2              	// Copyright Jacques Deschênes 2021 
   3              	// This file is part of stm32-tbi 
   4              	//
   5              	//     stm32-tbi is free software: you can redistribute it and/or modify
   6              	//     it under the terms of the GNU General Public License as published by
   7              	//     the Free Software Foundation, either version 3 of the License, or
   8              	//     (at your option) any later version.
   9              	//
  10              	//     stm32-tbi is distributed in the hope that it will be useful,
  11              	//     but WITHOUT ANY WARRANTY// without even the implied warranty of
  12              	//     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  13              	//     GNU General Public License for more details.
  14              	//
  15              	//     You should have received a copy of the GNU General Public License
  16              	//     along with stm32-tbi.  If not, see <http://www.gnu.org/licenses/>.
  17              	*****************************************************************************/
  18              	/************************************************************************
  19              	REF: https://en.wikipedia.org/wiki/Tiny_BASIC
  20              	************************************************************************/
  21              	
  22              	.syntax unified
  23              	  .cpu cortex-m3
  24              	  .fpu softvfp
  25              	  .thumb
  26              	
  27              	  .include "stm32f103.inc"
   1              	/*
   2              	   STM32F103 registers
   3              	*/
   4              	    /* RAM */
   5              	    .equ RAM_ADR, 0x20000000 
   6              	    .equ RAM_SIZE, 0x5000
   7              	    .equ RAM_END, RAM_ADR+RAM_SIZE
   8              	
   9              	   /* RAM bit band alias */
  10              	      .equ RAM_BIT_ALIAS, 0x22000000
  11              	
  12              	    /* FLASH MEMORY */
  13              	    /* memory reported by MCU */
  14              	    .equ FLASH_ADR, 0x8000000 
  15              	    .equ FLASH_SIZE, 0x10000
  16              	    .equ FLASH_END, FLASH_ADR+FLASH_SIZE
  17              	    /* the MCU as 64K flash not reported by MCU */
  18              	    .equ FLASH_HIDDEN_ADR, 0x8010000
  19              	    .equ FLASH_HIDDEN_SIZE, 0x10000
  20              	    .equ FLASH_HIDDEN_END, FLASH_HIDDEN_ADR+FLASH_HIDDEN_SIZE
  21              	    .equ PAGE_SIZE, 1024 // erase block size 
  22              	
  23              	   /* system memory */
  24              	      .equ SYS_MEM, 0x1FFFF000
  25              	      .equ SYS_MEM_SIZE, 0x800
  26              	
  27              	   /* option memory */
  28              	      .equ OPTION, 0x1FFFF800   
  29              	      .equ OPT_SIZE, 16
  30              	
ARM GAS  tinyBasic.s 			page 2


  31              	
  32              	   /* peripherals base address */
  33              	      .equ PER_BASE_ADR,  0x40000000
  34              	   /* PERIPHERALS bit band alias */
  35              	      .equ PER_BIT_ALIAS, 0x42000000 
  36              	
  37              	
  38              	    /* RCC registers address */
  39              	    .equ RCC_BASE_ADR, 0x40021000
  40              	    /* RCC registers offset */
  41              	    .equ RCC_CR, 0
  42              	    .equ RCC_CFGR, 4
  43              	    .equ RCC_CIR, 8
  44              	    .equ RCC_APB2RSTR, 12
  45              	    .equ RCC_APB1RSTR, 16
  46              	    .equ RCC_AHBENR, 20
  47              	    .equ RCC_APB2ENR, 24
  48              	    .equ RCC_APB1ENR, 28
  49              	    .equ RCC_BDCR, 32 
  50              	    .equ RCC_CSR, 36
  51              	
  52              	    /* FLASH registers address */
  53              	    .equ FLASH_BASE_ADR, 0x40022000
  54              	    /* FLASH registers offset */
  55              	    .equ FLASH_ACR, 0
  56              	    .equ FLASH_KEYR, 4
  57              	    .equ FLASH_OPTKEYR, 8
  58              	    .equ FLASH_SR, 12
  59              	    .equ FLASH_CR, 16
  60              	    .equ FLASH_AR, 20
  61              	    .equ FLASH_OBR, 28
  62              	    .equ FLASH_WRPR,32
  63              	    .equ RDPRT_KEY, 0x00A5
  64              	    .equ FLASH_KEY1, 0x45670123
  65              	    .equ FLASH_KEY2, 0xCDEF89AB
  66              	
  67              	    /* GPIOx base address */
  68              	    .equ GPIOA_BASE_ADR, 0x40010800
  69              	    .equ GPIOB_BASE_ADR, 0x40010C00
  70              	    .equ GPIOC_BASE_ADR, 0x40011000
  71              	    .equ GPIOD_BASE_ADR, 0x40011400
  72              	    .equ GPIOE_BASE_ADR, 0x40011800
  73              	    .equ GPIOF_BASE_ADR, 0x40018C00
  74              	    .equ GPIOG_BASE_ADR, 0x40012000
  75              	
  76              	    /* gpiox registers offset from base address */
  77              	    .equ GPIO_CRL, 0
  78              	    .equ GPIO_CRH, 4
  79              	    .equ GPIO_IDR, 8
  80              	    .equ GPIO_ODR, 12
  81              	    .equ GPIO_BSRR, 16
  82              	    .equ GPIO_BRR, 20
  83              	    .equ GPIO_LOCKR, 24 
  84              	    
  85              	   /* AFIO base address */
  86              	   .equ AFIO_BASE_ADR, 0x40010000
  87              	   
ARM GAS  tinyBasic.s 			page 3


  88              	   /* AFIO registers offset */
  89              	   .equ AFIO_EVCR,0
  90              	   .equ AFIO_MAPR,4
  91              	   .equ AFIO_EXTICR1,8
  92              	   .equ AFIO_EXTICR2,12 
  93              	   .equ AFIO_EXTICR3,16
  94              	   .equ AFIO_EXTICR4,20
  95              	   .equ AFIO_MAPR2,28
  96              	   
  97              	    /* USART1 registers */
  98              	    .equ USART1_BASE_ADR, 0x40013800
  99              	    /* USARTx registers offset */
 100              	    .equ USART_SR, 0
 101              	    .equ USART_DR,4
 102              	    .equ USART_BRR,8
 103              	    .equ USART_CR1,12
 104              	    .equ USART_CR2,16
 105              	    .equ USART_CR3,20
 106              	    .equ USART_GTPR,24
 107              	
 108              	   /* systick */
 109              	    .equ STK_BASE_ADR, 0xE000E010
 110              	    /* registers offset */
 111              	    .equ STK_CTL, 0
 112              	    .equ STK_LOAD, 4
 113              	    .equ STK_VAL, 8
 114              	    .equ STK_CALIB, 12
 115              	
 116              	   /* system control block */
 117              	   .equ SCB_BASE_ADR, 0xE000ED00
 118              	   /* registers offset */
 119              	   .equ SCB_CPUID, 0
 120              	   .equ SCB_ICSR, 4 
 121              	   .equ SCB_VTOR, 8
 122              	   .equ SCB_AIRCR, 12
 123              	   .equ SCB_SCR, 16
 124              	   .equ SCB_CCR, 20
 125              	   .equ SCB_SHPR1,24
 126              	   .equ SCB_SHPR2,28
 127              	   .equ SCB_SHPR3,32
 128              	   .equ SCB_SHCRS,36
 129              	   .equ SCB_CFSR,40
 130              	   .equ SCB_HFSR,44
 131              	   .equ SCB_MMAR,52
 132              	   .equ SCB_BFAR,56
 133              	   // key to to write in SCB_AIRCR 
 134              	   .equ SCB_VECTKEY,0x5fa 
 135              	   
 136              	   /* NVIC block */
 137              	   .equ NVIC_BASE_ADR, 0xE000E100
 138              	   .equ NVIC_ISER0, 0
 139              	   .equ NVIC_ISER1, 4
 140              	   .equ NVIC_ISER2, 8
 141              	   .equ NVIC_ICER0, 0x80
 142              	   .equ NVIC_ICER1, 0x84 
 143              	   .equ NVIC_ICER2, 0x88 
 144              	   .equ NVIC_ISPR0, 0x100
ARM GAS  tinyBasic.s 			page 4


 145              	   .equ NVIC_ISPR1, 0x104
 146              	   .equ NVIC_ISPR2, 0x108 
 147              	   .equ NVIC_ICPR0, 0x180
 148              	   .equ NVIC_ICPR1, 0x184
 149              	   .equ NVIC_ICPR2, 0x188
 150              	   .equ NVIC_IABR0, 0x200
 151              	   .equ NVIC_IABR1, 0x204
 152              	   .equ NVIC_IABR2, 0x208
 153              	   .equ NVIC_IPR_BASE, 0x300 
 154              	
 155              	/* system control register */
 156              	.equ SCR_BASE_ADR,0xE000ED10
 157              	.equ SCR_SLEEPONEXIT,(1<<1)
 158              	.equ SCR_SLEEPDEEP,(1<<2)
 159              	.equ SCR_SEVONPEND,(1<<4)
 160              	
 161              	/* power control register */
 162              	.equ PWR_CR_ADR,0x40007000
 163              	.equ PWR_CR_LPDS,(1<<0)
 164              	.equ PWR_CR_PDDS,(1<<1)
 165              	.equ PWR_CR_CWUF,(1<<2)
 166              	.equ PWR_CR_CSBF,(1<<3)
 167              	.equ PWR_CR_PVDE,(1<<4)
 168              	.equ PWR_CR_PLS,(1<<5)
 169              	.equ PWR_CR_DBP,(1<<8)
 170              	
 171              	/* power control and statut register */
 172              	.equ PWR_CSR_ADR,0x40007004 
 173              	.equ PWR_CSR_WUF,(1<<0)
 174              	.equ PWR_CSR_SBF,(1<<1)
 175              	.equ PWR_CSR_PVDO,(1<<2)
 176              	.equ PWR_CSR_EWUP,(1<<8)
 177              	
 178              	/* Window watchdog (WWDG) */
 179              	.equ WWDG_BASE_ADR,0x40002C00
 180              	.equ WWDG_CR,0
 181              	.equ WWDG_CFR,4
 182              	.equ WWDG_SR,8
 183              	
 184              	/* Independent watchdog (IWDG) */
 185              	.equ IWDG_BASE_ADR,0x40003000
 186              	.equ IWDG_KR,0 
 187              	.equ IWDG_PR,4
 188              	.equ IWDG_RLR,8
 189              	.equ IWDG_SR,12
  28              	  .include "ascii.inc"
   1              	////
   2              	// Copyright Jacques Deschênes 2021
   3              	// This file is part of stm32-tbi 
   4              	//
   5              	//     stm32-tbi is free software: you can redistribute it and/or modify
   6              	//     it under the terms of the GNU General Public License as published by
   7              	//     the Free Software Foundation, either version 3 of the License, or
   8              	//     (at your option) any later version.
   9              	//
  10              	//     stm32-tbi is distributed in the hope that it will be useful,
  11              	//     but WITHOUT ANY WARRANTY// without even the implied warranty of
ARM GAS  tinyBasic.s 			page 5


  12              	//     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  13              	//     GNU General Public License for more details.
  14              	//
  15              	//     You should have received a copy of the GNU General Public License
  16              	//     along with stm32-tbi.  If not, see <http://www.gnu.org/licenses/>.
  17              	////
  18              	
  19              	//-------------------------------------------------------
  20              	//     ASCII control  values
  21              	//     CTRL_x   are VT100 keyboard values  
  22              	// REF: https://en.wikipedia.org/wiki/ASCII    
  23              	//-------------------------------------------------------
  24              		.equ CTRL_A ,  1
  25              		.equ SOH, CTRL_A  // start of heading 
  26              		.equ CTRL_B ,  2
  27              		.equ STX, CTRL_B  // start of text 
  28              		.equ CTRL_C ,  3
  29              		.equ ETX, CTRL_C  // end of text 
  30              		.equ CTRL_D ,  4
  31              		.equ EOT, CTRL_D  // end of transmission 
  32              		.equ CTRL_E ,  5
  33              		.equ ENQ, CTRL_E  // enquery 
  34              		.equ CTRL_F ,  6
  35              		.equ ACK, CTRL_F  // acknowledge
  36              		.equ CTRL_G ,  7
  37              		.equ BELL ,  7    // vt100 terminal generate a sound.
  38              		.equ CTRL_H ,  8  
  39              		.equ BS ,  8     // back space 
  40              		.equ CTRL_I ,  9
  41              		.equ TAB ,  9     // horizontal tabulation
  42              		.equ CTRL_J ,  10 
  43              		.equ LF ,  10     // line feed
  44              		.equ CTRL_K ,  11
  45              		.equ VT ,  11     // vertical tabulation 
  46              		.equ CTRL_L ,  12
  47              		.equ FF ,  12      // new page
  48              		.equ CTRL_M ,  13
  49              		.equ CR ,  13      // carriage return 
  50              		.equ CTRL_N ,  14
  51              		.equ SO, CTRL_N    // shift out 
  52              		.equ CTRL_O ,  15
  53              		.equ SI, CTRL_O    // shift in 
  54              		.equ CTRL_P ,  16
  55              		.equ DLE, CTRL_P   // data link escape 
  56              		.equ CTRL_Q ,  17
  57              		.equ DC1, CTRL_Q   // device control 1 
  58              		.equ XON, DC1 
  59              		.equ CTRL_R ,  18
  60              		.equ DC2, CTRL_R   // device control 2 
  61              		.equ CTRL_S ,  19
  62              		.equ DC3, CTRL_S   // device control 3
  63              		.equ XOFF, DC3 
  64              		.equ CTRL_T ,  20
  65              		.equ DC4, CTRL_T   // device control 4 
  66              		.equ CTRL_U ,  21
  67              		.equ NAK, CTRL_U   // negative acknowledge
  68              		.equ CTRL_V ,  22
ARM GAS  tinyBasic.s 			page 6


  69              		.equ SYN, CTRL_V   // synchronous idle 
  70              		.equ CTRL_W ,  23
  71              		.equ ETB, CTRL_W   // end of transmission block
  72              		.equ CTRL_X ,  24
  73              		.equ CAN, CTRL_X   // cancel 
  74              		.equ CTRL_Y ,  25
  75              		.equ EM, CTRL_Y    // end of medium
  76              		.equ CTRL_Z ,  26
  77              		.equ SUB, CTRL_Z   // substitute 
  78              		.equ EOF, SUB      // end of text file in MSDOS 
  79              		.equ ESC ,  27     // escape 
  80              		.equ FS, 28        // file separator 
  81              		.equ GS, 29        // group separator 
  82              		.equ RS, 30  // record separator 
  83              		.equ US, 31  // unit separator 
  84              		.equ SPACE ,  32
  85              		.equ COMMA ,  44 
  86              		.equ SHARP ,  35
  87              		.equ TICK ,  39
  29              	  .include "tbi_macros.inc"
   1              	//---------------------------------------------------------------------------
   2              	// Copyright Jacques Deschênes 2021 
   3              	// This file is part of stm32-tbi 
   4              	//
   5              	//     stm32-tbi is free software: you can redistribute it and/or modify
   6              	//     it under the terms of the GNU General Public License as published by
   7              	//     the Free Software Foundation, either version 3 of the License, or
   8              	//     (at your option) any later version.
   9              	//
  10              	//     stm32-tbi is distributed in the hope that it will be useful,
  11              	//     but WITHOUT ANY WARRANTY// without even the implied warranty of
  12              	//     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  13              	//     GNU General Public License for more details.
  14              	//
  15              	//     You should have received a copy of the GNU General Public License
  16              	//     along with stm32-tbi.  If not, see <http://www.gnu.org/licenses/>.
  17              	//
  18              	//---------------------------------------------------------------------------
  19              	
  20              	  .equ  STACK_SIZE,0x100
  21              	  .equ  STACK_EMPTY,RAM_END
  22              	  .equ  STACK_FULL, (RAM_END - STACK_SIZE)
  23              	  .equ  TIB_SIZE,80 
  24              	  .equ  PAD_SIZE,128 
  25              	  .equ  RX_QUEUE_SIZE,16
  26              	  .equ  DSTACK_TOP,0x20004f00 
  27              	  .equ  RSTACK_TOP,0x20005000
  28              	  
  29              	
  30              	.equ DEFAULT_TAB_WIDTH,4 // default tabulation width 
  31              	.equ EOF,0xff // end of file marker 
  32              	
  33              	//--------------------------------------
  34              	//       token attribute
  35              	//--------------------------------------
  36              	// tokens without attributes 
  37              	  .equ TK_NONE,0       // not a token mark end of line 
ARM GAS  tinyBasic.s 			page 7


  38              	  .equ TK_COLON,1      // ':' command separator 
  39              	  .equ TK_COMMA,2      // ',' list separator
  40              	  .equ TK_SEMIC,3      // ';' print command column align 
  41              	  .equ TK_SHARP,4      // '#' print command set column width 
  42              	  .equ TK_LPAREN,5     // '(' 
  43              	  .equ TK_RPAREN,6     // ')'
  44              	  .equ TK_PLUS,7       // '+'
  45              	  .equ TK_MINUS,8      // '-'
  46              	  .equ TK_MULT,9       // '*'
  47              	  .equ TK_DIV,10       // '/'
  48              	  .equ TK_MOD,11       // '%'   arithmetic modulo
  49              	  .equ TK_ARRAY,12     // '@'   array variable  
  50              	  .equ TK_EQUAL,13     // '='   assignment and relop 
  51              	  .equ TK_GT,14        // '>'   relop 
  52              	  .equ TK_LT,15        // '<'   relop 
  53              	  .equ TK_GE,16        // '>='  relop 
  54              	  .equ TK_LE,17        // '<='  relop
  55              	  .equ TK_NE,18        // '<>'  relop 
  56              	// tokens with .byte attribute 
  57              	  .equ TK_CHAR,19      // ASCII character 
  58              	  .equ TK_VAR,20       // variable index 
  59              	  .equ TK_IFUNC,21     // BASIC integer function
  60              	  .equ TK_CFUNC,22     // BASIC character function
  61              	  .equ TK_CMD,23       // BASIC command
  62              	// token with .word attribute 
  63              	  .equ TK_SCONST,24    // SYSTEM constant    
  64              	  .equ TK_CONST,25    // BASIC constant 
  65              	  .equ TK_LABEL,26
  66              	  .equ TK_INTGR,27    // 32 bits integer 
  67              	  .equ TK_QSTR,28    // quoted string  
  68              	  .equ TK_INVALID,29  // value >=27 are invalid 
  69              	
  70              	//--------------------------------------
  71              	//   error codes 
  72              	//--------------------------------------
  73              	  .equ ERR_NONE,0
  74              	  .equ ERR_MEM_FULL,1 
  75              	  .equ ERR_SYNTAX,2
  76              	  .equ ERR_MATH_OVF,3
  77              	  .equ ERR_DIV0,4 
  78              	  .equ ERR_NO_LINE,5
  79              	  .equ ERR_RUN_ONLY,6
  80              	  .equ ERR_CMD_ONLY,7
  81              	  .equ ERR_DUPLICATE,8
  82              	  .equ ERR_NOT_FILE,9
  83              	  .equ ERR_BAD_VALUE,10
  84              	  .equ ERR_NO_ACCESS,11
  85              	  .equ ERR_NO_DATA,12 
  86              	  .equ ERR_NO_PROG,13
  87              	  .equ ERR_NO_FSPACE,14
  88              	  .equ ERR_BUF_FULL,15
  89              	  .equ ERR_CANT_PROG,16
  90              	  
  91              	
  92              	//--------------------------------------
  93              	//   assembler flags 
  94              	//-------------------------------------
ARM GAS  tinyBasic.s 			page 8


  95              	.equ MATH_OVF,0 // if 1 then stop on math overflow 
  96              	
  97              	.equ CELL_SIZE,4 
  98              	
  99              	
 100              	    UPP .req r4  // base address system variables 
 101              	    VADR .req r5  // address FOR loop variable 
 102              	    LIMIT .req r6   // LOOP limit 
 103              	    INCR  .req  r7  // LOOP increment 
 104              	    T1  .req r8     // temporary register 
 105              	    T2  .req r9     // temporary register 
 106              	    IN  .req r10    //  index in text line or token list 
 107              	    BPTR .req r11   //  buffer address or BASIC line address 
 108              	    DP   .req r12   //  parameter stack pointer 
 109              	
 110              	/***************************
 111              	  SYSTEM variables offset 
 112              	  from UPP  
 113              	***************************/ 
 114              	
 115              	  .equ IN_SAVED,0 // set by get_token before parsing next token, used by unget_token
 116              	  .equ COUNT, IN_SAVED+4  // current BASIC line length and tib text length  
 117              	  .equ BASICPTR,COUNT+4 // point to current BASIC line address.
 118              	  .equ DATAPTR, BASICPTR+4 // point to DATA address
 119              	  .equ DATA,DATAPTR+4 // index to next data item 
 120              	  .equ DATALEN, DATA+4 // length of data line 
 121              	  .equ BASE,DATALEN+4 // nemeric base used to print integer 
 122              	  .equ TICKS,BASE+4 // milliseconds ticks counter (see Timer4UpdateHandler)
 123              	  .equ TIMER,TICKS+4 //  milliseconds count down timer 
 124              	  .equ SEED,TIMER+4  // xorshift 16 seed x  used by RND() function 
 125              	  .equ FSPTR,SEED+4 //  pointer used by file system
 126              	  .equ FSFREE,FSPTR+4 // flash free address // file system free space pointer
 127              	  .equ TXTBGN,FSFREE+4 // tokenized BASIC text beginning address 
 128              	  .equ TXTEND,TXTBGN+4 // tokenized BASIC text end address 
 129              	  .equ LOOP_DEPTH,TXTEND+4  // level of nested loop. Conformity check   
 130              	  .equ ARRAY_SIZE,LOOP_DEPTH+4 // array size, free RAM left after BASIC code.  
 131              	  .equ FLAGS,ARRAY_SIZE+4 // various boolean flags
 132              	  .equ TAB_WIDTH,FLAGS+4 // print colon width (default 4)
 133              	  .equ RX_HEAD,TAB_WIDTH+4 // rx_queue head pointer
 134              	  .equ RX_TAIL,RX_HEAD+4 // rx1_queue tail pointer  
 135              	  .equ RX_QUEUE,RX_TAIL+4 // UART1 receive circular queue 
 136              	  .equ VARS,RX_QUEUE+RX_QUEUE_SIZE // BASIC variables 
 137              	  .equ VARS_SIZE, 4*26 // space used by 26 BASIC variables (A-Z)
 138              	  .equ ARRAY_ADR,VARS+VARS_SIZE // array address at bottom of pad  
 139              	  .equ TRACE_LEVEL,ARRAY_ADR+4  // debugging level 
 140              	  .equ HERE,TRACE_LEVEL+4 // constants pointer position 
 141              	  .equ BASIC_START,TRACE_LEVEL+4 // BASIC area start after variables 
 142              	
 143              	/* flags used by BASIC interpreter */ 
 144              		.equ FRUN,(1<<0) // programm running
 145              		.equ FTRAP,(1<<1) // inside trap handler 
 146              		.equ FLOOP,(1<<2) // FOR loop in preparation 
 147              		.equ FSTOP,(1<<3) // program stopped  
 148              		.equ FBREAK,(1<<4) // break point flag 
 149              		.equ FCOMP,(1<<5)  // compiling flags 
 150              		.equ FAUTORUN,(1<<6) // auto start program running 
 151              	  .equ FPRINT,(1<<7) // inside print command 
ARM GAS  tinyBasic.s 			page 9


 152              	
 153              	  .equ FIRST_DATA_ITEM,6 // first DATA item offset on line.
 154              		.equ MAX_LINENO,0xffff// BASIC maximum line number 
 155              	
 156              	/***********************************************
 157              	*       MACROS
 158              	***********************************************/
 159              		.macro _CALL fn /* low level routine call */ 
 160              	 	PUSH {LR}
 161              		BL \fn  
 162              	  POP {LR}
 163              		.endm
 164              		
 165              		.macro	_RET /* return from subroutine */
 166              		BX	LR
 167              		.endm
 168              	
 169              		.macro _MOV32 REG LITERAL   /* load register with 32 bits literal */
 170              		MOV \REG, #\LITERAL&0xffff
 171              		MOVT \REG, #\LITERAL>>16
 172              		.endm
 173              	
 174              	// local function header 
 175              	  .macro _FUNC label 
 176              	  .p2align 2 
 177              	  .type \label, %function  
 178              	\label:
 179              	  .endm 
 180              	
 181              	// global function header 
 182              	  .macro _GBL_FUNC label 
 183              	  .global \label 
 184              	  _FUNC \label 
 185              	  .endm 
 186              	
 187              	
 188              	/********************************
 189              	    dictionary structure
 190              	*********************************/
 191              		.macro _dict_entry tok_type,name,cmd_idx 
 192              	  .word LINK 
 193              	  .word \cmd_idx 
 194              		.word \tok_type  	
 195              		.equ LINK,.
 196              		.asciz "\name"
 197              		.p2align 2 
 198              		.endm 
 199              	
 200              	  // pop parameter in register 
 201              	  .macro _POP  reg 
 202              	  ldmia  DP!,{\reg}
 203              	  .endm 
 204              	
 205              	  // push register on parameter stack 
 206              	  .macro _PUSH reg 
 207              	  stmdb DP!,{\reg}
 208              	  .endm 
ARM GAS  tinyBasic.s 			page 10


 209              	
 210              	  // drop n parameters on dstack 
 211              	  .macro _DROP n
 212              	  mov r0,#4*\n
 213              	  add DP,R0 
 214              	  .endm 
 215              	
 216              	  // back to previous token in list 
 217              	  .macro _UNGET_TOKEN 
 218              	  ldr IN,[UPP,#IN_SAVED]
 219              	  ldr BPTR,[UPP,#BASICPTR] 
 220              	  .endm 
 221              	
 222              	 // create a text data 
 223              	 .macro _TEXT label,text
 224              	 \label: .asciz "\text"
 225              	 .p2align 2 
 226              	 .endm 
 227              	
 228              	// command line only 
 229              	  .macro _CLO 
 230              	  ldr r0,[UPP,#FLAGS]
 231              	  tst r0,#FRUN 
 232              	  beq 1f 
 233              	  mov r0,#ERR_CMD_ONLY
 234              	  b tb_error
 235              	1: 
 236              	  .endm 
 237              	
 238              	// run time only 
 239              	  .macro _RTO 
 240              	  ldr r0,[UPP,#FLAGS]
 241              	  tst r0,#FRUN 
 242              	  bne 1f 
 243              	  mov r0,#ERR_CMD_ONLY
 244              	  b tb_error
 245              	1:
 246              	  .endm 
 247              	
  30              	  .include "cmd_index.inc"
   1              	//---------------------------------------------------------------------  
   2              	//  Copyright Jacques Deschênes 2021
   3              	//  This file is part of stm32-tbi 
   4              	// 
   5              	//   stm32-tbi is free software: you can redistribute it and/or modify
   6              	//   it under the terms of the GNU General Public License as published by
   7              	//   the Free Software Foundation, either version 3 of the License, or
   8              	//   (at your option) any later version.
   9              	// 
  10              	//   stm32-tbi is distributed in the hope that it will be useful,
  11              	//   but WITHOUT ANY WARRANTY//  without even the implied warranty of
  12              	//   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  13              	//   GNU General Public License for more details.
  14              	// 
  15              	//   You should have received a copy of the GNU General Public License
  16              	//   along with stm32-tbi.  If not, see <http://www.gnu.org/licenses/>.
  17              	// 
ARM GAS  tinyBasic.s 			page 11


  18              	// ----------------------------------------------------------------------
  19              	
  20              	// ---------------------------------------
  21              	//  BASIC command and functions indexes
  22              	//  for addressing 'code_addr' table
  23              	// --------------------------------------
  24              	
  25              	    .equ ABS_IDX, 0  //  absolute function
  26              	    .equ AND_IDX,ABS_IDX+1 // 
  27              	    .equ ASC_IDX,AND_IDX+1  // 
  28              	    .equ AWU_IDX,ASC_IDX+1 //
  29              	    .equ BIT_IDX,AWU_IDX+1 //
  30              	    .equ BRES_IDX,BIT_IDX+1 // 
  31              	    .equ BSET_IDX,BRES_IDX+1 // 
  32              	    .equ BTEST_IDX,BSET_IDX+1 // 
  33              	    .equ BTOGL_IDX,BTEST_IDX+1 // 
  34              	    .equ CHAR_IDX,BTOGL_IDX+1 // 
  35              	    .equ CLS_IDX,CHAR_IDX+1 //
  36              	    .equ CONST_IDX,CLS_IDX+1 //
  37              	    .equ DATA_IDX,CONST_IDX+1 // 
  38              	    .equ DATALN_IDX,DATA_IDX+1 // 
  39              	    .equ DEC_IDX,DATALN_IDX+1 // 
  40              	    .equ DIR_IDX,DEC_IDX+1 // 
  41              	    .equ DO_IDX,DIR_IDX+1 // 
  42              	    .equ DROP_IDX,DO_IDX+1
  43              	    .equ DUMP_IDX, DROP_IDX+1 
  44              	    .equ END_IDX,DUMP_IDX+1 // 
  45              	    .equ ERASE_IDX,END_IDX+1 
  46              	    .equ FOR_IDX, ERASE_IDX+1 // 
  47              	    .equ FORGET_IDX, FOR_IDX+1 // 
  48              	    .equ FREE_IDX, FORGET_IDX+1 // 
  49              	    .equ GET_IDX,FREE_IDX+1
  50              	    .equ GOSUB_IDX, GET_IDX+1 // 
  51              	    .equ GOTO_IDX, GOSUB_IDX+1 //
  52              	    .equ HEX_IDX, GOTO_IDX+1 // 
  53              	    .equ IF_IDX, HEX_IDX+1 // 
  54              	    .equ IN_IDX,IF_IDX+1
  55              	    .equ INPUT_IDX, IN_IDX+1 // 
  56              	    .equ INVERT_IDX, INPUT_IDX+1 // 
  57              	    .equ KEY_IDX, INVERT_IDX+1 // 
  58              	    .equ LET_IDX, KEY_IDX+1 // 
  59              	    .equ LIST_IDX, LET_IDX+1 // 
  60              	    .equ LOAD_IDX, LIST_IDX+1 // 
  61              	    .equ LOCATE_IDX,LOAD_IDX+1 //
  62              	    .equ LSHIFT_IDX, LOCATE_IDX+1 // 
  63              	    .equ NEW_IDX, LSHIFT_IDX+1 // 
  64              	    .equ NEXT_IDX, NEW_IDX+1 // 
  65              	    .equ NOT_IDX, NEXT_IDX+1 // 
  66              	    .equ OR_IDX, NOT_IDX+1 // 
  67              	    .equ OUT_IDX,OR_IDX+1
  68              	    .equ PAD_IDX, OUT_IDX+1 // 
  69              	    .equ PAUSE_IDX, PAD_IDX+1 // 
  70              	    .equ PMODE_IDX, PAUSE_IDX+1 // 
  71              	    .equ PEEK8_IDX, PMODE_IDX+1 //
  72              	    .equ PEEK16_IDX,  PEEK8_IDX+1
  73              	    .equ PEEK32_IDX, PEEK16_IDX+1
  74              	    .equ POKE8_IDX, PEEK32_IDX+1 // 
ARM GAS  tinyBasic.s 			page 12


  75              	    .equ POKE16_IDX,POKE8_IDX+1 
  76              	    .equ POKE32_IDX,POKE16_IDX+1
  77              	    .equ POP_IDX,POKE32_IDX+1
  78              	    .equ PRT_IDX, POP_IDX+1 //  //  PRINT commande index 
  79              	    .equ PUSH_IDX,PRT_IDX+1
  80              	    .equ PUT_IDX,PUSH_IDX+1
  81              	    .equ QKEY_IDX, PUT_IDX+1 // 
  82              	    .equ READ_IDX, QKEY_IDX+1 // 
  83              	    .equ REM_IDX, READ_IDX+1  //  REMARK command index 
  84              	    .equ REST_IDX, REM_IDX+1 //  RESTORE
  85              	    .equ RET_IDX, REST_IDX+1   //  RETURN 
  86              	    .equ RND_IDX, RET_IDX+1  //  RANDOM 
  87              	    .equ RSHIFT_IDX, RND_IDX+1 // 
  88              	    .equ RUN_IDX, RSHIFT_IDX+1 // 
  89              	    .equ SAVE_IDX, RUN_IDX+1 // 
  90              	    .equ SLEEP_IDX, SAVE_IDX+1 // 
  91              	    .equ SPC_IDX,SLEEP_IDX+1 //
  92              	    .equ STEP_IDX, SPC_IDX+1 // 
  93              	    .equ STOP_IDX, STEP_IDX+1 // 
  94              	    .equ STORE_IDX,STOP_IDX+1
  95              	    .equ TAB_IDX, STORE_IDX+1 //
  96              	    .equ THEN_IDX,TAB_IDX+1
  97              	    .equ TICKS_IDX, THEN_IDX+1 // 
  98              	    .equ TIMER_IDX, TICKS_IDX+1 // 
  99              	    .equ TMROUT_IDX, TIMER_IDX+1   //  TIMEOUT
 100              	    .equ TO_IDX, TMROUT_IDX+1 // 
 101              	    .equ TRACE_IDX,TO_IDX+1
 102              	    .equ UBOUND_IDX, TRACE_IDX+1 // 
 103              	    .equ UFLASH_IDX, UBOUND_IDX+1 // 
 104              	    .equ UNTIL_IDX, UFLASH_IDX+1 // 
 105              	    .equ WAIT_IDX, UNTIL_IDX+1 // 
 106              	    .equ WORDS_IDX, WAIT_IDX+1 // 
 107              	    .equ XOR_IDX, WORDS_IDX+1 //
 108              	    .equ XPOS_IDX,XOR_IDX+1 //
 109              	    .equ YPOS_IDX,XPOS_IDX+1 // 
 110              	
  31              	
  32              	  .section  .text , "ax", %progbits 
  33              	
  34              	
  35              	/********************************
  36              	    HELPER FUNCTIONS 
  37              	********************************/
  38              	
  39              	/**********************************
  40              	   strlen 
  41              	   return length of asciz 
  42              	   input:
  43              	      r0    *asciz 
  44              	   output:
  45              	      r0   length 
  46              	   use:
  47              	      r1   string length 
  48              	      r2   char 
  49              	*********************************/
  50              	    _GBL_FUNC strlen 
  51 0000 06B4     	    push {r1,r2}
ARM GAS  tinyBasic.s 			page 13


  52 0002 81EA0101 	    eor r1,r1  // strlen 
  53 0006 10F8012B 	1:  ldrb r2,[r0],#1 
  54 000a 12B1     	    cbz r2,9f  
  55 000c 01F10101 	    add r1,#1 
  56 0010 F9E7     	    b 1b 
  57 0012 0846     	9:  mov r0,r1 
  58 0014 06BC     	    pop {r1,r2}
  59 0016 7047     	    _RET     
  60              	
  61              	
  62              	/******************************
  63              	   cmove 
  64              	   move n characters 
  65              	   input:
  66              	    r0      src 
  67              	    r1      dest 
  68              	    r2      count 
  69              	  output:
  70              	    none:
  71              	  use: 
  72              	    r3    temp   
  73              	******************************/
  74              	    _GBL_FUNC cmove
  75 0018 08B4     	    push {r3} 
  76 001a 1240     	    ands r2,r2
  77 001c 10D0     	    beq 9f 
  78 001e 8842     	    cmp r0,r1 
  79 0020 06D4     	    bmi move_from_end 
  80              	move_from_low: // move from low address toward high 
  81 0022 10F8013B 	    ldrb r3,[r0],#1
  82 0026 01F8013B 	    strb r3,[r1],#1
  83 002a 013A     	    subs r2,#1
  84 002c F9D1     	    bne move_from_low
  85 002e 07E0     	    b 9f 
  86              	move_from_end: // move from high address toward low 
  87 0030 1044     	    add r0,r0,r2 
  88 0032 1144     	    add r1,r1,r2     
  89 0034 10F8013D 	1:  ldrb r3,[r0,#-1]!
  90 0038 01F8013D 	    strb r3,[r1,#-1]!
  91 003c 013A     	    subs r2,#1
  92 003e F9D1     	    bne 1b 
  93 0040 08BC     	9:  pop {r3}
  94 0042 7047     	    _RET
  95              	
  96              	/*********************************
  97              	  strcpy 
  98              	  copy .asciz string 
  99              	  input:
 100              	    r0   *string
 101              	    r1   *dest_buffer
 102              	  output:
 103              	    r0   *string
 104              	    r1   *dest_buffer 
 105              	  use:
 106              	    r2   char
 107              	**********************************/
 108              	    _GBL_FUNC strcpy 
ARM GAS  tinyBasic.s 			page 14


 109 0044 07B4     	    push {r0,r1,r2}
 110 0046 10F8012B 	1:  ldrb r2,[r0],#1
 111 004a 12B1     	    cbz  r2, 9f 
 112 004c 01F8012B 	    strb r2,[r1],#1
 113 0050 F9E7     	    b 1b 
 114 0052 0A70     	9:  strb r2,[r1] 
 115 0054 07BC     	    pop {r0,r1,r2}
 116 0056 7047     	    _RET 
 117              	
 118              	/*********************************
 119              	  strcmp 
 120              	  compare 2  .asciz strings 
 121              	  input:
 122              	    r0  *str1 
 123              	    r1  *str2
 124              	  output:
 125              	    r0  <0 str1<str2 
 126              	        0  str1==str2 
 127              	        >0  str1>str2  
 128              	  use:
 129              	    r2  *str1
 130              	    r3 char 1 
 131              	    r7 char 2  
 132              	*********************************/
 133              	  _FUNC strcmp
 134 0058 8CB4     	    push {r2,r3,r7}
 135 005a 0246     	    mov r2, r0
 136              	1:
 137 005c 12F8013B 	    ldrb r3,[r2],#1  
 138 0060 11F8017B 	    ldrb r7,[r1],#1
 139 0064 13B1     	    cbz r3, 2f 
 140 0066 0FB1     	    cbz r7, 2f 
 141 0068 D81B     	    subs r0,r3,r7 
 142 006a F7D0     	    beq 1b
 143 006c A3EB0700 	2:  sub r0,r3,r7 
 144 0070 8CBC     	    pop {r2,r3,r7}
 145 0072 7047     	    _RET 
 146              	
 147              	/**********************************
 148              	    prt_tok 
 149              	    print token id and value 
 150              	  input:
 151              	    r0    id 
 152              	    r1    value 
 153              	  output:
 154              	    none
 155              	  use:
 156              	
 157              	***********************************/
 158              	    _FUNC prt_tok 
 159 0074 03B4     	    push {r0,r1}
 160 0076 1148     	    ldr r0,tok_msg 
 161 0078 00B5FFF7 	    _CALL uart_puts 
 161      FEFF5DF8 
 161      04EB
 162 0082 01BC     	    pop {r0}
 163 0084 4FF01001 	    mov r1,#16 
ARM GAS  tinyBasic.s 			page 15


 164 0088 00B5FFF7 	    _CALL print_int 
 164      FEFF5DF8 
 164      04EB
 165 0092 4FF02000 	    mov r0,#SPACE 
 166 0096 00B5FFF7 	    _CALL uart_putc 
 166      FEFF5DF8 
 166      04EB
 167 00a0 01BC     	    pop {r0}
 168 00a2 4FF01001 	    mov r1,#16 
 169 00a6 00B5FFF7 	    _CALL print_int
 169      FEFF5DF8 
 169      04EB
 170 00b0 00B5FFF7 	    _CALL cr   
 170      FEFF5DF8 
 170      04EB
 171 00ba 7047     	    _RET 
 172 00bc 746F6B65 	    _TEXT tok_msg,"token: " 
 172      6E3A2000 
 173              	
 174              	/******************************************
 175              	    prt_row 
 176              	    print memory content in byte format 
 177              	    input:
 178              	      r0    address 
 179              	      r1    count 
 180              	    output:
 181              	      r0    address+count 
 182              	    use:
 183              	      r2    address 
 184              	      r3    count
 185              	****************************************/
 186              	    _FUNC prt_row 
 187 00c4 0FB4     	    push {r0,r1,r2,r3}
 188 00c6 0246     	    mov r2,r0 
 189 00c8 0B46     	    mov r3,r1  
 190 00ca 4FF01001 	    mov r1,#16 
 191 00ce 00B5FFF7 	    _CALL print_int 
 191      FEFF5DF8 
 191      04EB
 192 00d8 4FF00C00 	    mov r0,#12 
 193 00dc 00B5FFF7 	    _CALL cursor_x 
 193      FEFF5DF8 
 193      04EB
 194              	// print bytes values in hexadecimal 
 195 00e6 12F8010B 	1:  ldrb r0,[r2],#1 
 196 00ea 00B5FFF7 	    _CALL print_hex
 196      FEFF5DF8 
 196      04EB
 197 00f4 013B     	    subs r3,#1 
 198 00f6 F6D1     	    bne 1b 
 199 00f8 4FF00200 	    mov r0,#2 
 200 00fc 00B5FFF7 	    _CALL spaces
 200      FEFF5DF8 
 200      04EB
 201              	// print characters      
 202 0106 03BC     	    pop {r0,r1}
 203 0108 00B500F0 	    _CALL prt_chars 
ARM GAS  tinyBasic.s 			page 16


 203      8DF85DF8 
 203      04EB
 204 0112 00B5FFF7 	    _CALL cr  
 204      FEFF5DF8 
 204      04EB
 205 011c 1046     	    mov r0,r2
 206 011e 0CBC     	    pop {r2,r3}      
 207 0120 7047     	    _RET 
 208              	
 209              	
 210              	/************************************
 211              	  show current line number 
 212              	***********************************/
 213 0122 00BF     	    _FUNC show_line_nbr 
 214 0124 03B4     	    push {r0,r1}
 215 0126 BBF80000 	    ldrh r0,[BPTR]
 216 012a 4FF00A01 	    mov r1,#10
 217 012e 00B5FFF7 	    _CALL print_int
 217      FEFF5DF8 
 217      04EB
 218 0138 00B5FFF7 	    _CALL cr 
 218      FEFF5DF8 
 218      04EB
 219 0142 03BC     	    pop  {r0,r1}
 220 0144 7047     	    _RET 
 221              	
 222              	/************************************
 223              	  show data stack 
 224              	************************************/
 225 0146 00BF     	    _FUNC show_data_stack 
 226 0148 2DE90303 	    push {r0,r1,T1,T2}
 227 014c 0E48     	    ldr r0,data_stack 
 228 014e 00B5FFF7 	    _CALL uart_puts 
 228      FEFF5DF8 
 228      04EB
 229 0158 E046     	    mov T1,DP 
 230 015a 4FF49E49 	    _MOV32 T2,DSTACK_TOP
 230      C2F20009 
 231 0162 C145     	1:  cmp T2,T1 
 232 0164 08D0     	    beq 9f 
 233 0166 59F8040D 	    ldmdb T2!,{r0} 
 234 016a A169     	    ldr r1,[UPP,#BASE] 
 235 016c 00B5FFF7 	    _CALL print_int 
 235      FEFF5DF8 
 235      04EB
 236 0176 F4E7     	    b 1b 
 237 0178 00B5FFF7 	9:  _CALL cr 
 237      FEFF5DF8 
 237      04EB
 238 0182 BDE80303 	    pop {r0,r1,T1,T2}
 239 0186 7047     	    _RET 
 240              	data_stack:
 241 0188 8C010000 	  .word .+4 
 242 018c 64737461 	  .asciz "dstack: "
 242      636B3A20 
 242      00
 243              	
ARM GAS  tinyBasic.s 			page 17


 244              	/************************************
 245              	  show main stack 
 246              	***********************************/
 247 0195 0000BF   	    _FUNC show_main_stack
 248 0198 2CE90303 	    stmdb DP!,{r0,r1,T1,T2}
 249 019c DFF83C00 	    ldr r0,main_stack 
 250 01a0 00B5FFF7 	    _CALL uart_puts 
 250      FEFF5DF8 
 250      04EB
 251 01aa 4FF4A049 	    _MOV32 T2,RSTACK_TOP
 251      C2F20009 
 252 01b2 0DF10408 	    add T1,sp,#4
 253 01b6 C145     	1:  cmp T2,T1
 254 01b8 08D0     	    beq 9f 
 255 01ba 59F8040D 	    ldmdb T2!,{r0} 
 256 01be A169     	    ldr r1,[UPP,#BASE]
 257 01c0 00B5FFF7 	    _CALL print_int
 257      FEFF5DF8 
 257      04EB
 258 01ca F4E7     	    b 1b
 259 01cc 00B5FFF7 	9:  _CALL cr 
 259      FEFF5DF8 
 259      04EB
 260 01d6 BCE80303 	    ldmia DP!,{r0,r1,T1,T2}     
 261 01da 7047     	    _RET  
 262              	main_stack:
 263 01dc E0010000 	   .word .+4 
 264 01e0 72737461 	   .asciz "rstack: " 
 264      636B3A20 
 264      00
 265              	
 266              	/************************************
 267              	    show execution trace 
 268              	************************************/
 269 01e9 0000BF   	    _FUNC show_trace
 270 01ec 04B4     	    push {r2}
 271 01ee D4F8CC20 	    ldr r2,[UPP,#TRACE_LEVEL]
 272 01f2 BAB1     	    cbz r2,9f  
 273 01f4 00B5FFF7 	    _CALL cr 
 273      FEFF5DF8 
 273      04EB
 274 01fe 00B5FFF7 	    _CALL show_line_nbr
 274      90FF5DF8 
 274      04EB
 275 0208 022A     	    cmp r2,#2 
 276 020a 0BD4     	    bmi 9f 
 277 020c 00B5FFF7 	    _CALL show_data_stack 
 277      9BFF5DF8 
 277      04EB
 278 0216 032A     	    cmp r2,#3 
 279 0218 04D4     	    bmi 9f 
 280 021a 00B5FFF7 	    _CALL show_main_stack 
 280      BCFF5DF8 
 280      04EB
 281 0224 04BC     	9:  pop {r2}
 282 0226 7047     	    _RET 
 283              	
ARM GAS  tinyBasic.s 			page 18


 284              	
 285              	/************************************
 286              	    prt_chars 
 287              	    print n ascii character starting 
 288              	    at address 
 289              	    input: 
 290              	      r0    address 
 291              	      r1    count 
 292              	    output:
 293              	      r0    address + count
 294              	    use:
 295              	      r2    address 
 296              	***********************************/
 297              	    _FUNC prt_chars 
 298 0228 04B4     	    push {r2}
 299 022a 0246     	    mov r2,r0
 300 022c 12F8010B 	1:  ldrb r0,[r2],#1 
 301 0230 2028     	    cmp r0,#SPACE 
 302 0232 01D5     	    bpl 2f 
 303 0234 4FF05F00 	    mov r0,#'_' 
 304 0238 00B5FFF7 	2:  _CALL uart_putc
 304      FEFF5DF8 
 304      04EB
 305 0242 0139     	    subs r1,#1 
 306 0244 F2D1     	    bne 1b 
 307 0246 1046     	    mov r0,r2 
 308 0248 04BC     	    pop {r2}
 309 024a 7047     	    _RET 
 310              	
 311              	
 312              	/*********************************
 313              	    search_target 
 314              	    search for goto, gosub target
 315              	    target is line number | label  
 316              	*********************************/
 317              	    _FUNC search_target
 318 024c 00B500F0 	    _CALL next_token 
 318      E7FD5DF8 
 318      04EB
 319 0256 1A28     	    cmp r0,TK_LABEL 
 320 0258 06D1     	    bne 2f 
 321 025a 00B500F0 	    _CALL search_label
 321      34F85DF8 
 321      04EB
 322 0264 A0B1     	    cbz r0,8f  
 323 0266 16E0     	    b 9f 
 324 0268 D4F800A0 	2:  _UNGET_TOKEN
 324      D4F808B0 
 325 0270 00B500F0 	    _CALL expression 
 325      19FF5DF8 
 325      04EB
 326 027a 1B28     	    cmp r0,#TK_INTGR 
 327 027c 40F0DA83 	    bne syntax_error 
 328 0280 48B1     	    cbz r0,9f 
 329 0282 0846     	    mov r0,r1 
 330 0284 00B5FFF7 	    _CALL search_lineno 
 330      FEFF5DF8 
ARM GAS  tinyBasic.s 			page 19


 330      04EB
 331 028e 11B1     	    cbz r1,9f 
 332 0290 4FF00A00 	8:  mov r0,#ERR_BAD_VALUE 
 333 0294 D2E3     	    b tb_error 
 334 0296 7047     	9:  _RET 
 335              	
 336              	
 337              	/***************************************
 338              	  search_const 
 339              	  search for constant 
 340              	  input:
 341              	    r0  constant label 
 342              	  output:
 343              	    r0  constant value  
 344              	  use:
 345              	    r1  temp 
 346              	    T1   *list 
 347              	    T2   BOUND 
 348              	***************************************/
 349              	    _FUNC search_const
 350 0298 2DE90203 	    push {r1,T1,T2} 
 351 029c D4F83480 	    ldr T1,[UPP,#TXTEND]
 352 02a0 D4F8D090 	    ldr T2,[UPP,#HERE] 
 353 02a4 C845     	1:  cmp T1,T2 
 354 02a6 0BD5     	    bpl 8f 
 355 02a8 58F8041B 	    ldr r1,[T1],#4
 356 02ac 8842     	    cmp r0,r1 
 357 02ae 02D0     	    beq 2f 
 358 02b0 08F10408 	    add T1,#4
 359 02b4 F6E7     	    b 1b 
 360              	2:  // found 
 361 02b6 D8F80000 	    ldr r0,[T1]
 362 02ba BDE80203 	    pop {r1,T1,T2}
 363 02be 7047     	    _RET
 364              	8:  // that constant doesn't exist 
 365 02c0 4FF00A00 	    mov r0,#ERR_BAD_VALUE 
 366 02c4 BAE3     	    b tb_error      
 367              	
 368              	
 369              	/***************************************
 370              	    search_label 
 371              	    search target label 
 372              	    input:
 373              	      r1    target label 
 374              	    output:
 375              	      r0    address or 0 
 376              	    use:
 377              	      r2    line address link 
 378              	      r3    search limit 
 379              	****************************************/
 380 02c6 00BF     	    _FUNC search_label 
 381 02c8 0CB4     	    push {r2,r3}
 382 02ca 226B     	    ldr r2,[UPP,#TXTBGN]
 383 02cc 636B     	    ldr r3,[UPP,#TXTEND]
 384 02ce 9A42     	1:  cmp r2,r3
 385 02d0 0AD0     	    beq 8f 
 386 02d2 D078     	    ldrb r0,[r2,#3]
ARM GAS  tinyBasic.s 			page 20


 387 02d4 1A28     	    cmp  r0,#TK_LABEL 
 388 02d6 02D0     	    beq 4f 
 389 02d8 9078     	2:  ldrb r0,[r2,#2]
 390 02da 0244     	    add r2,r0 
 391 02dc F7E7     	    b 1b 
 392              	4:  // compare label 
 393 02de 5068     	    ldr r0,[R2,#4]
 394 02e0 8142     	    cmp r1,r0 
 395 02e2 F9D1     	    bne 2b 
 396              	    // found label 
 397 02e4 1046     	    mov r0,r2 
 398 02e6 01E0     	    b 9f
 399 02e8 80EA0000 	8:  eor r0,r0 
 400 02ec 0CBC     	9:  pop {r2,r3}
 401 02ee 7047     	    _RET 
 402              	
 403              	
 404              	/***************************************
 405              	    search_lineno 
 406              	    localize BASIC line from its number 
 407              	    input:
 408              	      r0   line# 
 409              	    output: 
 410              	      r0   adr where found || adr new to be inserted 
 411              	      r1   0 found || !0 not found  
 412              	    use:
 413              	      r0   scan address 
 414              	      r1   temp   
 415              	      r2   address end of text
 416              	      r3   target line#
 417              	****************************************/    
 418              	    _GBL_FUNC search_lineno
 419 02f0 0CB4     	    push {r2,r3} 
 420 02f2 0346     	    mov r3,r0 // target 
 421 02f4 206B     	    ldr r0,[UPP,#TXTBGN] // search start adr 
 422 02f6 626B     	    ldr r2,[UPP,#TXTEND] // search area end adr
 423 02f8 9042     	1:  cmp r0,r2 
 424 02fa 05D0     	    beq  8f
 425 02fc 0188     	    ldrh r1,[r0]
 426 02fe C91A     	    subs r1,r3 
 427 0300 04D5     	    bpl 9f 
 428 0302 8178     	    ldrb r1,[r0,#2]
 429 0304 0844     	    add r0,r1
 430 0306 F7E7     	    b 1b 
 431 0308 4FF0FF31 	8:  mov r1,#-1 
 432 030c 0CBC     	9:  pop {r2,r3}
 433 030e 7047     	    _RET 
 434              	
 435              	
 436              	/********************************************
 437              	    delete_line 
 438              	    delete BASIC line at addr 
 439              	    input:
 440              	      r0    address line to delete 
 441              	    output:
 442              	      r0    same as input 
 443              	    use: 
ARM GAS  tinyBasic.s 			page 21


 444              	      r1    dest adr
 445              	      r2    bytes to move 
 446              	      T1    length line to delete 
 447              	      T2    txtend 
 448              	********************************************/
 449              	    _FUNC delete_line 
 450 0310 2DE90703 	    push {r0,r1,r2,T1,T2}
 451 0314 0146     	    mov r1,r0 // dest 
 452 0316 91F80280 	    ldrb T1,[r1,#2] // line length 
 453 031a 4044     	    add r0,T1  // src
 454 031c D4F83490 	    ldr T2,[UPP,#TXTEND]
 455 0320 A9EB0002 	    sub r2,T2,r0 // bytes to move 
 456 0324 00B5FFF7 	    _CALL cmove
 456      FEFF5DF8 
 456      04EB
 457 032e A9EB0809 	    sub T2,T1 // txtend-count 
 458 0332 C4F83490 	    str T2,[UPP,#TXTEND] 
 459 0336 BDE80703 	    pop {r0,r1,r2,T1,T2}
 460 033a 7047     	    _RET 
 461              	
 462              	/******************************************
 463              	    create_gap 
 464              	    create a gap in text area to insert new line 
 465              	    input:
 466              	      r0    adr 
 467              	      r1    length 
 468              	    output:
 469              	      r0    adr 
 470              	    use:
 471              	      T1    length 
 472              	      T2    txtend 
 473              	************************************************/
 474              	    _FUNC create_gap 
 475 033c 2DE90503 	    push {r0,r2,T1,T2}
 476 0340 8846     	    mov T1,R1
 477 0342 0144     	    add r1,r0  // dest 
 478 0344 D4F83490 	    ldr T2,[UPP,#TXTEND]
 479 0348 A9EB0002 	    sub r2,T2,r0 
 480 034c 00B5FFF7 	    _CALL cmove
 480      FEFF5DF8 
 480      04EB
 481 0356 C144     	    add T2,T1 
 482 0358 C4F83490 	    str T2,[UPP,#TXTEND]
 483 035c BDE80503 	    pop {r0,r2,T1,T2}
 484 0360 7047     	    _RET 
 485              	
 486              	/************************************************
 487              	    insert_line 
 488              	    insert BASIC line in text area 
 489              	    first search if line with same number exist 
 490              	    replace if so. 
 491              	    input:
 492              	      r0    *buffer to insert 
 493              	    output:
 494              	      none 
 495              	    use: 
 496              	      T1     *buffer
ARM GAS  tinyBasic.s 			page 22


 497              	      T2     temp  
 498              	************************************************/ 
 499 0362 00BF     	    _FUNC insert_line 
 500 0364 2DE90203 	    push {r1,T1,T2}
 501 0368 8046     	    mov T1,r0 
 502 036a B8F80000 	    ldrh r0,[T1]
 503 036e 00B5FFF7 	    _CALL search_lineno 
 503      FEFF5DF8 
 503      04EB
 504 0378 49B9     	    cbnz  r1, 1f // line# doesn't exist
 505              	// already exist 
 506 037a 00B5FFF7 	    _CALL delete_line // delete old one 
 506      C8FF5DF8 
 506      04EB
 507 0384 98F80290 	    ldrb T2,[T1,#2] // buffer line length 
 508 0388 B9F1040F 	    cmp T2,#4 // empty line length==4  
 509 038c 0ED0     	    beq 9f
 510              	1: //insert new line 
 511 038e 98F80210 	    ldrb r1,[T1,#2]
 512 0392 00B5FFF7 	    _CALL create_gap 
 512      D2FF5DF8 
 512      04EB
 513 039c 0146     	    mov r1,r0
 514 039e 4046     	    mov r0,T1 
 515 03a0 8278     	    ldrb r2,[r0,#2]
 516 03a2 00B5FFF7 	    _CALL cmove 
 516      FEFF5DF8 
 516      04EB
 517 03ac BDE80203 	9:  pop {r1,T1,T2}
 518 03b0 7047     	    _RET 
 519              	
 520              	/*********************************
 521              	    compile 
 522              	    tokenize source line save it 
 523              	    in pas buffer.
 524              	    compiled line format: 
 525              	      line_no  2 bytes {0...32767}
 526              	      count    1 byte  
 527              	      tokens   variable length 
 528              	  input:
 529              	     r0   *text buffer 
 530              	     r1   *text length   
 531              	  output:
 532              	    r0    0 stored | -1 immediate 
 533              	  use:
 534              	    r3    tib index   
 535              	    T1    tib
 536              	    T2    pad
 537              	***********************************/
 538 03b2 00BF     	    _FUNC compile
 539 03b4 8046     	    mov T1, r0  // source text buffer 
 540 03b6 6160     	    str r1,[UPP,#COUNT] // save line length 
 541 03b8 DFF8C099 	    ldr T2,pad // tokens buffer
 542 03bc 83EA0303 	    eor r3,r3 // source index  
 543 03c0 206C     	    ldr r0,[UPP,#FLAGS]
 544 03c2 40F02000 	    orr r0,#FCOMP
 545 03c6 2064     	    str r0,[UPP,#FLAGS] // compiling flag 
ARM GAS  tinyBasic.s 			page 23


 546 03c8 80EA0000 	    eor r0,r0     
 547 03cc 29F8020B 	    strh r0,[T2],#2   // line no 
 548 03d0 09F8010B 	    strb r0,[T2],#1 // length 
 549 03d4 2060     	    str  r0,[UPP,#IN_SAVED]  // save index 
 550 03d6 C4F80880 	    str  T1,[UPP,#BASICPTR] // save text line 
 551 03da 00B500F0 	    _CALL parse_int 
 551      68F95DF8 
 551      04EB
 552 03e4 0AD0     	    beq 2f 
 553              	// this is a line number     
 554 03e6 0129     	    cmp r1,#1 
 555 03e8 02D5     	    bpl 1f 
 556 03ea 4FF00A00 	0:  mov r0,#ERR_BAD_VALUE 
 557 03ee 25E3     	    b tb_error  
 558 03f0 B1F5803F 	1:  cmp r1,#65536
 559 03f4 F9D5     	    bpl 0b 
 560              	    // write line # to pad 
 561 03f6 29F8031C 	    strh r1,[T2,#-3]
 562 03fa 2360     	    str r3,[UPP,#IN_SAVED]
 563              	2:  // check for pad full 
 564 03fc C145     	    cmp T2,T1
 565 03fe 02DB     	    blt 3f 
 566 0400 4FF00F00 	    mov r0,#ERR_BUF_FULL 
 567 0404 1AE3     	    b tb_error 
 568 0406 00B500F0 	3:  _CALL comp_token 
 568      28F85DF8 
 568      04EB
 569 0410 0028     	    cmp r0,#TK_NONE 
 570 0412 01D0     	    beq 4f 
 571 0414 2360     	    str r3,[UPP,#IN_SAVED]
 572 0416 F1E7     	    b 2b 
 573              	4: // compilation completed 
 574 0418 DFF86039 	    ldr r3,pad 
 575 041c A9EB0300 	    sub r0,T2,r3 // line length 
 576 0420 9870     	    strb r0,[r3,#2]
 577 0422 6060     	    str r0,[UPP,#COUNT] // lenght of tokens line 
 578 0424 1888     	    ldrh r0,[r3] // line number 
 579 0426 70B1     	    cbz r0,8f  
 580              	// insert line in text buffer 
 581 0428 206C     	    ldr r0,[UPP,#FLAGS]
 582 042a 10F0080F 	    tst r0,#FSTOP
 583 042e 02D0     	    beq 7f 
 584 0430 4FF01000 	    mov r0,#ERR_CANT_PROG 
 585 0434 02E3     	    b tb_error 
 586 0436 1846     	7:  mov r0,r3 
 587 0438 00B5FFF7 	    _CALL insert_line 
 587      93FF5DF8 
 587      04EB
 588 0442 4040     	    eors r0,r0 
 589 0444 08E0     	    b 9f 
 590 0446 9B46     	8:  mov BPTR,r3 // *token_list 
 591 0448 4FF0030A 	    mov IN,#3
 592 044c 206C     	    ldr r0,[UPP,#FLAGS]
 593 044e A0F12000 	    sub r0,#FCOMP
 594 0452 2064     	    str r0,[UPP,#FLAGS]
 595 0454 5FF0FF30 	    movs r0,#-1 
 596 0458 7047     	9:  _RET 
ARM GAS  tinyBasic.s 			page 24


 597              	
 598              	/*********************************************
 599              	    compile next token from source 
 600              	    input: 
 601              	      r3 		tib index  
 602              	      T1    tib adr
 603              	      T2    insert point in pad  
 604              	    output:
 605              	      r0     token attribute 
 606              	      r1 		token value
 607              	      r3     tib index updated    
 608              	      T2     updated 
 609              	      use:
 610              	**********************************************/
 611 045a 00BF     	    _FUNC comp_token 
 612 045c 40B4     	    push {r6}
 613 045e 18F80300 	    ldrb r0,[T1,r3]
 614 0462 0040     	    ands r0,r0 
 615 0464 7DD0     	    beq store_r0  // reached end of text  
 616 0466 4FF02000 	    mov r0,#SPACE 
 617 046a 00B500F0 	    _CALL skip  // skip spaces 
 617      70F95DF8 
 617      04EB
 618 0474 18F80300 	    ldrb r0,[T1,r3]
 619 0478 0040     	    ands r0,r0 
 620 047a 72D0     	    beq store_r0  // reached end of text 
 621 047c 03F10103 	    add r3,#1
 622 0480 00B500F0 	    _CALL is_letter 
 622      99F95DF8 
 622      04EB
 623 048a 0BD1     	    bne 1f
 624 048c A3F10103 	    sub r3,#1 
 625 0490 00B500F0 	    _CALL comp_label // parse and compile label 
 625      AFF85DF8 
 625      04EB
 626 049a 1728     	    cmp r0,#TK_CMD 
 627 049c 71D1     	    bne token_exit 
 628 049e 3A29     	    cmp r1,#REM_IDX 
 629 04a0 4DD0     	    beq tick2 
 630 04a2 6EE0     	    b token_exit 
 631 04a4 00B500F0 	1:  _CALL is_special
 631      6FF85DF8 
 631      04EB
 632 04ae DFF8286D 	    ldr r6,=token_ofs
 633 04b2 D6E811F0 	    tbh [r6,r1] 
 634              	tok_idx0:     
 635              	//  not special char.  
 636 04b6 57E0     	    b try_number 
 637              	// single char token with no value 
 638              	single: 
 639 04b8 DFF8206D 	    ldr r6,=tok_single
 640 04bc 705C     	    ldrb r0,[r6,r1] 
 641 04be 50E0     	    b store_r0
 642              	lt:
 643 04c0 4FF00F00 	    mov r0,#TK_LT
 644 04c4 18F80310 	    ldrb r1,[T1,r3]
 645 04c8 3E29     	    cmp r1,#'>' 
ARM GAS  tinyBasic.s 			page 25


 646 04ca 06D0     	    beq 1f
 647 04cc 0AE0     	    b 2f 
 648              	gt:
 649 04ce 4FF00E00 	    mov r0,#TK_GT 
 650 04d2 18F80310 	    ldrb r1,[T1,r3]
 651 04d6 3C29     	    cmp r1,#'<'
 652 04d8 04D1     	    bne 2f  
 653 04da 03F10103 	1:  add r3,#1
 654 04de 4FF01200 	    mov r0,#TK_NE  
 655 04e2 3EE0     	    b store_r0
 656 04e4 3D29     	2:  cmp r1,#'=' 
 657 04e6 3CD1     	    bne store_r0  
 658 04e8 03F10103 	    add r3,#1
 659 04ec 00F10200 	    add r0,#2
 660 04f0 37E0     	    b store_r0       
 661              	bkslash:
 662 04f2 18F80310 	    ldrb r1,[T1,r3]
 663 04f6 03F10103 	    add r3,#1
 664 04fa 4FF01300 	    mov r0,#TK_CHAR 
 665 04fe 09F8010B 	    strb r0,[T2],#1
 666 0502 09F8011B 	    strb r1,[T2],#1
 667 0506 3CE0     	    b token_exit 
 668              	prt_cmd: 
 669 0508 4FF01700 	    mov r0,#TK_CMD 
 670 050c 4FF03501 	    mov r1,#PRT_IDX
 671 0510 09F8010B 	    strb r0,[T2],#1
 672 0514 09F8011B 	    strb r1,[T2],#1
 673 0518 33E0     	    b token_exit 
 674              	quote:
 675 051a 4FF01C00 	    mov r0,#TK_QSTR 
 676 051e 09F8010B 	    strb r0,[T2],#1
 677 0522 00B500F0 	    _CALL parse_quote
 677      E0F85DF8 
 677      04EB
 678 052c 29E0     	    b token_exit
 679              	tick: 
 680              	// copy comment in pad 
 681 052e 4FF01700 	    mov r0,#TK_CMD 
 682 0532 4FF03A01 	    mov r1,#REM_IDX 
 683 0536 09F8010B 	    strb r0,[T2],#1 
 684 053a 09F8011B 	    strb r1,[T2],#1
 685              	tick2:
 686 053e 08EB0300 	    add r0,T1,r3 
 687 0542 4946     	    mov r1,T2 
 688 0544 00B5FFF7 	    _CALL strcpy 
 688      FEFF5DF8 
 688      04EB
 689 054e 00B5FFF7 	    _CALL strlen 
 689      FEFF5DF8 
 689      04EB
 690 0558 8144     	    add T2,r0
 691 055a 09F10109 	    add T2,#1
 692 055e 6368     	    ldr r3,[UPP,#COUNT]
 693 0560 0FE0     	    b token_exit
 694              	store_r0: 
 695 0562 09F8010B 	    strb r0,[T2],#1
 696 0566 0CE0     	    b token_exit 
ARM GAS  tinyBasic.s 			page 26


 697              	try_number:
 698 0568 A3F10103 	    sub r3,#1
 699 056c 00B500F0 	    _CALL parse_int  
 699      9FF85DF8 
 699      04EB
 700 0576 00F05D82 	    beq syntax_error  
 701 057a 09F8010B 	    strb r0,[T2],#1 
 702 057e 49F8041B 	    str r1,[T2],#4
 703              	token_exit:
 704 0582 40BC     	    pop {r6}
 705 0584 7047     	    _RET 
 706              	
 707              	
 708              	/****************************
 709              	    is_special  
 710              	    check for non alphanum
 711              	    input:
 712              	      r0    character to scan 
 713              	    output:
 714              	      r0    character 
 715              	      r1    0 || index 
 716              	    use: 
 717              	      r1    scan index 
 718              	      r2    temp 
 719              	      r3    char_list 
 720              	*****************************/
 721 0586 00BF     	    _FUNC is_special 
 722 0588 0CB4     	    push {r2,r3}
 723 058a 4FF00101 	    mov r1,#1
 724 058e DFF8503C 	    ldr r3,=char_list 
 725 0592 5A5C     	1:  ldrb r2,[r3,r1]
 726 0594 22B1     	    cbz r2,8f 
 727 0596 8242     	    cmp r2,r0 
 728 0598 04D0     	    beq 9f 
 729 059a 01F10101 	    add r1,#1 
 730 059e F8E7     	    b 1b
 731 05a0 81EA0101 	8:  eor r1,r1     
 732 05a4 0CBC     	9:  pop {r2,r3}
 733 05a6 7047     	    _RET 
 734              	
 735              	char_list:
 736 05a8 202C3B40 	  .asciz " ,;@():#-+*/%=<>\\?'\""
 736      28293A23 
 736      2D2B2A2F 
 736      253D3C3E 
 736      5C3F2722 
 737              	
 738              	tok_single:
 739 05bd 0002030C 	  .byte TK_NONE,TK_COMMA,TK_SEMIC,TK_ARRAY,TK_LPAREN,TK_RPAREN,TK_COLON
 739      050601
 740 05c4 04080709 	  .byte TK_SHARP,TK_MINUS,TK_PLUS,TK_MULT,TK_DIV,TK_MOD,TK_EQUAL 
 740      0A0B0D
 741              	
 742 05cb 00       	  .p2align 2
 743              	token_ofs:
 744 05cc 0000     	  .hword  0 // not found
 745              	  // TK_COMMA...TK_EQUAL , 13 
ARM GAS  tinyBasic.s 			page 27


 746 05ce 01000100 	  .hword  (single-tok_idx0)/2,(single-tok_idx0)/2,(single-tok_idx0)/2,(single-tok_idx0)/2
 746      01000100 
 747 05d6 01000100 	  .hword  (single-tok_idx0)/2,(single-tok_idx0)/2,(single-tok_idx0)/2,(single-tok_idx0)/2
 747      01000100 
 748 05de 01000100 	  .hword  (single-tok_idx0)/2,(single-tok_idx0)/2,(single-tok_idx0)/2,(single-tok_idx0)/2
 748      01000100 
 749 05e6 0100     	  .hword  (single-tok_idx0)/2    
 750              	  // '<','>'
 751 05e8 05000C00 	  .hword  (lt-tok_idx0)/2,(gt-tok_idx0)/2
 752              	  // '\'
 753 05ec 1E00     	  .hword  (bkslash-tok_idx0)/2
 754              	  // '?' 
 755 05ee 2900     	  .hword  (prt_cmd-tok_idx0)/2 
 756              	  // "'"  
 757 05f0 3C00     	  .hword  (tick-tok_idx0)/2 
 758              	  // '"' quote 
 759 05f2 3200     	  .hword (quote-tok_idx0)/2
 760              	
 761              	  .p2align 2
 762              	
 763              	/****************************
 764              	    comp_label
 765              	    compile a label 
 766              	    it can be a target|keyword|
 767              	    variable| user constant  
 768              	    label form: [A..Z]+
 769              	    input:
 770              	      *buffer 
 771              	    output:
 772              	      r0  token type 
 773              	      r1  token value 
 774              	      T2  updated 
 775              	      R3  updated
 776              	    use:
 777              	****************************/
 778              	    _FUNC comp_label
 779 05f4 24B4     	    push {r2,r5}
 780 05f6 4DF8049D 	    push {T2}
 781 05fa 82EA0202 	    eor r2,r2
 782 05fe 4FF00605 	    mov r5,#6 
 783 0602 18F80300 	1:  ldrb r0,[T1,r3]
 784 0606 00B500F0 	    _CALL is_letter 
 784      D6F85DF8 
 784      04EB
 785 0610 09D1     	    bne 2f // not letter 
 786 0612 00B500F0 	    _CALL upper 
 786      A8F85DF8 
 786      04EB
 787 061c 09F8010B 	    strb r0,[T2],#1
 788 0620 03F10103 	    add r3,#1
 789 0624 EDE7     	    b 1b 
 790 0626 80EA0000 	2:  eor r0,r0 
 791 062a 89F80000 	    strb r0,[T2]
 792              	// is this a variable ?
 793 062e 5DF8049B 	    pop {T2}
 794 0632 99F80100 	    ldrb r0,[T2,#1]
 795 0636 30B9     	    cbnz r0,3f // length >1 not variable 
ARM GAS  tinyBasic.s 			page 28


 796 0638 99F80010 	    ldrb r1,[T2]
 797 063c A1F14101 	    sub r1,#'A' 
 798 0640 4FF01400 	    mov r0,#TK_VAR
 799 0644 1CE0     	    b 8f 
 800              	3:  // try keyword 
 801 0646 4846     	    mov r0,T2 
 802 0648 DFF8981B 	    ldr r1,=kword_dict  
 803 064c 00B500F0 	    _CALL search_dict 
 803      B3FA5DF8 
 803      04EB
 804 0656 30B1     	    cbz r0,4f
 805 0658 1828     	    cmp r0,TK_SCONST  
 806 065a 11D1     	    bne 8f
 807              	    //system constant  
 808 065c 09F8010B 	    strb r0,[T2],#1
 809 0660 49F8041B 	    str r1,[T2],#4
 810 0664 10E0     	    b 9f 
 811              	4: // must be a label 
 812 0666 4846     	    mov r0,T2 
 813 0668 00B500F0 	    _CALL compress_label
 813      0FF85DF8 
 813      04EB
 814 0672 4FF01A00 	    mov r0,#TK_LABEL
 815 0676 09F8010B 	    strb r0,[T2],#1
 816 067a 49F8041B 	    str r1,[T2],#4
 817 067e 03E0     	    b 9f 
 818 0680 09F8010B 	8:  strb r0,[T2],#1
 819 0684 09F8011B 	    strb r1,[T2],#1          
 820 0688 24BC     	9:  pop {r2,r5}
 821 068a 7047     	    _RET 
 822              	
 823              	/********************************
 824              	    compress_label 
 825              	    compress label in integer 
 826              	    maximum 6 character, 
 827              	    ignore extras characters 
 828              	    input:
 829              	      r0  *label 
 830              	    output:
 831              	      r1   compressed label 
 832              	********************************/
 833              	    _FUNC compress_label
 834 068c 0CB4     	    push {r2,r3}
 835 068e 82EA0202 	    eor r2,r2 // compress value
 836 0692 4FF00603 	    mov r3,#6 // max characters 
 837 0696 10F8011B 	1:  ldrb r1,[r0],#1 
 838 069a 31B1     	    cbz r1,2f 
 839 069c A1F14001 	    sub r1,#'@'
 840 06a0 4FEA4212 	    lsl r2,#5
 841 06a4 0A44     	    add r2,r1
 842 06a6 013B     	    subs r3,#1 
 843 06a8 F5D1     	    bne 1b 
 844 06aa 1146     	2:  mov r1,r2     
 845 06ac 0CBC     	    pop {r2,r3}
 846 06ae 7047     	    _RET 
 847              	
 848              	
ARM GAS  tinyBasic.s 			page 29


 849              	/****************************
 850              	    parse_int 
 851              	    parse an integer from text
 852              	    if not valid integer 
 853              	    r1 return *buffer else 
 854              	    *buffer is incremented after integer 
 855              	  input:
 856              	    r0   *buffer 
 857              	  output:
 858              	    r0   TK_INTGR|TK_NONE
 859              	    r1   int|0   
 860              	  use:
 861              	    r3   tib index updated     
 862              	*****************************/
 863              	    _FUNC parse_int 
 864 06b0 4FF00A01 	    mov r1,#10 // default base 
 865 06b4 18F80300 	    ldrb r0,[T1,r3]
 866 06b8 2428     	    cmp r0,'$' 
 867 06ba 02D1     	    bne 2f 
 868 06bc 4FF01001 	    mov r1,#16 // hexadecimal number 
 869 06c0 03E0     	    b 3f  
 870 06c2 2628     	2:  cmp r0,#'&' 
 871 06c4 03D1     	    bne 4f
 872 06c6 4FF00201 	    mov r1,#2 //binary number  
 873 06ca 03F10103 	3:  add r3,#1
 874 06ce 03EB0800 	4:  add r0,r3,T1 
 875 06d2 00B5FFF7 	    _CALL atoi 
 875      FEFF5DF8 
 875      04EB
 876 06dc 10B1     	    cbz r0,9f
 877 06de 0344     	    add r3,r0
 878 06e0 4FF01B00 	    mov r0,#TK_INTGR
 879 06e4 0040     	9:  ands r0,r0   
 880 06e6 7047     	    _RET 
 881              	
 882              	/*********************************************
 883              	    parse_quote 
 884              	    parse quoted string 
 885              	    input: 
 886              	      r3 		tib index  
 887              	      T1    tib adr
 888              	      T2    insert point in pad  
 889              	    output:
 890              	      r0     token attribute 
 891              	      r1 		*str 
 892              	      r3     tib index updated    
 893              	      T2     updated 
 894              	      use:
 895              	*********************************************/
 896              	    _FUNC parse_quote
 897 06e8 4DF8049D 	    push {T2} 
 898 06ec 18F80300 	1:  ldrb r0,[T1,r3]
 899 06f0 03F10103 	    add r3,#1 
 900 06f4 2228     	    cmp r0,#'"'
 901 06f6 09D0     	    beq 9f 
 902 06f8 5C28     	    cmp r0,#'\\'
 903 06fa 04D1     	    bne 2f 
ARM GAS  tinyBasic.s 			page 30


 904 06fc 00B500F0 	    _CALL get_escaped_char 
 904      0DF85DF8 
 904      04EB
 905 0706 09F8010B 	2:  strb r0,[T2],#1
 906 070a EFE7     	    b 1b 
 907 070c 80EA0000 	9:  eor  r0,r0
 908 0710 09F8010B 	    strb r0,[T2],#1
 909 0714 4FF01C00 	    mov r0,#TK_QSTR
 910 0718 02BC     	    pop {r1}
 911 071a 7047     	    _RET 
 912              	
 913              	/**********************************************
 914              	    get_escaped_char 
 915              	    convert "\c" in quoted string 
 916              	    input:
 917              	      r0 
 918              	      r3   index 
 919              	      T1   tib 
 920              	    output:
 921              	      r0   replacement char
 922              	      r3   updated 
 923              	    use:
 924              	      r1   *table 
 925              	      r2   temp 
 926              	**********************************************/
 927              	    _FUNC get_escaped_char 
 928 071c 06B4     	    push {r1,r2}
 929 071e 18F80300 	    ldrb r0,[T1,r3]
 930 0722 03F10103 	    add r3,#1
 931 0726 2228     	    cmp r0,#'"' 
 932 0728 0BD0     	    beq 9f 
 933 072a DFF8BC1A 	1:  ldr r1,=escaped 
 934 072e 11F8012B 	2:  ldrb r2,[r1],#1
 935 0732 12B1     	    cbz r2,6f 
 936 0734 8242     	    cmp r2,r0 
 937 0736 02D0     	    beq 7f 
 938 0738 F9E7     	    b 2b
 939 073a A0F10702 	6:  sub r2,r0,#7     
 940 073e 02F10700 	7:  add r0,r2,#7
 941 0742 06BC     	9:  pop {r1,r2}   
 942 0744 7047     	    _RET
 943              	
 944 0746 6162746E 	escaped: .asciz "abtnvfr"
 944      76667200 
 945              	
 946              	/*********************************************
 947              	   skip character in TIB 
 948              	   input:
 949              	      r0    character to skip 
 950              	      r3    tib index 
 951              	      T1    tib adr
 952              	    output: 
 953              	      r3    updated
 954              	    use:
 955              	      r1     
 956              	**********************************************/   
 957 074e 00BF     	    _FUNC skip
ARM GAS  tinyBasic.s 			page 31


 958 0750 02B4     	    push {r1} 
 959 0752 18F80310 	1:  ldrb r1,[T1,r3]
 960 0756 8142     	    cmp r1,r0
 961 0758 02D1     	    bne 2f
 962 075a 03F10103 	    add r3,#1 
 963 075e F8E7     	    b 1b 
 964 0760 2360     	2:  str r3,[UPP,#IN_SAVED]
 965 0762 02BC     	    pop {r1}
 966 0764 7047     	    _RET
 967              	
 968              	/********************************************
 969              	    upper
 970              	    convert character in upper case 
 971              	    input: 
 972              	      r0   character 
 973              	    output:
 974              	      r0   upper case character 
 975              	*********************************************/
 976 0766 00BF     	    _FUNC upper 
 977 0768 6128     	    cmp r0,#'a' 
 978 076a 03DB     	    blt 9f 
 979 076c 7A28     	    cmp r0,#'z' 
 980 076e 01DC     	    bgt 9f 
 981 0770 00F05F00 	    and r0,#0x5f 
 982 0774 7047     	9:  _RET 
 983              	
 984              	/***************************************
 985              	   is_digit 
 986              	   check if char is decimal digit.
 987              	   convert to decimal digit.
 988              	   input:
 989              	      r0    char 
 990              	   output:
 991              	      r0        if Z then converted digit else not changed
 992              	      Z flag    1 true | 0 false  
 993              	***************************************/
 994 0776 00BF     	    _GBL_FUNC is_digit 
 995 0778 02B4     	    push {r1} 
 996 077a 4FF0FF31 	    mov r1,#-1   
 997 077e 3028     	    cmp r0,#'0' 
 998 0780 05DB     	    blt 9f
 999 0782 3A28     	    cmp r0,'9'+1
 1000 0784 03D5     	    bpl 9f 
 1001 0786 81EA0101 	    eor r1,r1 
 1002 078a A0F13000 	    sub r0,#'0'  
 1003              	9:   
 1004 078e 0940     	    ands r1,r1
 1005 0790 02BC     	    pop {r1} 
 1006 0792 7047     	    _RET 
 1007              	
 1008              	/***************************************
 1009              	    is_hex 
 1010              	    check for hexadecimal digit 
 1011              	    convert to hex digit.
 1012              	    input:
 1013              	      r0    
 1014              	    output:
ARM GAS  tinyBasic.s 			page 32


 1015              	      r0         if Z then converted digit 
 1016              	      Z  flag    1 true | 0 false         
 1017              	***************************************/
 1018              	    _FUNC is_hex 
 1019 0794 02B4     	    push {r1}
 1020 0796 80EA0000 	    eor r0,r0 
 1021 079a 4128     	    cmp r0,#'A' 
 1022 079c 01D4     	    bmi 1f 
 1023 079e A0F10700 	    sub r0,#7 
 1024 07a2 A0F13000 	1:  sub r0,#'0'
 1025 07a6 01D4     	    bmi 2f 
 1026 07a8 1028     	    cmp r0,#16
 1027 07aa 01D4     	    bmi 9f 
 1028 07ac 6FEA0101 	2:  mvn r1,r1  
 1029 07b0 0940     	9:  ands r1,r1 
 1030 07b2 02BC     	    pop {r1}
 1031 07b4 7047     	    _RET 
 1032              	
 1033              	/***************************************
 1034              	    is_letter 
 1035              	    check if character is {a..z,A..Z} 
 1036              	  input:
 1037              	    r0   character 
 1038              	  output: 
 1039              	    r0       same character 
 1040              	    Z flag   1 true | 0 false  
 1041              	****************************************/
 1042 07b6 00BF     	    _FUNC is_letter
 1043 07b8 02B4     	    push {r1} 
 1044 07ba 81EA0101 	    eor r1,r1 
 1045 07be 4128     	    cmp r0,#'A' 
 1046 07c0 05D4     	    bmi 8f 
 1047 07c2 5B28     	    cmp r0,#'Z'+1 
 1048 07c4 05D4     	    bmi 9f
 1049 07c6 6128     	    cmp r0,#'a' 
 1050 07c8 01D4     	    bmi 8f 
 1051 07ca 7B28     	    cmp r0,#'z'+1
 1052 07cc 01D4     	    bmi 9f  
 1053 07ce 6FEA0101 	8:  mvn r1,r1  
 1054 07d2 0940     	9:  ands r1,r1 
 1055 07d4 02BC     	    pop {r1}
 1056 07d6 7047     	    _RET 
 1057              	
 1058              	
 1059              	/******************************************
 1060              	    atoi 
 1061              	    convert ascii to integer 
 1062              	    input:
 1063              	      r0   *buffer 
 1064              	      r1   base 
 1065              	    output:
 1066              	      r0   0 no integer found 
 1067              	      r1   integer
 1068              	    use:
 1069              	      r2   base  
 1070              	      T1   *buffer 
 1071              	      T2   digit count  
ARM GAS  tinyBasic.s 			page 33


 1072              	******************************************/
 1073              	    _GBL_FUNC atoi 
 1074 07d8 2DE90403 	    push {r2,T1,T2}
 1075 07dc 8046     	    mov T1,r0  // *buffer 
 1076 07de 0A46     	    mov r2,r1  // base  
 1077 07e0 81EA0101 	    eor r1,r1  // converted integer 
 1078 07e4 89EA0909 	    eor T2,T2  // digit count 
 1079 07e8 18F8010B 	1:  ldrb r0,[T1],#1
 1080 07ec 00B5FFF7 	    _CALL upper 
 1080      BBFF5DF8 
 1080      04EB
 1081 07f6 3028     	    cmp r0,#'0'
 1082 07f8 0FD4     	    bmi 8f
 1083 07fa 3A28     	    cmp r0,#'9'+1 
 1084 07fc 03D4     	    bmi 2f 
 1085 07fe 4128     	    cmp r0,#'A'
 1086 0800 0BD4     	    bmi 8f 
 1087 0802 A0F10700 	    sub r0,#7 
 1088 0806 A0F13000 	2:  sub r0,#'0' 
 1089 080a 9042     	    cmp r0,r2
 1090 080c 05D5     	    bpl 8f  
 1091 080e 02FB01F1 	    mul r1,r2 
 1092 0812 0144     	    add r1,r0
 1093 0814 09F10109 	    add T2,#1
 1094 0818 E6E7     	    b 1b 
 1095 081a 4846     	8:  mov r0,T2  
 1096 081c BDE80403 	    pop {r2,T1,T2}
 1097 0820 7047     	    _RET 
 1098              	
 1099              	
 1100              	
 1101              	/*******************
 1102              	    DECOMPILER 
 1103              	*******************/
 1104              	
 1105              	/********************************************
 1106              	    cmd_name 
 1107              	    search bytecode in dictionary and 
 1108              	    return its name 
 1109              	  input:
 1110              	    r0    keyword bytecode 
 1111              	  ouput:
 1112              	    r0    name string 
 1113              	  use:
 1114              	    T1    link 
 1115              	    T2    tmp 
 1116              	*********************************************/
 1117 0822 00BF     	    _FUNC cmd_name 
 1118 0824 2DE90003 	    push {T1,T2}
 1119 0828 DFF8B889 	    ldr T1,=kword_dict 
 1120 082c 58F8089C 	1:  ldr T2,[T1,#-8]
 1121 0830 8145     	    cmp T2,r0 
 1122 0832 04D0     	    beq 2f 
 1123 0834 58F80C8C 	    ldr T1,[T1,#-12]
 1124 0838 B8F1000F 	    cmp T1,#0
 1125 083c F6D1     	    bne 1b  
 1126 083e 4046     	2:  mov r0,T1 
ARM GAS  tinyBasic.s 			page 34


 1127 0840 BDE80003 	    pop {T1,T2}
 1128 0844 7047     	    _RET
 1129              	
 1130              	/*****************************
 1131              	  decompile_line 
 1132              	  detokenize BASIC line 
 1133              	  input:
 1134              	    r0  *token list 
 1135              	    r1  *output buffer 
 1136              	  output:
 1137              	    r0  *output buffer (.asciz) 
 1138              	  use:
 1139              	    T1  *output buffer
 1140              	    BPTR  *token list
 1141              	    IN  offset in token list  
 1142              	******************************/
 1143 0846 00BF     	    _GBL_FUNC decompile_line
 1144 0848 2DE90E01 	    push {r1,r2,r3,T1} 
 1145 084c 8346     	    mov BPTR,r0 
 1146 084e 4FF0000A 	    mov IN,#0
 1147 0852 8846     	    mov T1,r1 
 1148 0854 3BF80A00 	    ldrh r0,[BPTR,IN]
 1149 0858 0AF1020A 	    add IN,#2 
 1150 085c 4FF00A01 	    mov r1,#10 
 1151 0860 00B5FFF7 	    _CALL itoa
 1151      FEFF5DF8 
 1151      04EB
 1152 086a 4146     	    mov r1,T1
 1153 086c 00B5FFF7 	    _CALL strcpy
 1153      FEFF5DF8 
 1153      04EB
 1154 0876 4046     	    mov r0,T1 
 1155 0878 00B5FFF7 	    _CALL strlen
 1155      FEFF5DF8 
 1155      04EB
 1156 0882 8044     	    add T1,r0 
 1157 0884 1BF80A00 	    ldrb r0,[BPTR,IN]    
 1158 0888 0AF1010A 	    add IN,#1 
 1159 088c 6060     	    str r0,[UPP,#COUNT]
 1160              	decomp_loop:
 1161 088e 00B500F0 	    _CALL next_token
 1161      C6FA5DF8 
 1161      04EB
 1162 0898 0028     	    cmp r0,#TK_NONE 
 1163 089a 00F0A480 	    beq 9f
 1164 089e 1028     	    cmp r0,#TK_GE 
 1165 08a0 05D5     	    bpl 1f 
 1166 08a2 DFF84819 	    ldr r1,=single_char 
 1167 08a6 085C     	    ldrb r0,[r1,r0]
 1168 08a8 08F8010B 	    strb r0,[T1],#1 
 1169 08ac EFE7     	    b decomp_loop
 1170              	1: 
 1171 08ae 1328     	    cmp r0,#TK_CHAR  
 1172 08b0 14D5     	    bpl 2f 
 1173 08b2 A0F11000 	    sub r0,#TK_GE
 1174 08b6 4FEA8000 	    lsl r0,#2 
 1175 08ba DFF83419 	    ldr r1,=relop_str 
ARM GAS  tinyBasic.s 			page 35


 1176 08be 0858     	    ldr r0,[r1,r0]
 1177 08c0 4146     	    mov r1,T1 
 1178 08c2 00B5FFF7 	    _CALL strcpy 
 1178      FEFF5DF8 
 1178      04EB
 1179 08cc 4046     	    mov r0,T1 
 1180 08ce 00B5FFF7 	    _CALL strlen 
 1180      FEFF5DF8 
 1180      04EB
 1181 08d8 8044     	    add T1,r0 
 1182 08da D8E7     	    b decomp_loop
 1183 08dc 1328     	2:  cmp r0,#TK_CHAR 
 1184 08de 06D1     	    bne 3f 
 1185 08e0 4FF05C00 	    mov r0,#'\\'
 1186 08e4 08F8010B 	    strb r0,[T1],#1
 1187 08e8 08F8011B 	    strb r1,[T1],#1
 1188              	//    mov r0,#SPACE 
 1189              	//    strb r0,[T1],#1
 1190 08ec CFE7     	    b decomp_loop 
 1191 08ee 1428     	3:  cmp r0,#TK_VAR 
 1192 08f0 04D1     	    bne 4f 
 1193 08f2 01F14100 	    add r0,r1,'A'
 1194 08f6 08F8010B 	    strb r0,[T1],#1 
 1195 08fa C8E7     	    b decomp_loop 
 1196 08fc 1A28     	4:  cmp r0,#TK_LABEL 
 1197 08fe 2ED5     	    bpl 5f   
 1198 0900 03B4     	    push {r0,r1}
 1199              	//    mov r0,#SPACE 
 1200              	//    strb r0,[T1],#1  
 1201 0902 0846     	    mov r0,r1 
 1202 0904 00B5FFF7 	    _CALL cmd_name
 1202      8DFF5DF8 
 1202      04EB
 1203 090e 4146     	    mov r1,T1 
 1204 0910 00B5FFF7 	    _CALL strcpy 
 1204      FEFF5DF8 
 1204      04EB
 1205 091a 4046     	    mov r0,T1 
 1206 091c 00B5FFF7 	    _CALL strlen 
 1206      FEFF5DF8 
 1206      04EB
 1207 0926 8044     	    add T1,r0
 1208 0928 03BC     	    pop {r0,r1}
 1209 092a 1528     	    cmp r0,#TK_IFUNC
 1210 092c 03D0     	    beq 4f
 1211 092e 4FF02000 	    mov r0,#SPACE 
 1212 0932 08F8010B 	    strb r0,[T1],#1 
 1213 0936 3A29     	4:  cmp r1,#REM_IDX
 1214 0938 A9D1     	    bne decomp_loop 
 1215 093a 0BEB0A00 	    add r0,BPTR,IN
 1216 093e 4146     	    mov r1,T1   
 1217 0940 00B5FFF7 	    _CALL strcpy
 1217      FEFF5DF8 
 1217      04EB
 1218 094a 4046     	    mov r0,T1 
 1219 094c 00B5FFF7 	    _CALL strlen
 1219      FEFF5DF8 
ARM GAS  tinyBasic.s 			page 36


 1219      04EB
 1220 0956 8044     	    add T1,r0
 1221 0958 D4F804A0 	    ldr IN,[UPP,#COUNT]
 1222 095c 43E0     	    b 9f 
 1223 095e 1B28     	5:  cmp r0,#TK_INTGR
 1224 0960 14D1     	    bne 6f  
 1225 0962 0846     	    mov r0,r1 
 1226 0964 A169     	    ldr r1,[UPP,#BASE]
 1227 0966 00B5FFF7 	    _CALL itoa
 1227      FEFF5DF8 
 1227      04EB
 1228 0970 4146     	    mov r1,T1 
 1229 0972 00B5FFF7 	    _CALL strcpy
 1229      FEFF5DF8 
 1229      04EB
 1230 097c 4046     	    mov r0,T1 
 1231 097e 00B5FFF7 	    _CALL strlen
 1231      FEFF5DF8 
 1231      04EB
 1232 0988 8044     	    add T1,r0 
 1233 098a 80E7     	    b decomp_loop 
 1234 098c 1A28     	6:  cmp r0,#TK_LABEL
 1235 098e 13D1     	    bne 7f
 1236 0990 4FF01902 	    mov r2,#25
 1237 0994 4FF6FF73 	    mov r3,#0xffff 
 1238 0998 C3F6FF73 	    movt r3,#0x3fff 
 1239 099c 01EA0301 	0:  and r1,r3 
 1240 09a0 4FEA5313 	    lsr r3,#5 
 1241 09a4 31FA02F0 	    lsrs r0,r1,r2 
 1242 09a8 03D0     	    beq 2f
 1243 09aa 00F14000 	    add r0,#'@'
 1244 09ae 08F8010B 	    strb r0,[T1],#1
 1245 09b2 053A     	2:  subs r2,#5 
 1246 09b4 F2DA     	    bge 0b 
 1247 09b6 6AE7     	    b decomp_loop
 1248 09b8 4FF02200 	7:  mov r0,#'"'
 1249 09bc 08F8010B 	    strb r0,[T1],#1 
 1250 09c0 0846     	    mov r0,r1
 1251 09c2 4146     	    mov r1,T1  
 1252 09c4 00B5FFF7 	    _CALL strcpy
 1252      FEFF5DF8 
 1252      04EB
 1253 09ce 4046     	    mov r0,T1 
 1254 09d0 00B5FFF7 	    _CALL strlen 
 1254      FEFF5DF8 
 1254      04EB
 1255 09da 8044     	    add T1,r0 
 1256 09dc 4FF02200 	    mov r0,#'"'
 1257 09e0 08F8010B 	    strb r0,[T1],#1 
 1258 09e4 53E7     	    b decomp_loop
 1259 09e6 80EA0000 	9:  eor r0,r0 
 1260 09ea 88F80000 	    strb r0,[T1]
 1261 09ee BDE80E01 	    pop {r1,r2,r3,T1}
 1262 09f2 0846     	    mov r0,r1 
 1263 09f4 7047     	    _RET 
 1264              	
 1265 09f6 020A0000 	relop_str: .word ge_str,le_str,ne_str 
ARM GAS  tinyBasic.s 			page 37


 1265      050A0000 
 1265      080A0000 
 1266 0a02 3E3D00   	ge_str: .asciz ">="
 1267 0a05 3C3D00   	le_str: .asciz "<="
 1268 0a08 3C3E00   	ne_str: .asciz "<>"
 1269              	
 1270              	single_char:
 1271 0a0b 003A2C3B 	  .byte 0, ':', ',', ';', '#', '(', ')', '+' , '-', '*', '/', '%'
 1271      2328292B 
 1271      2D2A2F25 
 1272 0a17 403D3E3C 	  .byte '@','=', '>', '<' 
 1273              	
 1274              	
 1275              	
 1276              	
 1277              	/**********************************
 1278              	  modulo 
 1279              	  compute r0 mod r1
 1280              	  input:
 1281              	    r0   dividend
 1282              	    r1   divisor 
 1283              	  output:
 1284              	    r0   TK_INTGR 
 1285              	    r1   r0 mod r1 
 1286              	*********************************/
 1287 0a1b 00       	    _GBL_FUNC modulo 
 1288 0a1c 01B4     	    push {r0}
 1289 0a1e B0FBF1F0 	    udiv r0,r1 
 1290 0a22 01FB00F0 	    mul  r0,r1 
 1291 0a26 02BC     	    pop {r1}
 1292 0a28 A1EB0001 	    sub r1,r0
 1293 0a2c 4FF01B00 	    mov r0,#TK_INTGR
 1294 0a30 7047     	    _RET 
 1295              	
 1296              	/**********************************
 1297              	      BASIC commands 
 1298              	**********************************/
 1299              	
 1300              	/*********************************
 1301              	    syntax_error 
 1302              	    display syntax error message and 
 1303              	    abort program 
 1304              	  input:
 1305              	    none  
 1306              	  output: 
 1307              	    none 
 1308              	  use:
 1309              	*********************************/
 1310 0a32 00BF     	    _FUNC syntax_error 
 1311 0a34 4FF00200 	    mov r0,#ERR_SYNTAX
 1312 0a38 00E0     	    b tb_error 
 1313              	
 1314              	/*********************************
 1315              	    tb_error 
 1316              	    display BASIC error and 
 1317              	    abort program. 
 1318              	  input:
ARM GAS  tinyBasic.s 			page 38


 1319              	    r0    error code   
 1320              	  output: 
 1321              	    none 
 1322              	  use:
 1323              	    r1    temp 
 1324              	*********************************/
 1325 0a3a 00BF     	    _FUNC tb_error 
 1326 0a3c 216C     	    ldr r1,[UPP,#FLAGS]
 1327 0a3e 11F0200F 	    tst r1,#FCOMP
 1328 0a42 43D1     	    bne compile_error
 1329              	rt_error:
 1330 0a44 5246     	    mov r2,IN 
 1331 0a46 01B4     	    push {r0}
 1332 0a48 DFF8A807 	    ldr r0,=rt_error_msg 
 1333 0a4c 00B5FFF7 	    _CALL uart_puts 
 1333      FEFF5DF8 
 1333      04EB
 1334 0a56 01BC     	    pop {r0}
 1335 0a58 DFF89C17 	    ldr r1,=err_msg  
 1336 0a5c 4FEA8000 	    lsl r0,#2 
 1337 0a60 0858     	    ldr r0,[r1,r0]
 1338 0a62 00B5FFF7 	    _CALL uart_puts
 1338      FEFF5DF8 
 1338      04EB
 1339              	// decompile and print faulty line      
 1340 0a6c 5846     	    mov r0,BPTR
 1341 0a6e 5246     	    mov r2,IN  
 1342 0a70 DFF80813 	    ldr r1,pad 
 1343 0a74 00B5FFF7 	    _CALL decompile_line
 1343      FEFF5DF8 
 1343      04EB
 1344 0a7e 00B5FFF7 	    _CALL uart_puts 
 1344      FEFF5DF8 
 1344      04EB
 1345 0a88 00B5FFF7 	    _CALL cr 
 1345      FEFF5DF8 
 1345      04EB
 1346              	// print error offset on line      
 1347 0a92 DFF86807 	    ldr r0,=token_at_msg 
 1348 0a96 00B5FFF7 	    _CALL uart_puts 
 1348      FEFF5DF8 
 1348      04EB
 1349 0aa0 1046     	    mov r0,r2 
 1350 0aa2 4FF01001 	    mov r1,#16 
 1351 0aa6 00B5FFF7 	    _CALL print_int
 1351      FEFF5DF8 
 1351      04EB
 1352 0ab0 00B5FFF7 	    _CALL cr
 1352      FEFF5DF8 
 1352      04EB
 1353              	// dump tokenize line 
 1354 0aba 5846     	    mov r0,BPTR
 1355 0abc 8278     	    ldrb r2,[r0,#2]
 1356 0abe 00B500F0 	    _CALL dump01 
 1356      E0F95DF8 
 1356      04EB
 1357 0ac8 FFF7FEBF 	    b warm_start 
ARM GAS  tinyBasic.s 			page 39


 1358              	compile_error:
 1359 0acc DFF82817 	    ldr r1,=err_msg 
 1360 0ad0 4FEA8000 	    lsl r0,#2 
 1361 0ad4 0858     	    ldr r0,[r1,r0]
 1362 0ad6 00B5FFF7 	    _CALL uart_puts
 1362      FEFF5DF8 
 1362      04EB
 1363 0ae0 A068     	    ldr r0,[UPP,#BASICPTR]
 1364 0ae2 00B5FFF7 	    _CALL uart_puts
 1364      FEFF5DF8 
 1364      04EB
 1365 0aec 00B5FFF7 	    _CALL cr
 1365      FEFF5DF8 
 1365      04EB
 1366 0af6 2068     	    ldr r0,[UPP,#IN_SAVED]
 1367 0af8 00B5FFF7 	    _CALL spaces 
 1367      FEFF5DF8 
 1367      04EB
 1368 0b02 4FF05E00 	    mov r0,#'^' 
 1369 0b06 00B5FFF7 	    _CALL uart_putc
 1369      FEFF5DF8 
 1369      04EB
 1370 0b10 00B5FFF7 	    _CALL cr
 1370      FEFF5DF8 
 1370      04EB
 1371 0b1a FFF7FEBF 	    b  warm_start  
 1372              	    
 1373 0b1e 0A52756E 	rt_error_msg: .asciz "\nRuntime error: "
 1373      74696D65 
 1373      20657272 
 1373      6F723A20 
 1373      00
 1374 0b2f 746F6B65 	token_at_msg: .asciz "token offset: "
 1374      6E206F66 
 1374      66736574 
 1374      3A2000
 1375              	
 1376              	
 1377              	err_msg:
 1378 0b3e 00000000 		.word 0,err_mem_full, err_syntax, err_math_ovf, err_div0,err_no_line    
 1378      00000000 
 1378      0D000000 
 1378      1B000000 
 1378      34000000 
 1379 0b56 59000000 		.word err_run_only,err_cmd_only,err_duplicate,err_not_file,err_bad_value
 1379      6F000000 
 1379      89000000 
 1379      9A000000 
 1379      AB000000 
 1380 0b6a B7000000 		.word err_no_access,err_no_data,err_no_prog,err_no_fspace,err_buf_full    
 1380      EA000000 
 1380      FA000000 
 1380      0E010000 
 1380      21010000 
 1381 0b7e 2E010000 	   .word err_cant_prog 
 1382              	
 1383              	    .section .rodata.tb_error 
ARM GAS  tinyBasic.s 			page 40


 1384              	
 1385 0000 4D656D6F 	err_mem_full: .asciz "Memory full\n" 
 1385      72792066 
 1385      756C6C0A 
 1385      00
 1386 000d 73796E74 	err_syntax: .asciz "syntax error\n" 
 1386      61782065 
 1386      72726F72 
 1386      0A00
 1387 001b 6D617468 	err_math_ovf: .asciz "math operation overflow\n"
 1387      206F7065 
 1387      72617469 
 1387      6F6E206F 
 1387      76657266 
 1388 0034 64697669 	err_div0: .asciz "division by 0\n" 
 1388      73696F6E 
 1388      20627920 
 1388      300A00
 1389 0043 696E7661 	err_no_line: .asciz "invalid line number.\n"
 1389      6C696420 
 1389      6C696E65 
 1389      206E756D 
 1389      6265722E 
 1390 0059 72756E20 	err_run_only: .asciz "run time only usage.\n" 
 1390      74696D65 
 1390      206F6E6C 
 1390      79207573 
 1390      6167652E 
 1391 006f 636F6D6D 	err_cmd_only: .asciz "command line only usage.\n"
 1391      616E6420 
 1391      6C696E65 
 1391      206F6E6C 
 1391      79207573 
 1392 0089 6475706C 	err_duplicate: .asciz "duplicate name.\n"
 1392      69636174 
 1392      65206E61 
 1392      6D652E0A 
 1392      00
 1393 009a 46696C65 	err_not_file: .asciz "File not found.\n"
 1393      206E6F74 
 1393      20666F75 
 1393      6E642E0A 
 1393      00
 1394 00ab 62616420 	err_bad_value: .asciz "bad value.\n"
 1394      76616C75 
 1394      652E0A00 
 1395 00b7 46696C65 	err_no_access: .asciz "File in extended memory, can't be run from there.\n" 
 1395      20696E20 
 1395      65787465 
 1395      6E646564 
 1395      206D656D 
 1396 00ea 4E6F2064 	err_no_data: .asciz "No data found.\n"
 1396      61746120 
 1396      666F756E 
 1396      642E0A00 
 1397 00fa 4E6F2070 	err_no_prog: .asciz "No program in RAM!\n"
 1397      726F6772 
ARM GAS  tinyBasic.s 			page 41


 1397      616D2069 
 1397      6E205241 
 1397      4D210A00 
 1398 010e 46696C65 	err_no_fspace: .asciz "File system full.\n" 
 1398      20737973 
 1398      74656D20 
 1398      66756C6C 
 1398      2E0A00
 1399 0121 42756666 	err_buf_full: .asciz "Buffer full\n"
 1399      65722066 
 1399      756C6C0A 
 1399      00
 1400 012e 43616E27 	err_cant_prog: .asciz "Can't modify program in STOP mode. Use END command before.\n" 
 1400      74206D6F 
 1400      64696679 
 1400      2070726F 
 1400      6772616D 
 1401              	
 1402 016a 0A72756E 	rt_msg: .asciz "\nrun time error, "
 1402      2074696D 
 1402      65206572 
 1402      726F722C 
 1402      2000
 1403 017c 0A636F6D 	comp_msg: .asciz "\ncompile error, "
 1403      70696C65 
 1403      20657272 
 1403      6F722C20 
 1403      00
 1404 018d 6C617374 	tk_id: .asciz "last token id: "
 1404      20746F6B 
 1404      656E2069 
 1404      643A2000 
 1405              	
 1406              	
 1407              	    .section  .text , "ax", %progbits 
 1408              	
 1409              	/*********************************
 1410              	   skip_line 
 1411              	   data and remark line are skipped
 1412              	   by the interpreter 
 1413              	***********************************/
 1414 0b82 00BF     	    _FUNC skip_line 
 1415 0b84 D4F804A0 	    ldr IN,[UPP,#COUNT]
 1416 0b88 7047     	    _RET 
 1417              	
 1418              	
 1419              	/*********************************
 1420              	   BASIC: BTGL adr, mask   
 1421              	   toggle bits [adr]=[adr]^mask  
 1422              	   input:
 1423              	     r0    adr 
 1424              	     r1    mask 
 1425              	    output;
 1426              	      none 
 1427              	    use:
 1428              	      T1   temp
 1429              	      T2   temp  
ARM GAS  tinyBasic.s 			page 42


 1430              	*******************************/     
 1431 0b8a 00BF     	    _FUNC BTGL 
 1432              	
 1433 0b8c 7047     	    _RET 
 1434              	
 1435              	/***************************************
 1436              	   kword_cmp
 1437              	   compare keyword to dict entry
 1438              	  input:
 1439              	    r0  keyword 
 1440              	    r1  dict entry 
 1441              	    r2  character count 
 1442              	  output:
 1443              	    r0  0 not same | -1 same 
 1444              	  use:
 1445              	    r6   result  
 1446              	    T1   char 1
 1447              	    T2   char 2
 1448              	**************************************/   
 1449 0b8e 00BF     	    _FUNC kword_cmp 
 1450 0b90 2DE94003 	    push {r6,T1,T2}
 1451 0b94 4FF0FF36 	    mov r6,#-1 
 1452 0b98 4AB1     	1:  cbz r2,9f       
 1453 0b9a 10F8018B 	    ldrb T1,[r0],#1
 1454 0b9e 11F8019B 	    ldrb T2,[r1],#1
 1455 0ba2 A2F10102 	    sub r2,#1
 1456 0ba6 C845     	    cmp T1,T2
 1457 0ba8 F6D0     	    beq 1b 
 1458 0baa 86EA0606 	    eor r6,r6  
 1459 0bae 3046     	9:  mov r0,r6
 1460 0bb0 BDE84003 	    pop {r6,T1,T2}
 1461 0bb4 7047     	    _RET 
 1462              	
 1463              	/***********************************************
 1464              	    search_dict 
 1465              	    search keyword in dictionary
 1466              	   input:
 1467              	  	 r0   keyword 
 1468              	     r1		dictionary first name field address  
 1469              	   output:
 1470              	     r0 		token attribute 
 1471              	     r1		  cmd_index if r0!=TK_NONE  
 1472              	   use:
 1473              	     r3   length keyword 
 1474              	     T1   keyword
 1475              	     T2   link  
 1476              	**********************************************/
 1477 0bb6 00BF     	  _FUNC search_dict
 1478 0bb8 2DE90C03 	  push {r2,r3,T1,T2}
 1479 0bbc 8046     	  mov T1,r0 
 1480 0bbe 00B5FFF7 	  _CALL strlen 
 1480      FEFF5DF8 
 1480      04EB
 1481 0bc8 0346     	  mov r3,r0  
 1482              	1:  
 1483 0bca 8946     	   mov T2,r1  // keep for linking   
 1484 0bcc 0878     	   ldrb r0,[r1] 
ARM GAS  tinyBasic.s 			page 43


 1485 0bce 78B1     	   cbz r0,9f // null byte, end of dictionary
 1486 0bd0 4046     	   mov r0,T1
 1487 0bd2 1A46     	   mov r2,r3   
 1488 0bd4 00B5FFF7 	   _CALL kword_cmp  
 1488      DBFF5DF8 
 1488      04EB
 1489 0bde 18B9     	   cbnz r0,2f 
 1490 0be0 4946     	   mov r1,T2
 1491 0be2 51F80C1C 	   ldr r1,[r1,#-12]
 1492 0be6 F0E7     	   b 1b   
 1493              	2: // found
 1494 0be8 59F8040C 	   ldr r0,[T2,#-4] // token attribute 
 1495 0bec 59F8081C 	   ldr r1,[T2,#-8]  // command index 
 1496 0bf0 BDE80C03 	9: pop {r2,r3,T1,T2}
 1497 0bf4 7047     	   _RET 
 1498              	
 1499              	
 1500              	/**************************
 1501              	    INTERPRETER 
 1502              	*************************/
 1503              	
 1504              	/*********************************
 1505              	   cold_start 
 1506              	   initialize BASIC interpreter 
 1507              	   never leave 
 1508              	   input:
 1509              	     none 
 1510              	   output:
 1511              	    none 
 1512              	*********************************/
 1513              	  .type cold_start, %function 
 1514              	  .global cold_start 
 1515              	cold_start: 
 1516 0bf6 4FF00004 	    _MOV32 UPP,RAM_ADR 
 1516      C2F20004 
 1517 0bfe DFF85400 	    ldr r0,src_addr 
 1518 0c02 DFF85410 	    ldr r1,dest_addr
 1519 0c06 0968     	    ldr r1,[r1] 
 1520 0c08 0C44     	    add UPP,r1 // system variables base address   
 1521              	// clear RAM
 1522 0c0a 2046     	    mov r0,UPP  
 1523 0c0c DFF86811 	    ldr r1,tib 
 1524 0c10 82EA0202 	    eor r2,r2 
 1525 0c14 40F8042B 	1:  str r2,[r0],#4 
 1526 0c18 8842     	    cmp r0,r1 
 1527 0c1a FBD4     	    bmi 1b 
 1528              	//copy initialized system variables to ram 
 1529 0c1c DFF83400 	    ldr r0,src_addr 
 1530 0c20 2146     	    mov r1,UPP 
 1531 0c22 DFF83820 	    ldr r2,sysvar_size
 1532 0c26 00B5FFF7 	    _CALL cmove
 1532      FEFF5DF8 
 1532      04EB
 1533 0c30 00B500F0 	    _CALL prt_version
 1533      15F85DF8 
 1533      04EB
 1534 0c3a 00B500F0 	    _CALL clear_basic 
ARM GAS  tinyBasic.s 			page 44


 1534      62F85DF8 
 1534      04EB
 1535 0c44 00B5FFF7 	    _CALL search_free 
 1535      FEFF5DF8 
 1535      04EB
 1536 0c4e E062     	    str r0,[UPP,#FSFREE] 
 1537 0c50 FFF7FEBF 	    b warm_start    
 1538              	src_addr:
 1539 0c54 00000000 	  .word uzero
 1540              	dest_addr:
 1541 0c58 00000000 	  .word vectors_size
 1542 0c5c D4000000 	sysvar_size: .word ulast-uzero 
 1543              	
 1544              	/************************************
 1545              	    print firmware version 
 1546              	    input: 
 1547              	      none 
 1548              	    output:
 1549              	      none 
 1550              	    use:
 1551              	      r0 
 1552              	***********************************/
 1553              	    _FUNC prt_version 
 1554 0c60 DFF89C05 	    ldr r0,=version_msg 
 1555 0c64 00B5FFF7 	    _CALL uart_puts
 1555      FEFF5DF8 
 1555      04EB
 1556 0c6e 9FF87400 	    ldrb r0,version 
 1557 0c72 4FEA1010 	    lsr r0,#4 
 1558 0c76 00F13000 	    add r0,#'0' 
 1559 0c7a 3A28     	    cmp r0,#'9'+1 
 1560 0c7c 01D4     	    bmi 1f 
 1561 0c7e 00F10700 	    add r0,#7 
 1562              	  1:
 1563 0c82 00B5FFF7 	    _CALL uart_putc 
 1563      FEFF5DF8 
 1563      04EB
 1564 0c8c 4FF02E00 	    mov r0,#'. 
 1565 0c90 00B5FFF7 	    _CALL uart_putc 
 1565      FEFF5DF8 
 1565      04EB
 1566 0c9a 9FF84800 	    ldrb r0,version 
 1567 0c9e 00F00F00 	    and r0,#15 
 1568 0ca2 00F13000 	    add r0,'0' 
 1569 0ca6 3A28     	    cmp r0,#'9'+1 
 1570 0ca8 01D4     	    bmi 1f 
 1571 0caa 00F10700 	    add r0,#7
 1572              	  1: 
 1573 0cae 00B5FFF7 	    _CALL uart_putc 
 1573      FEFF5DF8 
 1573      04EB
 1574 0cb8 00B5FFF7 	    _CALL cr
 1574      FEFF5DF8 
 1574      04EB
 1575 0cc2 7047     	    _RET  
 1576              	version_msg:
 1577 0cc4 0A626C75 	    .asciz "\nblue pill tiny BASIC, version "
ARM GAS  tinyBasic.s 			page 45


 1577      65207069 
 1577      6C6C2074 
 1577      696E7920 
 1577      42415349 
 1578              	version:
 1579 0ce4 10       	    .byte 0x10 
 1580 0ce5 0000BF   	    .p2align 2 
 1581              	
 1582              	
 1583              	/*****************************
 1584              	    clear_vars 
 1585              	    initialize variables to 0
 1586              	  input:
 1587              	    none 
 1588              	  output:
 1589              	    none 
 1590              	  use:
 1591              	    r0,r1,r2 
 1592              	*****************************/
 1593              	    _FUNC clear_vars 
 1594 0ce8 07B4     	    push {r0,r1,r2}
 1595 0cea 80EA0000 	    eor r0,r0 
 1596 0cee 04F16001 	    add r1,UPP,#VARS
 1597 0cf2 4FF01A02 	    mov r2,#26
 1598 0cf6 41F8040B 	1:  str r0,[r1],#4 
 1599 0cfa 013A     	    subs r2,#1
 1600 0cfc FBD1     	    bne 1b  
 1601 0cfe 07BC     	    pop {r0,r1,r2}
 1602 0d00 7047     	    _RET 
 1603              	
 1604              	/*****************************
 1605              	   clear_basic 
 1606              	   reset BASIC system variables 
 1607              	   and clear variables and RAM 
 1608              	*****************************/
 1609 0d02 00BF     	    _FUNC clear_basic
 1610 0d04 80EA0000 	  	eor r0,r0
 1611 0d08 2064     	    str r0,[UPP,#FLAGS] 
 1612 0d0a 6060     	    str r0,[UPP,#COUNT]
 1613 0d0c 2060     	    str r0,[UPP,#IN_SAVED]
 1614 0d0e A060     	    str r0,[UPP,#BASICPTR]
 1615 0d10 E060     	    str r0,[UPP,#DATAPTR]
 1616 0d12 2061     	    str r0,[UPP,#DATA]
 1617 0d14 6061     	    str r0,[UPP,#DATALEN]
 1618 0d16 04F1D000 	    add r0,UPP,#BASIC_START 
 1619 0d1a 00F11000 	    add r0,#16 
 1620 0d1e 6FF00F01 	    mvn r1,#15
 1621 0d22 00EA0100 	    and r0,r1 
 1622 0d26 2063     	    str r0,[UPP,#TXTBGN]
 1623 0d28 6063     	    str r0,[UPP,#TXTEND]
 1624 0d2a C4F8D000 	    str r0,[UPP,#HERE]
 1625 0d2e 00B5FFF7 	    _CALL clear_vars
 1625      DAFF5DF8 
 1625      04EB
 1626 0d38 206B     	    ldr r0,[UPP,#TXTBGN]
 1627 0d3a DFF83C10 	    ldr r1,tib 
 1628 0d3e 82EA0202 	    eor r2,r2 
ARM GAS  tinyBasic.s 			page 46


 1629 0d42 40F8042B 	1:  str r2,[r0],#4
 1630 0d46 8842     	    cmp r0,r1 
 1631 0d48 FBD4     	    bmi 1b 
 1632 0d4a 7047     	    _RET  
 1633              	
 1634              	/***********************************
 1635              	   warm_init 
 1636              	   initialize interpreter context 
 1637              	  input:
 1638              	    none
 1639              	  output:
 1640              	    none 
 1641              	  use:
 1642              	    r0 
 1643              	***********************************/
 1644              	warm_init:
 1645              	// reset data stack       
 1646 0d4c DFF824C0 	    ldr DP,dstack 
 1647 0d50 4FF0000A 	    mov IN,#0 // BASIC line index 
 1648 0d54 4FF0000B 	    mov BPTR,#0 // BASIC line address 
 1649 0d58 80EA0000 	    eor r0,r0 
 1650 0d5c 6060     	    str r0,[UPP,#COUNT]  
 1651 0d5e 2064     	    str r0,[UPP,#FLAGS]
 1652 0d60 A063     	    str r0,[UPP,#LOOP_DEPTH] 
 1653 0d62 4FF00400 	    mov r0, #DEFAULT_TAB_WIDTH
 1654 0d66 6064     	    str r0,[UPP,#TAB_WIDTH]
 1655 0d68 4FF00A00 	    mov r0,#10 // default base decimal 
 1656 0d6c A061     	    str r0,[UPP,#BASE]
 1657 0d6e 7047     	    _RET  
 1658              	
 1659 0d70 00000000 	mstack: .word _mstack 
 1660 0d74 00000000 	dstack: .word _dstack 
 1661 0d78 00000000 	tib: .word _tib 
 1662 0d7c 00000000 	pad: .word _pad 
 1663 0d80 FCFFFFFF 	array: .word _pad - 4 
 1664 0d84 0A524541 	ready: .asciz "\nREADY" 
 1664      445900
 1665              	
 1666              	/**********************************
 1667              	    warm_start 
 1668              	    start BASIC interpreter doesn't  
 1669              	    reset variables and code space 
 1670              	  input:
 1671              	    none 
 1672              	  output:
 1673              	    none 
 1674              	**********************************/
 1675 0d8b 00       	    _GBL_FUNC warm_start 
 1676              	// initialise parameters stack
 1677 0d8c FFF7DEFF 	    bl warm_init
 1678              	// reset main stack 
 1679 0d90 5FF82400 	    ldr r0,mstack
 1680 0d94 8546     	    mov sp,r0 
 1681 0d96 DFF86C04 	    ldr r0,=ready 
 1682 0d9a 00B5FFF7 	    _CALL uart_puts 
 1682      FEFF5DF8 
 1682      04EB
ARM GAS  tinyBasic.s 			page 47


 1683              	// fall in cmd_line 
 1684              	
 1685              	/**********************************
 1686              	   cmd_line 
 1687              	   shell command line 
 1688              	   input:
 1689              	      none 
 1690              	   output:
 1691              	      none 
 1692              	   use:
 1693              	
 1694              	***********************************/
 1695              	    _FUNC cmd_line 
 1696 0da4 00B5FFF7 	    _CALL cr
 1696      FEFF5DF8 
 1696      04EB
 1697 0dae 80EA0000 	    eor r0,r0 
 1698 0db2 C4F8CC00 	    str r0,[UPP,#TRACE_LEVEL] 
 1699 0db6 5FF84000 	1:  ldr r0,tib
 1700 0dba 4FF05001 	    mov r1,#TIB_SIZE 
 1701 0dbe 00B5FFF7 	    _CALL readln 
 1701      FEFF5DF8 
 1701      04EB
 1702 0dc8 0940     	    ands r1,r1 // empty line 
 1703 0dca F4D0     	    beq 1b 
 1704 0dcc 00B5FFF7 	    _CALL compile // tokenize BASIC text
 1704      F1FA5DF8 
 1704      04EB
 1705 0dd6 EED0     	    beq 1b  // tokens stored in text area 
 1706              	// interpret tokenized line 
 1707              	interpreter:
 1708 0dd8 00B500F0 	  _CALL next_token 
 1708      21F85DF8 
 1708      04EB
 1709 0de2 0228     	  cmp r0,#2
 1710 0de4 F8D4     	  bmi interpreter    
 1711 0de6 1A28     	  cmp r0,#TK_LABEL 
 1712 0de8 F6D0     	  beq interpreter 
 1713 0dea 1728     	  cmp r0,#TK_CMD 
 1714 0dec 03D1     	  bne 2f
 1715 0dee 0846     	  mov r0,r1 
 1716 0df0 00F012F8 	  bl execute  
 1717 0df4 F0E7     	  b interpreter   
 1718              	2: 
 1719 0df6 1428     	  cmp r0,#TK_VAR 
 1720 0df8 05D1     	  bne 3f 
 1721 0dfa 00B500F0 	  _CALL let_var 
 1721      7FFB5DF8 
 1721      04EB
 1722 0e04 E8E7     	  b interpreter 
 1723              	3: 
 1724 0e06 0C28     	  cmp r0,#TK_ARRAY 
 1725 0e08 05D1     	  bne 4f
 1726 0e0a 00B500F0 	  _CALL let_array 
 1726      85FB5DF8 
 1726      04EB
 1727 0e14 E0E7     	  b interpreter
ARM GAS  tinyBasic.s 			page 48


 1728              	4: 
 1729 0e16 0DE6     	  b syntax_error
 1730              	
 1731              	/*****************************
 1732              	    execute 
 1733              	    execute a BASIC routine from 
 1734              	    its token value 
 1735              	  input:
 1736              	    r0  BASIC SUB|FUNC token  
 1737              	  output: 
 1738              	    depend on SUB|FUNc
 1739              	*****************************/
 1740              	    _FUNC execute 
 1741 0e18 FB49     	    ldr r1,=fn_table 
 1742 0e1a 51F82000 	    ldr r0,[r1,r0,lsl #2]
 1743 0e1e 0047     	    bx r0 
 1744              	
 1745              	/*************************************
 1746              	  next_token 
 1747              	  extract next token from token list 
 1748              	  input:
 1749              	    none 
 1750              	  output:
 1751              	    r0    token attribute
 1752              	    r1    token value if there is one 
 1753              	  use:
 1754              	    T1    exit token type  
 1755              	****************************/
 1756              	    _FUNC next_token 
 1757 0e20 4DF8048D 	    push {T1}
 1758 0e24 88EA0808 	    eor T1,T1 // TK_NONE 
 1759 0e28 6068     	    ldr r0,[UPP,#COUNT]
 1760 0e2a 8245     	    cmp IN,r0 
 1761 0e2c 14D4     	    bmi 0f
 1762              	end_of_line:
 1763 0e2e BBF80010 	    ldrh r1,[BPTR] // line #
 1764 0e32 09B9     	    cbnz r1, next_line  // command line
 1765 0e34 FFF7FEBF 	    b warm_start
 1766              	next_line:
 1767 0e38 8344     	    add BPTR,r0 // next line 
 1768 0e3a 606B     	    ldr r0,[UPP,#TXTEND]
 1769 0e3c 8345     	    cmp BPTR,r0 
 1770 0e3e 7FF5FEAF 	    bpl warm_start // end of program
 1771 0e42 9BF80200 	    ldrb r0,[BPTR,#2] // line length 
 1772 0e46 6060     	    str r0,[UPP,#COUNT] 
 1773 0e48 4FF0030A 	    mov IN,#3
 1774 0e4c 00B5FFF7 	    _CALL show_trace
 1774      CDF95DF8 
 1774      04EB
 1775 0e56 24E0     	    b 9f  
 1776              	0: 
 1777 0e58 C4F800A0 	    str IN,[UPP,#IN_SAVED]
 1778 0e5c C4F808B0 	    str BPTR,[UPP,#BASICPTR]
 1779 0e60 1BF80A00 	    ldrb r0,[BPTR,IN] // token id 
 1780 0e64 0AF1010A 	    add IN,#1  
 1781 0e68 8046     	    mov T1,r0 // save token id 
 1782 0e6a 1328     	    cmp r0,#TK_CHAR 
ARM GAS  tinyBasic.s 			page 49


 1783 0e6c 19D4     	    bmi 9f // these tokens have no value  
 1784 0e6e 1828     	    cmp r0,#TK_SCONST 
 1785 0e70 04D5     	    bpl 1f
 1786              	    // tokens with .byte value 
 1787 0e72 1BF80A10 	    ldrb r1,[BPTR,IN] 
 1788 0e76 0AF1010A 	    add IN,#1 
 1789 0e7a 12E0     	    b 9f  
 1790 0e7c 1C28     	1:  cmp r0,#TK_QSTR 
 1791 0e7e 0BD1     	    bne 2f 
 1792 0e80 0BEB0A01 	    add r1,BPTR,IN
 1793 0e84 0846     	    mov r0,r1 
 1794 0e86 00B5FFF7 	    _CALL strlen 
 1794      FEFF5DF8 
 1794      04EB
 1795 0e90 8244     	    add IN,r0 
 1796 0e92 0AF1010A 	    add IN,#1 
 1797 0e96 04E0     	    b 9f 
 1798              	2:  // .word value 
 1799 0e98 5BF80A10 	    ldr r1,[BPTR,IN] 
 1800 0e9c 0AF1040A 	    add IN,#4 
 1801 0ea0 FFE7     	    b 9f 
 1802 0ea2 4046     	9:  mov r0,T1  
 1803 0ea4 5DF8048B 	    pop {T1}
 1804 0ea8 7047     	    _RET
 1805              	
 1806              	
 1807              	/*********************************
 1808              	    expect 
 1809              	    check if next token is of 
 1810              	    expected type. If not 
 1811              	    call syntax_error  
 1812              	  input:
 1813              	      r0   token attribute
 1814              	  output:
 1815              	      r0  token attribute 
 1816              	      r1  token value
 1817              	  use:
 1818              	      T1   
 1819              	**********************************/
 1820 0eaa 00BF     	    _FUNC expect 
 1821 0eac 4DF8048D 	    push {T1}
 1822 0eb0 8046     	    mov T1,r0 
 1823 0eb2 00B5FFF7 	    _CALL next_token 
 1823      B4FF5DF8 
 1823      04EB
 1824 0ebc 4045     	    cmp r0,T1  
 1825 0ebe 7FF4B9AD 	    bne syntax_error 
 1826 0ec2 5DF8048B 	    pop {T1}
 1827 0ec6 7047     	    _RET 
 1828              	
 1829              	/***********************************
 1830              	    func_args 
 1831              	    get function arguments list 
 1832              	  input:
 1833              	    none 
 1834              	  output:
 1835              	    r0    arg. count 
ARM GAS  tinyBasic.s 			page 50


 1836              	  use:
 1837              	
 1838              	************************************/
 1839              	    _FUNC func_args 
 1840 0ec8 4FF00500 	    mov r0,#TK_LPAREN 
 1841 0ecc 00B5FFF7 	    _CALL expect 
 1841      EDFF5DF8 
 1841      04EB
 1842 0ed6 00B500F0 	    _CALL arg_list 
 1842      0CF85DF8 
 1842      04EB
 1843 0ee0 01B4     	    push {r0}
 1844 0ee2 4FF00600 	    mov r0,#TK_RPAREN 
 1845 0ee6 00B5FFF7 	    _CALL expect 
 1845      E0FF5DF8 
 1845      04EB
 1846 0ef0 01BC     	    pop {r0}
 1847 0ef2 7047     	    _RET 
 1848              	
 1849              	/**********************************
 1850              	    arg_list 
 1851              	    get arguments list on dstack 
 1852              	  input:
 1853              	    none 
 1854              	  output:
 1855              	    r0    arg count
 1856              	  use:
 1857              	    T1    tmp count  
 1858              	***********************************/
 1859              	    _FUNC arg_list 
 1860 0ef4 4DF8048D 	    push {T1}
 1861 0ef8 88EA0808 	    eor T1,T1 
 1862 0efc 00B500F0 	1:  _CALL expression 
 1862      D3F85DF8 
 1862      04EB
 1863 0f06 0028     	    cmp R0,#TK_NONE 
 1864 0f08 10D0     	    beq 9f 
 1865 0f0a 1B28     	    cmp r0,#TK_INTGR
 1866 0f0c 0ED1     	    bne 9f 
 1867 0f0e 4CF8041D 	    _PUSH r1 
 1868 0f12 08F10108 	    add T1,#1 
 1869 0f16 00B5FFF7 	    _CALL next_token 
 1869      82FF5DF8 
 1869      04EB
 1870 0f20 0228     	    cmp r0,#TK_COMMA 
 1871 0f22 EBD0     	    beq 1b 
 1872 0f24 D4F800A0 	    _UNGET_TOKEN 
 1872      D4F808B0 
 1873 0f2c 4046     	9:  mov r0,T1 
 1874 0f2e 5DF8048B 	    pop {T1}
 1875 0f32 7047     	    _RET 
 1876              	
 1877              	/***********************************
 1878              	 factor
 1879              	 arithmetick factor parser 
 1880              	 factor ::= ['+'|'-'|e]  var | @ |
 1881              				 integer | function |
ARM GAS  tinyBasic.s 			page 51


 1882              				 '('expression')' 
 1883              	  input: 
 1884              	    none 
 1885              	  output:
 1886              	    r0   token attribute 
 1887              	    r1   token value 
 1888              	  use:
 1889              	    r2   temp 
 1890              	    T1   sign 
 1891              	    T2   exit token attribute 
 1892              	***********************************/
 1893              	    _FUNC factor 
 1894 0f34 2DE90403 	    push {r2,T1,T2}
 1895 0f38 4FF01B09 	    mov T2,#TK_INTGR 
 1896 0f3c 4FF00108 	    mov T1,#1 // default sign +  
 1897 0f40 00B5FFF7 	    _CALL next_token
 1897      6DFF5DF8 
 1897      04EB
 1898 0f4a 0728     	    cmp r0,#TK_PLUS 
 1899 0f4c 03D0     	    beq 0f 
 1900 0f4e 0828     	    cmp r0,#TK_MINUS  
 1901 0f50 06D1     	    bne 1f 
 1902 0f52 4FF0FF38 	    mov T1,#-1 // minus sign 
 1903 0f56 00B5FFF7 	0:  _CALL next_token
 1903      62FF5DF8 
 1903      04EB
 1904 0f60 1B28     	1:  cmp r0,#TK_INTGR 
 1905 0f62 5ED0     	    beq 8f 
 1906 0f64 0C28     	    cmp r0,#TK_ARRAY 
 1907 0f66 1ED1     	    bne 2f 
 1908 0f68 4FF00500 	    mov r0,#TK_LPAREN 
 1909 0f6c 00B5FFF7 	    _CALL expect 
 1909      9DFF5DF8 
 1909      04EB
 1910 0f76 00B500F0 	    _CALL expression
 1910      96F85DF8 
 1910      04EB
 1911 0f80 1B28     	    cmp r0,#TK_INTGR
 1912 0f82 7FF457AD 	    bne syntax_error
 1913 0f86 8146     	    mov T2,r0
 1914 0f88 0A46     	    mov r2,r1  
 1915 0f8a 4FF00600 	    mov r0,#TK_RPAREN
 1916 0f8e 00B5FFF7 	    _CALL expect 
 1916      8CFF5DF8 
 1916      04EB
 1917 0f98 1046     	    mov r0,r2 
 1918 0f9a 00B500F0 	    _CALL get_array_element 
 1918      F8F85DF8 
 1918      04EB
 1919 0fa4 3DE0     	    b 8f
 1920 0fa6 0528     	2:  cmp r0,#TK_LPAREN 
 1921 0fa8 12D1     	    bne 3f 
 1922 0faa 00B500F0 	    _CALL expression 
 1922      7CF85DF8 
 1922      04EB
 1923 0fb4 1B28     	    cmp r0,#TK_INTGR 
 1924 0fb6 7FF43DAD 	    bne syntax_error
ARM GAS  tinyBasic.s 			page 52


 1925 0fba 8146     	    mov T2,r0
 1926 0fbc 0A46     	    mov r2,r1   
 1927 0fbe 4FF00600 	    mov r0,#TK_RPAREN
 1928 0fc2 00B5FFF7 	    _CALL expect 
 1928      72FF5DF8 
 1928      04EB
 1929 0fcc 1146     	    mov r1,r2 
 1930 0fce 28E0     	    b 8f       
 1931 0fd0 1428     	3:  cmp r0,#TK_VAR 
 1932 0fd2 06D1     	    bne 4f
 1933 0fd4 0846     	    mov r0,r1  
 1934 0fd6 00B500F0 	    _CALL get_var 
 1934      EEF85DF8 
 1934      04EB
 1935 0fe0 1FE0     	    b 8f 
 1936 0fe2 1528     	4:  cmp r0,#TK_IFUNC 
 1937 0fe4 06D1     	    bne 6f 
 1938 0fe6 0846     	5:  mov r0,r1  
 1939 0fe8 00B5FFF7 	    _CALL execute
 1939      15FF5DF8 
 1939      04EB
 1940 0ff2 16E0     	    b 8f 
 1941 0ff4 1A28     	6:  cmp r0,#TK_LABEL
 1942 0ff6 08D1     	    bne 7f 
 1943 0ff8 41F00040 	    orr r0,r1,#(1<<31) 
 1944 0ffc 00B5FFF7 	    _CALL search_const
 1944      4BF95DF8 
 1944      04EB
 1945 1006 0146     	    mov r1,r0 
 1946 1008 0BE0     	    b 8f 
 1947 100a 1828     	7:  cmp r0,#TK_SCONST 
 1948 100c 02D1     	    bne 7f 
 1949 100e 4FF01B00 	    mov r0,#TK_INTGR
 1950 1012 06E0     	    b 8f 
 1951 1014 D4F800A0 	7: _UNGET_TOKEN      
 1951      D4F808B0 
 1952 101c 4FF00000 	    mov r0,#TK_NONE
 1953 1020 03E0     	    b 9f  
 1954 1022 08FB01F1 	8:  mul r1,T1 
 1955 1026 5FEA0900 	    movs r0,T2 
 1956 102a BDE80403 	9:  pop {r2,T1,T2}   
 1957 102e 7047     	    _RET 
 1958              	
 1959              	
 1960              	/*****************************************
 1961              	    term 
 1962              	    term parser 
 1963              	    term ::= factor [['*'|'/'|'%'] factor]* 
 1964              	    output:
 1965              	      r0  	token attribute 
 1966              	      r1		integer
 1967              	    use:
 1968              	      r2    first operand 
 1969              	      r3    temp 
 1970              	      T1    operator 
 1971              	      T2    exit token attribute 
 1972              	******************************************/
ARM GAS  tinyBasic.s 			page 53


 1973              	     _FUNC term 
 1974 1030 2DE90C03 	    push {r2,r3,T1,T2}
 1975 1034 4FF00009 	    mov T2,#TK_NONE 
 1976 1038 00B5FFF7 	    _CALL factor
 1976      7BFF5DF8 
 1976      04EB
 1977 1042 58B3     	    cbz r0, 9f  // no factor   
 1978 1044 8146     	    mov T2,r0  // TK_INTGR 
 1979 1046 0A46     	    mov r2,r1 // first factor    
 1980 1048 00B5FFF7 	0:  _CALL next_token
 1980      E9FE5DF8 
 1980      04EB
 1981 1052 8046     	    mov T1,r0  // operator 
 1982 1054 0928     	    cmp r0,TK_MULT
 1983 1056 01D4     	    bmi 1f 
 1984 1058 0C28     	    cmp r0,#TK_MOD+1
 1985 105a 04D4     	    bmi 2f
 1986 105c D4F800A0 	1:  _UNGET_TOKEN
 1986      D4F808B0 
 1987 1064 1AE0     	    b 9f 
 1988 1066 00B5FFF7 	2:  _CALL factor  
 1988      64FF5DF8 
 1988      04EB
 1989 1070 3FF4E0AC 	    beq syntax_error 
 1990 1074 B8F1090F 	    cmp T1,#TK_MULT
 1991 1078 02D1     	    bne 3f 
 1992              	// multiplication
 1993 107a 01FB02F2 	    mul r2,r1
 1994 107e E3E7     	    b 0b  
 1995 1080 B8F10A0F 	3:  cmp T1,#TK_DIV 
 1996 1084 02D1     	    bne 4f
 1997              	// division
 1998 1086 92FBF1F2 	    sdiv r2,r2,r1
 1999 108a DDE7     	    b 0b  
 2000              	4: // modulo
 2001 108c 1046     	    mov r0,r2 
 2002 108e 92FBF1F2 	    sdiv r2,r2,r1 
 2003 1092 01FB02F2 	    mul  r2,r1 
 2004 1096 A0EB0202 	    sub  r2,r0,r2
 2005 109a D5E7     	    b 0b  
 2006 109c 1146     	9:  mov r1,r2 
 2007 109e 5FEA0900 	    movs r0,T2 
 2008 10a2 BDE80C03 	    pop {r2,r3,T1,T2}
 2009 10a6 7047     	    _RET 
 2010              	
 2011              	/*****************************************
 2012              	    expression 
 2013              	    arithmetic expression parser 
 2014              	    expression ::= term [['+'|'-'] term]*
 2015              	    result range {-32768..32767}
 2016              	    output:
 2017              	      r0    TK_NONE || TK_INTGR 
 2018              	      r1 	  integer
 2019              	    use:
 2020              	      r2  left operand 
 2021              	      T1  operator 
 2022              	      T2  exit token attribute
ARM GAS  tinyBasic.s 			page 54


 2023              	******************************************/
 2024              	    _FUNC expression 
 2025 10a8 2DE90403 	    push {r2,t1,t2}
 2026 10ac 4FF00009 	    mov T2,#TK_NONE
 2027 10b0 82EA0202 	    eor r2,r2 // zero 
 2028 10b4 00B5FFF7 	    _CALL term 
 2028      BBFF5DF8 
 2028      04EB
 2029 10be 21D0     	    beq 9f  // no term  
 2030 10c0 0A46     	    mov r2,r1 // first term
 2031 10c2 4FF01B09 	    mov T2,#TK_INTGR    
 2032 10c6 00B5FFF7 	1:  _CALL next_token 
 2032      AAFE5DF8 
 2032      04EB
 2033 10d0 8046     	    mov T1,r0 // token type +|-
 2034 10d2 0728     	    cmp r0,#TK_PLUS 
 2035 10d4 06D0     	    beq 3f 
 2036 10d6 0828     	    cmp r0,#TK_MINUS  
 2037 10d8 04D0     	    beq 3f 
 2038 10da D4F800A0 	    _UNGET_TOKEN
 2038      D4F808B0 
 2039 10e2 0FE0     	    b 9f  
 2040 10e4 00B5FFF7 	3:  _CALL term 
 2040      A3FF5DF8 
 2040      04EB
 2041 10ee 1B28     	    cmp r0,#TK_INTGR 
 2042 10f0 7FF4A0AC 	    bne syntax_error 
 2043 10f4 B8F1070F 	    cmp T1,#TK_PLUS 
 2044 10f8 02D0     	    beq 4f 
 2045 10fa A2EB0102 	    sub r2,r2,r1 // N1-N2  
 2046 10fe E2E7     	    b 1b 
 2047 1100 0A44     	4:  add r2,r2,r1 // N1+N2
 2048 1102 E0E7     	    b 1b
 2049 1104 5FEA0900 	9:  movs r0,T2 
 2050 1108 1146     	    mov r1,r2 
 2051 110a BDE80403 	    pop {r2,t1,t2}
 2052 110e 7047     	    _RET 
 2053              	
 2054              	
 2055              	/**********************************************
 2056              	    relation parser 
 2057              	    rel ::= expr1 rel_op expr2
 2058              	    rel_op ::=  '=','<','>','>=','<=','<>','><'
 2059              	    relation return  integer , zero is false 
 2060              	    output:
 2061              	        r0	TK_INTGR  
 2062              	        r1	integer 
 2063              	    use:
 2064              	        r2   first operand 
 2065              	        T1   relop   
 2066              	**********************************************/
 2067              	    _FUNC relation 
 2068 1110 2DE90401 	    push {r2,T1}
 2069 1114 00B5FFF7 	    _CALL expression 
 2069      C7FF5DF8 
 2069      04EB
 2070 111e 1B28     	    cmp r0,#TK_INTGR 
ARM GAS  tinyBasic.s 			page 55


 2071 1120 7FF488AC 	    bne syntax_error 
 2072 1124 0A46     	    mov r2,r1  // first operand  
 2073 1126 00B5FFF7 	    _CALL next_token 
 2073      7AFE5DF8 
 2073      04EB
 2074 1130 A0F10D08 	    sub T1,r0,#TK_EQUAL  // relop  
 2075 1134 0D28     	    cmp r0,#TK_EQUAL 
 2076 1136 1DD4     	    bmi 8f 
 2077 1138 1328     	    cmp r0,#TK_CHAR 
 2078 113a 1BD5     	    bpl 8f 
 2079 113c 00B5FFF7 	    _CALL expression 
 2079      B3FF5DF8 
 2079      04EB
 2080 1146 1B28     	    cmp r0,#TK_INTGR 
 2081 1148 7FF474AC 	    bne syntax_error 
 2082 114c 8A42     	    cmp r2,r1 // compare operands  
 2083 114e 4FF0FF31 	    mov r1,#-1 
 2084 1152 2E4A     	    ldr r2,=relop_jmp
 2085 1154 D2E808F0 	    tbb [r2,T1]    
 2086              	rel_idx0:
 2087              	rel_eq:
 2088 1158 11D0     	    beq 9f 
 2089 115a 08E0     	    b rel_false
 2090              	rel_gt:
 2091 115c 0FDC     	    bgt 9f  
 2092 115e 06E0     	    b rel_false  
 2093              	rel_ge:
 2094 1160 0DDA     	    bge 9f  
 2095 1162 04E0     	    b rel_false  
 2096              	rel_lt: 
 2097 1164 0BDB     	    blt 9f   
 2098 1166 02E0     	    b rel_false 
 2099              	rel_le:
 2100 1168 09DD     	    ble 9f  
 2101 116a 00E0     	    b rel_false 
 2102              	rel_ne:
 2103 116c 07D1     	    bne 9f 
 2104              	rel_false:    
 2105 116e 81EA0101 	    eor r1,r1  // false
 2106 1172 04E0     	    b 9f  
 2107 1174 D4F800A0 	8:  _UNGET_TOKEN 
 2107      D4F808B0 
 2108 117c 1146     	    mov r1,r2    
 2109 117e 4FF01B00 	9:  mov r0,#TK_INTGR
 2110 1182 BDE80401 	    pop {r2,T1}
 2111 1186 7047     	    _RET 
 2112              	
 2113              	
 2114              	relop_jmp: 
 2115 1188 00       	  .byte 0 // =  
 2116 1189 02       	  .byte (rel_gt-rel_idx0)/2 // > 
 2117 118a 06       	  .byte (rel_lt-rel_idx0)/2 // <
 2118 118b 04       	  .byte (rel_ge-rel_idx0)/2 // >=
 2119 118c 08       	  .byte (rel_le-rel_idx0)/2 // <=
 2120 118d 0A       	  .byte (rel_ne-rel_idx0)/2 // <> 
 2121              	
 2122              	
ARM GAS  tinyBasic.s 			page 56


 2123              	/***********************************
 2124              	    get_array_element
 2125              	    return value of @(n)
 2126              	  input:
 2127              	    r0    indice 
 2128              	  output:
 2129              	    r0   TK_INTGR
 2130              	    r1   value  
 2131              	************************************/
 2132 118e 00BF     	    _FUNC get_array_element 
 2133 1190 D4F8C810 	    ldr r1,[UPP,#ARRAY_ADR]
 2134 1194 4FEA8000 	    lsl r0,#2 
 2135 1198 C0EB0100 	    rsb r0,r1 
 2136 119c 0168     	    ldr r1,[r0]
 2137 119e 4FF01B00 	    mov r0,#TK_INTGR 
 2138 11a2 7047     	    _RET 
 2139              	
 2140              	
 2141              	/***********************************
 2142              	    set_array_element 
 2143              	    set value of array element 
 2144              	  input:
 2145              	    r0   index 
 2146              	    r1   new value 
 2147              	  output:
 2148              	    none
 2149              	  use:
 2150              	    r2    array pointer 
 2151              	**********************************/
 2152              	    _FUNC set_array_element 
 2153 11a4 04B4     	    push {r2}
 2154 11a6 D4F8C810 	    ldr r1,[UPP,#ARRAY_ADR]
 2155 11aa 4FEA8000 	    lsl r0,#2 
 2156 11ae A1EB0001 	    sub r1,r0 
 2157 11b2 0960     	    str r1,[r1]
 2158 11b4 04BC     	    pop {r2}
 2159 11b6 7047     	    _RET 
 2160              	
 2161              	/***********************************
 2162              	   get_var 
 2163              	   get variable value 
 2164              	  input:
 2165              	     r0    variable index {0..25}
 2166              	  output:
 2167              	     r0    TK_INTGR
 2168              	     r1    value 
 2169              	**********************************/
 2170              	    _FUNC get_var 
 2171 11b8 04F16001 	    add r1,UPP,#VARS
 2172 11bc 4FEA8000 	    lsl r0,#2 
 2173 11c0 0958     	    ldr r1,[r1,r0]
 2174 11c2 4FF01B00 	    mov r0,#TK_INTGR
 2175 11c6 7047     	    _RET 
 2176              	
 2177              	/*********************************
 2178              	    set_var 
 2179              	    set variable value 
ARM GAS  tinyBasic.s 			page 57


 2180              	  input:
 2181              	     r0    variable index {0..25}
 2182              	     r1    new value 
 2183              	  output:
 2184              	    none 
 2185              	  use:
 2186              	    r2   vars pointer 
 2187              	*********************************/
 2188              	    _FUNC set_var 
 2189 11c8 04B4     	    push {r2}
 2190 11ca 04F16002 	    add r2,UPP,#VARS
 2191 11ce 4FEA8000 	    lsl r0,#2
 2192 11d2 1150     	    str r1,[r2,r0]
 2193 11d4 04BC     	    pop {r2}
 2194 11d6 7047     	    _RET 
 2195              	
 2196              	/******************************
 2197              	    CONSTANTS data
 2198              	******************************/
 2199              	
 2200              	  .section .rodata 
 2201              	
 2202              	// system variables initial value 
 2203              	uzero:
 2204 0000 00000000 	  .word 0 // IN_SAVED
 2205 0004 00000000 	  .word 0 // COUNT
 2206 0008 00000000 	  .word 0 // BASICPTR
 2207 000c 00000000 	  .word 0 // DATAPTR
 2208 0010 00000000 	  .word 0 // DATA
 2209 0014 00000000 	  .word 0 // DATALEN
 2210 0018 0A000000 	  .word 10 // BASE
 2211 001c 00000000 	  .word 0 // TICKS
 2212 0020 00000000 	  .word 0 // TIMER
 2213 0024 AA5555AA 	  .word 0xaa5555aa // SEED
 2214 0028 00000000 	  .word FILE_SYSTEM // FSPTR
 2215 002c 00000000 	  .word 0 // FSFREE
 2216 0030 00000000 	  .word 0 // TXTBGN
 2217 0034 00000000 	  .word 0 // TXTEND
 2218 0038 00000000 	  .word 0 //LOOP_DEPTH
 2219 003c 00000000 	  .word 0 // ARRAY_SIZE
 2220 0040 00000000 	  .word 0 // FLAGS
 2221 0044 04000000 	  .word 4 // TAB_WIDTH
 2222 0048 00000000 	  .word 0 // RX_HEAD
 2223 004c 00000000 	  .word 0 // RX_TAIL
 2224 0050 00000000 	  .space RX_QUEUE_SIZE,0 // RX_QUEUE
 2224      00000000 
 2224      00000000 
 2224      00000000 
 2225 0060 00000000 	  .space VARS_SIZE,0 // VARS
 2225      00000000 
 2225      00000000 
 2225      00000000 
 2225      00000000 
 2226 00c8 00000000 	  .word _pad  // ARRAY_ADR 
 2227 00cc 00000000 	  .word 0 // TRACE_LEVEL 
 2228 00d0 00000000 	  .word 0 // HERE 
 2229              	ulast:
ARM GAS  tinyBasic.s 			page 58


 2230              	
 2231              	  .section .rodata.dictionary 
 2232              	
 2233              	// keep alphabetic order for BASIC names from Z-A
 2234              	// this sort order is for for WORDS cmd output. 	
 2235              	  .type kword_end, %object
 2236              		.equ link, 0
 2237              	kword_end:
 2238 0000 0C000000 	  _dict_entry TK_NONE,"",0 
 2238      00000000 
 2238      00000000 
 2238      00000000 
 2239 0010 0C000000 	  _dict_entry TK_IFUNC,YPOS,YPOS_IDX // ypos 
 2239      54000000 
 2239      15000000 
 2239      59504F53 
 2239      00000000 
 2240 0024 1C000000 	  _dict_entry TK_IFUNC,XPOS,XPOS_IDX // xpos
 2240      53000000 
 2240      15000000 
 2240      58504F53 
 2240      00000000 
 2241 0038 30000000 	  _dict_entry TK_IFUNC,XOR,XOR_IDX //bit_xor
 2241      52000000 
 2241      15000000 
 2241      584F5200 
 2242 0048 44000000 	  _dict_entry TK_CMD,WORDS,WORDS_IDX //words 
 2242      51000000 
 2242      17000000 
 2242      574F5244 
 2242      53000000 
 2243 005c 54000000 	  _dict_entry TK_CMD,WAIT,WAIT_IDX //wait 
 2243      50000000 
 2243      17000000 
 2243      57414954 
 2243      00000000 
 2244 0070 68000000 	  _dict_entry TK_CMD,UNTIL,UNTIL_IDX //until 
 2244      4F000000 
 2244      17000000 
 2244      554E5449 
 2244      4C000000 
 2245 0084 7C000000 	  _dict_entry TK_IFUNC,UFLASH,UFLASH_IDX //uflash 
 2245      4E000000 
 2245      15000000 
 2245      55464C41 
 2245      53480000 
 2246 0098 90000000 	  _dict_entry TK_IFUNC,UBOUND,UBOUND_IDX //ubound
 2246      4D000000 
 2246      15000000 
 2246      55424F55 
 2246      4E440000 
 2247 00ac A4000000 	  _dict_entry TK_CMD,TRACE,TRACE_IDX // trace 
 2247      4C000000 
 2247      17000000 
 2247      54524143 
 2247      45000000 
 2248 00c0 B8000000 	  _dict_entry TK_CMD,TO,TO_IDX //to
ARM GAS  tinyBasic.s 			page 59


 2248      4B000000 
 2248      17000000 
 2248      544F0000 
 2249 00d0 CC000000 	  _dict_entry TK_CMD,TIMER,TIMER_IDX //set_timer
 2249      49000000 
 2249      17000000 
 2249      54494D45 
 2249      52000000 
 2250 00e4 DC000000 	  _dict_entry TK_IFUNC,TIMEOUT,TMROUT_IDX //timeout 
 2250      4A000000 
 2250      15000000 
 2250      54494D45 
 2250      4F555400 
 2251 00f8 F0000000 	  _dict_entry TK_IFUNC,TICKS,TICKS_IDX //get_ticks
 2251      48000000 
 2251      15000000 
 2251      5449434B 
 2251      53000000 
 2252 010c 04010000 	  _dict_entry TK_CMD,THEN,THEN_IDX // then 
 2252      47000000 
 2252      17000000 
 2252      5448454E 
 2252      00000000 
 2253 0120 18010000 	  _dict_entry TK_CMD,TAB,TAB_IDX //tab 
 2253      46000000 
 2253      17000000 
 2253      54414200 
 2254 0130 2C010000 	  _dict_entry TK_CMD,STORE,STORE_IDX // store  
 2254      45000000 
 2254      17000000 
 2254      53544F52 
 2254      45000000 
 2255 0144 3C010000 	  _dict_entry TK_CMD,STOP,STOP_IDX //stop 
 2255      44000000 
 2255      17000000 
 2255      53544F50 
 2255      00000000 
 2256 0158 50010000 	  _dict_entry TK_CMD,STEP,STEP_IDX //step 
 2256      43000000 
 2256      17000000 
 2256      53544550 
 2256      00000000 
 2257 016c 64010000 	  _dict_entry TK_CMD,SPC,SPC_IDX // spc 
 2257      42000000 
 2257      17000000 
 2257      53504300 
 2258 017c 78010000 	  _dict_entry TK_CMD,SLEEP,SLEEP_IDX //sleep 
 2258      41000000 
 2258      17000000 
 2258      534C4545 
 2258      50000000 
 2259 0190 88010000 	  _dict_entry TK_CMD,SAVE,SAVE_IDX //save
 2259      40000000 
 2259      17000000 
 2259      53415645 
 2259      00000000 
 2260 01a4 9C010000 	  _dict_entry TK_CMD,RUN,RUN_IDX //run
ARM GAS  tinyBasic.s 			page 60


 2260      3F000000 
 2260      17000000 
 2260      52554E00 
 2261 01b4 B0010000 	  _dict_entry TK_IFUNC,RSHIFT,RSHIFT_IDX //rshift
 2261      3E000000 
 2261      15000000 
 2261      52534849 
 2261      46540000 
 2262 01c8 C0010000 	  _dict_entry TK_IFUNC,RND,RND_IDX //random 
 2262      3D000000 
 2262      15000000 
 2262      524E4400 
 2263 01d8 D4010000 	  _dict_entry TK_CMD,RETURN,RET_IDX //return 
 2263      3C000000 
 2263      17000000 
 2263      52455455 
 2263      524E0000 
 2264 01ec E4010000 	  _dict_entry TK_CMD,RESTORE,REST_IDX //restore 
 2264      3B000000 
 2264      17000000 
 2264      52455354 
 2264      4F524500 
 2265 0200 F8010000 	  _dict_entry TK_CMD,REM,REM_IDX //remark 
 2265      3A000000 
 2265      17000000 
 2265      52454D00 
 2266 0210 0C020000 	  _dict_entry TK_IFUNC,READ,READ_IDX //read  
 2266      39000000 
 2266      15000000 
 2266      52454144 
 2266      00000000 
 2267 0224 1C020000 	  _dict_entry TK_IFUNC,QKEY,QKEY_IDX //qkey 
 2267      38000000 
 2267      15000000 
 2267      514B4559 
 2267      00000000 
 2268 0238 30020000 	  _dict_entry TK_CMD,PUT,PUT_IDX // put 
 2268      37000000 
 2268      17000000 
 2268      50555400 
 2269 0248 44020000 	  _dict_entry TK_CMD,PUSH,PUSH_IDX //cmd_push  
 2269      36000000 
 2269      17000000 
 2269      50555348 
 2269      00000000 
 2270 025c 54020000 	  _dict_entry TK_CMD,PRINT,PRT_IDX //print 
 2270      35000000 
 2270      17000000 
 2270      5052494E 
 2270      54000000 
 2271 0270 68020000 	  _dict_entry TK_IFUNC,POP,POP_IDX // fn_pop 
 2271      34000000 
 2271      15000000 
 2271      504F5000 
 2272 0280 7C020000 	  _dict_entry TK_CMD,POKEW,POKE32_IDX //poke32
 2272      33000000 
 2272      17000000 
ARM GAS  tinyBasic.s 			page 61


 2272      504F4B45 
 2272      57000000 
 2273 0294 8C020000 	  _dict_entry TK_CMD,POKEH,POKE16_IDX // poke16
 2273      32000000 
 2273      17000000 
 2273      504F4B45 
 2273      48000000 
 2274 02a8 A0020000 	  _dict_entry TK_CMD,POKEB,POKE8_IDX // poke8 
 2274      31000000 
 2274      17000000 
 2274      504F4B45 
 2274      42000000 
 2275 02bc B4020000 	  _dict_entry TK_CMD,PMODE,PMODE_IDX // pin_mode 
 2275      2D000000 
 2275      17000000 
 2275      504D4F44 
 2275      45000000 
 2276 02d0 C8020000 	  _dict_entry TK_IFUNC,PEEKW,PEEK32_IDX //peek32
 2276      30000000 
 2276      15000000 
 2276      5045454B 
 2276      57000000 
 2277 02e4 DC020000 	  _dict_entry TK_IFUNC,PEEKH,PEEK16_IDX //peek16
 2277      2F000000 
 2277      15000000 
 2277      5045454B 
 2277      48000000 
 2278 02f8 F0020000 	  _dict_entry TK_IFUNC,PEEKB,PEEK8_IDX //peek8
 2278      2E000000 
 2278      15000000 
 2278      5045454B 
 2278      42000000 
 2279 030c 04030000 	  _dict_entry TK_CMD,PAUSE,PAUSE_IDX //pause 
 2279      2C000000 
 2279      17000000 
 2279      50415553 
 2279      45000000 
 2280 0320 18030000 	  _dict_entry TK_IFUNC,PAD,PAD_IDX //pad_ref 
 2280      2B000000 
 2280      15000000 
 2280      50414400 
 2281 0330 2C030000 	  _dict_entry TK_CMD,OUT,OUT_IDX //out 
 2281      2A000000 
 2281      17000000 
 2281      4F555400 
 2282 0340 3C030000 	  _dict_entry TK_IFUNC,OR,OR_IDX //bit_or
 2282      29000000 
 2282      15000000 
 2282      4F520000 
 2283 0350 4C030000 	  _dict_entry TK_IFUNC,NOT,NOT_IDX //func_not 
 2283      28000000 
 2283      15000000 
 2283      4E4F5400 
 2284 0360 5C030000 	  _dict_entry TK_CMD,NEXT,NEXT_IDX //next 
 2284      27000000 
 2284      17000000 
 2284      4E455854 
ARM GAS  tinyBasic.s 			page 62


 2284      00000000 
 2285 0374 6C030000 	  _dict_entry TK_CMD,NEW,NEW_IDX //new
 2285      26000000 
 2285      17000000 
 2285      4E455700 
 2286 0384 80030000 	  _dict_entry TK_IFUNC,LSHIFT,LSHIFT_IDX //lshift
 2286      25000000 
 2286      15000000 
 2286      4C534849 
 2286      46540000 
 2287 0398 90030000 	  _dict_entry TK_CMD,LOCATE,LOCATE_IDX // locate 
 2287      24000000 
 2287      17000000 
 2287      4C4F4341 
 2287      54450000 
 2288 03ac A4030000 	  _dict_entry TK_CMD,LOAD,LOAD_IDX //load 
 2288      23000000 
 2288      17000000 
 2288      4C4F4144 
 2288      00000000 
 2289 03c0 B8030000 	  _dict_entry TK_CMD,LIST,LIST_IDX //list
 2289      22000000 
 2289      17000000 
 2289      4C495354 
 2289      00000000 
 2290 03d4 CC030000 	  _dict_entry TK_CMD,LET,LET_IDX //let 
 2290      21000000 
 2290      17000000 
 2290      4C455400 
 2291 03e4 E0030000 	  _dict_entry TK_IFUNC,KEY,KEY_IDX //key 
 2291      20000000 
 2291      15000000 
 2291      4B455900 
 2292 03f4 F0030000 	  _dict_entry TK_IFUNC,INVERT,INVERT_IDX //invert 
 2292      1F000000 
 2292      15000000 
 2292      494E5645 
 2292      52540000 
 2293 0408 00040000 	  _dict_entry TK_CMD,INPUT,INPUT_IDX //input_var
 2293      1E000000 
 2293      17000000 
 2293      494E5055 
 2293      54000000 
 2294 041c 14040000 	  _dict_entry TK_IFUNC,IN,IN_IDX // pin_input   
 2294      1D000000 
 2294      15000000 
 2294      494E0000 
 2295 042c 28040000 	  _dict_entry TK_CMD,IF,IF_IDX //if 
 2295      1C000000 
 2295      17000000 
 2295      49460000 
 2296 043c 38040000 	  _dict_entry TK_CMD,HEX,HEX_IDX //hex_base
 2296      1B000000 
 2296      17000000 
 2296      48455800 
 2297 044c 48040000 	  _dict_entry TK_SCONST,GPIOC,GPIOC_BASE_ADR //  
 2297      00100140 
ARM GAS  tinyBasic.s 			page 63


 2297      18000000 
 2297      4750494F 
 2297      43000000 
 2298 0460 58040000 	  _dict_entry TK_SCONST,GPIOB,GPIOB_BASE_ADR //  
 2298      000C0140 
 2298      18000000 
 2298      4750494F 
 2298      42000000 
 2299 0474 6C040000 	  _dict_entry TK_SCONST,GPIOA,GPIOA_BASE_ADR //  
 2299      00080140 
 2299      18000000 
 2299      4750494F 
 2299      41000000 
 2300 0488 80040000 	  _dict_entry TK_CMD,GOTO,GOTO_IDX //goto 
 2300      1A000000 
 2300      17000000 
 2300      474F544F 
 2300      00000000 
 2301 049c 94040000 	  _dict_entry TK_CMD,GOSUB,GOSUB_IDX //gosub 
 2301      19000000 
 2301      17000000 
 2301      474F5355 
 2301      42000000 
 2302 04b0 A8040000 	  _dict_entry TK_IFUNC,GET,GET_IDX // get 
 2302      18000000 
 2302      15000000 
 2302      47455400 
 2303 04c0 BC040000 	  _dict_entry TK_IFUNC,FREE,FREE_IDX //free  
 2303      17000000 
 2303      15000000 
 2303      46524545 
 2303      00000000 
 2304 04d4 CC040000 	  _dict_entry TK_CMD,FORGET,FORGET_IDX //forget 
 2304      16000000 
 2304      17000000 
 2304      464F5247 
 2304      45540000 
 2305 04e8 E0040000 	  _dict_entry TK_CMD,FOR,FOR_IDX //for 
 2305      15000000 
 2305      17000000 
 2305      464F5200 
 2306 04f8 F4040000 	  _dict_entry TK_CMD,ERASE,ERASE_IDX // erase 
 2306      14000000 
 2306      17000000 
 2306      45524153 
 2306      45000000 
 2307 050c 04050000 	  _dict_entry TK_CMD,END,END_IDX //cmd_end  
 2307      13000000 
 2307      17000000 
 2307      454E4400 
 2308 051c 18050000 	  _dict_entry TK_CMD,DUMP,DUMP_IDX // dump 
 2308      12000000 
 2308      17000000 
 2308      44554D50 
 2308      00000000 
 2309 0530 28050000 	  _dict_entry TK_CMD,DROP,DROP_IDX // drop 
 2309      11000000 
ARM GAS  tinyBasic.s 			page 64


 2309      17000000 
 2309      44524F50 
 2309      00000000 
 2310 0544 3C050000 	  _dict_entry TK_CMD,DO,DO_IDX //do_loop
 2310      10000000 
 2310      17000000 
 2310      444F0000 
 2311 0554 50050000 	  _dict_entry TK_CMD,DIR,DIR_IDX //directory 
 2311      0F000000 
 2311      17000000 
 2311      44495200 
 2312 0564 60050000 	  _dict_entry TK_CMD,DEC,DEC_IDX //dec_base
 2312      0E000000 
 2312      17000000 
 2312      44454300 
 2313 0574 70050000 	  _dict_entry TK_CMD,DATALN,DATALN_IDX //data_line  
 2313      0D000000 
 2313      17000000 
 2313      44415441 
 2313      4C4E0000 
 2314 0588 80050000 	  _dict_entry TK_CMD,DATA,DATA_IDX //data  
 2314      0C000000 
 2314      17000000 
 2314      44415441 
 2314      00000000 
 2315 059c 94050000 	  _dict_entry TK_CMD,CONST,CONST_IDX // const 
 2315      0B000000 
 2315      17000000 
 2315      434F4E53 
 2315      54000000 
 2316 05b0 A8050000 	  _dict_entry TK_CMD,CLS,CLS_IDX // cls 
 2316      0A000000 
 2316      17000000 
 2316      434C5300 
 2317 05c0 BC050000 	  _dict_entry TK_CFUNC,CHAR,CHAR_IDX //char
 2317      09000000 
 2317      16000000 
 2317      43484152 
 2317      00000000 
 2318 05d4 CC050000 	  _dict_entry TK_CMD,BTOGL,BTOGL_IDX //bit_toggle
 2318      08000000 
 2318      17000000 
 2318      42544F47 
 2318      4C000000 
 2319 05e8 E0050000 	  _dict_entry TK_IFUNC,BTEST,BTEST_IDX //bit_test 
 2319      07000000 
 2319      15000000 
 2319      42544553 
 2319      54000000 
 2320 05fc F4050000 	  _dict_entry TK_CMD,BSET,BSET_IDX //bit_set 
 2320      06000000 
 2320      17000000 
 2320      42534554 
 2320      00000000 
 2321 0610 08060000 	  _dict_entry TK_CMD,BRES,BRES_IDX //bit_reset
 2321      05000000 
 2321      17000000 
ARM GAS  tinyBasic.s 			page 65


 2321      42524553 
 2321      00000000 
 2322 0624 1C060000 	  _dict_entry TK_IFUNC,BIT,BIT_IDX //bitmask
 2322      04000000 
 2322      15000000 
 2322      42495400 
 2323 0634 30060000 	  _dict_entry TK_CMD,AWU,AWU_IDX //awu 
 2323      03000000 
 2323      17000000 
 2323      41575500 
 2324 0644 40060000 	  _dict_entry TK_IFUNC,ASC,ASC_IDX //ascii
 2324      02000000 
 2324      15000000 
 2324      41534300 
 2325 0654 50060000 	  _dict_entry TK_IFUNC,AND,AND_IDX //bit_and
 2325      01000000 
 2325      15000000 
 2325      414E4400 
 2326              	first_link: 
 2327 0664 60060000 	  .word LINK 
 2328 0668 00000000 	  .word ABS_IDX 
 2329 066c 15000000 	  .word TK_IFUNC
 2330              	kword_dict: // first name field 
 2331              	  .equ LINK,. 
 2332 0670 41425300 	  .asciz "ABS" 
 2333              	  .p2align 2 
 2334              	
 2335              	    .section .rodata.fn_tabld 
 2336              	
 2337              	//comands and fonctions address table
 2338              	  .type fn_table, %object
 2339              	fn_table:
 2340 0000 00000000 		.word abs,bit_and,ascii,awu,bitmask 
 2340      00000000 
 2340      00000000 
 2340      00000000 
 2340      00000000 
 2341 0014 00000000 		.word bit_reset,bit_set,bit_test,bit_toggle,char,cls,const   
 2341      00000000 
 2341      00000000 
 2341      00000000 
 2341      00000000 
 2342 0030 00000000 		.word skip_line,data_line,dec_base,directory,do_loop,drop,dump
 2342      00000000 
 2342      00000000 
 2342      00000000 
 2342      00000000 
 2343 004c 00000000 		.word cmd_end,erase,for,forget,free,get,gosub,goto
 2343      00000000 
 2343      00000000 
 2343      00000000 
 2343      00000000 
 2344 006c 00000000 		.word hex_base,if,pin_input,input_var,invert,key
 2344      00000000 
 2344      00000000 
 2344      00000000 
 2344      00000000 
ARM GAS  tinyBasic.s 			page 66


 2345 0084 00000000 		.word let,list,load,locate,lshift,new,next
 2345      00000000 
 2345      00000000 
 2345      00000000 
 2345      00000000 
 2346 00a0 00000000 		.word func_not,bit_or,out,pad_ref,pause,pin_mode,peek8,peek16,peek32
 2346      00000000 
 2346      00000000 
 2346      00000000 
 2346      00000000 
 2347 00c4 00000000 		.word poke8,poke16,poke32,fn_pop,print,cmd_push,put  
 2347      00000000 
 2347      00000000 
 2347      00000000 
 2347      00000000 
 2348 00e0 00000000 		.word qkey,read,skip_line
 2348      00000000 
 2348      00000000 
 2349 00ec 00000000 		.word restore,return, random,rshift,run,save
 2349      00000000 
 2349      00000000 
 2349      00000000 
 2349      00000000 
 2350 0104 00000000 		.word sleep,spc,step,stop,store,tab
 2350      00000000 
 2350      00000000 
 2350      00000000 
 2350      00000000 
 2351 011c 00000000 		.word then,get_ticks,set_timer,timeout,to,trace,ubound,uflash,until
 2351      00000000 
 2351      00000000 
 2351      00000000 
 2351      00000000 
 2352 0140 00000000 		.word wait,words,bit_xor,xpos,ypos 
 2352      00000000 
 2352      00000000 
 2352      00000000 
 2352      00000000 
 2353 0154 00000000 		.word 0 
 2354              	
 2355              	
 2356              	/**********************************
 2357              	    BASIC commands and functions 
 2358              	**********************************/
 2359              	
 2360              	    .section .text.basic , "ax", %progbits 
 2361              	
 2362              	
 2363              	/*******************************
 2364              	  BASIC:  ABS expr 
 2365              	  input:
 2366              	    none 
 2367              	  output:
 2368              	    r0    token type 
 2369              	    r1    abs(expr)
 2370              	  use:
 2371              	    none 
ARM GAS  tinyBasic.s 			page 67


 2372              	******************************/
 2373              	    _FUNC abs 
 2374 0000 00B5FFF7 	    _CALL arg_list
 2374      FEFF5DF8 
 2374      04EB
 2375 000a 0128     	    cmp r0,#1 
 2376 000c 01D0     	    beq 1f 
 2377 000e FFF7FEBF 	    b syntax_error 
 2378 0012 5CF8041B 	1:  _POP r1 
 2379 0016 11F0004F 	    tst r1,#(1<<31)
 2380 001a 01D0     	    beq 9f
 2381 001c C1F10001 	    rsb r1,#0 
 2382 0020 4FF01B00 	9:  mov r0,#TK_INTGR
 2383 0024 7047     	   _RET 
 2384              	
 2385 0026 00BF     	    _FUNC power_adc
 2386 0028 7047     	    _RET
 2387              	
 2388 002a 00BF     	    _FUNC analog_read
 2389 002c 7047     	    _RET
 2390              	
 2391              	/************************************
 2392              	  BASIC: AND(expr1,expr2)
 2393              	  logical ANND bit to between expr1,expr2
 2394              	************************************/
 2395 002e 00BF     	    _FUNC bit_and
 2396 0030 00B5FFF7 	    _CALL func_args 
 2396      FEFF5DF8 
 2396      04EB
 2397 003a 0228     	    cmp r0,#2 
 2398 003c 7FF4FEAF 	    bne syntax_error 
 2399 0040 5CF8040B 	    _POP r0 
 2400 0044 5CF8041B 	    _POP r1 
 2401 0048 01EA0001 	    and r1,r0 
 2402 004c 4FF01B00 	    mov r0,#TK_INTGR
 2403 0050 7047     	    _RET
 2404              	
 2405              	/*******************************************
 2406              	  BASIC: ASC(string|char)
 2407              	  return ASCII code of char of first char 
 2408              	  of string 
 2409              	*******************************************/
 2410 0052 00BF     	    _FUNC ascii
 2411 0054 4FF00500 	    mov r0,#TK_LPAREN 
 2412 0058 00B5FFF7 	    _CALL expect 
 2412      FEFF5DF8 
 2412      04EB
 2413 0062 00B5FFF7 	    _CALL next_token 
 2413      FEFF5DF8 
 2413      04EB
 2414 006c 1C28     	    cmp r0,#TK_QSTR
 2415 006e 03D0     	    beq 2f 
 2416 0070 1328     	    cmp r0,#TK_CHAR 
 2417 0072 7FF4FEAF 	    bne syntax_error 
 2418 0076 00E0     	    b 9f 
 2419 0078 0978     	2:  ldrb r1,[r1]
 2420 007a 4CF8041D 	9:  _PUSH r1 
ARM GAS  tinyBasic.s 			page 68


 2421 007e 4FF00600 	    mov r0,#TK_RPAREN 
 2422 0082 00B5FFF7 	    _CALL expect 
 2422      FEFF5DF8 
 2422      04EB
 2423 008c 4FF01B00 	    mov r0,#TK_INTGR 
 2424 0090 5CF8041B 	    _POP r1 
 2425 0094 7047     	    _RET
 2426              	
 2427 0096 00BF     	    _FUNC autorun
 2428 0098 7047     	    _RET
 2429              	
 2430              	/*******************************************
 2431              	  BASIC: AWU time_sleep  
 2432              	  enable LSI and IWDG and place MCU in 
 2433              	  deep sleep. IDWG wakeup MCU 
 2434              	******************************************/
 2435 009a 00BF     	    _FUNC awu
 2436 009c 00B5FFF7 	    _CALL arg_list
 2436      FEFF5DF8 
 2436      04EB
 2437 00a6 0128     	    cmp r0,#1 
 2438 00a8 7FF4FEAF 	    bne syntax_error 
 2439 00ac 4FF48051 	    _MOV32 r1,RCC_BASE_ADR
 2439      C4F20201 
 2440 00b4 486A     	    ldr r0,[r1,#RCC_CSR]
 2441              	// enable LSI 
 2442 00b6 80F00100 	    eor r0,#1
 2443 00ba 4862     	    str r0,[r1,#RCC_CSR]
 2444              	// wait for LSIRDY 
 2445 00bc 486A     	1:  ldr r0,[r1,#RCC_CSR]
 2446 00be 10F0020F 	    tst r0,#2 // LSIRDY bit 
 2447 00c2 FBD0     	    beq 1b 
 2448              	// configure IWDG
 2449              	// compute values for IWDG_PR and IWDG_RLR 
 2450 00c4 5CF8042B 	    _POP r2 // time_sleep in msec. 
 2451 00c8 4FF00A03 	    mov r3,#10 // Flsi=40Khz but smallest divisor is 4 
 2452 00cc 03FB02F2 	    mul r2,r3 
 2453 00d0 83EA0303 	    eor r3,r3
 2454 00d4 B2F5005F 	2:  cmp r2,#8192 
 2455 00d8 04D4     	    bmi 3f 
 2456 00da 4FEA5202 	    lsr r2,#1 
 2457 00de 03F10103 	    add r3,#1
 2458 00e2 F7E7     	    b 2b
 2459              	// initialize IWDG      
 2460 00e4 4FF44051 	3:  _MOV32 r1,IWDG_BASE_ADR
 2460      C4F20001 
 2461 00ec 45F25550 	    mov r0,0x5555 // enable register writing
 2462 00f0 0860     	    str r0,[r1,#IWDG_KR]
 2463 00f2 4B60     	    str r3,[r1,#IWDG_PR]
 2464 00f4 8A60     	    str r2,[r1,#IWDG_RLR]
 2465 00f6 4CF6CC40 	    mov r0,#0xcccc // start IWDG 
 2466 00fa 0860     	    str r0,[r1,#IWDG_KR]
 2467 00fc 00F06EBF 	    b sleep // place MCU in deep sleep
 2468 0100 7047     	    _RET
 2469              	
 2470              	/********************************************
 2471              	  BASIC: BIT(expr)
ARM GAS  tinyBasic.s 			page 69


 2472              	  expr must be between 0..31 and is used 
 2473              	  to create 1 bit mask at that position
 2474              	*******************************************/
 2475 0102 00BF     	    _FUNC bitmask
 2476 0104 00B5FFF7 	    _CALL func_args
 2476      FEFF5DF8 
 2476      04EB
 2477 010e 0128     	    cmp r0,#1 
 2478 0110 7FF4FEAF 	    bne syntax_error 
 2479 0114 5CF8040B 	    _POP r0
 2480 0118 4FF00101 	    mov r1,#1
 2481 011c 01FA00F1 	    lsl r1,r0 
 2482 0120 4FF01B00 	9:  mov r0,#TK_INTGR
 2483 0124 7047     	    _RET 
 2484              	
 2485              	  
 2486              	  /*********************************
 2487              	   BASIC: BRES adr, mask   
 2488              	   reset bits [adr]= [adr] & ~mask  
 2489              	   input:
 2490              	     none 
 2491              	    output;
 2492              	      none 
 2493              	    use:
 2494              	      T1   temp
 2495              	      T2   temp 
 2496              	*******************************/     
 2497 0126 00BF     	  _FUNC bit_reset
 2498 0128 00B5FFF7 	    _CALL arg_list 
 2498      FEFF5DF8 
 2498      04EB
 2499 0132 0228     	    cmp r0,#2 
 2500 0134 01D0     	    beq 1f 
 2501 0136 FFF7FEBF 	    b syntax_error 
 2502 013a 5CF8041B 	1:  _POP r1 //mask 
 2503 013e 5CF8040B 	    _POP r0 //address 
 2504 0142 D0F80090 	    ldr T2,[r0] 
 2505 0146 81F0FF31 	    eor r1,#-1 // ~mask 
 2506 014a 01EA0901 	    and r1,T2
 2507 014e 0160     	    str r1,[r0]
 2508 0150 7047     	    _RET  
 2509              	
 2510              	
 2511              	/*********************************
 2512              	   BASIC: BSET adr, mask   
 2513              	   reset bits [adr]= [adr] & ~mask  
 2514              	   input:
 2515              	      none 
 2516              	    output;
 2517              	      none 
 2518              	    use:
 2519              	      T1   temp
 2520              	      T2   temp  
 2521              	*******************************/     
 2522 0152 00BF     	    _FUNC bit_set
 2523 0154 00B5FFF7 	    _CALL arg_list 
 2523      FEFF5DF8 
ARM GAS  tinyBasic.s 			page 70


 2523      04EB
 2524 015e 0228     	    cmp r0,#2 
 2525 0160 01D0     	    beq 1f 
 2526 0162 FFF7FEBF 	    b syntax_error 
 2527 0166 5CF8041B 	1:  _POP r1 //mask 
 2528 016a 5CF8040B 	    _POP r0 //address 
 2529 016e D0F80090 	    ldr T2,[r0] 
 2530 0172 41EA0901 	    orr r1,T2
 2531 0176 0160     	    str r1,[r0]
 2532 0178 7047     	    _RET 
 2533              	
 2534              	  /*********************************
 2535              	   BASIC: BTOGL adr, mask   
 2536              	   reset bits [adr]= [adr] & ~mask  
 2537              	   input:
 2538              	     r0    adr 
 2539              	     r1    mask 
 2540              	    output;
 2541              	      none 
 2542              	    use:
 2543              	      T1   temp
 2544              	      T2   temp  
 2545              	*******************************/     
 2546 017a 00BF     	  _FUNC bit_toggle
 2547 017c 00B5FFF7 	    _CALL arg_list 
 2547      FEFF5DF8 
 2547      04EB
 2548 0186 0228     	    cmp r0,#2 
 2549 0188 01D0     	    beq 1f 
 2550 018a FFF7FEBF 	    b syntax_error 
 2551 018e 5CF8041B 	1:  _POP r1 //mask 
 2552 0192 5CF8040B 	    _POP r0 //address 
 2553 0196 D0F80090 	    ldr T2,[r0] 
 2554 019a 81EA0901 	    eor r1,T2
 2555 019e 0160     	    str r1,[r0]
 2556 01a0 7047     	    _RET  
 2557              	
 2558              	/********************************
 2559              	  BASIC: BTEST(addr,bit)
 2560              	  return bit state at address
 2561              	********************************/
 2562 01a2 00BF     	    _FUNC bit_test
 2563 01a4 00B5FFF7 	    _CALL func_args
 2563      FEFF5DF8 
 2563      04EB
 2564 01ae 0228     	    cmp r0,#2 
 2565 01b0 7FF4FEAF 	    bne syntax_error 
 2566 01b4 5CF8041B 	    _POP r1
 2567 01b8 4FF00100 	    mov r0,#1
 2568 01bc 01F01F01 	    and r1,#31  
 2569 01c0 21B1     	1:  cbz r1, 2f
 2570 01c2 4FEA4000 	    lsl r0,#1
 2571 01c6 A1F10101 	    sub r1,#1
 2572 01ca F9E7     	    b 1b 
 2573 01cc 5CF8041B 	2:  _POP r1
 2574 01d0 0968     	    ldr r1,[r1]
 2575 01d2 01EA0001 	    and r1,r0 
ARM GAS  tinyBasic.s 			page 71


 2576 01d6 09B1     	    cbz r1,9f 
 2577 01d8 4FF00101 	    mov r1,#1
 2578 01dc 4FF01B00 	9:  mov r0,#TK_INTGR    
 2579 01e0 7047     	    _RET 
 2580              	
 2581              	/********************************
 2582              	  BASIC: CLS 
 2583              	  clear terminal screen move cursor 
 2584              	  home 
 2585              	************************************/
 2586 01e2 00BF     	    _FUNC cls 
 2587 01e4 00B5FFF7 	    _CALL clear_screen
 2587      FEFF5DF8 
 2587      04EB
 2588 01ee 7047     	    _RET 
 2589              	
 2590              	/*********************************
 2591              	  BASIC: CHAR(expr)
 2592              	  convert expr in character 
 2593              	********************************/
 2594              	    _FUNC char
 2595 01f0 00B5FFF7 	    _CALL func_args
 2595      FEFF5DF8 
 2595      04EB
 2596 01fa 0128     	    cmp r0,#1
 2597 01fc 7FF4FEAF 	    bne syntax_error 
 2598 0200 5CF8041B 	    _POP r1 
 2599 0204 01F07F01 	    and r1,#127 
 2600 0208 4FF01300 	    mov r0,#TK_CHAR
 2601 020c 7047     	    _RET 
 2602              	
 2603              	/**********************************
 2604              	  BASIC: CONST !label=expr [,!label=expr]
 2605              	  define constants constants are 
 2606              	  store at end of BASIC code.
 2607              	  use:
 2608              	    T1   *location 
 2609              	    T2   *bound 
 2610              	*********************************/
 2611 020e 00BF     	    _FUNC const
 2612 0210 206C10F0 	    _RTO 
 2612      010F03D1 
 2612      4FF00700 
 2612      FFF7FEBF 
 2613 0220 D4F8D080 	    ldr T1,[UPP,#HERE]
 2614 0224 DFF80097 	    ldr T2,pad_adr  
 2615 0228 C845     	1:  cmp T1,T2 
 2616 022a 03D4     	    bmi 2f 
 2617 022c 4FF00100 	    mov r0,#ERR_MEM_FULL 
 2618 0230 FFF7FEBF 	    b tb_error 
 2619 0234 00B5FFF7 	2:  _CALL next_token 
 2619      FEFF5DF8 
 2619      04EB
 2620 023e 1A28     	    cmp r0,#TK_LABEL 
 2621 0240 7FF4FEAF 	    bne syntax_error 
 2622 0244 41F00041 	    orr r1,#(1<<31) // this label identify a constant 
 2623 0248 4CF8041D 	    _PUSH r1 
ARM GAS  tinyBasic.s 			page 72


 2624 024c 4FF00D00 	    mov r0,#TK_EQUAL
 2625 0250 00B5FFF7 	    _CALL expect
 2625      FEFF5DF8 
 2625      04EB
 2626 025a 00B5FFF7 	    _CALL expression  
 2626      FEFF5DF8 
 2626      04EB
 2627 0264 1B28     	    cmp r0,#TK_INTGR
 2628 0266 7FF4FEAF 	    bne syntax_error
 2629 026a 5CF8040B 	    _POP r0 
 2630 026e 48F8040B 	    str r0,[T1],#4
 2631 0272 48F8041B 	    str r1,[T1],#4 
 2632 0276 C4F8D080 	    str T1,[UPP,#HERE]
 2633 027a 00B5FFF7 	    _CALL next_token
 2633      FEFF5DF8 
 2633      04EB
 2634 0284 0228     	    cmp r0,#TK_COMMA 
 2635 0286 CFD0     	    beq 1b 
 2636 0288 D4F800A0 	    _UNGET_TOKEN
 2636      D4F808B0 
 2637              	9:  
 2638 0290 7047     	    _RET 
 2639              	
 2640              	
 2641              	/**************************
 2642              	  BASIC: DATALN expr 
 2643              	  set data pointer to line#
 2644              	  specified by expr. 
 2645              	  if line# not valid program 
 2646              	  end with error.
 2647              	  use:
 2648              	
 2649              	**************************/
 2650 0292 00BF     	    _FUNC data_line
 2651 0294 206C10F0 	    _RTO // run time only 
 2651      010F03D1 
 2651      4FF00700 
 2651      FFF7FEBF 
 2652 02a4 00B5FFF7 	    _CALL expression 
 2652      FEFF5DF8 
 2652      04EB
 2653 02ae 1B28     	    cmp r0,#TK_INTGR
 2654 02b0 7FF4FEAF 	    bne syntax_error
 2655 02b4 0846     	    mov r0,r1 
 2656 02b6 00B5FFF7 	    _CALL search_lineno
 2656      FEFF5DF8 
 2656      04EB
 2657 02c0 0029     	    cmp r1,#0
 2658 02c2 03D0     	    beq 1f 
 2659 02c4 4FF00A00 	0:  mov r0,#ERR_BAD_VALUE
 2660 02c8 FFF7FEBF 	    b syntax_error 
 2661 02cc C178     	1:  ldrb r1,[r0,#3]
 2662 02ce 1729     	    cmp r1,#TK_CMD 
 2663 02d0 F8D1     	    bne 0b
 2664 02d2 0179     	    ldrb r1,[r0,#4]
 2665 02d4 0C29     	    cmp r1,#DATA_IDX 
 2666 02d6 F5D1     	    bne 0b  
ARM GAS  tinyBasic.s 			page 73


 2667 02d8 E060     	    str r0,[UPP,#DATAPTR]
 2668 02da 8178     	    ldrb r1,[r0,#2]
 2669 02dc 6161     	    str r1,[UPP,#DATALEN]
 2670 02de 4FF00501 	    mov r1,#5 // position of first data item  
 2671 02e2 2161     	    str r1,[UPP,#DATA]
 2672 02e4 7047     	    _RET 
 2673              	
 2674              	/*****************************
 2675              	  BASIC: READ 
 2676              	  read next data item 
 2677              	  the value can be assigned to
 2678              	  variable or used in expression
 2679              	*****************************/
 2680 02e6 00BF     	    _FUNC read
 2681 02e8 206C10F0 	    _RTO
 2681      010F03D1 
 2681      4FF00700 
 2681      FFF7FEBF 
 2682 02f8 6069     	    ldr r0,[UPP,#DATALEN] // line length 
 2683 02fa E168     	    ldr r1,[UPP,#DATAPTR] // line address 
 2684 02fc 2269     	    ldr r2,[UPP,#DATA] // item on line  
 2685 02fe 8242     	    cmp r2,r0
 2686 0300 0ED0     	    beq seek_next
 2687 0302 885C     	1:  ldrb r0,[r1,r2]
 2688 0304 02F10102 	    add r2,#1
 2689 0308 0028     	    cmp r0,#TK_NONE
 2690 030a 09D0     	    beq seek_next
 2691 030c 0228     	    cmp r0,#TK_COMMA
 2692 030e F8D0     	    beq 1b  
 2693 0310 1B28     	    cmp r0,#TK_INTGR 
 2694 0312 7FF4FEAF 	    bne syntax_error  
 2695 0316 8958     	    ldr r1,[r1,r2]
 2696 0318 02F10402 	    add r2,#4
 2697 031c 2261     	    str r2,[UPP,#DATA]
 2698 031e 12E0     	    b 9f  
 2699              	seek_next: // is next line data ?
 2700 0320 8878     	    ldrb r0,[R1,#2]
 2701 0322 0144     	    add r1,r0 
 2702 0324 C878     	    ldrb r0,[R1,#3]
 2703 0326 1728     	    cmp r0,#TK_CMD
 2704 0328 09D1     	    bne 2f 
 2705 032a 0879     	    ldrb r0,[r1,#4]
 2706 032c 0C28     	    cmp r0,#DATA_IDX 
 2707 032e 06D1     	    bne 2f 
 2708 0330 E160     	    str r1,[UPP,#DATAPTR]
 2709 0332 8878     	    ldrb r0,[r1,#2]
 2710 0334 6061     	    str  r0,[UPP,#DATALEN]
 2711 0336 4FF00502 	    mov r2,#5 
 2712 033a 2261     	    str r2,[UPP,#DATA]
 2713 033c E1E7     	    b 1b 
 2714 033e 4FF00C00 	2:  mov r0,#ERR_NO_DATA
 2715 0342 FFF7FEBF 	    b tb_error 
 2716 0346 7047     	9:  _RET 
 2717              	
 2718              	/********************************
 2719              	  BASIC: RESTORE 
 2720              	  seek first data line 
ARM GAS  tinyBasic.s 			page 74


 2721              	********************************/
 2722              	    _FUNC restore
 2723 0348 206C10F0 	    _RTO 
 2723      010F03D1 
 2723      4FF00700 
 2723      FFF7FEBF 
 2724 0358 216B     	    ldr r1,[UPP,#TXTBGN]
 2725 035a 606B     	1:  ldr r0,[UPP,#TXTEND]
 2726 035c 0FD0     	    beq no_data_line 
 2727 035e 0879     	    ldrb r0,[r1,#4]
 2728 0360 0C28     	    cmp r0,#DATA_IDX
 2729 0362 09D1     	    bne try_next_line
 2730 0364 C878     	    ldrb r0,[r1,#3]
 2731 0366 1728     	    cmp r0,#TK_CMD
 2732 0368 06D1     	    bne try_next_line
 2733              	// this a the first data line 
 2734 036a E160     	    str r1,[UPP,#DATAPTR]
 2735 036c 8878     	    ldrb r0,[r1,#2]
 2736 036e 6061     	    str r0,[UPP,#DATALEN]
 2737 0370 4FF00500 	    mov r0,#5 
 2738 0374 2061     	    str r0,[UPP,#DATA]
 2739 0376 07E0     	    b 9f
 2740              	try_next_line:
 2741 0378 8878     	    ldrb r0,[r1,#2]
 2742 037a 0144     	    add r1,r0 
 2743 037c EDE7     	    b 1b 
 2744              	no_data_line:
 2745 037e 80EA0000 	    eor r0,r0 
 2746 0382 E060     	    str r0,[UPP,#DATAPTR]
 2747 0384 2061     	    str r0,[UPP,#DATA]
 2748 0386 6061     	    str r0,[UPP,#DATALEN]
 2749 0388 7047     	9:  _RET 
 2750              	
 2751              	/***********************************
 2752              	  BASIC: DEC 
 2753              	  switch base to decimal 
 2754              	***********************************/
 2755 038a 00BF     	    _FUNC dec_base
 2756 038c 4FF00A00 	    mov r0,#10
 2757 0390 A061     	    str r0,[UPP,#BASE]
 2758 0392 7047     	    _RET 
 2759              	
 2760              	/***************************************
 2761              	  BASIC: DO 
 2762              	  initialize a DO..UNTIL loop 
 2763              	***************************************/
 2764              	    _FUNC do_loop
 2765 0394 2CE9000C 	    stmdb DP!,{IN,BPTR}
 2766 0398 7047     	    _RET 
 2767              	
 2768              	
 2769              	/****************************************
 2770              	  BASIC: DUMP adr, count 
 2771              	    command line only  
 2772              	    print memory content in hexadecimal 
 2773              	    16 bytes per row 
 2774              	    ouput:
ARM GAS  tinyBasic.s 			page 75


 2775              	      none 
 2776              	    use:
 2777              	      r2   byte counter  
 2778              	****************************************/
 2779 039a 00BF     	    _FUNC dump 
 2780 039c 206C10F0 	    _CLO 
 2780      010F03D0 
 2780      4FF00700 
 2780      FFF7FEBF 
 2781 03ac 00B5FFF7 	    _CALL arg_list 
 2781      FEFF5DF8 
 2781      04EB
 2782 03b6 0228     	    cmp r0,#2
 2783 03b8 7FF4FEAF 	    bne syntax_error 
 2784 03bc 5CF8042B 	    _POP r2   // count 
 2785 03c0 5CF8040B 	    _POP  r0  // adr
 2786              	dump01:
 2787 03c4 00B500F0 	    _CALL print_dump_header 
 2787      0DF85DF8 
 2787      04EB
 2788 03ce 4FF01001 	1:  mov r1,#16
 2789 03d2 00B5FFF7 	    _CALL prt_row 
 2789      FEFF5DF8 
 2789      04EB
 2790 03dc 103A     	    subs r2,#16 
 2791 03de F6D5     	    bpl 1b 
 2792 03e0 7047     	    _RET 
 2793              	
 2794              	/********************************
 2795              	   print_dump_header
 2796              	********************************/
 2797 03e2 00BF     	    _FUNC print_dump_header
 2798 03e4 2DE90103 	    push {r0,T1,T2}
 2799 03e8 4FF00C00 	    mov r0,#12 
 2800 03ec 00B5FFF7 	    _CALL cursor_x 
 2800      FEFF5DF8 
 2800      04EB
 2801 03f6 4FF00000 	    mov r0,#0
 2802 03fa 4FF01009 	    mov T2,#16
 2803 03fe 8046     	1:  mov T1,r0 
 2804 0400 00B5FFF7 	    _CALL print_hex 
 2804      FEFF5DF8 
 2804      04EB
 2805 040a 08F10100 	    add r0,T1,#1  
 2806 040e 4845     	    cmp r0,T2 
 2807 0410 F5D4     	    bmi 1b 
 2808 0412 00B5FFF7 	    _CALL cr
 2808      FEFF5DF8 
 2808      04EB
 2809 041c 4FF03D00 	    mov r0,#'='
 2810 0420 4FF04F08 	    mov T1,#79
 2811 0424 00B5FFF7 	2:  _CALL uart_putc
 2811      FEFF5DF8 
 2811      04EB
 2812 042e B8F10108 	    subs T1,#1 
 2813 0432 F7D1     	    bne 2b     
 2814 0434 00B5FFF7 	    _CALL cr
ARM GAS  tinyBasic.s 			page 76


 2814      FEFF5DF8 
 2814      04EB
 2815 043e BDE80103 	    pop {r0,T1,T2}
 2816 0442 7047     	    _RET 
 2817              	
 2818              	
 2819              	/*******************************
 2820              	  BASIC: END 
 2821              	  exit program 
 2822              	******************************/ 
 2823              	    _FUNC cmd_end
 2824 0444 FFF7FEBF 	    b warm_start 
 2825 0448 7047     	    _RET 
 2826              	
 2827              	/*******************************************
 2828              	  BASIC: STORE adr, value 
 2829              	  write value to user space in flash memory 
 2830              	*********************************************/
 2831 044a 00BF     	    _FUNC store 
 2832 044c 00B5FFF7 	    _CALL arg_list 
 2832      FEFF5DF8 
 2832      04EB
 2833 0456 0228     	    cmp r0,#2 
 2834 0458 7FF4FEAF 	    bne syntax_error 
 2835 045c BCE80300 	    ldmia DP!,{r0,r1}
 2836 0460 DFF83020 	    ldr r2,user_space
 2837 0464 9142     	    cmp r1,r2 
 2838 0466 03D5     	    bpl 1f 
 2839 0468 4FF00A00 	0:  mov r0,#ERR_BAD_VALUE
 2840 046c FFF7FEBF 	    b tb_error 
 2841 0470 02F58062 	1:  add r2,#1024 
 2842 0474 9142     	    cmp r1,r2 
 2843 0476 F7D5     	    bpl 0b 
 2844 0478 00B5FFF7 	    _CALL flash_store 
 2844      FEFF5DF8 
 2844      04EB
 2845 0482 7047     	    _RET 
 2846              	
 2847              	/**************************************************
 2848              	  BASIC: ERASE 
 2849              	  erase user space page 
 2850              	*************************************************/
 2851              	    _FUNC erase 
 2852 0484 DFF80C00 	    ldr r0,user_space 
 2853 0488 00B5FFF7 	    _CALL erase_page 
 2853      FEFF5DF8 
 2853      04EB
 2854 0492 7047     	    _RET 
 2855 0494 00000000 	user_space: .word user 
 2856              	
 2857              	
 2858              	/**************************************************
 2859              	  BASIC: FOR var=expr TO expr [STEP exp] ... NEXT 
 2860              	  introdure FOR...NEXT loop 
 2861              	**************************************************/
 2862              	    _FUNC for
 2863 0498 2CE9E000 	    stmdb r12!,{VADR,LIMIT,INCR}
ARM GAS  tinyBasic.s 			page 77


 2864 049c 4FF00107 	    mov INCR,#1
 2865 04a0 00B5FFF7 	    _CALL next_token
 2865      FEFF5DF8 
 2865      04EB
 2866 04aa 1428     	    cmp r0,#TK_VAR
 2867 04ac 7FF4FEAF 	    bne syntax_error
 2868 04b0 02B4     	    push {r1} 
 2869 04b2 00B500F0 	    _CALL let_var 
 2869      25F95DF8 
 2869      04EB
 2870 04bc 20BC     	    pop {VADR}
 2871 04be 4FEA8505 	    lsl VADR,#2
 2872 04c2 2544     	    add VADR,UPP 
 2873 04c4 05F16005 	    add VADR,#VARS 
 2874 04c8 7047     	    _RET 
 2875              	
 2876              	/***************************************
 2877              	  BASIC: TO expr 
 2878              	  set limit of FOR...NEXT loop 
 2879              	**************************************/
 2880 04ca 00BF     	    _FUNC to
 2881 04cc 00B5FFF7 	    _CALL expression 
 2881      FEFF5DF8 
 2881      04EB
 2882 04d6 1B28     	    cmp r0,#TK_INTGR
 2883 04d8 7FF4FEAF 	    bne syntax_error 
 2884 04dc 0E46     	    mov LIMIT,r1
 2885              	    // save loop back parameters 
 2886 04de 2CE9000C 	    stmdb DP!,{IN,BPTR}
 2887 04e2 7047     	    _RET 
 2888              	
 2889              	/********************************************
 2890              	  BASIC: STEP expr 
 2891              	  set increment for FOR...NEXT loop 
 2892              	********************************************/
 2893              	    _FUNC step
 2894 04e4 00B5FFF7 	    _CALL expression 
 2894      FEFF5DF8 
 2894      04EB
 2895 04ee 1B28     	    cmp r0,#TK_INTGR
 2896 04f0 7FF4FEAF 	    bne syntax_error 
 2897 04f4 0F46     	    mov INCR,r1
 2898              	    // replace parameters left by TO
 2899 04f6 8CE8000C 	    stmia DP, {IN,BPTR}
 2900 04fa 7047     	    _RET 
 2901              	
 2902              	/********************************************
 2903              	  BASIC: NEXT var 
 2904              	  incrment FOR...NEXT loop variable
 2905              	  exit if variable cross LIMIT 
 2906              	********************************************/
 2907              	    _FUNC next
 2908 04fc 00B5FFF7 	    _CALL next_token 
 2908      FEFF5DF8 
 2908      04EB
 2909 0506 1428     	    cmp r0,#TK_VAR 
 2910 0508 7FF4FEAF 	    bne syntax_error 
ARM GAS  tinyBasic.s 			page 78


 2911 050c 4FEA8101 	    lsl r1,#2 
 2912 0510 2144     	    add r1,UPP 
 2913 0512 01F16001 	    add r1,#VARS 
 2914 0516 A942     	    cmp r1,VADR
 2915 0518 7FF4FEAF 	    bne syntax_error 
 2916 051c 2868     	    ldr r0,[VADR]
 2917 051e 3844     	    add r0,INCR 
 2918 0520 2860     	    str r0,[VADR]
 2919 0522 002F     	    cmp INCR,#0
 2920 0524 02D4     	    bmi 2f
 2921 0526 B042     	    cmp r0,LIMIT 
 2922 0528 02DC     	    bgt 8f  
 2923 052a 07E0     	    b 9f  
 2924 052c B042     	2:  cmp r0,LIMIT 
 2925 052e 05DA     	    bge 9f  
 2926              	8: // exit for...next
 2927              	  //  drop branch parameters
 2928 0530 4FF00800 	    _DROP 2
 2928      8444
 2929              	  // restore outer loop parameters
 2930 0536 BCE8E000 	    ldmia DP!,{VADR,LIMIT,INCR}
 2931 053a 7047     	    _RET 
 2932 053c 9CE8000C 	9:  ldmia DP,{IN,BPTR}
 2933 0540 9BF80200 	    ldrb r0,[BPTR,#2]
 2934 0544 6060     	    str r0,[UPP,#COUNT]
 2935 0546 00B5FFF7 	    _CALL show_trace 
 2935      FEFF5DF8 
 2935      04EB
 2936 0550 7047     	    _RET 
 2937              	
 2938              	
 2939              	/*********************************
 2940              	  BASIC: GOSUB expr 
 2941              	  call a subroutine at line# 
 2942              	*********************************/
 2943 0552 00BF     	    _FUNC gosub
 2944 0554 00B5FFF7 	    _CALL search_target 
 2944      FEFF5DF8 
 2944      04EB
 2945 055e 2DE9000C 	    push {IN,BPTR}
 2946              	target:
 2947 0562 8346     	    mov BPTR,r0 
 2948 0564 4FF0030A 	    mov IN,#3 
 2949 0568 9BF80200 	    ldrb r0,[BPTR,#2]
 2950 056c 6060     	    str r0,[UPP,#COUNT]
 2951 056e 00B5FFF7 	    _CALL show_trace 
 2951      FEFF5DF8 
 2951      04EB
 2952 0578 7047     	    _RET 
 2953              	
 2954              	/**********************************
 2955              	  BASIC: RETURN 
 2956              	  leave a subroutine 
 2957              	*********************************/
 2958 057a 00BF     	    _FUNC return 
 2959 057c BDE8000C 	    pop {IN,BPTR}
 2960 0580 9BF80200 	    ldrb r0,[BPTR,#2]
ARM GAS  tinyBasic.s 			page 79


 2961 0584 6060     	    str r0,[UPP,#COUNT]
 2962 0586 00B5FFF7 	    _CALL show_trace 
 2962      FEFF5DF8 
 2962      04EB
 2963 0590 7047     	    _RET 
 2964              	
 2965              	/**********************************
 2966              	  BASIC: GOTO expr 
 2967              	  go to line # | label 
 2968              	**********************************/
 2969 0592 00BF     	    _FUNC goto
 2970 0594 00B5FFF7 	    _CALL search_target 
 2970      FEFF5DF8 
 2970      04EB
 2971 059e E0E7     	    b target  
 2972              	
 2973              	/***************************************
 2974              	  BASIC: HEX 
 2975              	  set numeric base to hexadecimal 
 2976              	***************************************/
 2977              	    _FUNC hex_base
 2978 05a0 4FF01000 	    mov r0,#16 
 2979 05a4 A061     	    str r0,[UPP,#BASE]
 2980 05a6 7047     	    _RET 
 2981              	
 2982              	/**********************************************
 2983              	  BASIC: IF relation THEN statement
 2984              	  execute statement only if relation is true
 2985              	*********************************************/
 2986              	    _FUNC if
 2987 05a8 00B5FFF7 	    _CALL relation 
 2987      FEFF5DF8 
 2987      04EB
 2988 05b2 09B9     	    cbnz r1,9f 
 2989 05b4 D4F804A0 	    ldr IN,[UPP,#COUNT]
 2990 05b8 7047     	9:  _RET 
 2991              	
 2992              	/*******************************************************
 2993              	  BASIC: THEN statement
 2994              	  statements following THEN are executed if relation is !=0
 2995              	  optional, retained for compatibility.
 2996              	******************************************************/
 2997 05ba 00BF     	    _FUNC then 
 2998              	// do nothing 
 2999 05bc 7047     	    _RET
 3000              	
 3001              	/****************************************
 3002              	  BASIC: INPUT [string]var [,[string]var]+
 3003              	  prompt user for variable value
 3004              	***************************************/
 3005 05be 00BF     	     _FUNC input_var
 3006 05c0 2DE90401 	    push {r2,T1}
 3007 05c4 00B5FFF7 	1:  _CALL next_token 
 3007      FEFF5DF8 
 3007      04EB
 3008 05ce 0228     	    cmp r0,#2
 3009 05d0 67D4     	    bmi 8f 
ARM GAS  tinyBasic.s 			page 80


 3010 05d2 1C28     	    cmp r0,#TK_QSTR 
 3011 05d4 12D1     	    bne 2f 
 3012 05d6 0846     	    mov r0,r1
 3013 05d8 DFF8D810 	    ldr r1,str_buffer
 3014 05dc 00B5FFF7 	    _CALL strcpy
 3014      FEFF5DF8 
 3014      04EB
 3015 05e6 4FF01400 	    mov r0,#TK_VAR   
 3016 05ea 00B5FFF7 	    _CALL expect 
 3016      FEFF5DF8 
 3016      04EB
 3017 05f4 8846     	    mov T1,r1 
 3018 05f6 DFF8BC00 	    ldr r0,str_buffer 
 3019 05fa 08E0     	    b 3f 
 3020 05fc 1428     	2:  cmp r0,#TK_VAR 
 3021 05fe 7FF4FEAF 	    bne syntax_error     
 3022 0602 8846     	    mov T1,r1 
 3023 0604 01F14100 	    add r0,r1,#'A' 
 3024 0608 2A49     	    ldr r1,str_buffer
 3025 060a 0880     	    strh r0,[r1]
 3026 060c 0846     	    mov r0,r1 
 3027 060e 00B5FFF7 	3:  _CALL uart_puts  
 3027      FEFF5DF8 
 3027      04EB
 3028 0618 4FF03D00 	    mov r0,#'='
 3029 061c 00B5FFF7 	    _CALL uart_putc
 3029      FEFF5DF8 
 3029      04EB
 3030 0626 DFF88800 	    ldr r0,input_buffer
 3031 062a 4FF02201 	    mov r1,#34 
 3032 062e 00B5FFF7 	    _CALL readln
 3032      FEFF5DF8 
 3032      04EB
 3033 0638 31B3     	    cbz r1,6f
 3034 063a 0178     	    ldrb r1,[r0]
 3035 063c 01B4     	    push {r0}
 3036 063e 0846     	    mov r0,r1
 3037 0640 00B5FFF7 	    _CALL is_letter 
 3037      FEFF5DF8 
 3037      04EB
 3038 064a 01BC     	    pop {r0}
 3039 064c 02D1     	    bne 3f 
 3040 064e 01F05F01 	    and r1,#0x5f // uppercase  
 3041 0652 19E0     	    b 6f 
 3042 0654 2429     	3:  cmp r1,#'$'
 3043 0656 04D1     	    bne 3f 
 3044 0658 4FF01001 	    mov r1,#16
 3045 065c 00F10100 	    add r0,#1  
 3046 0660 08E0     	    b 5f 
 3047 0662 2629     	3:  cmp r1,#'&' 
 3048 0664 04D1     	    bne 4f 
 3049 0666 4FF00201 	    mov r1,#2
 3050 066a 00F10100 	    add r0,#1 
 3051 066e 01E0     	    b 5f 
 3052 0670 4FF00A01 	4:  mov r1,#10 
 3053 0674 00B5FFF7 	5:  _CALL atoi 
 3053      FEFF5DF8 
ARM GAS  tinyBasic.s 			page 81


 3053      04EB
 3054 067e 18B9     	    cbnz r0,6f
 3055 0680 4FF00A00 	    mov r0,#ERR_BAD_VALUE
 3056 0684 FFF7FEBF 	    b tb_error
 3057 0688 4046     	6:  mov r0,T1 
 3058 068a 00B5FFF7 	    _CALL set_var
 3058      FEFF5DF8 
 3058      04EB
 3059 0694 00B5FFF7 	    _CALL next_token
 3059      FEFF5DF8 
 3059      04EB
 3060 069e 0228     	    cmp r0,#TK_COMMA 
 3061 06a0 90D0     	    beq 1b 
 3062 06a2 D4F800A0 	8:  _UNGET_TOKEN          
 3062      D4F808B0 
 3063 06aa BDE80401 	9:  pop {r2,T1}       
 3064 06ae 7047     	    _RET 
 3065 06b0 00000000 	input_buffer: .word _tib 
 3066 06b4 00000000 	str_buffer: .word _pad 
 3067              	
 3068              	
 3069              	/*****************************************
 3070              	  BASIC: INVERT(expr)
 3071              	  return 1's complement of expr
 3072              	****************************************/
 3073              	    _FUNC invert
 3074 06b8 00B5FFF7 	    _CALL func_args
 3074      FEFF5DF8 
 3074      04EB
 3075 06c2 0128     	    cmp r0,#1 
 3076 06c4 7FF4FEAF 	    bne syntax_error
 3077 06c8 5CF8041B 	    _POP r1  
 3078 06cc 6FEA0101 	    mvn r1,r1
 3079 06d0 4FF01B00 	    mov r0,#TK_INTGR
 3080 06d4 7047     	    _RET 
 3081              	
 3082              	/*************************************
 3083              	  BASIC: KEY 
 3084              	  wait for a character from console
 3085              	*************************************/
 3086 06d6 00BF     	    _FUNC key
 3087 06d8 00B5FFF7 	    _CALL uart_getc
 3087      FEFF5DF8 
 3087      04EB
 3088 06e2 0146     	    mov r1,r0
 3089 06e4 4FF01300 	    mov r0,#TK_CHAR 
 3090 06e8 7047     	    _RET  
 3091              	
 3092              	/******************************
 3093              	  BASIC: [LET] var=expr 
 3094              	         [LET] @(expr)=expr
 3095              	  input:
 3096              	    none 
 3097              	  output:
 3098              	    none 
 3099              	  use:
 3100              	
ARM GAS  tinyBasic.s 			page 82


 3101              	****************************/         
 3102 06ea 00BF     	    _FUNC let
 3103 06ec 00B5FFF7 	    _CALL next_token 
 3103      FEFF5DF8 
 3103      04EB
 3104 06f6 1428     	    cmp r0,#TK_VAR
 3105 06f8 03D0     	    beq let_var 
 3106 06fa 0C28     	    cmp r0,#TK_ARRAY 
 3107 06fc 07D0     	    beq let_array 
 3108 06fe FFF7FEBF 	    b syntax_error 
 3109              	let_var:
 3110 0702 4FEA8101 	    lsl r1,#2
 3111 0706 04F16000 	    add r0,UPP,#VARS
 3112 070a 0844     	    add r0,r1
 3113 070c 1FE0     	    b 1f 
 3114              	let_array: 
 3115 070e 4FF00500 	    mov r0,#TK_LPAREN
 3116 0712 00B5FFF7 	    _CALL expect 
 3116      FEFF5DF8 
 3116      04EB
 3117 071c 00B5FFF7 	    _CALL expression
 3117      FEFF5DF8 
 3117      04EB
 3118 0726 1B28     	    cmp r0,#TK_INTGR 
 3119 0728 7FF4FEAF 	    bne syntax_error
 3120 072c 4CF8041D 	    _PUSH r1 
 3121 0730 4FF00600 	    mov r0,#TK_RPAREN
 3122 0734 00B5FFF7 	    _CALL expect 
 3122      FEFF5DF8 
 3122      04EB
 3123 073e 5CF8041B 	    _POP r1 
 3124 0742 D4F8C800 	    ldr r0,[UPP,#ARRAY_ADR]
 3125 0746 4FEA8101 	    lsl r1,#2 
 3126 074a A0EB0100 	    sub r0,r1 
 3127 074e 4CF8040D 	1:  _PUSH r0 
 3128 0752 4FF00D00 	    mov r0,#TK_EQUAL 
 3129 0756 00B5FFF7 	    _CALL expect 
 3129      FEFF5DF8 
 3129      04EB
 3130 0760 00B5FFF7 	    _CALL expression   
 3130      FEFF5DF8 
 3130      04EB
 3131 076a 1B28     	    cmp r0,#TK_INTGR
 3132 076c 7FF4FEAF 	    bne syntax_error   
 3133 0770 5CF8040B 	2:  _POP r0 
 3134 0774 0160     	    str r1,[r0]
 3135 0776 7047     	    _RET  
 3136              	
 3137              	/***************************************
 3138              	  BASIC: LIST [[first]-last]
 3139              	  use:
 3140              	    r2   first line# 
 3141              	    r3   last line#
 3142              	    T1   *line 
 3143              	    T2   TXTEND 
 3144              	**************************************/  
 3145              	    _FUNC list
ARM GAS  tinyBasic.s 			page 83


 3146 0778 206C10F0 	    _CLO
 3146      010F03D0 
 3146      4FF00700 
 3146      FFF7FEBF 
 3147 0788 D4F83080 	    ldr T1,[UPP,#TXTBGN]
 3148 078c D4F83490 	    ldr T2,[UPP,#TXTEND]
 3149 0790 B8F80020 	    ldrh r2,[T1]
 3150 0794 4FF6FF73 	    mov r3,#65535 
 3151 0798 00B5FFF7 	    _CALL next_token 
 3151      FEFF5DF8 
 3151      04EB
 3152 07a2 10B3     	    cbz r0,6f 
 3153 07a4 1B28     	    cmp r0,#TK_INTGR
 3154 07a6 09D1     	    bne 1f 
 3155 07a8 0A46     	    mov r2,r1 // first line
 3156 07aa 00B5FFF7 	    _CALL next_token
 3156      FEFF5DF8 
 3156      04EB
 3157 07b4 0028     	    cmp r0,#TK_NONE 
 3158 07b6 01D1     	    bne 1f 
 3159 07b8 1346     	    mov r3,r2 
 3160 07ba 0CE0     	    b 4f 
 3161 07bc 0828     	1:  cmp r0,#TK_MINUS 
 3162 07be 7FF4FEAF 	    bne syntax_error 
 3163 07c2 00B5FFF7 	    _CALL next_token 
 3163      FEFF5DF8 
 3163      04EB
 3164 07cc 18B1     	    cbz r0,4f 
 3165 07ce 1B28     	    cmp r0,#TK_INTGR
 3166 07d0 7FF4FEAF 	    bne syntax_error  
 3167 07d4 0B46     	    mov r3,r1 
 3168              	4:  // skip lines below r2 
 3169 07d6 B8F80000 	    ldrh r0,[T1]
 3170 07da 9042     	    cmp r0,r2 
 3171 07dc 05D5     	    bpl 6f 
 3172 07de 98F80200 	    ldrb r0,[T1,#2]
 3173 07e2 8044     	    add T1,r0
 3174 07e4 C845     	    cmp T1,T2 
 3175 07e6 F6D4     	    bmi 4b
 3176 07e8 1AE0     	    b 9f 
 3177 07ea C845     	6:  cmp T1,T2  
 3178 07ec 18D5     	    bpl 9f
 3179 07ee 4046     	    mov r0,T1   
 3180 07f0 DFF83010 	    ldr r1,out_buff 
 3181 07f4 00B5FFF7 	    _CALL decompile_line 
 3181      FEFF5DF8 
 3181      04EB
 3182 07fe 00B5FFF7 	    _CALL uart_puts 
 3182      FEFF5DF8 
 3182      04EB
 3183 0808 00B5FFF7 	    _CALL cr 
 3183      FEFF5DF8 
 3183      04EB
 3184 0812 98F80200 	    ldrb r0,[T1,#2]
 3185 0816 8044     	    add T1,r0
 3186 0818 B8F80000 	    ldrh r0,[T1]
 3187 081c 9842     	    cmp r0,r3 
ARM GAS  tinyBasic.s 			page 84


 3188 081e E4DD     	    ble 6b 
 3189 0820 FFF7FEBF 	9:  b warm_start 
 3190 0824 00000000 	out_buff: .word _tib 
 3191              	
 3192              	/********************************
 3193              	  BASIC: LOCATE line,col
 3194              	  return log base 2 of expr 
 3195              	********************************/
 3196              	    _FUNC locate
 3197 0828 00B5FFF7 	    _CALL arg_list 
 3197      FEFF5DF8 
 3197      04EB
 3198 0832 0228     	    cmp r0,#2 
 3199 0834 7FF4FEAF 	    bne syntax_error
 3200 0838 5CF8041B 	    _POP r1
 3201 083c 5CF8040B 	    _POP r0  
 3202 0840 00B5FFF7 	    _CALL set_curpos 
 3202      FEFF5DF8 
 3202      04EB
 3203 084a 7047     	    _RET 
 3204              	
 3205              	
 3206              	/****************************************
 3207              	  BASIC: LSHIFT(expr1,expr2)
 3208              	  shift right expr1 of expr2 bits 
 3209              	****************************************/
 3210              	    _FUNC lshift
 3211 084c 00B5FFF7 	    _CALL func_args
 3211      FEFF5DF8 
 3211      04EB
 3212 0856 0228     	    cmp r0,#2
 3213 0858 7FF4FEAF 	    bne syntax_error 
 3214 085c BCE80300 	    ldmia DP!,{r0,r1}
 3215 0860 01FA00F1 	    lsl r1,r0 
 3216 0864 4FF01B00 	    mov r0,#TK_INTGR
 3217 0868 7047     	    _RET 
 3218              	
 3219              	/***********************************
 3220              	  BASIC: NEW 
 3221              	  delete existing program in memory
 3222              	  and clear variables and RAM 
 3223              	***********************************/
 3224 086a 00BF     	    _FUNC new
 3225 086c 206C10F0 	    _CLO 
 3225      010F03D0 
 3225      4FF00700 
 3225      FFF7FEBF 
 3226 087c 00B5FFF7 	    _CALL clear_basic 
 3226      FEFF5DF8 
 3226      04EB
 3227 0886 FFF7FEBF 	    b warm_start   
 3228              	
 3229              	/************************************
 3230              	  BASIC: NOT relation  
 3231              	  invert logical value or relation
 3232              	************************************/
 3233 088a 00BF     	      _FUNC func_not
ARM GAS  tinyBasic.s 			page 85


 3234 088c 00B5FFF7 	      _CALL relation 
 3234      FEFF5DF8 
 3234      04EB
 3235 0896 11B1     	      cbz r1,8f 
 3236 0898 81EA0101 	      eor r1,r1
 3237 089c 01E0     	      b 9f 
 3238 089e 4FF0FF31 	  8:  mov r1,#-1
 3239 08a2 7047     	  9:  _RET 
 3240              	
 3241              	/******************************************
 3242              	  BASIC: OR(expr1,expr2)
 3243              	  binary OR between 2 expressions
 3244              	******************************************/
 3245              	    _FUNC bit_or
 3246 08a4 00B5FFF7 	    _CALL func_args
 3246      FEFF5DF8 
 3246      04EB
 3247 08ae 0228     	    cmp r0,#2
 3248 08b0 7FF4FEAF 	    bne syntax_error
 3249 08b4 5CF8040B 	    _POP r0 
 3250 08b8 5CF8041B 	    _POP r1
 3251 08bc 41EA0001 	    orr r1,r0 
 3252 08c0 4FF01B00 	    mov r0,#TK_INTGR
 3253 08c4 7047     	    _RET 
 3254              	
 3255              	/****************************************
 3256              	  BASIC: IN(gpio,pin) 
 3257              	  read gpio_idr selected pin  
 3258              	***************************************/
 3259 08c6 00BF     	    _FUNC pin_input 
 3260 08c8 00B5FFF7 	    _CALL func_args 
 3260      FEFF5DF8 
 3260      04EB
 3261 08d2 0228     	    cmp r0,#2 
 3262 08d4 7FF4FEAF 	    bne syntax_error  
 3263 08d8 BCE80300 	    ldmia DP!,{r0,r1}
 3264 08dc 4FF00802 	    mov r2,#GPIO_IDR 
 3265 08e0 8A58     	    ldr r2,[r1,r2]
 3266 08e2 00F00F00 	    and r0,#15 
 3267 08e6 22FA00F2 	    lsr r2,r0 
 3268 08ea 02F00101 	    and r1,r2,#1 
 3269 08ee 4FF01B00 	    mov r0,#TK_INTGR
 3270 08f2 7047     	    _RET 
 3271              	
 3272              	
 3273              	/****************************************
 3274              	  BASIC: OUT gpio,pin,value 
 3275              	   output to gpio_odr
 3276              	***************************************/
 3277              	    _FUNC out
 3278 08f4 00B5FFF7 	    _CALL arg_list 
 3278      FEFF5DF8 
 3278      04EB
 3279 08fe 0328     	    cmp r0,#3 
 3280 0900 7FF4FEAF 	    bne syntax_error 
 3281 0904 BCE80700 	    ldmia DP!,{r0,r1,r2} // value,pin,gpio 
 3282 0908 4FF01003 	    mov r3,#GPIO_BSRR
ARM GAS  tinyBasic.s 			page 86


 3283 090c 08B9     	    cbnz r0,1f 
 3284 090e 01F11001 	    add r1,#16 
 3285 0912 4FF00100 	1:  mov r0,#1 
 3286 0916 00FA01F0 	    lsl r0,r1 
 3287 091a D050     	    str r0,[r2,r3]    
 3288 091c 7047     	    _RET 
 3289              	
 3290              	
 3291              	/****************************************
 3292              	  BASIC: PAD 
 3293              	  return pad buffer address 
 3294              	****************************************/
 3295 091e 00BF     	    _FUNC pad_ref
 3296 0920 0149     	    ldr r1,pad_adr  
 3297 0922 4FF01B00 	    mov r0,#TK_INTGR 
 3298 0926 7047     	    _RET 
 3299 0928 00000000 	pad_adr: .word _pad 
 3300              	
 3301              	/***********************
 3302              	  BASIC: PAUSE expr 
 3303              	  suspend execution for 
 3304              	  expr milliseconds 
 3305              	************************/
 3306              	    _FUNC pause
 3307 092c 00B5FFF7 	    _CALL expression 
 3307      FEFF5DF8 
 3307      04EB
 3308 0936 1B28     	    cmp r0,#TK_INTGR 
 3309 0938 7FF4FEAF 	    bne syntax_error 
 3310 093c E069     	    ldr r0,[UPP,#TICKS]
 3311 093e 0844     	    add r0,r1 
 3312 0940 E169     	1:  ldr r1,[UPP,#TICKS]
 3313 0942 8842     	    cmp r0,r1 
 3314 0944 FCD1     	    bne 1b     
 3315 0946 7047     	    _RET 
 3316              	
 3317              	/***************************************************
 3318              	  BASIC: PMODE \c,pin,mode[,opt] 
 3319              	  configure a digital pin for input|output
 3320              	  paramters:
 3321              	    \c    port letter
 3322              	    pin   pin {0..15} 
 3323              	    mode  0->input,1->output 10Mhz,2->output 2Mhz,3->output 50Mhz 
 3324              	    for input mode:
 3325              	      opt 0->analog, 1->floating,2->pulldown,3->pullup  
 3326              	    for output mode:
 3327              	      opt 0-> GPIO pushpull, 1->GPIO opendrain, 2->AF pushpull, 3->AF opendrain 
 3328              	  use:
 3329              	    r2  opt
 3330              	    r3  mode 
 3331              	    T1  pin  
 3332              	    T2  port      
 3333              	***************************************************/
 3334              	      _FUNC pin_mode
 3335 0948 4FF01300 	      mov r0,#TK_CHAR 
 3336 094c 00B5FFF7 	      _CALL expect
 3336      FEFF5DF8 
ARM GAS  tinyBasic.s 			page 87


 3336      04EB
 3337 0956 0846     	      mov r0,r1 
 3338 0958 00B5FFF7 	      _CALL upper 
 3338      FEFF5DF8 
 3338      04EB
 3339 0962 A0F14109 	      sub T2,r0,#'A'
 3340 0966 4FF00200 	      mov r0,#TK_COMMA
 3341 096a 00B5FFF7 	      _CALL expect 
 3341      FEFF5DF8 
 3341      04EB
 3342 0974 00B5FFF7 	      _CALL arg_list
 3342      FEFF5DF8 
 3342      04EB
 3343 097e 0228     	      cmp r0,#2 
 3344 0980 3FF5FEAF 	      bmi syntax_error
 3345 0984 0428     	      cmp r0,#4
 3346 0986 01D4     	      bmi 1f 
 3347 0988 FFF7FEBF 	      b syntax_error
 3348 098c 4FF00002 	  1:  mov r2,#0 // default opt, input floating or output opendrain 
 3349 0990 0228     	      cmp r0,#2
 3350 0992 02D0     	      beq 2f 
 3351              	// 3 parameters, pin,mode,opt  
 3352 0994 BCE80C01 	    ldmia DP!,{r2,r3,T1}
 3353 0998 01E0     	    b 4f  
 3354              	2: // 2 parameters, pin,mode 
 3355 099a BCE80801 	    ldmia DP!,{r3,T1}
 3356 099e 4FF48060 	4:  mov r0,#0x400 
 3357 09a2 00FB09F9 	    mul T2,r0 
 3358 09a6 4FF40060 	    _MOV32 r0,GPIOA_BASE_ADR
 3358      C4F20100 
 3359 09ae 8144     	    add T2,r0 // port base address 
 3360              	// if input mode set pull in ODR 
 3361 09b0 83B9     	    cbnz r3,2f 
 3362 09b2 022A     	    cmp r2,#2
 3363 09b4 0ED4     	    bmi 2f 
 3364 09b6 4FF00100 	    mov r0,#1 
 3365 09ba 4146     	    mov r1,T1 
 3366 09bc 032A     	    cmp r2,#3 
 3367 09be 01D0     	    beq 1f
 3368 09c0 01F11001 	    add r1,#16 //reset bit 
 3369 09c4 00FA01F0 	1:  lsl r0,r1
 3370 09c8 C9F81000 	    str r0,[T2,#GPIO_BSRR]
 3371 09cc 032A     	    cmp r2,#3 
 3372 09ce 01D4     	    bmi 2f 
 3373 09d0 A2F10102 	    sub r2,#1
 3374              	2: // set CNF|MODE bits GPIO_CRx 
 3375 09d4 B8F1080F 	    cmp T1,#8 
 3376 09d8 03D4     	    bmi 3f 
 3377 09da A8F10808 	    sub T1,#8 
 3378 09de 09F10409 	    add T2,#4 //CRH 
 3379 09e2 4FF00F00 	3:  mov r0,#15   
 3380 09e6 4FEA8801 	    lsl r1,T1,#2 
 3381 09ea 00FA01F0 	    lsl r0,r1
 3382 09ee 6FEA0000 	    mvn r0,r0 // bitmask 
 3383 09f2 D9F80010 	    ldr r1,[T2]
 3384 09f6 01EA0001 	    and r1,r0  // clear CNF|MODE bits  
 3385              	// combine opt|mode     
ARM GAS  tinyBasic.s 			page 88


 3386 09fa 4FEA8200 	    lsl r0,r2,#2 
 3387 09fe 40EA0300 	    orr r0,r3 // OPT|MODE 
 3388 0a02 4FEA8803 	    lsl r3,T1,#2 
 3389 0a06 00FA03F0 	    lsl r0,r3
 3390 0a0a 41EA0001 	    orr r1,r0   
 3391 0a0e C9F80010 	    str r1,[T2] // mode and option set
 3392 0a12 7047     	    _RET 
 3393              	
 3394              	
 3395              	/*****************************************
 3396              	  BASIC: PEEK8 (expr)  
 3397              	  return byte value at address 
 3398              	*****************************************/
 3399              	    _FUNC peek8
 3400 0a14 00B5FFF7 	    _CALL func_args  
 3400      FEFF5DF8 
 3400      04EB
 3401 0a1e 0128     	    cmp r0,#1
 3402 0a20 3FF5FEAF 	    bmi syntax_error
 3403 0a24 5CF8041B 	    _POP r1 
 3404 0a28 0978     	    ldrb r1,[r1]
 3405 0a2a 4FF01B00 	    mov r0,#TK_INTGR     
 3406 0a2e 7047     	    _RET 
 3407              	
 3408              	/*****************************************
 3409              	  BASIC: PEEK16 (expr)  
 3410              	  return byte value at address 
 3411              	*****************************************/
 3412              	    _FUNC peek16
 3413 0a30 00B5FFF7 	    _CALL func_args  
 3413      FEFF5DF8 
 3413      04EB
 3414 0a3a 0128     	    cmp r0,#1
 3415 0a3c 3FF5FEAF 	    bmi syntax_error
 3416 0a40 5CF8041B 	    _POP r1 
 3417 0a44 0988     	    ldrh r1,[r1]
 3418 0a46 4FF01B00 	    mov r0,#TK_INTGR     
 3419 0a4a 7047     	    _RET 
 3420              	
 3421              	/*****************************************
 3422              	  BASIC: PEEK32 (expr)  
 3423              	  return byte value at address 
 3424              	*****************************************/
 3425              	    _FUNC peek32
 3426 0a4c 00B5FFF7 	    _CALL func_args  
 3426      FEFF5DF8 
 3426      04EB
 3427 0a56 0128     	    cmp r0,#1
 3428 0a58 3FF5FEAF 	    bmi syntax_error
 3429 0a5c 5CF8041B 	    _POP r1 
 3430 0a60 0968     	    ldr r1,[r1]
 3431 0a62 4FF01B00 	    mov r0,#TK_INTGR     
 3432 0a66 7047     	    _RET 
 3433              	
 3434              	
 3435              	/**********************************
 3436              	  BASIC: POKE8 addr,byte
ARM GAS  tinyBasic.s 			page 89


 3437              	  store byte at addr   
 3438              	**********************************/
 3439              	    _FUNC poke8
 3440 0a68 00B5FFF7 	    _CALL arg_list
 3440      FEFF5DF8 
 3440      04EB
 3441 0a72 0228     	    cmp r0,#2 
 3442 0a74 7FF4FEAF 	    bne syntax_error
 3443 0a78 BCE80300 	    ldmia DP!,{r0,r1} 
 3444 0a7c 0870     	    strb r0,[r1]
 3445 0a7e 7047     	    _RET 
 3446              	
 3447              	/**********************************
 3448              	  BASIC: POKE16 addr,hword
 3449              	  store hword at addr   
 3450              	**********************************/
 3451              	    _FUNC poke16
 3452 0a80 00B5FFF7 	    _CALL arg_list
 3452      FEFF5DF8 
 3452      04EB
 3453 0a8a 0228     	    cmp r0,#2 
 3454 0a8c 7FF4FEAF 	    bne syntax_error
 3455 0a90 BCE80300 	    ldmia DP!,{r0,r1} 
 3456 0a94 0880     	    strh r0,[r1]
 3457 0a96 7047     	    _RET 
 3458              	
 3459              	/**********************************
 3460              	  BASIC: POKE32 addr,word
 3461              	  store word at addr   
 3462              	**********************************/
 3463              	    _FUNC poke32
 3464 0a98 00B5FFF7 	    _CALL arg_list 
 3464      FEFF5DF8 
 3464      04EB
 3465 0aa2 0228     	    cmp r0,#2 
 3466 0aa4 7FF4FEAF 	    bne syntax_error
 3467 0aa8 BCE80300 	    ldmia DP!,{r0,r1} 
 3468 0aac 0860     	    str r0,[r1]
 3469 0aae 7047     	    _RET 
 3470              	
 3471              	
 3472              	
 3473              	/****************************
 3474              	  BASIC: PRINT|? arg_list 
 3475              	  print list of arguments 
 3476              	****************************/
 3477              	    _FUNC print
 3478 0ab0 206C     	    ldr r0,[UPP,#FLAGS]
 3479 0ab2 40F08000 	    orr r0,#FPRINT 
 3480 0ab6 2064     	    str r0,[UPP,#FLAGS]
 3481 0ab8 88EA0808 	    eor T1,T1 
 3482 0abc 00B5FFF7 	0:  _CALL expression
 3482      FEFF5DF8 
 3482      04EB
 3483 0ac6 1B28     	    cmp r0,#TK_INTGR
 3484 0ac8 07D1     	    bne 1f 
 3485 0aca 0846     	    mov r0,r1
ARM GAS  tinyBasic.s 			page 90


 3486 0acc A169     	    ldr r1,[UPP,#BASE]
 3487 0ace 00B5FFF7 	    _CALL print_int
 3487      FEFF5DF8 
 3487      04EB
 3488 0ad8 3EE0     	    b 8f  
 3489 0ada 00B5FFF7 	1:  _CALL next_token
 3489      FEFF5DF8 
 3489      04EB
 3490 0ae4 0128     	    cmp r0,#TK_COLON 
 3491 0ae6 00DC     	    bgt 2f
 3492 0ae8 4DE0     	    b unget_exit 
 3493 0aea 1C28     	2:  cmp r0,#TK_QSTR 
 3494 0aec 06D1     	    bne 3f
 3495 0aee 0846     	    mov r0,r1 
 3496 0af0 00B5FFF7 	    _CALL uart_puts  
 3496      FEFF5DF8 
 3496      04EB
 3497 0afa 2DE0     	    b 8f 
 3498 0afc 1628     	3:  cmp r0,#TK_CFUNC
 3499 0afe 05D1     	    bne 4f
 3500 0b00 0846     	    mov r0,r1
 3501 0b02 00B5FFF7 	    _CALL execute 
 3501      FEFF5DF8 
 3501      04EB
 3502 0b0c 1328     	4:  cmp r0,#TK_CHAR 
 3503 0b0e 06D1     	    bne 5f 
 3504 0b10 0846     	    mov r0,r1 
 3505 0b12 00B5FFF7 	    _CALL uart_putc 
 3505      FEFF5DF8 
 3505      04EB
 3506 0b1c 1CE0     	    b 8f 
 3507 0b1e 0428     	5:  cmp r0,#TK_SHARP
 3508 0b20 09D1     	    bne 6f 
 3509 0b22 00B5FFF7 	   _CALL next_token
 3509      FEFF5DF8 
 3509      04EB
 3510 0b2c 1B28     	    cmp r0,#TK_INTGR  
 3511 0b2e 7FF4FEAF 	    bne syntax_error 
 3512 0b32 6164     	    str r1,[UPP,#TAB_WIDTH]
 3513 0b34 10E0     	    b 8f 
 3514 0b36 1728     	6:  cmp r0,#TK_CMD 
 3515 0b38 25D1     	    bne unget_exit  
 3516 0b3a 4629     	    cmp r1,#TAB_IDX 
 3517 0b3c 05D1     	    bne 6f
 3518 0b3e 00B500F0 	    _CALL tab 
 3518      9AFA5DF8 
 3518      04EB
 3519 0b48 06E0     	    b 8f 
 3520 0b4a 4229     	6:  cmp r1,#SPC_IDX  
 3521 0b4c 1BD1     	    bne unget_exit
 3522 0b4e 00B500F0 	    _CALL spc   
 3522      54FA5DF8 
 3522      04EB
 3523 0b58 88EA0808 	8:  eor T1,T1  
 3524 0b5c 00B5FFF7 	    _CALL next_token
 3524      FEFF5DF8 
 3524      04EB
ARM GAS  tinyBasic.s 			page 91


 3525 0b66 90B1     	    cbz r0, print_exit  
 3526 0b68 0228     	    cmp r0,#TK_COMMA 
 3527 0b6a 02D1     	    bne 8f 
 3528 0b6c 4FF0FF38 	    mov T1,#-1
 3529 0b70 A4E7     	    b 0b
 3530 0b72 0328     	8:  cmp r0,#TK_SEMIC 
 3531 0b74 07D1     	    bne unget_exit 
 3532 0b76 00B5FFF7 	    _CALL tabulation 
 3532      FEFF5DF8 
 3532      04EB
 3533 0b80 4FF0FF38 	    mov T1,#-1
 3534 0b84 9AE7     	    b 0b
 3535              	unget_exit:         
 3536 0b86 D4F800A0 	   _UNGET_TOKEN 
 3536      D4F808B0 
 3537              	print_exit:
 3538 0b8e 18EA0808 	    ands T1,T1 
 3539 0b92 08D1     	    bne 9f
 3540 0b94 00B5FFF7 	    _CALL cr
 3540      FEFF5DF8 
 3540      04EB
 3541 0b9e 206C     	    ldr r0,[UPP,#FLAGS]
 3542 0ba0 80F08000 	    eor r0,#FPRINT 
 3543 0ba4 2064     	    str r0,[UPP,#FLAGS] 
 3544 0ba6 7047     	9:  _RET 
 3545              	
 3546              	/**************************************
 3547              	  BASIC: QKEY
 3548              	  check if key pressed 
 3549              	**************************************/ 
 3550              	    _FUNC qkey
 3551 0ba8 4FF00001 	    mov r1,#0
 3552 0bac 00B5FFF7 	    _CALL uart_qkey
 3552      FEFF5DF8 
 3552      04EB
 3553 0bb6 01D0     	    beq 9f 
 3554 0bb8 4FF0FF31 	    mov r1,#-1 
 3555 0bbc 4FF01B00 	9:  mov r0,#TK_INTGR
 3556 0bc0 7047     	    _RET 
 3557              	
 3558              	/******************************************
 3559              	  BASIC RANDOM(expr)
 3560              	  generate random number between 0..expr-1
 3561              	******************************************/
 3562 0bc2 00BF     	    _FUNC random
 3563 0bc4 00B5FFF7 	    _CALL func_args 
 3563      FEFF5DF8 
 3563      04EB
 3564 0bce 0128     	    cmp r0,#1
 3565 0bd0 7FF4FEAF 	    bne syntax_error 
 3566 0bd4 606A     	    ldr r0,[UPP,#SEED]
 3567 0bd6 4FEA4031 	    lsl r1,r0,#13
 3568 0bda 81EA0001 	    eor r1,r0
 3569 0bde 4FEA5140 	    lsr r0,r1,#17
 3570 0be2 81EA0001 	    eor r1,r0
 3571 0be6 4FEA4110 	    lsl r0,r1,#5
 3572 0bea 81EA0001 	    eor r1,r0
ARM GAS  tinyBasic.s 			page 92


 3573 0bee 6162     	    str r1,[UPP,#SEED]
 3574 0bf0 5CF8040B 	    _POP r0 
 3575 0bf4 B1FBF0F2 	    udiv r2,r1,r0  
 3576 0bf8 00FB02F2 	    mul r2,r0 
 3577 0bfc A1EB0201 	    sub r1,r2 
 3578 0c00 4FF01B00 	    mov r0,#TK_INTGR
 3579 0c04 7047     	    _RET 
 3580              	
 3581              	/****************************************
 3582              	  BASIC: RSHIFT(expr1,expr2)
 3583              	  shift left expr1 de expr2 bits 
 3584              	****************************************/
 3585 0c06 00BF     	    _FUNC rshift
 3586 0c08 00B5FFF7 	    _CALL func_args
 3586      FEFF5DF8 
 3586      04EB
 3587 0c12 0228     	    cmp r0,#2 
 3588 0c14 7FF4FEAF 	    bne syntax_error
 3589 0c18 BCE80300 	    ldmia DP!,{r0,r1}
 3590 0c1c 21FA00F1 	    lsr r1,r0  
 3591 0c20 4FF01B00 	    mov r0,#TK_INTGR
 3592 0c24 7047     	    _RET 
 3593              	
 3594              	/****************************
 3595              	  BASIC: RUN 
 3596              	  execute program in memory
 3597              	****************************/
 3598 0c26 00BF     	    _FUNC run
 3599 0c28 206C10F0 	    _CLO 
 3599      010F03D0 
 3599      4FF00700 
 3599      FFF7FEBF 
 3600 0c38 206B     	    ldr r0,[UPP,#TXTBGN]
 3601 0c3a 616B     	    ldr r1,[UPP,#TXTEND]
 3602 0c3c C4F8D010 	    str r1,[UPP,#HERE]
 3603 0c40 8842     	    cmp r0,r1
 3604 0c42 21D0     	    beq 9f
 3605 0c44 216C     	    ldr r1,[UPP,#FLAGS]
 3606 0c46 11F0080F 	    tst r1,#FSTOP
 3607 0c4a 09D0     	    beq 1f
 3608 0c4c BCE8010C 	    ldmia DP!,{r0,IN,BPTR}
 3609 0c50 6060     	    str r0,[UPP,#COUNT]
 3610 0c52 206C     	    ldr r0,[UPP,#FLAGS]
 3611 0c54 4FF00901 	    mov r1,#FRUN+FSTOP
 3612 0c58 80EA0100 	    eor r0,r1
 3613 0c5c 2064     	    str r0,[UPP,#FLAGS] 
 3614 0c5e 13E0     	    b 9f  
 3615 0c60 8178     	1:  ldrb r1,[r0,#2]
 3616 0c62 6160     	    str r1,[UPP,#COUNT]
 3617 0c64 8346     	    mov BPTR,r0 
 3618 0c66 4FF0030A 	    mov IN,#3
 3619 0c6a 606B     	    ldr r0,[UPP,#TXTEND]
 3620              	    // reset dataline pointers 
 3621 0c6c 80EA0000 	    eor r0,r0 
 3622 0c70 E060     	    str r0,[UPP,#DATAPTR]
 3623 0c72 2061     	    str r0,[UPP,#DATA]
 3624 0c74 6061     	    str r0,[UPP,#DATALEN] 
ARM GAS  tinyBasic.s 			page 93


 3625 0c76 206C     	    ldr r0,[UPP,#FLAGS]
 3626 0c78 40F00100 	    orr r0,#FRUN 
 3627 0c7c 2064     	    str r0,[UPP,#FLAGS]
 3628 0c7e 00B5FFF7 	    _CALL show_trace 
 3628      FEFF5DF8 
 3628      04EB
 3629 0c88 7047     	9:  _RET 
 3630              	
 3631              	/**********************************
 3632              	        FILE SYSTEM 
 3633              	**********************************/
 3634              	
 3635              	/*********************************
 3636              	  search_free 
 3637              	  search first free PAGE in fs
 3638              	  a PAGE is free if first word is
 3639              	  -1
 3640              	  input:
 3641              	    none 
 3642              	  output:
 3643              	    r0    addr|0
 3644              	  use:
 3645              	*********************************/
 3646 0c8a 00BF     	    _FUNC search_free 
 3647 0c8c 06B4     	    push {r1,r2}
 3648 0c8e DFF86410 	    ldr r1,fs_addr 
 3649 0c92 4FF00002 	    _MOV32 r2,FLASH_HIDDEN_END
 3649      C0F60202 
 3650 0c9a 0868     	1:  ldr r0,[r1]
 3651 0c9c B0F1FF3F 	    cmp r0,#-1
 3652 0ca0 03D0     	    beq 8f 
 3653 0ca2 01F58061 	    add r1,#PAGE_SIZE
 3654 0ca6 9142     	    cmp r1,r2 
 3655 0ca8 F7D4     	    bmi 1b 
 3656 0caa 0846     	8:  mov r0,r1 
 3657 0cac 06BC     	    pop {r1,r2}   
 3658 0cae 7047     	    _RET 
 3659              	
 3660              	/*********************************
 3661              	  search_file 
 3662              	  search for a file name 
 3663              	  in file system.
 3664              	  input: 
 3665              	    r0   .asciz target name
 3666              	  output:
 3667              	    r0    0 || address found 
 3668              	  use:
 3669              	   r0     temp 
 3670              	   r1     *file_name 
 3671              	   r2     *fs  
 3672              	   r3     target   
 3673              	**********************************/
 3674              	    _FUNC search_file 
 3675 0cb0 0EB4     	    push {r1,r2,r3}
 3676 0cb2 DFF84020 	    ldr r2,fs_addr
 3677 0cb6 0346     	    mov r3,r0  
 3678              	cmp_loop:
ARM GAS  tinyBasic.s 			page 94


 3679 0cb8 1068     	    ldr r0,[r2]
 3680 0cba B0F1FF3F 	    cmp r0,#-1
 3681 0cbe 80EA0000 	    eor r0,r0
 3682 0cc2 15D0     	    beq 9f // reached end of fs 
 3683 0cc4 1846     	1:  mov r0,r3
 3684 0cc6 02F10201 	    add r1,r2,#2
 3685 0cca 00B5FFF7 	    _CALL strcmp
 3685      FEFF5DF8 
 3685      04EB
 3686 0cd4 08B9     	    cbnz r0,2f
 3687 0cd6 1046     	    mov r0,r2 
 3688 0cd8 0AE0     	    b 9f   
 3689 0cda 1088     	2:  ldrh r0,[r2] // name length
 3690 0cdc 0244     	    add r2,r0 
 3691 0cde 1088     	    ldrh r0,[r2]
 3692 0ce0 1044     	    add r0,r2
 3693 0ce2 00B5FFF7 	    _CALL page_align 
 3693      FEFF5DF8 
 3693      04EB
 3694 0cec 0246     	    mov r2,r0   
 3695 0cee E3E7     	    b cmp_loop 
 3696 0cf0 0EBC     	9:  pop {r1,r2,r3}
 3697 0cf2 7047     	    _RET 
 3698              	
 3699 0cf4 00000000 	fs_addr: .word FILE_SYSTEM
 3700              	
 3701              	/*************************************
 3702              	  BASIC: DIR 
 3703              	  list files stored in fs 
 3704              	  use:
 3705              	    r0  temp 
 3706              	    r1  temp
 3707              	    r2  file count
 3708              	    r3  data size
 3709              	    T1  *fs  
 3710              	*************************************/
 3711              	    _FUNC directory
 3712 0cf8 206C10F0 	    _CLO 
 3712      010F03D0 
 3712      4FF00700 
 3712      FFF7FEBF 
 3713 0d08 82EA0202 	    eor r2,r2 
 3714 0d0c 5FF81C80 	    ldr T1,fs_addr 
 3715 0d10 D8F80000 	1:  ldr r0,[T1] // name length 
 3716 0d14 B0F1FF3F 	    cmp r0,#-1
 3717 0d18 2AD0     	    beq no_more_file
 3718 0d1a 00F00F03 	    and r3,r0,#15
 3719 0d1e 08F10200 	    add r0,T1,#2
 3720 0d22 00B5FFF7 	    _CALL uart_puts 
 3720      FEFF5DF8 
 3720      04EB
 3721 0d2c 4FF01000 	    mov r0,#16 
 3722 0d30 00B5FFF7 	    _CALL cursor_x 
 3722      FEFF5DF8 
 3722      04EB
 3723 0d3a 9844     	    add T1,r3 
 3724 0d3c B8F80030 	    ldrh r3,[T1]
ARM GAS  tinyBasic.s 			page 95


 3725 0d40 1846     	    mov r0,r3 
 3726 0d42 4FF00A01 	    mov r1,#10 
 3727 0d46 00B5FFF7 	    _CALL print_int
 3727      FEFF5DF8 
 3727      04EB
 3728 0d50 00B5FFF7 	    _CALL cr  
 3728      FEFF5DF8 
 3728      04EB
 3729 0d5a 08EB0300 	    add r0,T1,r3 
 3730 0d5e 00B5FFF7 	    _CALL page_align
 3730      FEFF5DF8 
 3730      04EB
 3731 0d68 8046     	    mov T1,r0 
 3732 0d6a 02F10102 	    add r2,#1 
 3733 0d6e CFE7     	    b 1b  
 3734              	no_more_file:
 3735 0d70 00B5FFF7 	    _CALL cr
 3735      FEFF5DF8 
 3735      04EB
 3736 0d7a 4FF01000 	    mov r0,#16
 3737 0d7e 00B5FFF7 	    _CALL cursor_x  
 3737      FEFF5DF8 
 3737      04EB
 3738 0d88 1046     	    mov r0,r2 
 3739 0d8a 4FF00A01 	    mov r1,#10 
 3740 0d8e 00B5FFF7 	    _CALL print_int 
 3740      FEFF5DF8 
 3740      04EB
 3741 0d98 DFF85405 	    ldr r0,=fcount 
 3742 0d9c 00B5FFF7 	    _CALL uart_puts 
 3742      FEFF5DF8 
 3742      04EB
 3743 0da6 7047     	    _RET 
 3744 0da8 66696C65 	fcount:  .asciz "files\n"
 3744      730A00
 3745              	
 3746              	/*************************************
 3747              	  BASIC: FORGET ["name"]
 3748              	  delete file and all following 
 3749              	  if no name given delete all files 
 3750              	************************************/
 3751 0daf 00       	    _FUNC forget
 3752 0db0 2DE90802 	    push {r3,T2}
 3753 0db4 5FF8C490 	    ldr T2,fs_addr 
 3754 0db8 E36A     	    ldr r3,[UPP,#FSFREE]
 3755 0dba 00B5FFF7 	    _CALL next_token
 3755      FEFF5DF8 
 3755      04EB
 3756 0dc4 38B1     	    cbz r0,1f // no name 
 3757 0dc6 0846     	    mov r0,r1
 3758 0dc8 00B5FFF7 	    _CALL search_file
 3758      71FF5DF8 
 3758      04EB
 3759 0dd2 58B1     	    cbz r0,9f 
 3760 0dd4 8146     	    mov T2,r0 
 3761 0dd6 9945     	1:  cmp T2,r3 
 3762 0dd8 08D5     	    bpl 9f 
ARM GAS  tinyBasic.s 			page 96


 3763 0dda 4846     	    mov r0,T2 
 3764 0ddc 00B5FFF7 	    _CALL erase_page
 3764      FEFF5DF8 
 3764      04EB
 3765 0de6 09F58069 	    add T2,#PAGE_SIZE
 3766 0dea F4E7     	    b 1b 
 3767 0dec 00B5FFF7 	9:  _CALL search_free
 3767      4DFF5DF8 
 3767      04EB
 3768 0df6 BDE80802 	    pop {r3,T2} 
 3769 0dfa 7047     	    _RET 
 3770              	
 3771              	/**********************************
 3772              	  BASIC LOAD "name" 
 3773              	  load file in RAM for execution
 3774              	  use:
 3775              	    r0   temp
 3776              	    r1   src
 3777              	    r2   dest 
 3778              	    r3   count 
 3779              	**********************************/
 3780              	    _FUNC load
 3781 0dfc 206C10F0 	    _CLO 
 3781      010F03D0 
 3781      4FF00700 
 3781      FFF7FEBF 
 3782 0e0c 00B5FFF7 	    _CALL next_token 
 3782      FEFF5DF8 
 3782      04EB
 3783 0e16 1C28     	    cmp r0,#TK_QSTR 
 3784 0e18 7FF4FEAF 	    bne syntax_error 
 3785 0e1c 0846     	    mov r0,r1 
 3786 0e1e 00B5FFF7 	    _CALL search_file 
 3786      46FF5DF8 
 3786      04EB
 3787 0e28 18B9     	    cbnz r0, 1f 
 3788 0e2a 4FF00900 	    mov r0,#ERR_NOT_FILE
 3789 0e2e FFF7FEBF 	    b tb_error 
 3790 0e32 0146     	1:  mov r1,r0 
 3791 0e34 0888     	    ldrh r0,[r1]
 3792 0e36 0144     	    add r1,r0 // data size field  
 3793 0e38 31F8023B 	    ldrh r3,[r1],#2 // data size 
 3794 0e3c 226B     	    ldr r2,[UPP,#TXTBGN]
 3795 0e3e 02EB0300 	    add r0,r2,r3  
 3796 0e42 6063     	    str r0,[UPP,#TXTEND]
 3797 0e44 03F10103 	    add r3,#1
 3798 0e48 4FEA5303 	    lsr r3,#1
 3799              	2:  // load file data 
 3800 0e4c 31F8020B 	    ldrh r0,[r1],#2
 3801 0e50 22F8020B 	    strh r0,[r2],#2 
 3802 0e54 013B     	    subs r3,#1 
 3803 0e56 F9D1     	    bne 2b 
 3804              	// report file size 
 3805 0e58 DFF89804 	    ldr r0,=fsize 
 3806 0e5c 00B5FFF7 	    _CALL uart_puts
 3806      FEFF5DF8 
 3806      04EB
ARM GAS  tinyBasic.s 			page 97


 3807 0e66 606B     	    ldr r0,[UPP,#TXTEND]
 3808 0e68 236B     	    ldr r3,[UPP,#TXTBGN]
 3809 0e6a A0EB0300 	    sub r0,r3 
 3810 0e6e 4FF00A01 	    mov r1,#10 
 3811 0e72 00B5FFF7 	    _CALL print_int 
 3811      FEFF5DF8 
 3811      04EB
 3812 0e7c DFF87804 	    ldr r0,=data_bytes 
 3813 0e80 00B5FFF7 	    _CALL uart_puts      
 3813      FEFF5DF8 
 3813      04EB
 3814 0e8a 7047     	    _RET 
 3815              	
 3816              	
 3817              	/*********************************
 3818              	  BASIC: SAVE "name" 
 3819              	  save program in flash memory
 3820              	  file structure:
 3821              	    .hword name_length 
 3822              	    .asciz name
 3823              	    .palign 1  
 3824              	    .hword data_length 
 3825              	    .byte  file data (variable length)  
 3826              	  use:
 3827              	    r0  temp 
 3828              	    r1  temp
 3829              	    r2  *flash 
 3830              	    r3  *ram  
 3831              	    T1  temp   
 3832              	********************************/
 3833              	    _FUNC save
 3834 0e8c 206C10F0 	    _CLO 
 3834      010F03D0 
 3834      4FF00700 
 3834      FFF7FEBF 
 3835 0e9c 606B     	    ldr r0,[UPP,#TXTEND]
 3836 0e9e 216B     	    ldr r1,[UPP,#TXTBGN]
 3837 0ea0 8842     	    cmp r0,r1
 3838 0ea2 03D1     	    bne 0f 
 3839 0ea4 4FF00D00 	    mov r0,#ERR_NO_PROG
 3840 0ea8 FFF7FEBF 	    b tb_error 
 3841 0eac 00B5FFF7 	0:  _CALL next_token 
 3841      FEFF5DF8 
 3841      04EB
 3842 0eb6 1C28     	    cmp r0,#TK_QSTR
 3843 0eb8 7FF4FEAF 	    bne syntax_error 
 3844              	// check for existing 
 3845 0ebc 0B46     	    mov r3,r1 // save name 
 3846 0ebe 1846     	    mov r0,r3  
 3847 0ec0 00B5FFF7 	    _CALL search_file
 3847      F5FE5DF8 
 3847      04EB
 3848 0eca 18B1     	    cbz r0,new_file 
 3849 0ecc 4FF00800 	    mov r0,#ERR_DUPLICATE
 3850 0ed0 FFF7FEBF 	    b tb_error 
 3851              	new_file:
 3852 0ed4 4FF00100 	    mov r0,#1 
ARM GAS  tinyBasic.s 			page 98


 3853 0ed8 00B5FFF7 	    _CALL unlock 
 3853      FEFF5DF8 
 3853      04EB
 3854 0ee2 E26A     	    ldr r2,[UPP,#FSFREE] //*flash 
 3855 0ee4 1846     	    mov r0,r3 // *name 
 3856 0ee6 00B5FFF7 	    _CALL strlen 
 3856      FEFF5DF8 
 3856      04EB
 3857 0ef0 00F10400 	    add r0,#4  
 3858 0ef4 20F00100 	    and r0,#-2 //even size
 3859 0ef8 A0F10208 	    sub T1,r0,#2  // name length counter   
 3860 0efc 1146     	1:  mov r1,r2  
 3861 0efe 00B5FFF7 	    _CALL hword_write   
 3861      FEFF5DF8 
 3861      04EB
 3862 0f08 02F10202 	    add r2,#2  
 3863              	// write file name      
 3864 0f0c 33F8020B 	2:  ldrh r0,[r3],#2 
 3865 0f10 1146     	    mov r1,r2 
 3866 0f12 00B5FFF7 	    _CALL hword_write
 3866      FEFF5DF8 
 3866      04EB
 3867 0f1c 02F10202 	    add r2,#2
 3868 0f20 B8F10208 	    subs T1,#2
 3869 0f24 F2D1     	    bne 2b
 3870              	// write data size 
 3871 0f26 606B     	    ldr r0,[UPP,#TXTEND]
 3872 0f28 236B     	    ldr r3,[UPP,#TXTBGN]
 3873 0f2a A0EB0300 	    sub r0,r3
 3874 0f2e 8046     	    mov T1,r0
 3875 0f30 1146     	    mov r1,r2 
 3876 0f32 00B5FFF7 	    _CALL hword_write
 3876      FEFF5DF8 
 3876      04EB
 3877 0f3c 02F10202 	    add r2,#2 
 3878              	// write data 
 3879 0f40 08F10108 	    add T1,#1 
 3880 0f44 4FEA5808 	    lsr T1,#1 // .hword to write 
 3881 0f48 33F8020B 	3:  ldrh r0,[r3],#2
 3882 0f4c 1146     	    mov r1,r2
 3883 0f4e 00B5FFF7 	    _CALL hword_write 
 3883      FEFF5DF8 
 3883      04EB
 3884 0f58 02F10202 	    add r2,#2 
 3885 0f5c B8F10108 	    subs T1,#1 
 3886 0f60 F2D1     	    bne 3b
 3887 0f62 4FF00000 	    mov r0,#0 
 3888 0f66 00B5FFF7 	    _CALL unlock
 3888      FEFF5DF8 
 3888      04EB
 3889              	// update FSFREE     
 3890 0f70 606B     	    ldr r0,[UPP,#TXTEND]
 3891 0f72 216B     	    ldr r1,[UPP,#TXTBGN]
 3892 0f74 A0EB0100 	    sub r0,r1 
 3893 0f78 8046     	    mov T1,r0 
 3894 0f7a E16A     	    ldr r1,[UPP,#FSFREE]
 3895 0f7c 0844     	    add r0,r1 
ARM GAS  tinyBasic.s 			page 99


 3896 0f7e 00B5FFF7 	    _CALL page_align
 3896      FEFF5DF8 
 3896      04EB
 3897 0f88 E062     	    str r0,[UPP,#FSFREE]
 3898 0f8a DA48     	    ldr r0,=fsize
 3899 0f8c 00B5FFF7 	    _CALL uart_puts
 3899      FEFF5DF8 
 3899      04EB
 3900 0f96 4046     	    mov r0,T1 
 3901 0f98 4FF00A01 	    mov r1,#10 
 3902 0f9c 00B5FFF7 	    _CALL print_int 
 3902      FEFF5DF8 
 3902      04EB
 3903 0fa6 D448     	    ldr r0,=data_bytes 
 3904 0fa8 00B5FFF7 	    _CALL uart_puts  
 3904      FEFF5DF8 
 3904      04EB
 3905 0fb2 7047     	    _RET 
 3906 0fb4 66696C65 	fsize: .asciz "file size: "
 3906      2073697A 
 3906      653A2000 
 3907 0fc0 62797465 	data_bytes: .asciz "bytes"
 3907      7300
 3908              	
 3909              	
 3910              	/*******************************
 3911              	  BASIC: FREE 
 3912              	  return RAM free bytes 
 3913              	*******************************/
 3914 0fc6 00BF     	    _FUNC free
 3915 0fc8 D4F8D000 	    ldr r0,[UPP,#HERE]
 3916 0fcc D4F8C810 	    ldr r1,[UPP,#ARRAY_ADR]
 3917 0fd0 A1EB0001 	    sub r1,r0
 3918 0fd4 4FF01B00 	    mov r0,#TK_INTGR
 3919 0fd8 7047     	    _RET  
 3920              	
 3921              	/*********************************
 3922              	  BASIC: SLEEP 
 3923              	  place MCU lowest power mode 
 3924              	  wait for external interrpt or
 3925              	  reset.
 3926              	*********************************/
 3927 0fda 00BF     	    _FUNC sleep
 3928 0fdc 4EF61050 	    _MOV32 r0,SCR_BASE_ADR
 3928      CEF20000 
 3929 0fe4 4FF00401 	    mov r1,#SCR_SLEEPDEEP
 3930 0fe8 0160     	    str r1,[r0]
 3931 0fea 4FF4E040 	    _MOV32 r0,PWR_CR_ADR
 3931      C4F20000 
 3932 0ff2 4FF00601 	    mov r1,#PWR_CR_PDDS+PWR_CR_CWUF
 3933 0ff6 0160     	    str r1,[r0]
 3934 0ff8 20BF     	    wfe 
 3935 0ffa 7047     	    _RET 
 3936              	
 3937              	/************************************
 3938              	  BASIC: SPC(expr)
 3939              	  mov cursor right expr spaces 
ARM GAS  tinyBasic.s 			page 100


 3940              	***********************************/
 3941              	    _FUNC spc 
 3942 0ffc 00B5FFF7 	    _CALL func_args 
 3942      FEFF5DF8 
 3942      04EB
 3943 1006 0128     	    cmp r0,#1
 3944 1008 7FF4FEAF 	    bne syntax_error 
 3945 100c 206C     	    ldr r0,[UPP,#FLAGS]
 3946 100e 10F0800F 	    tst r0,#FPRINT 
 3947 1012 5CF8040B 	    _POP r0 
 3948 1016 04D0     	    beq 9f 
 3949 1018 00B5FFF7 	    _CALL spaces 
 3949      FEFF5DF8 
 3949      04EB
 3950 1022 7047     	9:  _RET 
 3951              	
 3952              	    _FUNC spi_read
 3953 1024 7047     	    _RET 
 3954              	
 3955 1026 00BF     	    _FUNC spi_enable
 3956 1028 7047     	    _RET 
 3957              	
 3958 102a 00BF     	    _FUNC spi_select
 3959 102c 7047     	    _RET 
 3960              	
 3961 102e 00BF     	    _FUNC spi_write
 3962 1030 7047     	    _RET 
 3963              	
 3964              	/******************************
 3965              	  BASIC: STOP 
 3966              	  stop program executre but 
 3967              	  keep execution state for 
 3968              	  resume 
 3969              	******************************/
 3970 1032 00BF     	    _FUNC stop
 3971 1034 206C10F0 	    _RTO 
 3971      010F03D1 
 3971      4FF00700 
 3971      FFF7FEBF 
 3972 1044 6068     	    ldr r0,[UPP,#COUNT]
 3973 1046 2CE9010C 	    stmdb DP!,{r0,IN,BPTR}
 3974 104a 206C     	    ldr r0,[UPP,#FLAGS]
 3975 104c 4FF00901 	    mov r1,#FRUN+FSTOP
 3976 1050 80EA0100 	    eor r0,r1
 3977 1054 2064     	    str r0,[UPP,#FLAGS]
 3978 1056 8AEA0A0A 	    eor IN,IN 
 3979 105a 8BEA0B0B 	    eor BPTR,BPTR 
 3980 105e C4F804A0 	    str IN,[UPP,#COUNT]
 3981 1062 C4F800A0 	    str IN,[UPP,#IN_SAVED]
 3982 1066 C4F808A0 	    str IN,[UPP,#BASICPTR]
 3983 106a 4FF4A040 	    _MOV32 r0,RAM_END
 3983      C2F20000 
 3984 1072 8546     	    mov sp,r0
 3985 1074 FFF7FEBF 	    b cmd_line 
 3986              	
 3987              	
 3988              	/**************************
ARM GAS  tinyBasic.s 			page 101


 3989              	  BASIC: TAB(expr)
 3990              	  move cursor column expr 
 3991              	**************************/
 3992              	    _FUNC tab 
 3993 1078 00B5FFF7 	    _CALL func_args  
 3993      FEFF5DF8 
 3993      04EB
 3994 1082 0128     	    cmp r0,#1 
 3995 1084 7FF4FEAF 	    bne syntax_error 
 3996 1088 206C     	    ldr r0,[UPP,#FLAGS]
 3997 108a 10F0800F 	    tst r0,#FPRINT
 3998 108e 5CF8040B 	    _POP r0 
 3999 1092 04D0     	    beq 9f 
 4000 1094 00B5FFF7 	    _CALL cursor_x 
 4000      FEFF5DF8 
 4000      04EB
 4001 109e 7047     	9:  _RET 
 4002              	
 4003              	
 4004              	/**************************
 4005              	  BASIC: TICKS 
 4006              	  return msec counter
 4007              	**************************/  
 4008              	    _FUNC get_ticks
 4009 10a0 E169     	    ldr r1,[UPP,#TICKS]
 4010 10a2 4FF01B00 	    mov r0,#TK_INTGR
 4011 10a6 7047     	    _RET  
 4012              	
 4013              	/*************************
 4014              	  BASIC: TIMER expr 
 4015              	  set countdown timer 
 4016              	************************/
 4017              	    _FUNC set_timer
 4018 10a8 00B5FFF7 	    _CALL expression 
 4018      FEFF5DF8 
 4018      04EB
 4019 10b2 1B28     	    cmp r0,#TK_INTGR
 4020 10b4 7FF4FEAF 	    bne syntax_error 
 4021 10b8 2162     	    str r1,[UPP,#TIMER]
 4022 10ba 7047     	    _RET 
 4023              	
 4024              	/***************************
 4025              	  BASIC: TIMEOUT
 4026              	  check for timer expiration 
 4027              	  return -1 true || 0 false
 4028              	****************************/
 4029              	    _FUNC timeout
 4030 10bc 81EA0101 	    eor r1,r1 
 4031 10c0 206A     	    ldr r0,[UPP,#TIMER]
 4032 10c2 08B9     	    cbnz r0,9f 
 4033 10c4 6FEA0101 	    mvn r1,r1 
 4034 10c8 4FF01B00 	9:  mov r0,#TK_INTGR    
 4035 10cc 7047     	    _RET 
 4036              	
 4037              	/****************************************
 4038              	  BASIC:  TONE freq, duration 
 4039              	  play a tone with frequency freq and duration
ARM GAS  tinyBasic.s 			page 102


 4040              	  in milliseconds
 4041              	***********************************************/
 4042 10ce 00BF     	    _FUNC tone
 4043 10d0 00B5FFF7 	    _CALL arg_list 
 4043      FEFF5DF8 
 4043      04EB
 4044 10da 0228     	    cmp r0,#2 
 4045 10dc 7FF4FEAF 	    bne syntax_error
 4046 10e0 BCE80003 	    ldmia DP!,{T1,T2}
 4047              	    
 4048 10e4 7047     	    _RET 
 4049              	
 4050              	/****************************************
 4051              	  BASIC: TRACE n 
 4052              	  enable execution trace 
 4053              	  0   ddisable
 4054              	  1   show current line#
 4055              	  2  show line#+data_stack
 4056              	  3  show line#+data_stack+main_stack 
 4057              	***************************************/
 4058 10e6 00BF     	    _FUNC trace 
 4059 10e8 00B5FFF7 	    _CALL next_token 
 4059      FEFF5DF8 
 4059      04EB
 4060 10f2 1B28     	    cmp r0,#TK_INTGR  
 4061 10f4 7FF4FEAF 	    bne syntax_error 
 4062 10f8 01F00301 	    and r1,#3 
 4063 10fc C4F8CC10 	    str r1,[UPP,#TRACE_LEVEL]
 4064 1100 7047     	    _RET 
 4065              	
 4066              	
 4067              	/***************************
 4068              	  BASIC: UBOUND 
 4069              	  return last indice of @
 4070              	  output:
 4071              	    r0  TK_INTGR 
 4072              	    r1  +int 
 4073              	**************************/
 4074 1102 00BF     	    _FUNC ubound
 4075 1104 D4F8C810 	    ldr r1,[UPP,#ARRAY_ADR]
 4076 1108 D4F8D000 	    ldr r0,[UPP,#HERE]
 4077 110c A1EB0001 	    sub r1,r0 
 4078 1110 4FEA9101 	    lsr r1,#2
 4079 1114 4FF01B00 	    mov r0,#TK_INTGR 
 4080 1118 7047     	    _RET 
 4081              	
 4082              	/****************************
 4083              	  BASIC: UFLASH 
 4084              	  return user flash address
 4085              	*****************************/
 4086 111a 00BF     	    _FUNC uflash
 4087 111c 7749     	    ldr r1,=user
 4088 111e 4FF01B00 	    mov r0,#TK_INTGR 
 4089 1122 7047     	    _RET 
 4090              	
 4091              	
 4092              	/************************************
ARM GAS  tinyBasic.s 			page 103


 4093              	  BASIC: UNTIL relation 
 4094              	  close a DO..UNTIL loop 
 4095              	  loop until relation come true 
 4096              	************************************/
 4097              	    _FUNC until
 4098 1124 00B5FFF7 	    _CALL relation 
 4098      FEFF5DF8 
 4098      04EB
 4099 112e 11B1     	    cbz r1,9f
 4100 1130 0CF1080C 	    add DP,#8
 4101 1134 7047     	    _RET  
 4102 1136 9CE8000C 	9:  ldmia DP,{IN,BPTR}
 4103 113a 9BF80200 	    ldrb r0,[BPTR,#2]
 4104 113e 6060     	    str r0,[UPP,#COUNT]
 4105 1140 7047     	    _RET 
 4106              	
 4107              	/*************************************
 4108              	  BASIC: WAIT addr,expr1[,expr2] 
 4109              	  wait until *addr&expr1 is not null 
 4110              	  or until (*addr&expr1)^expr2 is null 
 4111              	***************************************/
 4112 1142 00BF     	    _FUNC wait
 4113 1144 00B5FFF7 	    _CALL arg_list 
 4113      FEFF5DF8 
 4113      04EB
 4114 114e 0228     	    cmp r0,#2
 4115 1150 03D0     	    beq 2f 
 4116 1152 0328     	    cmp r0,#3
 4117 1154 07D0     	    beq 4f
 4118 1156 FFF7FEBF 	    b syntax_error 
 4119 115a BCE80300 	2:  ldmia DP!,{r0,r1}
 4120 115e 0A88     	3:  ldrh r2,[r1]
 4121 1160 0240     	    ands r2,r0 
 4122 1162 FCD0     	    beq 3b 
 4123 1164 06E0     	    b 9f 
 4124 1166 BCE80700 	4:  ldmia DP!,{r0,r1,r2}
 4125 116a 1388     	5:  ldrh r3,[r2]
 4126 116c 83EA0003 	    eor r3,r0
 4127 1170 0B40     	    ands r3,r1 
 4128 1172 FAD0     	    beq 5b 
 4129 1174 7047     	9:  _RET 
 4130              	
 4131              	/*********************************************
 4132              	  BASIC: WORDS 
 4133              	  print list of BASIC WORDS in dictionary 
 4134              	  use:
 4135              	    r0,r1,r2,T1,T2  
 4136              	********************************************/
 4137 1176 00BF     	    _FUNC words
 4138 1178 206C10F0 	    _CLO 
 4138      010F03D0 
 4138      4FF00700 
 4138      FFF7FEBF 
 4139 1188 DFF87481 	    ldr T1,=kword_dict
 4140 118c 89EA0909 	    eor T2,T2
 4141 1190 82EA0202 	    eor r2,r2  
 4142              	1:  
ARM GAS  tinyBasic.s 			page 104


 4143 1194 4046     	    mov r0,T1
 4144 1196 00B5FFF7 	    _CALL strlen
 4144      FEFF5DF8 
 4144      04EB
 4145 11a0 F0B1     	    cbz r0,4f 
 4146 11a2 8144     	    add T2,r0 
 4147 11a4 B9F1500F 	    cmp T2,#80 
 4148 11a8 06D4     	    bmi 2f
 4149 11aa 89EA0909 	    eor T2,T2  
 4150 11ae 00B5FFF7 	    _CALL cr 
 4150      FEFF5DF8 
 4150      04EB
 4151 11b8 4046     	2:  mov r0,T1 
 4152 11ba 00B5FFF7 	    _CALL uart_puts 
 4152      FEFF5DF8 
 4152      04EB
 4153 11c4 4FF02000 	    mov r0,#SPACE
 4154 11c8 09F10109 	    add T2,#1  
 4155 11cc 00B5FFF7 	    _CALL uart_putc
 4155      FEFF5DF8 
 4155      04EB
 4156 11d6 02F10102 	    add r2,#1 
 4157 11da 58F80C8C 	    ldr T1,[T1,#-12]
 4158 11de D9E7     	    b 1b 
 4159 11e0 19EA0909 	4:  ands T2,T2
 4160 11e4 04D0     	    beq 5f 
 4161 11e6 00B5FFF7 	    _CALL cr 
 4161      FEFF5DF8 
 4161      04EB
 4162 11f0 1046     	5:  mov r0,r2 
 4163 11f2 4FF00A01 	    mov r1,#10
 4164 11f6 00B5FFF7 	    _CALL print_int 
 4164      FEFF5DF8 
 4164      04EB
 4165 1200 4048     	    ldr r0,=dict_words
 4166 1202 00B5FFF7 	    _CALL uart_puts  
 4166      FEFF5DF8 
 4166      04EB
 4167 120c 7047     	9:  _RET 
 4168              	
 4169 120e 776F7264 	dict_words: .asciz "words in dictionary" 
 4169      7320696E 
 4169      20646963 
 4169      74696F6E 
 4169      61727900 
 4170              	
 4171              	
 4172              	/**************************************
 4173              	  BASIC: XOR(expr1,expr2)
 4174              	  binary exclusive or between 2 expressions
 4175              	**************************************/
 4176 1222 00BF     	    _FUNC bit_xor
 4177 1224 00B5FFF7 	    _CALL func_args
 4177      FEFF5DF8 
 4177      04EB
 4178 122e 0228     	    cmp r0,#2
 4179 1230 7FF4FEAF 	    bne syntax_error
ARM GAS  tinyBasic.s 			page 105


 4180 1234 5CF8040B 	    _POP r0
 4181 1238 5CF8041B 	    _POP r1 
 4182 123c 81EA0001 	    eor r1,r0 
 4183 1240 4FF01B00 	    mov r0,#TK_INTGR
 4184 1244 7047     	    _RET 
 4185              	
 4186              	/***************************************
 4187              	    BASIC: XPOS 
 4188              	    report cursor column on terminal 
 4189              	***************************************/
 4190 1246 00BF     	    _FUNC xpos 
 4191 1248 00B5FFF7 	    _CALL get_curpos
 4191      FEFF5DF8 
 4191      04EB
 4192 1252 4FF01B00 	    mov r0,#TK_INTGR
 4193 1256 7047     	    _RET 
 4194              	
 4195              	/***********************************
 4196              	    BASIC: YPOS 
 4197              	    report cursor line on terminal 
 4198              	***********************************/
 4199              	    _FUNC ypos 
 4200 1258 00B5FFF7 	    _CALL get_curpos 
 4200      FEFF5DF8 
 4200      04EB
 4201 1262 0146     	    mov r1,r0 
 4202 1264 4FF01B00 	    mov r0,#TK_INTGR
 4203 1268 7047     	    _RET 
 4204              	
 4205              	
 4206              	/**********************************
 4207              	     argument stack manipulation
 4208              	**********************************/
 4209              	
 4210              	/**********************************
 4211              	  BASIC PUSH expr[,expr] 
 4212              	  push integers on stack 
 4213              	*********************************/
 4214 126a 00BF     	    _FUNC cmd_push 
 4215 126c 00B5FFF7 	    _CALL arg_list
 4215      FEFF5DF8 
 4215      04EB
 4216 1276 7047     	    _RET 
 4217              	
 4218              	/********************************
 4219              	  BASIC: POP 
 4220              	  pop an integer out of stack 
 4221              	********************************/    
 4222              	    _FUNC fn_pop 
 4223 1278 5CF8041B 	    _POP r1 
 4224 127c 4FF01B00 	    mov r0,#TK_INTGR 
 4225 1280 7047     	    _RET 
 4226              	
 4227              	/*******************************
 4228              	  BASIC: DROP n 
 4229              	  discard n integer from stack
 4230              	*******************************/
ARM GAS  tinyBasic.s 			page 106


 4231 1282 00BF     	    _FUNC drop 
 4232 1284 00B5FFF7 	    _CALL expression 
 4232      FEFF5DF8 
 4232      04EB
 4233 128e 1B28     	    cmp r0,#TK_INTGR 
 4234 1290 7FF4FEAF 	    bne syntax_error 
 4235 1294 4FF00400 	    mov r0,#4 
 4236 1298 01FB00F0 	    mul r0,r1 
 4237 129c 8444     	    add DP,r0 
 4238 129e 7047     	    _RET 
 4239              	
 4240              	/********************************
 4241              	  BASIC: GET(expr) 
 4242              	  retreive nth element from stack 
 4243              	********************************/
 4244              	    _FUNC get 
 4245 12a0 00B5FFF7 	    _CALL func_args
 4245      FEFF5DF8 
 4245      04EB
 4246 12aa 0128     	    cmp r0,#1 
 4247 12ac 7FF4FEAF 	    bne syntax_error 
 4248 12b0 5CF8040B 	    _POP r0
 4249 12b4 4FF00401 	    mov r1,#4 
 4250 12b8 01FB00F0 	    mul r0,r1 
 4251 12bc 5CF80010 	    ldr r1,[DP,r0]
 4252 12c0 4FF01B00 	    mov r0,#TK_INTGR
 4253 12c4 7047     	    _RET 
 4254              	
 4255              	/*************************************
 4256              	  BASIC: PUT value,n  
 4257              	  store value at nth position on stack
 4258              	**************************************/
 4259 12c6 00BF     	    _FUNC put
 4260 12c8 00B5FFF7 	    _CALL arg_list 
 4260      FEFF5DF8 
 4260      04EB
 4261 12d2 0228     	    cmp r0,#2 
 4262 12d4 7FF4FEAF 	    bne syntax_error 
 4263 12d8 5CF8040B 	    _POP r0 
 4264 12dc 4FF00401 	    mov r1,#4 
 4265 12e0 01FB00F0 	    mul r0,r1 
 4266 12e4 5CF8041B 	    _POP r1
 4267 12e8 4CF80010 	    str r1,[DP,r0]
 4268 12ec 7047     	    _RET 
 4269              	
 4270              	
 4271 12ee 0000     	  .section .rodata.user
 4272              	  .p2align 10 
 4273              	user:
 4274 0000 FFFFFFFF 	  .space 1024,255
 4274      FFFFFFFF 
 4274      FFFFFFFF 
 4274      FFFFFFFF 
 4274      FFFFFFFF 
 4275              	
 4276              	/*************************************************
 4277              	   extra FLASH memory not used by Tiny BASIC
ARM GAS  tinyBasic.s 			page 107


 4278              	   is used to save BASIC programs.
 4279              	************************************************/
 4280              	  .p2align 10  // align to 1KB, smallest erasable segment 
 4281              	  .section .rodata.fs
 4282              	FILE_SYSTEM: // file system start here
ARM GAS  tinyBasic.s 			page 108


DEFINED SYMBOLS
       stm32f103.inc:5      *ABS*:0000000020000000 RAM_ADR
       stm32f103.inc:6      *ABS*:0000000000005000 RAM_SIZE
       stm32f103.inc:7      *ABS*:0000000020005000 RAM_END
       stm32f103.inc:10     *ABS*:0000000022000000 RAM_BIT_ALIAS
       stm32f103.inc:14     *ABS*:0000000008000000 FLASH_ADR
       stm32f103.inc:15     *ABS*:0000000000010000 FLASH_SIZE
       stm32f103.inc:16     *ABS*:0000000008010000 FLASH_END
       stm32f103.inc:18     *ABS*:0000000008010000 FLASH_HIDDEN_ADR
       stm32f103.inc:19     *ABS*:0000000000010000 FLASH_HIDDEN_SIZE
       stm32f103.inc:20     *ABS*:0000000008020000 FLASH_HIDDEN_END
       stm32f103.inc:21     *ABS*:0000000000000400 PAGE_SIZE
       stm32f103.inc:24     *ABS*:000000001ffff000 SYS_MEM
       stm32f103.inc:25     *ABS*:0000000000000800 SYS_MEM_SIZE
       stm32f103.inc:28     *ABS*:000000001ffff800 OPTION
       stm32f103.inc:29     *ABS*:0000000000000010 OPT_SIZE
       stm32f103.inc:33     *ABS*:0000000040000000 PER_BASE_ADR
       stm32f103.inc:35     *ABS*:0000000042000000 PER_BIT_ALIAS
       stm32f103.inc:39     *ABS*:0000000040021000 RCC_BASE_ADR
       stm32f103.inc:41     *ABS*:0000000000000000 RCC_CR
       stm32f103.inc:42     *ABS*:0000000000000004 RCC_CFGR
       stm32f103.inc:43     *ABS*:0000000000000008 RCC_CIR
       stm32f103.inc:44     *ABS*:000000000000000c RCC_APB2RSTR
       stm32f103.inc:45     *ABS*:0000000000000010 RCC_APB1RSTR
       stm32f103.inc:46     *ABS*:0000000000000014 RCC_AHBENR
       stm32f103.inc:47     *ABS*:0000000000000018 RCC_APB2ENR
       stm32f103.inc:48     *ABS*:000000000000001c RCC_APB1ENR
       stm32f103.inc:49     *ABS*:0000000000000020 RCC_BDCR
       stm32f103.inc:50     *ABS*:0000000000000024 RCC_CSR
       stm32f103.inc:53     *ABS*:0000000040022000 FLASH_BASE_ADR
       stm32f103.inc:55     *ABS*:0000000000000000 FLASH_ACR
       stm32f103.inc:56     *ABS*:0000000000000004 FLASH_KEYR
       stm32f103.inc:57     *ABS*:0000000000000008 FLASH_OPTKEYR
       stm32f103.inc:58     *ABS*:000000000000000c FLASH_SR
       stm32f103.inc:59     *ABS*:0000000000000010 FLASH_CR
       stm32f103.inc:60     *ABS*:0000000000000014 FLASH_AR
       stm32f103.inc:61     *ABS*:000000000000001c FLASH_OBR
       stm32f103.inc:62     *ABS*:0000000000000020 FLASH_WRPR
       stm32f103.inc:63     *ABS*:00000000000000a5 RDPRT_KEY
       stm32f103.inc:64     *ABS*:0000000045670123 FLASH_KEY1
       stm32f103.inc:65     *ABS*:00000000cdef89ab FLASH_KEY2
       stm32f103.inc:68     *ABS*:0000000040010800 GPIOA_BASE_ADR
       stm32f103.inc:69     *ABS*:0000000040010c00 GPIOB_BASE_ADR
       stm32f103.inc:70     *ABS*:0000000040011000 GPIOC_BASE_ADR
       stm32f103.inc:71     *ABS*:0000000040011400 GPIOD_BASE_ADR
       stm32f103.inc:72     *ABS*:0000000040011800 GPIOE_BASE_ADR
       stm32f103.inc:73     *ABS*:0000000040018c00 GPIOF_BASE_ADR
       stm32f103.inc:74     *ABS*:0000000040012000 GPIOG_BASE_ADR
       stm32f103.inc:77     *ABS*:0000000000000000 GPIO_CRL
       stm32f103.inc:78     *ABS*:0000000000000004 GPIO_CRH
       stm32f103.inc:79     *ABS*:0000000000000008 GPIO_IDR
       stm32f103.inc:80     *ABS*:000000000000000c GPIO_ODR
       stm32f103.inc:81     *ABS*:0000000000000010 GPIO_BSRR
       stm32f103.inc:82     *ABS*:0000000000000014 GPIO_BRR
       stm32f103.inc:83     *ABS*:0000000000000018 GPIO_LOCKR
       stm32f103.inc:86     *ABS*:0000000040010000 AFIO_BASE_ADR
       stm32f103.inc:89     *ABS*:0000000000000000 AFIO_EVCR
ARM GAS  tinyBasic.s 			page 109


       stm32f103.inc:90     *ABS*:0000000000000004 AFIO_MAPR
       stm32f103.inc:91     *ABS*:0000000000000008 AFIO_EXTICR1
       stm32f103.inc:92     *ABS*:000000000000000c AFIO_EXTICR2
       stm32f103.inc:93     *ABS*:0000000000000010 AFIO_EXTICR3
       stm32f103.inc:94     *ABS*:0000000000000014 AFIO_EXTICR4
       stm32f103.inc:95     *ABS*:000000000000001c AFIO_MAPR2
       stm32f103.inc:98     *ABS*:0000000040013800 USART1_BASE_ADR
       stm32f103.inc:100    *ABS*:0000000000000000 USART_SR
       stm32f103.inc:101    *ABS*:0000000000000004 USART_DR
       stm32f103.inc:102    *ABS*:0000000000000008 USART_BRR
       stm32f103.inc:103    *ABS*:000000000000000c USART_CR1
       stm32f103.inc:104    *ABS*:0000000000000010 USART_CR2
       stm32f103.inc:105    *ABS*:0000000000000014 USART_CR3
       stm32f103.inc:106    *ABS*:0000000000000018 USART_GTPR
       stm32f103.inc:109    *ABS*:00000000e000e010 STK_BASE_ADR
       stm32f103.inc:111    *ABS*:0000000000000000 STK_CTL
       stm32f103.inc:112    *ABS*:0000000000000004 STK_LOAD
       stm32f103.inc:113    *ABS*:0000000000000008 STK_VAL
       stm32f103.inc:114    *ABS*:000000000000000c STK_CALIB
       stm32f103.inc:117    *ABS*:00000000e000ed00 SCB_BASE_ADR
       stm32f103.inc:119    *ABS*:0000000000000000 SCB_CPUID
       stm32f103.inc:120    *ABS*:0000000000000004 SCB_ICSR
       stm32f103.inc:121    *ABS*:0000000000000008 SCB_VTOR
       stm32f103.inc:122    *ABS*:000000000000000c SCB_AIRCR
       stm32f103.inc:123    *ABS*:0000000000000010 SCB_SCR
       stm32f103.inc:124    *ABS*:0000000000000014 SCB_CCR
       stm32f103.inc:125    *ABS*:0000000000000018 SCB_SHPR1
       stm32f103.inc:126    *ABS*:000000000000001c SCB_SHPR2
       stm32f103.inc:127    *ABS*:0000000000000020 SCB_SHPR3
       stm32f103.inc:128    *ABS*:0000000000000024 SCB_SHCRS
       stm32f103.inc:129    *ABS*:0000000000000028 SCB_CFSR
       stm32f103.inc:130    *ABS*:000000000000002c SCB_HFSR
       stm32f103.inc:131    *ABS*:0000000000000034 SCB_MMAR
       stm32f103.inc:132    *ABS*:0000000000000038 SCB_BFAR
       stm32f103.inc:134    *ABS*:00000000000005fa SCB_VECTKEY
       stm32f103.inc:137    *ABS*:00000000e000e100 NVIC_BASE_ADR
       stm32f103.inc:138    *ABS*:0000000000000000 NVIC_ISER0
       stm32f103.inc:139    *ABS*:0000000000000004 NVIC_ISER1
       stm32f103.inc:140    *ABS*:0000000000000008 NVIC_ISER2
       stm32f103.inc:141    *ABS*:0000000000000080 NVIC_ICER0
       stm32f103.inc:142    *ABS*:0000000000000084 NVIC_ICER1
       stm32f103.inc:143    *ABS*:0000000000000088 NVIC_ICER2
       stm32f103.inc:144    *ABS*:0000000000000100 NVIC_ISPR0
       stm32f103.inc:145    *ABS*:0000000000000104 NVIC_ISPR1
       stm32f103.inc:146    *ABS*:0000000000000108 NVIC_ISPR2
       stm32f103.inc:147    *ABS*:0000000000000180 NVIC_ICPR0
       stm32f103.inc:148    *ABS*:0000000000000184 NVIC_ICPR1
       stm32f103.inc:149    *ABS*:0000000000000188 NVIC_ICPR2
       stm32f103.inc:150    *ABS*:0000000000000200 NVIC_IABR0
       stm32f103.inc:151    *ABS*:0000000000000204 NVIC_IABR1
       stm32f103.inc:152    *ABS*:0000000000000208 NVIC_IABR2
       stm32f103.inc:153    *ABS*:0000000000000300 NVIC_IPR_BASE
       stm32f103.inc:156    *ABS*:00000000e000ed10 SCR_BASE_ADR
       stm32f103.inc:157    *ABS*:0000000000000002 SCR_SLEEPONEXIT
       stm32f103.inc:158    *ABS*:0000000000000004 SCR_SLEEPDEEP
       stm32f103.inc:159    *ABS*:0000000000000010 SCR_SEVONPEND
       stm32f103.inc:162    *ABS*:0000000040007000 PWR_CR_ADR
ARM GAS  tinyBasic.s 			page 110


       stm32f103.inc:163    *ABS*:0000000000000001 PWR_CR_LPDS
       stm32f103.inc:164    *ABS*:0000000000000002 PWR_CR_PDDS
       stm32f103.inc:165    *ABS*:0000000000000004 PWR_CR_CWUF
       stm32f103.inc:166    *ABS*:0000000000000008 PWR_CR_CSBF
       stm32f103.inc:167    *ABS*:0000000000000010 PWR_CR_PVDE
       stm32f103.inc:168    *ABS*:0000000000000020 PWR_CR_PLS
       stm32f103.inc:169    *ABS*:0000000000000100 PWR_CR_DBP
       stm32f103.inc:172    *ABS*:0000000040007004 PWR_CSR_ADR
       stm32f103.inc:173    *ABS*:0000000000000001 PWR_CSR_WUF
       stm32f103.inc:174    *ABS*:0000000000000002 PWR_CSR_SBF
       stm32f103.inc:175    *ABS*:0000000000000004 PWR_CSR_PVDO
       stm32f103.inc:176    *ABS*:0000000000000100 PWR_CSR_EWUP
       stm32f103.inc:179    *ABS*:0000000040002c00 WWDG_BASE_ADR
       stm32f103.inc:180    *ABS*:0000000000000000 WWDG_CR
       stm32f103.inc:181    *ABS*:0000000000000004 WWDG_CFR
       stm32f103.inc:182    *ABS*:0000000000000008 WWDG_SR
       stm32f103.inc:185    *ABS*:0000000040003000 IWDG_BASE_ADR
       stm32f103.inc:186    *ABS*:0000000000000000 IWDG_KR
       stm32f103.inc:187    *ABS*:0000000000000004 IWDG_PR
       stm32f103.inc:188    *ABS*:0000000000000008 IWDG_RLR
       stm32f103.inc:189    *ABS*:000000000000000c IWDG_SR
           ascii.inc:24     *ABS*:0000000000000001 CTRL_A
           ascii.inc:25     *ABS*:0000000000000001 SOH
           ascii.inc:26     *ABS*:0000000000000002 CTRL_B
           ascii.inc:27     *ABS*:0000000000000002 STX
           ascii.inc:28     *ABS*:0000000000000003 CTRL_C
           ascii.inc:29     *ABS*:0000000000000003 ETX
           ascii.inc:30     *ABS*:0000000000000004 CTRL_D
           ascii.inc:31     *ABS*:0000000000000004 EOT
           ascii.inc:32     *ABS*:0000000000000005 CTRL_E
           ascii.inc:33     *ABS*:0000000000000005 ENQ
           ascii.inc:34     *ABS*:0000000000000006 CTRL_F
           ascii.inc:35     *ABS*:0000000000000006 ACK
           ascii.inc:36     *ABS*:0000000000000007 CTRL_G
           ascii.inc:37     *ABS*:0000000000000007 BELL
           ascii.inc:38     *ABS*:0000000000000008 CTRL_H
           ascii.inc:39     *ABS*:0000000000000008 BS
           ascii.inc:40     *ABS*:0000000000000009 CTRL_I
           ascii.inc:41     *ABS*:0000000000000009 TAB
           ascii.inc:42     *ABS*:000000000000000a CTRL_J
           ascii.inc:43     *ABS*:000000000000000a LF
           ascii.inc:44     *ABS*:000000000000000b CTRL_K
           ascii.inc:45     *ABS*:000000000000000b VT
           ascii.inc:46     *ABS*:000000000000000c CTRL_L
           ascii.inc:47     *ABS*:000000000000000c FF
           ascii.inc:48     *ABS*:000000000000000d CTRL_M
           ascii.inc:49     *ABS*:000000000000000d CR
           ascii.inc:50     *ABS*:000000000000000e CTRL_N
           ascii.inc:51     *ABS*:000000000000000e SO
           ascii.inc:52     *ABS*:000000000000000f CTRL_O
           ascii.inc:53     *ABS*:000000000000000f SI
           ascii.inc:54     *ABS*:0000000000000010 CTRL_P
           ascii.inc:55     *ABS*:0000000000000010 DLE
           ascii.inc:56     *ABS*:0000000000000011 CTRL_Q
           ascii.inc:57     *ABS*:0000000000000011 DC1
           ascii.inc:58     *ABS*:0000000000000011 XON
           ascii.inc:59     *ABS*:0000000000000012 CTRL_R
ARM GAS  tinyBasic.s 			page 111


           ascii.inc:60     *ABS*:0000000000000012 DC2
           ascii.inc:61     *ABS*:0000000000000013 CTRL_S
           ascii.inc:62     *ABS*:0000000000000013 DC3
           ascii.inc:63     *ABS*:0000000000000013 XOFF
           ascii.inc:64     *ABS*:0000000000000014 CTRL_T
           ascii.inc:65     *ABS*:0000000000000014 DC4
           ascii.inc:66     *ABS*:0000000000000015 CTRL_U
           ascii.inc:67     *ABS*:0000000000000015 NAK
           ascii.inc:68     *ABS*:0000000000000016 CTRL_V
           ascii.inc:69     *ABS*:0000000000000016 SYN
           ascii.inc:70     *ABS*:0000000000000017 CTRL_W
           ascii.inc:71     *ABS*:0000000000000017 ETB
           ascii.inc:72     *ABS*:0000000000000018 CTRL_X
           ascii.inc:73     *ABS*:0000000000000018 CAN
           ascii.inc:74     *ABS*:0000000000000019 CTRL_Y
           ascii.inc:75     *ABS*:0000000000000019 EM
           ascii.inc:76     *ABS*:000000000000001a CTRL_Z
           ascii.inc:77     *ABS*:000000000000001a SUB
           ascii.inc:78     *ABS*:00000000000000ff EOF
           ascii.inc:79     *ABS*:000000000000001b ESC
           ascii.inc:80     *ABS*:000000000000001c FS
           ascii.inc:81     *ABS*:000000000000001d GS
           ascii.inc:82     *ABS*:000000000000001e RS
           ascii.inc:83     *ABS*:000000000000001f US
           ascii.inc:84     *ABS*:0000000000000020 SPACE
           ascii.inc:85     *ABS*:000000000000002c COMMA
           ascii.inc:86     *ABS*:0000000000000023 SHARP
           ascii.inc:87     *ABS*:0000000000000027 TICK
      tbi_macros.inc:20     *ABS*:0000000000000100 STACK_SIZE
      tbi_macros.inc:21     *ABS*:0000000020005000 STACK_EMPTY
      tbi_macros.inc:22     *ABS*:0000000020004f00 STACK_FULL
      tbi_macros.inc:23     *ABS*:0000000000000050 TIB_SIZE
      tbi_macros.inc:24     *ABS*:0000000000000080 PAD_SIZE
      tbi_macros.inc:25     *ABS*:0000000000000010 RX_QUEUE_SIZE
      tbi_macros.inc:26     *ABS*:0000000020004f00 DSTACK_TOP
      tbi_macros.inc:27     *ABS*:0000000020005000 RSTACK_TOP
      tbi_macros.inc:30     *ABS*:0000000000000004 DEFAULT_TAB_WIDTH
      tbi_macros.inc:37     *ABS*:0000000000000000 TK_NONE
      tbi_macros.inc:38     *ABS*:0000000000000001 TK_COLON
      tbi_macros.inc:39     *ABS*:0000000000000002 TK_COMMA
      tbi_macros.inc:40     *ABS*:0000000000000003 TK_SEMIC
      tbi_macros.inc:41     *ABS*:0000000000000004 TK_SHARP
      tbi_macros.inc:42     *ABS*:0000000000000005 TK_LPAREN
      tbi_macros.inc:43     *ABS*:0000000000000006 TK_RPAREN
      tbi_macros.inc:44     *ABS*:0000000000000007 TK_PLUS
      tbi_macros.inc:45     *ABS*:0000000000000008 TK_MINUS
      tbi_macros.inc:46     *ABS*:0000000000000009 TK_MULT
      tbi_macros.inc:47     *ABS*:000000000000000a TK_DIV
      tbi_macros.inc:48     *ABS*:000000000000000b TK_MOD
      tbi_macros.inc:49     *ABS*:000000000000000c TK_ARRAY
      tbi_macros.inc:50     *ABS*:000000000000000d TK_EQUAL
      tbi_macros.inc:51     *ABS*:000000000000000e TK_GT
      tbi_macros.inc:52     *ABS*:000000000000000f TK_LT
      tbi_macros.inc:53     *ABS*:0000000000000010 TK_GE
      tbi_macros.inc:54     *ABS*:0000000000000011 TK_LE
      tbi_macros.inc:55     *ABS*:0000000000000012 TK_NE
      tbi_macros.inc:57     *ABS*:0000000000000013 TK_CHAR
ARM GAS  tinyBasic.s 			page 112


      tbi_macros.inc:58     *ABS*:0000000000000014 TK_VAR
      tbi_macros.inc:59     *ABS*:0000000000000015 TK_IFUNC
      tbi_macros.inc:60     *ABS*:0000000000000016 TK_CFUNC
      tbi_macros.inc:61     *ABS*:0000000000000017 TK_CMD
      tbi_macros.inc:63     *ABS*:0000000000000018 TK_SCONST
      tbi_macros.inc:64     *ABS*:0000000000000019 TK_CONST
      tbi_macros.inc:65     *ABS*:000000000000001a TK_LABEL
      tbi_macros.inc:66     *ABS*:000000000000001b TK_INTGR
      tbi_macros.inc:67     *ABS*:000000000000001c TK_QSTR
      tbi_macros.inc:68     *ABS*:000000000000001d TK_INVALID
      tbi_macros.inc:73     *ABS*:0000000000000000 ERR_NONE
      tbi_macros.inc:74     *ABS*:0000000000000001 ERR_MEM_FULL
      tbi_macros.inc:75     *ABS*:0000000000000002 ERR_SYNTAX
      tbi_macros.inc:76     *ABS*:0000000000000003 ERR_MATH_OVF
      tbi_macros.inc:77     *ABS*:0000000000000004 ERR_DIV0
      tbi_macros.inc:78     *ABS*:0000000000000005 ERR_NO_LINE
      tbi_macros.inc:79     *ABS*:0000000000000006 ERR_RUN_ONLY
      tbi_macros.inc:80     *ABS*:0000000000000007 ERR_CMD_ONLY
      tbi_macros.inc:81     *ABS*:0000000000000008 ERR_DUPLICATE
      tbi_macros.inc:82     *ABS*:0000000000000009 ERR_NOT_FILE
      tbi_macros.inc:83     *ABS*:000000000000000a ERR_BAD_VALUE
      tbi_macros.inc:84     *ABS*:000000000000000b ERR_NO_ACCESS
      tbi_macros.inc:85     *ABS*:000000000000000c ERR_NO_DATA
      tbi_macros.inc:86     *ABS*:000000000000000d ERR_NO_PROG
      tbi_macros.inc:87     *ABS*:000000000000000e ERR_NO_FSPACE
      tbi_macros.inc:88     *ABS*:000000000000000f ERR_BUF_FULL
      tbi_macros.inc:89     *ABS*:0000000000000010 ERR_CANT_PROG
      tbi_macros.inc:95     *ABS*:0000000000000000 MATH_OVF
      tbi_macros.inc:97     *ABS*:0000000000000004 CELL_SIZE
      tbi_macros.inc:115    *ABS*:0000000000000000 IN_SAVED
      tbi_macros.inc:116    *ABS*:0000000000000004 COUNT
      tbi_macros.inc:117    *ABS*:0000000000000008 BASICPTR
      tbi_macros.inc:118    *ABS*:000000000000000c DATAPTR
      tbi_macros.inc:119    *ABS*:0000000000000010 DATA
      tbi_macros.inc:120    *ABS*:0000000000000014 DATALEN
      tbi_macros.inc:121    *ABS*:0000000000000018 BASE
      tbi_macros.inc:122    *ABS*:000000000000001c TICKS
      tbi_macros.inc:123    *ABS*:0000000000000020 TIMER
      tbi_macros.inc:124    *ABS*:0000000000000024 SEED
      tbi_macros.inc:125    *ABS*:0000000000000028 FSPTR
      tbi_macros.inc:126    *ABS*:000000000000002c FSFREE
      tbi_macros.inc:127    *ABS*:0000000000000030 TXTBGN
      tbi_macros.inc:128    *ABS*:0000000000000034 TXTEND
      tbi_macros.inc:129    *ABS*:0000000000000038 LOOP_DEPTH
      tbi_macros.inc:130    *ABS*:000000000000003c ARRAY_SIZE
      tbi_macros.inc:131    *ABS*:0000000000000040 FLAGS
      tbi_macros.inc:132    *ABS*:0000000000000044 TAB_WIDTH
      tbi_macros.inc:133    *ABS*:0000000000000048 RX_HEAD
      tbi_macros.inc:134    *ABS*:000000000000004c RX_TAIL
      tbi_macros.inc:135    *ABS*:0000000000000050 RX_QUEUE
      tbi_macros.inc:136    *ABS*:0000000000000060 VARS
      tbi_macros.inc:137    *ABS*:0000000000000068 VARS_SIZE
      tbi_macros.inc:138    *ABS*:00000000000000c8 ARRAY_ADR
      tbi_macros.inc:139    *ABS*:00000000000000cc TRACE_LEVEL
      tbi_macros.inc:140    *ABS*:00000000000000d0 HERE
      tbi_macros.inc:141    *ABS*:00000000000000d0 BASIC_START
      tbi_macros.inc:144    *ABS*:0000000000000001 FRUN
ARM GAS  tinyBasic.s 			page 113


      tbi_macros.inc:145    *ABS*:0000000000000002 FTRAP
      tbi_macros.inc:146    *ABS*:0000000000000004 FLOOP
      tbi_macros.inc:147    *ABS*:0000000000000008 FSTOP
      tbi_macros.inc:148    *ABS*:0000000000000010 FBREAK
      tbi_macros.inc:149    *ABS*:0000000000000020 FCOMP
      tbi_macros.inc:150    *ABS*:0000000000000040 FAUTORUN
      tbi_macros.inc:151    *ABS*:0000000000000080 FPRINT
      tbi_macros.inc:153    *ABS*:0000000000000006 FIRST_DATA_ITEM
      tbi_macros.inc:154    *ABS*:000000000000ffff MAX_LINENO
       cmd_index.inc:25     *ABS*:0000000000000000 ABS_IDX
       cmd_index.inc:26     *ABS*:0000000000000001 AND_IDX
       cmd_index.inc:27     *ABS*:0000000000000002 ASC_IDX
       cmd_index.inc:28     *ABS*:0000000000000003 AWU_IDX
       cmd_index.inc:29     *ABS*:0000000000000004 BIT_IDX
       cmd_index.inc:30     *ABS*:0000000000000005 BRES_IDX
       cmd_index.inc:31     *ABS*:0000000000000006 BSET_IDX
       cmd_index.inc:32     *ABS*:0000000000000007 BTEST_IDX
       cmd_index.inc:33     *ABS*:0000000000000008 BTOGL_IDX
       cmd_index.inc:34     *ABS*:0000000000000009 CHAR_IDX
       cmd_index.inc:35     *ABS*:000000000000000a CLS_IDX
       cmd_index.inc:36     *ABS*:000000000000000b CONST_IDX
       cmd_index.inc:37     *ABS*:000000000000000c DATA_IDX
       cmd_index.inc:38     *ABS*:000000000000000d DATALN_IDX
       cmd_index.inc:39     *ABS*:000000000000000e DEC_IDX
       cmd_index.inc:40     *ABS*:000000000000000f DIR_IDX
       cmd_index.inc:41     *ABS*:0000000000000010 DO_IDX
       cmd_index.inc:42     *ABS*:0000000000000011 DROP_IDX
       cmd_index.inc:43     *ABS*:0000000000000012 DUMP_IDX
       cmd_index.inc:44     *ABS*:0000000000000013 END_IDX
       cmd_index.inc:45     *ABS*:0000000000000014 ERASE_IDX
       cmd_index.inc:46     *ABS*:0000000000000015 FOR_IDX
       cmd_index.inc:47     *ABS*:0000000000000016 FORGET_IDX
       cmd_index.inc:48     *ABS*:0000000000000017 FREE_IDX
       cmd_index.inc:49     *ABS*:0000000000000018 GET_IDX
       cmd_index.inc:50     *ABS*:0000000000000019 GOSUB_IDX
       cmd_index.inc:51     *ABS*:000000000000001a GOTO_IDX
       cmd_index.inc:52     *ABS*:000000000000001b HEX_IDX
       cmd_index.inc:53     *ABS*:000000000000001c IF_IDX
       cmd_index.inc:54     *ABS*:000000000000001d IN_IDX
       cmd_index.inc:55     *ABS*:000000000000001e INPUT_IDX
       cmd_index.inc:56     *ABS*:000000000000001f INVERT_IDX
       cmd_index.inc:57     *ABS*:0000000000000020 KEY_IDX
       cmd_index.inc:58     *ABS*:0000000000000021 LET_IDX
       cmd_index.inc:59     *ABS*:0000000000000022 LIST_IDX
       cmd_index.inc:60     *ABS*:0000000000000023 LOAD_IDX
       cmd_index.inc:61     *ABS*:0000000000000024 LOCATE_IDX
       cmd_index.inc:62     *ABS*:0000000000000025 LSHIFT_IDX
       cmd_index.inc:63     *ABS*:0000000000000026 NEW_IDX
       cmd_index.inc:64     *ABS*:0000000000000027 NEXT_IDX
       cmd_index.inc:65     *ABS*:0000000000000028 NOT_IDX
       cmd_index.inc:66     *ABS*:0000000000000029 OR_IDX
       cmd_index.inc:67     *ABS*:000000000000002a OUT_IDX
       cmd_index.inc:68     *ABS*:000000000000002b PAD_IDX
       cmd_index.inc:69     *ABS*:000000000000002c PAUSE_IDX
       cmd_index.inc:70     *ABS*:000000000000002d PMODE_IDX
       cmd_index.inc:71     *ABS*:000000000000002e PEEK8_IDX
       cmd_index.inc:72     *ABS*:000000000000002f PEEK16_IDX
ARM GAS  tinyBasic.s 			page 114


       cmd_index.inc:73     *ABS*:0000000000000030 PEEK32_IDX
       cmd_index.inc:74     *ABS*:0000000000000031 POKE8_IDX
       cmd_index.inc:75     *ABS*:0000000000000032 POKE16_IDX
       cmd_index.inc:76     *ABS*:0000000000000033 POKE32_IDX
       cmd_index.inc:77     *ABS*:0000000000000034 POP_IDX
       cmd_index.inc:78     *ABS*:0000000000000035 PRT_IDX
       cmd_index.inc:79     *ABS*:0000000000000036 PUSH_IDX
       cmd_index.inc:80     *ABS*:0000000000000037 PUT_IDX
       cmd_index.inc:81     *ABS*:0000000000000038 QKEY_IDX
       cmd_index.inc:82     *ABS*:0000000000000039 READ_IDX
       cmd_index.inc:83     *ABS*:000000000000003a REM_IDX
       cmd_index.inc:84     *ABS*:000000000000003b REST_IDX
       cmd_index.inc:85     *ABS*:000000000000003c RET_IDX
       cmd_index.inc:86     *ABS*:000000000000003d RND_IDX
       cmd_index.inc:87     *ABS*:000000000000003e RSHIFT_IDX
       cmd_index.inc:88     *ABS*:000000000000003f RUN_IDX
       cmd_index.inc:89     *ABS*:0000000000000040 SAVE_IDX
       cmd_index.inc:90     *ABS*:0000000000000041 SLEEP_IDX
       cmd_index.inc:91     *ABS*:0000000000000042 SPC_IDX
       cmd_index.inc:92     *ABS*:0000000000000043 STEP_IDX
       cmd_index.inc:93     *ABS*:0000000000000044 STOP_IDX
       cmd_index.inc:94     *ABS*:0000000000000045 STORE_IDX
       cmd_index.inc:95     *ABS*:0000000000000046 TAB_IDX
       cmd_index.inc:96     *ABS*:0000000000000047 THEN_IDX
       cmd_index.inc:97     *ABS*:0000000000000048 TICKS_IDX
       cmd_index.inc:98     *ABS*:0000000000000049 TIMER_IDX
       cmd_index.inc:99     *ABS*:000000000000004a TMROUT_IDX
       cmd_index.inc:100    *ABS*:000000000000004b TO_IDX
       cmd_index.inc:101    *ABS*:000000000000004c TRACE_IDX
       cmd_index.inc:102    *ABS*:000000000000004d UBOUND_IDX
       cmd_index.inc:103    *ABS*:000000000000004e UFLASH_IDX
       cmd_index.inc:104    *ABS*:000000000000004f UNTIL_IDX
       cmd_index.inc:105    *ABS*:0000000000000050 WAIT_IDX
       cmd_index.inc:106    *ABS*:0000000000000051 WORDS_IDX
       cmd_index.inc:107    *ABS*:0000000000000052 XOR_IDX
       cmd_index.inc:108    *ABS*:0000000000000053 XPOS_IDX
       cmd_index.inc:109    *ABS*:0000000000000054 YPOS_IDX
         tinyBasic.s:50     .text:0000000000000000 strlen
         tinyBasic.s:50     .text:0000000000000000 $t
         tinyBasic.s:74     .text:0000000000000018 cmove
         tinyBasic.s:86     .text:0000000000000030 move_from_end
         tinyBasic.s:80     .text:0000000000000022 move_from_low
         tinyBasic.s:108    .text:0000000000000044 strcpy
         tinyBasic.s:133    .text:0000000000000058 strcmp
         tinyBasic.s:158    .text:0000000000000074 prt_tok
         tinyBasic.s:172    .text:00000000000000bc tok_msg
         tinyBasic.s:172    .text:00000000000000bc $d
         tinyBasic.s:172    .text:00000000000000c4 $t
         tinyBasic.s:186    .text:00000000000000c4 prt_row
         tinyBasic.s:297    .text:0000000000000228 prt_chars
         tinyBasic.s:213    .text:0000000000000124 show_line_nbr
         tinyBasic.s:225    .text:0000000000000148 show_data_stack
         tinyBasic.s:240    .text:0000000000000188 data_stack
         tinyBasic.s:241    .text:0000000000000188 $d
         tinyBasic.s:247    .text:0000000000000198 show_main_stack
         tinyBasic.s:262    .text:00000000000001dc main_stack
         tinyBasic.s:263    .text:00000000000001dc $d
ARM GAS  tinyBasic.s 			page 115


         tinyBasic.s:269    .text:00000000000001ec show_trace
         tinyBasic.s:317    .text:000000000000024c search_target
         tinyBasic.s:1756   .text:0000000000000e20 next_token
         tinyBasic.s:380    .text:00000000000002c8 search_label
         tinyBasic.s:2024   .text:00000000000010a8 expression
         tinyBasic.s:1310   .text:0000000000000a34 syntax_error
         tinyBasic.s:418    .text:00000000000002f0 search_lineno
         tinyBasic.s:1325   .text:0000000000000a3c tb_error
         tinyBasic.s:349    .text:0000000000000298 search_const
         tinyBasic.s:449    .text:0000000000000310 delete_line
         tinyBasic.s:474    .text:000000000000033c create_gap
         tinyBasic.s:499    .text:0000000000000364 insert_line
         tinyBasic.s:538    .text:00000000000003b4 compile
         tinyBasic.s:1662   .text:0000000000000d7c pad
         tinyBasic.s:863    .text:00000000000006b0 parse_int
         tinyBasic.s:611    .text:000000000000045c comp_token
         tinyBasic.s:694    .text:0000000000000562 store_r0
         tinyBasic.s:957    .text:0000000000000750 skip
         tinyBasic.s:1042   .text:00000000000007b8 is_letter
         tinyBasic.s:778    .text:00000000000005f4 comp_label
         tinyBasic.s:703    .text:0000000000000582 token_exit
         tinyBasic.s:685    .text:000000000000053e tick2
         tinyBasic.s:721    .text:0000000000000588 is_special
         tinyBasic.s:743    .text:00000000000005cc token_ofs
         tinyBasic.s:634    .text:00000000000004b6 tok_idx0
         tinyBasic.s:697    .text:0000000000000568 try_number
         tinyBasic.s:638    .text:00000000000004b8 single
         tinyBasic.s:738    .text:00000000000005bd tok_single
         tinyBasic.s:642    .text:00000000000004c0 lt
         tinyBasic.s:648    .text:00000000000004ce gt
         tinyBasic.s:661    .text:00000000000004f2 bkslash
         tinyBasic.s:668    .text:0000000000000508 prt_cmd
         tinyBasic.s:674    .text:000000000000051a quote
         tinyBasic.s:896    .text:00000000000006e8 parse_quote
         tinyBasic.s:679    .text:000000000000052e tick
         tinyBasic.s:735    .text:00000000000005a8 char_list
         tinyBasic.s:736    .text:00000000000005a8 $d
         tinyBasic.s:744    .text:00000000000005cc $d
         tinyBasic.s:761    .text:00000000000005f4 $t
         tinyBasic.s:976    .text:0000000000000768 upper
         tinyBasic.s:2330   .rodata.dictionary:0000000000000670 kword_dict
         tinyBasic.s:1477   .text:0000000000000bb8 search_dict
         tinyBasic.s:833    .text:000000000000068c compress_label
         tinyBasic.s:1073   .text:00000000000007d8 atoi
         tinyBasic.s:927    .text:000000000000071c get_escaped_char
         tinyBasic.s:944    .text:0000000000000746 escaped
         tinyBasic.s:944    .text:0000000000000746 $d
         tinyBasic.s:957    .text:000000000000074e $t
         tinyBasic.s:994    .text:0000000000000778 is_digit
         tinyBasic.s:1018   .text:0000000000000794 is_hex
         tinyBasic.s:1117   .text:0000000000000824 cmd_name
         tinyBasic.s:1143   .text:0000000000000848 decompile_line
         tinyBasic.s:1160   .text:000000000000088e decomp_loop
         tinyBasic.s:1270   .text:0000000000000a0b single_char
         tinyBasic.s:1265   .text:00000000000009f6 relop_str
         tinyBasic.s:1265   .text:00000000000009f6 $d
         tinyBasic.s:1266   .text:0000000000000a02 ge_str
ARM GAS  tinyBasic.s 			page 116


         tinyBasic.s:1267   .text:0000000000000a05 le_str
         tinyBasic.s:1268   .text:0000000000000a08 ne_str
         tinyBasic.s:1287   .text:0000000000000a1c modulo
         tinyBasic.s:1358   .text:0000000000000acc compile_error
         tinyBasic.s:1329   .text:0000000000000a44 rt_error
         tinyBasic.s:1373   .text:0000000000000b1e rt_error_msg
         tinyBasic.s:1377   .text:0000000000000b3e err_msg
         tinyBasic.s:1374   .text:0000000000000b2f token_at_msg
         tinyBasic.s:2786   .text.basic:00000000000003c4 dump01
         tinyBasic.s:1675   .text:0000000000000d8c warm_start
         tinyBasic.s:1373   .text:0000000000000b1e $d
         tinyBasic.s:1385   .rodata.tb_error:0000000000000000 err_mem_full
         tinyBasic.s:1386   .rodata.tb_error:000000000000000d err_syntax
         tinyBasic.s:1387   .rodata.tb_error:000000000000001b err_math_ovf
         tinyBasic.s:1388   .rodata.tb_error:0000000000000034 err_div0
         tinyBasic.s:1389   .rodata.tb_error:0000000000000043 err_no_line
         tinyBasic.s:1390   .rodata.tb_error:0000000000000059 err_run_only
         tinyBasic.s:1391   .rodata.tb_error:000000000000006f err_cmd_only
         tinyBasic.s:1392   .rodata.tb_error:0000000000000089 err_duplicate
         tinyBasic.s:1393   .rodata.tb_error:000000000000009a err_not_file
         tinyBasic.s:1394   .rodata.tb_error:00000000000000ab err_bad_value
         tinyBasic.s:1395   .rodata.tb_error:00000000000000b7 err_no_access
         tinyBasic.s:1396   .rodata.tb_error:00000000000000ea err_no_data
         tinyBasic.s:1397   .rodata.tb_error:00000000000000fa err_no_prog
         tinyBasic.s:1398   .rodata.tb_error:000000000000010e err_no_fspace
         tinyBasic.s:1399   .rodata.tb_error:0000000000000121 err_buf_full
         tinyBasic.s:1400   .rodata.tb_error:000000000000012e err_cant_prog
         tinyBasic.s:1402   .rodata.tb_error:000000000000016a rt_msg
         tinyBasic.s:1403   .rodata.tb_error:000000000000017c comp_msg
         tinyBasic.s:1404   .rodata.tb_error:000000000000018d tk_id
         tinyBasic.s:1414   .text:0000000000000b82 $t
         tinyBasic.s:1414   .text:0000000000000b84 skip_line
         tinyBasic.s:1431   .text:0000000000000b8c BTGL
         tinyBasic.s:1449   .text:0000000000000b90 kword_cmp
         tinyBasic.s:1515   .text:0000000000000bf6 cold_start
         tinyBasic.s:1538   .text:0000000000000c54 src_addr
         tinyBasic.s:1540   .text:0000000000000c58 dest_addr
         tinyBasic.s:1661   .text:0000000000000d78 tib
         tinyBasic.s:1542   .text:0000000000000c5c sysvar_size
         tinyBasic.s:1553   .text:0000000000000c60 prt_version
         tinyBasic.s:1609   .text:0000000000000d04 clear_basic
         tinyBasic.s:3646   .text.basic:0000000000000c8c search_free
         tinyBasic.s:1539   .text:0000000000000c54 $d
         tinyBasic.s:2203   .rodata:0000000000000000 uzero
         tinyBasic.s:2229   .rodata:00000000000000d4 ulast
         tinyBasic.s:1553   .text:0000000000000c60 $t
         tinyBasic.s:1576   .text:0000000000000cc4 version_msg
         tinyBasic.s:1578   .text:0000000000000ce4 version
         tinyBasic.s:1577   .text:0000000000000cc4 $d
         tinyBasic.s:1593   .text:0000000000000ce8 clear_vars
         tinyBasic.s:1644   .text:0000000000000d4c warm_init
         tinyBasic.s:1660   .text:0000000000000d74 dstack
         tinyBasic.s:1659   .text:0000000000000d70 mstack
         tinyBasic.s:1659   .text:0000000000000d70 $d
         tinyBasic.s:1663   .text:0000000000000d80 array
         tinyBasic.s:1664   .text:0000000000000d84 ready
         tinyBasic.s:1695   .text:0000000000000da4 cmd_line
ARM GAS  tinyBasic.s 			page 117


         tinyBasic.s:1707   .text:0000000000000dd8 interpreter
         tinyBasic.s:1740   .text:0000000000000e18 execute
         tinyBasic.s:3109   .text.basic:0000000000000702 let_var
         tinyBasic.s:3114   .text.basic:000000000000070e let_array
         tinyBasic.s:2339   .rodata.fn_tabld:0000000000000000 fn_table
         tinyBasic.s:1762   .text:0000000000000e2e end_of_line
         tinyBasic.s:1766   .text:0000000000000e38 next_line
         tinyBasic.s:1820   .text:0000000000000eac expect
         tinyBasic.s:1839   .text:0000000000000ec8 func_args
         tinyBasic.s:1859   .text:0000000000000ef4 arg_list
         tinyBasic.s:1893   .text:0000000000000f34 factor
         tinyBasic.s:2132   .text:0000000000001190 get_array_element
         tinyBasic.s:2170   .text:00000000000011b8 get_var
         tinyBasic.s:1973   .text:0000000000001030 term
         tinyBasic.s:2067   .text:0000000000001110 relation
         tinyBasic.s:2114   .text:0000000000001188 relop_jmp
         tinyBasic.s:2086   .text:0000000000001158 rel_idx0
         tinyBasic.s:2087   .text:0000000000001158 rel_eq
         tinyBasic.s:2104   .text:000000000000116e rel_false
         tinyBasic.s:2090   .text:000000000000115c rel_gt
         tinyBasic.s:2093   .text:0000000000001160 rel_ge
         tinyBasic.s:2096   .text:0000000000001164 rel_lt
         tinyBasic.s:2099   .text:0000000000001168 rel_le
         tinyBasic.s:2102   .text:000000000000116c rel_ne
         tinyBasic.s:2115   .text:0000000000001188 $d
         tinyBasic.s:2132   .text:000000000000118e $t
         tinyBasic.s:2152   .text:00000000000011a4 set_array_element
         tinyBasic.s:2188   .text:00000000000011c8 set_var
         tinyBasic.s:4282   .rodata.fs:0000000000000000 FILE_SYSTEM
         tinyBasic.s:2224   .rodata:0000000000000050 $d
         tinyBasic.s:2237   .rodata.dictionary:0000000000000000 kword_end
         tinyBasic.s:2236   *ABS*:0000000000000000 link
         tinyBasic.s:2331   .rodata.dictionary:0000000000000670 LINK
         tinyBasic.s:2238   .rodata.dictionary:000000000000000d $d
         tinyBasic.s:2326   .rodata.dictionary:0000000000000664 first_link
         tinyBasic.s:2373   .text.basic:0000000000000000 abs
         tinyBasic.s:2395   .text.basic:0000000000000030 bit_and
         tinyBasic.s:2410   .text.basic:0000000000000054 ascii
         tinyBasic.s:2435   .text.basic:000000000000009c awu
         tinyBasic.s:2475   .text.basic:0000000000000104 bitmask
         tinyBasic.s:2497   .text.basic:0000000000000128 bit_reset
         tinyBasic.s:2522   .text.basic:0000000000000154 bit_set
         tinyBasic.s:2562   .text.basic:00000000000001a4 bit_test
         tinyBasic.s:2546   .text.basic:000000000000017c bit_toggle
         tinyBasic.s:2594   .text.basic:00000000000001f0 char
         tinyBasic.s:2586   .text.basic:00000000000001e4 cls
         tinyBasic.s:2611   .text.basic:0000000000000210 const
         tinyBasic.s:2650   .text.basic:0000000000000294 data_line
         tinyBasic.s:2755   .text.basic:000000000000038c dec_base
         tinyBasic.s:3711   .text.basic:0000000000000cf8 directory
         tinyBasic.s:2764   .text.basic:0000000000000394 do_loop
         tinyBasic.s:4231   .text.basic:0000000000001284 drop
         tinyBasic.s:2779   .text.basic:000000000000039c dump
         tinyBasic.s:2823   .text.basic:0000000000000444 cmd_end
         tinyBasic.s:2851   .text.basic:0000000000000484 erase
         tinyBasic.s:2862   .text.basic:0000000000000498 for
         tinyBasic.s:3751   .text.basic:0000000000000db0 forget
ARM GAS  tinyBasic.s 			page 118


         tinyBasic.s:3914   .text.basic:0000000000000fc8 free
         tinyBasic.s:4244   .text.basic:00000000000012a0 get
         tinyBasic.s:2943   .text.basic:0000000000000554 gosub
         tinyBasic.s:2969   .text.basic:0000000000000594 goto
         tinyBasic.s:2977   .text.basic:00000000000005a0 hex_base
         tinyBasic.s:2986   .text.basic:00000000000005a8 if
         tinyBasic.s:3259   .text.basic:00000000000008c8 pin_input
         tinyBasic.s:3005   .text.basic:00000000000005c0 input_var
         tinyBasic.s:3073   .text.basic:00000000000006b8 invert
         tinyBasic.s:3086   .text.basic:00000000000006d8 key
         tinyBasic.s:3102   .text.basic:00000000000006ec let
         tinyBasic.s:3145   .text.basic:0000000000000778 list
         tinyBasic.s:3780   .text.basic:0000000000000dfc load
         tinyBasic.s:3196   .text.basic:0000000000000828 locate
         tinyBasic.s:3210   .text.basic:000000000000084c lshift
         tinyBasic.s:3224   .text.basic:000000000000086c new
         tinyBasic.s:2907   .text.basic:00000000000004fc next
         tinyBasic.s:3233   .text.basic:000000000000088c func_not
         tinyBasic.s:3245   .text.basic:00000000000008a4 bit_or
         tinyBasic.s:3277   .text.basic:00000000000008f4 out
         tinyBasic.s:3295   .text.basic:0000000000000920 pad_ref
         tinyBasic.s:3306   .text.basic:000000000000092c pause
         tinyBasic.s:3334   .text.basic:0000000000000948 pin_mode
         tinyBasic.s:3399   .text.basic:0000000000000a14 peek8
         tinyBasic.s:3412   .text.basic:0000000000000a30 peek16
         tinyBasic.s:3425   .text.basic:0000000000000a4c peek32
         tinyBasic.s:3439   .text.basic:0000000000000a68 poke8
         tinyBasic.s:3451   .text.basic:0000000000000a80 poke16
         tinyBasic.s:3463   .text.basic:0000000000000a98 poke32
         tinyBasic.s:4222   .text.basic:0000000000001278 fn_pop
         tinyBasic.s:3477   .text.basic:0000000000000ab0 print
         tinyBasic.s:4214   .text.basic:000000000000126c cmd_push
         tinyBasic.s:4259   .text.basic:00000000000012c8 put
         tinyBasic.s:3550   .text.basic:0000000000000ba8 qkey
         tinyBasic.s:2680   .text.basic:00000000000002e8 read
         tinyBasic.s:2722   .text.basic:0000000000000348 restore
         tinyBasic.s:2958   .text.basic:000000000000057c return
         tinyBasic.s:3562   .text.basic:0000000000000bc4 random
         tinyBasic.s:3585   .text.basic:0000000000000c08 rshift
         tinyBasic.s:3598   .text.basic:0000000000000c28 run
         tinyBasic.s:3833   .text.basic:0000000000000e8c save
         tinyBasic.s:3927   .text.basic:0000000000000fdc sleep
         tinyBasic.s:3941   .text.basic:0000000000000ffc spc
         tinyBasic.s:2893   .text.basic:00000000000004e4 step
         tinyBasic.s:3970   .text.basic:0000000000001034 stop
         tinyBasic.s:2831   .text.basic:000000000000044c store
         tinyBasic.s:3992   .text.basic:0000000000001078 tab
         tinyBasic.s:2997   .text.basic:00000000000005bc then
         tinyBasic.s:4008   .text.basic:00000000000010a0 get_ticks
         tinyBasic.s:4017   .text.basic:00000000000010a8 set_timer
         tinyBasic.s:4029   .text.basic:00000000000010bc timeout
         tinyBasic.s:2880   .text.basic:00000000000004cc to
         tinyBasic.s:4058   .text.basic:00000000000010e8 trace
         tinyBasic.s:4074   .text.basic:0000000000001104 ubound
         tinyBasic.s:4086   .text.basic:000000000000111c uflash
         tinyBasic.s:4097   .text.basic:0000000000001124 until
         tinyBasic.s:4112   .text.basic:0000000000001144 wait
ARM GAS  tinyBasic.s 			page 119


         tinyBasic.s:4137   .text.basic:0000000000001178 words
         tinyBasic.s:4176   .text.basic:0000000000001224 bit_xor
         tinyBasic.s:4190   .text.basic:0000000000001248 xpos
         tinyBasic.s:4199   .text.basic:0000000000001258 ypos
         tinyBasic.s:2373   .text.basic:0000000000000000 $t
         tinyBasic.s:2385   .text.basic:0000000000000028 power_adc
         tinyBasic.s:2388   .text.basic:000000000000002c analog_read
         tinyBasic.s:2427   .text.basic:0000000000000098 autorun
         tinyBasic.s:3299   .text.basic:0000000000000928 pad_adr
         tinyBasic.s:2699   .text.basic:0000000000000320 seek_next
         tinyBasic.s:2744   .text.basic:000000000000037e no_data_line
         tinyBasic.s:2740   .text.basic:0000000000000378 try_next_line
         tinyBasic.s:2797   .text.basic:00000000000003e4 print_dump_header
         tinyBasic.s:2855   .text.basic:0000000000000494 user_space
         tinyBasic.s:2855   .text.basic:0000000000000494 $d
         tinyBasic.s:4273   .rodata.user:0000000000000000 user
         tinyBasic.s:2862   .text.basic:0000000000000498 $t
         tinyBasic.s:2946   .text.basic:0000000000000562 target
         tinyBasic.s:3066   .text.basic:00000000000006b4 str_buffer
         tinyBasic.s:3065   .text.basic:00000000000006b0 input_buffer
         tinyBasic.s:3065   .text.basic:00000000000006b0 $d
         tinyBasic.s:3073   .text.basic:00000000000006b8 $t
         tinyBasic.s:3190   .text.basic:0000000000000824 out_buff
         tinyBasic.s:3190   .text.basic:0000000000000824 $d
         tinyBasic.s:3196   .text.basic:0000000000000828 $t
         tinyBasic.s:3299   .text.basic:0000000000000928 $d
         tinyBasic.s:3306   .text.basic:000000000000092c $t
         tinyBasic.s:3535   .text.basic:0000000000000b86 unget_exit
         tinyBasic.s:3537   .text.basic:0000000000000b8e print_exit
         tinyBasic.s:3699   .text.basic:0000000000000cf4 fs_addr
         tinyBasic.s:3674   .text.basic:0000000000000cb0 search_file
         tinyBasic.s:3678   .text.basic:0000000000000cb8 cmp_loop
         tinyBasic.s:3699   .text.basic:0000000000000cf4 $d
         tinyBasic.s:3711   .text.basic:0000000000000cf8 $t
         tinyBasic.s:3734   .text.basic:0000000000000d70 no_more_file
         tinyBasic.s:3744   .text.basic:0000000000000da8 fcount
         tinyBasic.s:3744   .text.basic:0000000000000da8 $d
         tinyBasic.s:3906   .text.basic:0000000000000fb4 fsize
         tinyBasic.s:3907   .text.basic:0000000000000fc0 data_bytes
         tinyBasic.s:3851   .text.basic:0000000000000ed4 new_file
         tinyBasic.s:3906   .text.basic:0000000000000fb4 $d
         tinyBasic.s:3914   .text.basic:0000000000000fc6 $t
         tinyBasic.s:3952   .text.basic:0000000000001024 spi_read
         tinyBasic.s:3955   .text.basic:0000000000001028 spi_enable
         tinyBasic.s:3958   .text.basic:000000000000102c spi_select
         tinyBasic.s:3961   .text.basic:0000000000001030 spi_write
         tinyBasic.s:4042   .text.basic:00000000000010d0 tone
         tinyBasic.s:4169   .text.basic:000000000000120e dict_words
         tinyBasic.s:4169   .text.basic:000000000000120e $d
         tinyBasic.s:4176   .text.basic:0000000000001222 $t
         tinyBasic.s:4272   .rodata.user:0000000000000000 $d
         tinyBasic.s:4271   .text.basic:00000000000012ee $d
         tinyBasic.s:4282   .text.basic:00000000000012f0 $d
         tinyBasic.s:4282   .text:00000000000011d8 $d
         tinyBasic.s:247    .text:0000000000000195 $d
         tinyBasic.s:247    .text:0000000000000196 $t
         tinyBasic.s:269    .text:00000000000001e9 $d
ARM GAS  tinyBasic.s 			page 120


         tinyBasic.s:269    .text:00000000000001ea $t
         tinyBasic.s:742    .text:00000000000005cb $d
         tinyBasic.s:1287   .text:0000000000000a1b $d
         tinyBasic.s:1287   .text:0000000000000a1c $t
         tinyBasic.s:1580   .text:0000000000000ce5 $d
         tinyBasic.s:1580   .text:0000000000000ce6 $t
         tinyBasic.s:1675   .text:0000000000000d8b $d
         tinyBasic.s:1675   .text:0000000000000d8c $t
         tinyBasic.s:3751   .text.basic:0000000000000daf $d
         tinyBasic.s:3751   .text.basic:0000000000000db0 $t

UNDEFINED SYMBOLS
uart_puts
print_int
uart_putc
cr
cursor_x
print_hex
spaces
itoa
vectors_size
_mstack
_dstack
_tib
_pad
readln
clear_screen
flash_store
erase_page
uart_getc
set_curpos
tabulation
uart_qkey
page_align
unlock
hword_write
get_curpos
