ARM GAS  stm32-tbi.s 			page 1


   1              	////
   2              	// Copyright Jacques Deschênes 2021 
   3              	// This file is part of stm32-tbi 
   4              	//
   5              	//     stm32-tbi is free software: you can redistribute it and/or modify
   6              	//     it under the terms of the GNU General Public License as published by
   7              	//     the Free Software Foundation, either version 3 of the License, or
   8              	//     (at your option) any later version.
   9              	//
  10              	//     stm32-tbi is distributed in the hope that it will be useful,
  11              	//     but WITHOUT ANY WARRANTY// without even the implied warranty of
  12              	//     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  13              	//     GNU General Public License for more details.
  14              	//
  15              	//     You should have received a copy of the GNU General Public License
  16              	//     along with stm32-tbi.  If not, see <http://www.gnu.org/licenses/>.
  17              	////
  18              	//--------------------------------------
  19              	/*****************************************
  20              	    REGISTERS USAGE 
  21              	
  22              	 R0-R3      // function parameters 
  23              	 R4         //  system variables base address 
  24              	 R5         //  FOR loop variable address 
  25              	 R6         //  FOR loop limit 
  26              	 R7         //  FOR loop increment 
  27              	 T1-T2      //  temporary registers
  28              	 R10        //  interpreter line index 
  29              	 R11        //  interpreter BASIC line address 
  30              	 R12        //  parameters stack pointer 
  31              	*****************************************/
  32              	
  33              	  .syntax unified
  34              	  .cpu cortex-m3
  35              	  .fpu softvfp
  36              	  .thumb
  37              	
  38              	  .include "stm32f103.inc"
   1              	/*
   2              	   STM32F103 registers
   3              	*/
   4              	    /* RAM */
   5              	    .equ RAM_ADR, 0x20000000 
   6              	    .equ RAM_SIZE, 0x5000
   7              	    .equ RAM_END, RAM_ADR+RAM_SIZE
   8              	
   9              	   /* RAM bit band alias */
  10              	      .equ RAM_BIT_ALIAS, 0x22000000
  11              	
  12              	    /* FLASH MEMORY */
  13              	    /* memory reported by MCU */
  14              	    .equ FLASH_ADR, 0x8000000 
  15              	    .equ FLASH_SIZE, 0x10000
  16              	    .equ FLASH_END, FLASH_ADR+FLASH_SIZE
  17              	    /* the MCU as 64K flash not reported by MCU */
  18              	    .equ FLASH_HIDDEN_ADR, 0x8010000
  19              	    .equ FLASH_HIDDEN_SIZE, 0x10000
ARM GAS  stm32-tbi.s 			page 2


  20              	    .equ FLASH_HIDDEN_END, FLASH_HIDDEN_ADR+FLASH_HIDDEN_SIZE
  21              	    .equ PAGE_SIZE, 1024 // erase block size 
  22              	
  23              	   /* system memory */
  24              	      .equ SYS_MEM, 0x1FFFF000
  25              	      .equ SYS_MEM_SIZE, 0x800
  26              	
  27              	   /* option memory */
  28              	      .equ OPTION, 0x1FFFF800   
  29              	      .equ OPT_SIZE, 16
  30              	
  31              	
  32              	   /* peripherals base address */
  33              	      .equ PER_BASE_ADR,  0x40000000
  34              	   /* PERIPHERALS bit band alias */
  35              	      .equ PER_BIT_ALIAS, 0x42000000 
  36              	
  37              	
  38              	    /* RCC registers address */
  39              	    .equ RCC_BASE_ADR, 0x40021000
  40              	    /* RCC registers offset */
  41              	    .equ RCC_CR, 0
  42              	    .equ RCC_CFGR, 4
  43              	    .equ RCC_CIR, 8
  44              	    .equ RCC_APB2RSTR, 12
  45              	    .equ RCC_APB1RSTR, 16
  46              	    .equ RCC_AHBENR, 20
  47              	    .equ RCC_APB2ENR, 24
  48              	    .equ RCC_APB1ENR, 28
  49              	    .equ RCC_BDCR, 32 
  50              	    .equ RCC_CSR, 36
  51              	
  52              	    /* FLASH registers address */
  53              	    .equ FLASH_BASE_ADR, 0x40022000
  54              	    /* FLASH registers offset */
  55              	    .equ FLASH_ACR, 0
  56              	    .equ FLASH_KEYR, 4
  57              	    .equ FLASH_OPTKEYR, 8
  58              	    .equ FLASH_SR, 12
  59              	    .equ FLASH_CR, 16
  60              	    .equ FLASH_AR, 20
  61              	    .equ FLASH_OBR, 28
  62              	    .equ FLASH_WRPR,32
  63              	    .equ RDPRT_KEY, 0x00A5
  64              	    .equ FLASH_KEY1, 0x45670123
  65              	    .equ FLASH_KEY2, 0xCDEF89AB
  66              	
  67              	    /* GPIOx base address */
  68              	    .equ GPIOA_BASE_ADR, 0x40010800
  69              	    .equ GPIOB_BASE_ADR, 0x40010C00
  70              	    .equ GPIOC_BASE_ADR, 0x40011000
  71              	    .equ GPIOD_BASE_ADR, 0x40011400
  72              	    .equ GPIOE_BASE_ADR, 0x40011800
  73              	    .equ GPIOF_BASE_ADR, 0x40018C00
  74              	    .equ GPIOG_BASE_ADR, 0x40012000
  75              	
  76              	    /* gpiox registers offset from base address */
ARM GAS  stm32-tbi.s 			page 3


  77              	    .equ GPIO_CRL, 0
  78              	    .equ GPIO_CRH, 4
  79              	    .equ GPIO_IDR, 8
  80              	    .equ GPIO_ODR, 12
  81              	    .equ GPIO_BSRR, 16
  82              	    .equ GPIO_BRR, 20
  83              	    .equ GPIO_LOCKR, 24 
  84              	    
  85              	
  86              	    /* USART1 registers */
  87              	    .equ USART1_BASE_ADR, 0x40013800
  88              	    /* USARTx registers offset */
  89              	    .equ USART_SR, 0
  90              	    .equ USART_DR,4
  91              	    .equ USART_BRR,8
  92              	    .equ USART_CR1,12
  93              	    .equ USART_CR2,16
  94              	    .equ USART_CR3,20
  95              	    .equ USART_GTPR,24
  96              	
  97              	   /* systick */
  98              	    .equ STK_BASE_ADR, 0xE000E010
  99              	    /* registers offset */
 100              	    .equ STK_CTL, 0
 101              	    .equ STK_LOAD, 4
 102              	    .equ STK_VAL, 8
 103              	    .equ STK_CALIB, 12
 104              	
 105              	   /* system control block */
 106              	   .equ SCB_BASE_ADR, 0xE000ED00
 107              	   /* registers offset */
 108              	   .equ SCB_CPUID, 0
 109              	   .equ SCB_ICSR, 4 
 110              	   .equ SCB_VTOR, 8
 111              	   .equ SCB_AIRCR, 12
 112              	   .equ SCB_SCR, 16
 113              	   .equ SCB_CCR, 20
 114              	   .equ SCB_SHPR1,24
 115              	   .equ SCB_SHPR2,28
 116              	   .equ SCB_SHPR3,32
 117              	   .equ SCB_SHCRS,36
 118              	   .equ SCB_CFSR,40
 119              	   .equ SCB_HFSR,44
 120              	   .equ SCB_MMAR,52
 121              	   .equ SCB_BFAR,56
 122              	   // key to to write in SCB_AIRCR 
 123              	   .equ SCB_VECTKEY,0x5fa 
 124              	   
 125              	   /* NVIC block */
 126              	   .equ NVIC_BASE_ADR, 0xE000E100
 127              	   .equ NVIC_ISER0, 0
 128              	   .equ NVIC_ISER1, 4
 129              	   .equ NVIC_ISER2, 8
 130              	   .equ NVIC_ICER0, 0x80
 131              	   .equ NVIC_ICER1, 0x84 
 132              	   .equ NVIC_ICER2, 0x88 
 133              	   .equ NVIC_ISPR0, 0x100
ARM GAS  stm32-tbi.s 			page 4


 134              	   .equ NVIC_ISPR1, 0x104
 135              	   .equ NVIC_ISPR2, 0x108 
 136              	   .equ NVIC_ICPR0, 0x180
 137              	   .equ NVIC_ICPR1, 0x184
 138              	   .equ NVIC_ICPR2, 0x188
 139              	   .equ NVIC_IABR0, 0x200
 140              	   .equ NVIC_IABR1, 0x204
 141              	   .equ NVIC_IABR2, 0x208
 142              	   .equ NVIC_IPR_BASE, 0x300 
  39              	  .include "ascii.inc"
   1              	////
   2              	// Copyright Jacques Deschênes 2021
   3              	// This file is part of stm32-tbi 
   4              	//
   5              	//     stm32-tbi is free software: you can redistribute it and/or modify
   6              	//     it under the terms of the GNU General Public License as published by
   7              	//     the Free Software Foundation, either version 3 of the License, or
   8              	//     (at your option) any later version.
   9              	//
  10              	//     stm32-tbi is distributed in the hope that it will be useful,
  11              	//     but WITHOUT ANY WARRANTY// without even the implied warranty of
  12              	//     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  13              	//     GNU General Public License for more details.
  14              	//
  15              	//     You should have received a copy of the GNU General Public License
  16              	//     along with stm32-tbi.  If not, see <http://www.gnu.org/licenses/>.
  17              	////
  18              	
  19              	//-------------------------------------------------------
  20              	//     ASCII control  values
  21              	//     CTRL_x   are VT100 keyboard values  
  22              	// REF: https://en.wikipedia.org/wiki/ASCII    
  23              	//-------------------------------------------------------
  24              		.equ CTRL_A ,  1
  25              		.equ SOH, CTRL_A  // start of heading 
  26              		.equ CTRL_B ,  2
  27              		.equ STX, CTRL_B  // start of text 
  28              		.equ CTRL_C ,  3
  29              		.equ ETX, CTRL_C  // end of text 
  30              		.equ CTRL_D ,  4
  31              		.equ EOT, CTRL_D  // end of transmission 
  32              		.equ CTRL_E ,  5
  33              		.equ ENQ, CTRL_E  // enquery 
  34              		.equ CTRL_F ,  6
  35              		.equ ACK, CTRL_F  // acknowledge
  36              		.equ CTRL_G ,  7
  37              		.equ BELL ,  7    // vt100 terminal generate a sound.
  38              		.equ CTRL_H ,  8  
  39              		.equ BS ,  8     // back space 
  40              		.equ CTRL_I ,  9
  41              		.equ TAB ,  9     // horizontal tabulation
  42              		.equ CTRL_J ,  10 
  43              		.equ LF ,  10     // line feed
  44              		.equ CTRL_K ,  11
  45              		.equ VT ,  11     // vertical tabulation 
  46              		.equ CTRL_L ,  12
  47              		.equ FF ,  12      // new page
ARM GAS  stm32-tbi.s 			page 5


  48              		.equ CTRL_M ,  13
  49              		.equ CR ,  13      // carriage return 
  50              		.equ CTRL_N ,  14
  51              		.equ SO, CTRL_N    // shift out 
  52              		.equ CTRL_O ,  15
  53              		.equ SI, CTRL_O    // shift in 
  54              		.equ CTRL_P ,  16
  55              		.equ DLE, CTRL_P   // data link escape 
  56              		.equ CTRL_Q ,  17
  57              		.equ DC1, CTRL_Q   // device control 1 
  58              		.equ XON, DC1 
  59              		.equ CTRL_R ,  18
  60              		.equ DC2, CTRL_R   // device control 2 
  61              		.equ CTRL_S ,  19
  62              		.equ DC3, CTRL_S   // device control 3
  63              		.equ XOFF, DC3 
  64              		.equ CTRL_T ,  20
  65              		.equ DC4, CTRL_T   // device control 4 
  66              		.equ CTRL_U ,  21
  67              		.equ NAK, CTRL_U   // negative acknowledge
  68              		.equ CTRL_V ,  22
  69              		.equ SYN, CTRL_V   // synchronous idle 
  70              		.equ CTRL_W ,  23
  71              		.equ ETB, CTRL_W   // end of transmission block
  72              		.equ CTRL_X ,  24
  73              		.equ CAN, CTRL_X   // cancel 
  74              		.equ CTRL_Y ,  25
  75              		.equ EM, CTRL_Y    // end of medium
  76              		.equ CTRL_Z ,  26
  77              		.equ SUB, CTRL_Z   // substitute 
  78              		.equ EOF, SUB      // end of text file in MSDOS 
  79              		.equ ESC ,  27     // escape 
  80              		.equ FS, 28        // file separator 
  81              		.equ GS, 29        // group separator 
  82              		.equ RS, 30  // record separator 
  83              		.equ US, 31  // unit separator 
  84              		.equ SPACE ,  32
  85              		.equ COMMA ,  44 
  86              		.equ SHARP ,  35
  87              		.equ TICK ,  39
  40              	  .include "tbi_macros.inc"
   1              	//---------------------------------------------------------------------------
   2              	// Copyright Jacques Deschênes 2021 
   3              	// This file is part of stm32-tbi 
   4              	//
   5              	//     stm32-tbi is free software: you can redistribute it and/or modify
   6              	//     it under the terms of the GNU General Public License as published by
   7              	//     the Free Software Foundation, either version 3 of the License, or
   8              	//     (at your option) any later version.
   9              	//
  10              	//     stm32-tbi is distributed in the hope that it will be useful,
  11              	//     but WITHOUT ANY WARRANTY// without even the implied warranty of
  12              	//     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  13              	//     GNU General Public License for more details.
  14              	//
  15              	//     You should have received a copy of the GNU General Public License
  16              	//     along with stm32-tbi.  If not, see <http://www.gnu.org/licenses/>.
ARM GAS  stm32-tbi.s 			page 6


  17              	//
  18              	//---------------------------------------------------------------------------
  19              	
  20              	  .equ  STACK_SIZE,0x100
  21              	  .equ  STACK_EMPTY,RAM_END
  22              	  .equ  STACK_FULL, (RAM_END - STACK_SIZE)
  23              	  .equ  TIB_SIZE,80 
  24              	  .equ  PAD_SIZE,128 
  25              	  .equ RX_QUEUE_SIZE,16
  26              	
  27              	.equ DEFAULT_TAB_WIDTH,4 // default tabulation width 
  28              	.equ EOF,0xff // end of file marker 
  29              	
  30              	//--------------------------------------
  31              	//   constantes related to Arduino 
  32              	//   API mapping 
  33              	//-------------------------------------
  34              	  .equ INP,0
  35              	  .equ OUTP,1 
  36              	
  37              	//--------------------------------------
  38              	//       token attribute
  39              	//--------------------------------------
  40              	// bits 4:5 identify token group 
  41              	// 0x0n -> miscelinous 
  42              	// 0x1n -> +|- operators 
  43              	// 0x2n -> *|/|% operators
  44              	// 0x3n -> relational operators 
  45              	  .equ TK_NONE,0       // not a token 
  46              	  .equ TK_COLON,1      // command separator ':' 
  47              	  .equ TK_QSTR,2     // quoted string  
  48              	  .equ TK_CHAR,3       // ASCII character 
  49              	  .equ TK_VAR,4      // variable index 
  50              	  .equ TK_ARRAY,5     // array variable '@' 
  51              	  .equ TK_LPAREN,6     // left parenthesis '('
  52              	  .equ TK_RPAREN,7     // right parenthesis ')'
  53              	  .equ TK_COMMA,8     // item separator ',' 
  54              	  .equ TK_SHARP,9     // print colon width '#' 
  55              	  .equ TK_CMD,0xa      // BASIC command   
  56              	  .equ TK_IFUNC,0xb    // BASIC integer function
  57              	  .equ TK_CFUNC,0xc    // BASIC character function
  58              	  .equ TK_CONST,0xd    // BASIC constant 
  59              	  .equ TK_INTGR,0xe    // 32 bits integer 
  60              	  .equ TK_BAD,0xf      // bad value 
  61              	  .equ TK_PLUS,0x10    // addition operator '+'
  62              	  .equ TK_MINUS,0x11   // subtraction operator '-'
  63              	  .equ TK_MULT,0x20    // multiplication operator '*'
  64              	  .equ TK_DIV,0x21     // division operator '/'
  65              	  .equ TK_MOD,0x22     // modulo operator '%'
  66              	
  67              	// don't change these token values 
  68              	// values chosen to be used as a mask.
  69              	// bit 7   1 for dictionary words else 0 
  70              	// bits 6  always 0 
  71              	// bits 5:4 identify group 
  72              	// bits 3:0 token identifier inside group  
  73              	  .equ TK_GT,0x31      // relation operator '>'
ARM GAS  stm32-tbi.s 			page 7


  74              	  .equ TK_EQUAL,0x32   // assignment or relation operator '='
  75              	  .equ TK_GE,0x33      // relation operator '>='
  76              	  .equ TK_LT,0x34      // relation operator '<'
  77              	  .equ TK_LE,0x36      // relation operator '<='
  78              	  .equ TK_NE,0x35      // relation operator '<>' not equal 
  79              	// token groups 
  80              	  .equ TK_GRP_MASK,0x30 // groups bits selector 
  81              	  .equ TK_GRP_MISC,0x00 // miscelinous group 
  82              	  .equ TK_GRP_ADD,0x10  // additive operators
  83              	  .equ TK_GRP_MULT,0x20 // multiplicative operators
  84              	  .equ TK_GRP_RELOP,0x30 //relational operators. 
  85              	  .equ CMD_END,2 
  86              	
  87              	//--------------------------------------
  88              	//   error codes 
  89              	//--------------------------------------
  90              	  .equ ERR_NONE,0
  91              	  .equ ERR_MEM_FULL,1 
  92              	  .equ ERR_SYNTAX,2
  93              	  .equ ERR_MATH_OVF,3
  94              	  .equ ERR_DIV0,4 
  95              	  .equ ERR_NO_LINE,5
  96              	  .equ ERR_RUN_ONLY,6
  97              	  .equ ERR_CMD_ONLY,7
  98              	  .equ ERR_DUPLICATE,8
  99              	  .equ ERR_NOT_FILE,9
 100              	  .equ ERR_BAD_VALUE,10
 101              	  .equ ERR_NO_ACCESS,11
 102              	  .equ ERR_NO_DATA,12 
 103              	  .equ ERR_NO_PROG,13
 104              	  .equ ERR_NO_FSPACE,14
 105              	  .equ ERR_BUF_FULL,15
 106              	
 107              	//--------------------------------------
 108              	//   assembler flags 
 109              	//-------------------------------------
 110              	.equ MATH_OVF,0 // if 1 then stop on math overflow 
 111              	
 112              	.equ CELL_SIZE,4 
 113              	
 114              	
 115              	//-------------------------------
 116              	//  macros used to help debugging
 117              	//-------------------------------
 118              	  .equ DEBUG,0
 119              	
 120              	    UPP .req r4  // base address system variables 
 121              	    VADR .req r5  // address FOR loop variable 
 122              	    LIMIT .req r6   // LOOP limit 
 123              	    INCR  .req  r7  // LOOP increment 
 124              	    T1  .req r8     // temporary register 
 125              	    T2  .req r9     // temporary register 
 126              	    IN  .req r10    //  index in text line or token list 
 127              	    BPTR .req r11   //  buffer address or BASIC line address 
 128              	    DP   .req r12   //  parameter stack pointer 
 129              	
 130              	/***************************
ARM GAS  stm32-tbi.s 			page 8


 131              	  SYSTEM variables offset 
 132              	  from UPP  
 133              	***************************/ 
 134              	
 135              	  .equ IN_SAVED,0 // set by get_token before parsing next token, used by unget_token
 136              	  .equ COUNT, IN_SAVED+4  // current BASIC line length and tib text length  
 137              	  .equ BASICPTR,COUNT+4 // point to current BASIC line address.
 138              	  .equ DATAPTR, BASICPTR+4 // point to DATA address
 139              	  .equ DATA,DATAPTR+4 // index to next data item 
 140              	  .equ DATALEN, DATA+4 // length of data line 
 141              	  .equ BASE,DATALEN+4 // nemeric base used to print integer 
 142              	  .equ TICKS,BASE+4 // milliseconds ticks counter (see Timer4UpdateHandler)
 143              	  .equ TIMER,TICKS+4 //  milliseconds count down timer 
 144              	  .equ SEED,TIMER+4  // xorshift 16 seed x  used by RND() function 
 145              	  .equ FSPTR,SEED+4 //  pointer used by file system
 146              	  .equ FFREE,FSPTR+4 // flash free address // file system free space pointer
 147              	  .equ TXTBGN,FFREE+4 // tokenized BASIC text beginning address 
 148              	  .equ TXTEND,TXTBGN+4 // tokenized BASIC text end address 
 149              	  .equ LOOP_DEPTH,TXTEND+4  // level of nested loop. Conformity check   
 150              	  .equ ARRAY_SIZE,LOOP_DEPTH+4 // array size, free RAM left after BASIC code.  
 151              	  .equ FLAGS,ARRAY_SIZE+4 // various boolean flags
 152              	  .equ TAB_WIDTH,FLAGS+4 // print colon width (default 4)
 153              	  .equ RX_HEAD,TAB_WIDTH+4 // rx_queue head pointer
 154              	  .equ RX_TAIL,RX_HEAD+4 // rx1_queue tail pointer  
 155              	  .equ RX_QUEUE,RX_TAIL+4 // UART1 receive circular queue 
 156              	  .equ VARS,RX_QUEUE+RX_QUEUE_SIZE // BASIC variables 
 157              	  .equ VARS_SIZE, 4*26 // space used by 26 BASIC variables (A-Z)
 158              	  .equ ARRAY_ADR,VARS+VARS_SIZE // array address at bottom of pad  
 159              	  .equ BASIC_START,ARRAY_ADR+4 // BASIC area start after variables 
 160              	
 161              	/* flags used by BASIC interpreter */ 
 162              		.equ FRUN,(1<<0) // programm running
 163              		.equ FTRAP,(1<<1) // inside trap handler 
 164              		.equ FLOOP,(1<<2) // FOR loop in preparation 
 165              		.equ FSLEEP,(1<<3) // in halt mode SLEEP 
 166              		.equ FBREAK,(1<<4) // break point flag 
 167              		.equ FCOMP,(1<<5)  // compiling flags 
 168              		.equ FAUTORUN,(1<<6) // auto start program running 
 169              	
 170              		.equ AUTORUN_NAME,0x8001C00  // address in FLASH  where auto run file name is saved 
 171              	  
 172              	  .equ FIRST_DATA_ITEM,6 // first DATA item offset on line.
 173              		.equ MAX_LINENO,0x7fff// BASIC maximum line number 
 174              	
 175              	/***********************************************
 176              	*       MACROS
 177              	***********************************************/
 178              		.macro _CALL fn /* low level routine call */ 
 179              	 	PUSH {LR}
 180              		BL \fn  
 181              	  POP {LR}
 182              		.endm
 183              		
 184              		.macro	_RET /* return from subroutine */
 185              		BX	LR
 186              		.endm
 187              	
ARM GAS  stm32-tbi.s 			page 9


 188              		.macro _MOV32 REG LITERAL   /* load register with 32 bits literal */
 189              		MOV \REG, #\LITERAL&0xffff
 190              		MOVT \REG, #\LITERAL>>16
 191              		.endm
 192              	
 193              	// local function header 
 194              	  .macro _FUNC label 
 195              	  .p2align 2 
 196              	  .type \label, %function  
 197              	\label:
 198              	  .endm 
 199              	
 200              	// global function header 
 201              	  .macro _GBL_FUNC label 
 202              	  .global \label 
 203              	  _FUNC \label 
 204              	  .endm 
 205              	
 206              	
 207              	/********************************
 208              	    dictionary structure
 209              	------------------------------
 210              	 format:
 211              	   link:    
 212              	   name_length+flags:  1 byte, bits 0:4 lenght,5:8 flags  
 213              	   cmd_name: 31 characters max 
 214              	   cmd_index: 2 bytes 
 215              	**********************************/
 216              		.macro _dict_entry tok_type,name,cmd_idx 
 217              	  .word LINK 
 218              	  .word \cmd_idx 
 219              		.word \tok_type  	
 220              		.equ LINK,.
 221              		.asciz "\name"
 222              		.p2align 2 
 223              		.endm 
 224              	
 225              	  // pop parameter in register 
 226              	  .macro _POP  reg 
 227              	  ldmia  DP!,{\reg}
 228              	  .endm 
 229              	
 230              	  // push register on parameter stack 
 231              	  .macro _PUSH reg 
 232              	  stmdb DP!,{\reg}
 233              	  .endm 
 234              	
 235              	  // drop n parameters on dstack 
 236              	  .macro _DROP n
 237              	  mov r0,#4*\n
 238              	  add DP,R0 
 239              	  .endm 
 240              	
 241              	  // back to previous token in list 
 242              	  .macro _UNGET_TOKEN 
 243              	  ldr IN,[UPP,#IN_SAVED]
 244              	  ldr BPTR,[UPP,#BASICPTR] 
ARM GAS  stm32-tbi.s 			page 10


 245              	  .endm 
 246              	
 247              	 // create a text data 
 248              	 .macro _TEXT label,text
 249              	 \label: .asciz "\text"
 250              	 .p2align 2 
 251              	 .endm 
 252              	
 253              	// command line only 
 254              	  .macro _CLO 
 255              	  ldr r0,[UPP,#FLAGS]
 256              	  tst r0,#FRUN 
 257              	  beq 1f 
 258              	  mov r0,#ERR_CMD_ONLY
 259              	  b tb_error
 260              	1: 
 261              	  .endm 
 262              	
 263              	// run time only 
 264              	  .macro _RTO 
 265              	  ldr r0,[UPP,#FLAGS]
 266              	  tst r0,#FRUN 
 267              	  bne 1f 
 268              	  mov r0,#ERR_CMD_ONLY
 269              	  b tb_error
 270              	1:
 271              	  .endm 
 272              	
  41              	  .include "cmd_index.inc"
   1              	//---------------------------------------------------------------------  
   2              	//  Copyright Jacques Deschênes 2021
   3              	//  This file is part of stm32-tbi 
   4              	// 
   5              	//   stm32-tbi is free software: you can redistribute it and/or modify
   6              	//   it under the terms of the GNU General Public License as published by
   7              	//   the Free Software Foundation, either version 3 of the License, or
   8              	//   (at your option) any later version.
   9              	// 
  10              	//   stm32-tbi is distributed in the hope that it will be useful,
  11              	//   but WITHOUT ANY WARRANTY//  without even the implied warranty of
  12              	//   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  13              	//   GNU General Public License for more details.
  14              	// 
  15              	//   You should have received a copy of the GNU General Public License
  16              	//   along with stm32-tbi.  If not, see <http://www.gnu.org/licenses/>.
  17              	// 
  18              	// ----------------------------------------------------------------------
  19              	
  20              	// ---------------------------------------
  21              	//  BASIC command and functions indexes
  22              	//  for addressing 'code_addr' table
  23              	// --------------------------------------
  24              	
  25              	    .equ ABS_IDX, 0  //  absolute function
  26              	    .equ ADCON_IDX, 1 // <<1   //   adc on 
  27              	    .equ ADCREAD_IDX, 2 // <<1
  28              	    .equ AND_IDX, 3 // <<1.equ  // 
ARM GAS  stm32-tbi.s 			page 11


  29              	    .equ ASC_IDX, 4 // <<1.equ  // 
  30              	    .equ AUTORUN_IDX, 5 // <<1
  31              	    .equ AWU_IDX, 6 // <<1
  32              	    .equ BIT_IDX, 7 // <<1
  33              	    .equ BRES_IDX, 8 // <<1
  34              	    .equ BSET_IDX, 9 // <<1
  35              	    .equ BTEST_IDX, 10 // <<1
  36              	    .equ BTOGL_IDX, 11 // <<1
  37              	    .equ BYE_IDX, 12 // <<1
  38              	    .equ CHAR_IDX, 13 // <<1
  39              	    .equ CRH_IDX, 14 // <<1
  40              	    .equ CRL_IDX, 15 // <<1
  41              	    .equ DATA_IDX, 16 // <<1
  42              	    .equ DATALN_IDX, 17 // <<1
  43              	    .equ DDR_IDX, 18 // <<1
  44              	    .equ DEC_IDX, 19 // <<1
  45              	    .equ DIR_IDX, 20 // <<1
  46              	    .equ DO_IDX, 21 // <<1
  47              	    .equ DREAD_IDX, 22 // <<1
  48              	    .equ DWRITE_IDX, 23 // <<1
  49              	    .equ END_IDX, 24 // <<1
  50              	    .equ EEPROM_IDX, 25 // <<1
  51              	    .equ FCPU_IDX, 26 // <<1
  52              	    .equ FOR_IDX, 27 // <<1
  53              	    .equ FORGET_IDX, 28 // <<1
  54              	    .equ GOSUB_IDX, 29 // <<1
  55              	    .equ GOTO_IDX, 30 // <<1
  56              	    .equ GPIO_IDX, 31 // <<1
  57              	    .equ HEX_IDX, 32 // <<1
  58              	    .equ IDR_IDX, 33 // <<1
  59              	    .equ IF_IDX, 34 // <<1
  60              	    .equ INPUT_IDX, 35 // <<1
  61              	    .equ INVERT_IDX, 36 // <<1
  62              	    .equ IWDGEN_IDX, 37 // <<1
  63              	    .equ IWDGREF_IDX, 38 // <<1
  64              	    .equ KEY_IDX, 39 // <<1
  65              	    .equ LET_IDX, 40 // <<1
  66              	    .equ LIST_IDX, 41 // <<1
  67              	    .equ LOAD_IDX, 42 // <<1
  68              	    .equ LOG2_IDX, 43 // <<1
  69              	    .equ LSHIFT_IDX, 44 // <<1
  70              	    .equ NEXT_IDX, 45 // <<1
  71              	    .equ NEW_IDX, 46 // <<1
  72              	    .equ NOT_IDX, 47 // <<1
  73              	    .equ ODR_IDX, 48 // <<1
  74              	    .equ OR_IDX, 49 // <<1
  75              	    .equ PAD_IDX, 50 // <<1
  76              	    .equ PAUSE_IDX, 51 // <<1
  77              	    .equ PMODE_IDX, 52 // <<1
  78              	    .equ PEEK_IDX, 53 // <<1
  79              	    .equ PINP_IDX, 54 // <<1
  80              	    .equ POKE_IDX, 55 // <<1
  81              	    .equ POUT_IDX, 56 // <<1
  82              	    .equ PRT_IDX, 57 // <<1 //  PRINT commande index 
  83              	    .equ PRTA_IDX, 58 // <<1
  84              	    .equ PRTB_IDX, 59 // <<1
  85              	    .equ PRTC_IDX, 60 // <<1
ARM GAS  stm32-tbi.s 			page 12


  86              	    .equ PRTD_IDX, 61 // <<1
  87              	    .equ PRTE_IDX, 62 // <<1
  88              	    .equ PRTF_IDX, 63 // <<1
  89              	    .equ PRTG_IDX, 64 // <<1
  90              	    .equ PRTH_IDX, 65 // <<1
  91              	    .equ PRTI_IDX, 66 // <<1
  92              	    .equ QKEY_IDX, 67 // <<1
  93              	    .equ READ_IDX, 68 // <<1
  94              	    .equ RBT_IDX, 69 // <<1  //  REBOOT
  95              	    .equ REM_IDX, 70 // <<1 //  REMARK command index 
  96              	    .equ REST_IDX, 71 // <<1 //  RESTORE
  97              	    .equ RET_IDX, 72 // <<1  //  RETURN 
  98              	    .equ RND_IDX, 73 // <<1 //  RANDOM 
  99              	    .equ RSHIFT_IDX, 74 // <<1
 100              	    .equ RUN_IDX, 75 // <<1
 101              	    .equ SAVE_IDX, 76 // <<1
 102              	    .equ SHOW_IDX, 77 // <<1
 103              	    .equ SIZE_IDX, 78 // <<1
 104              	    .equ SLEEP_IDX, 79 // <<1
 105              	    .equ SPIRD_IDX, 80 // <<1
 106              	    .equ SPIEN_IDX, 81 // <<1
 107              	    .equ SPISEL_IDX, 82 // <<1
 108              	    .equ SPIWR_IDX, 83 // <<1
 109              	    .equ STEP_IDX, 84 // <<1
 110              	    .equ STOP_IDX, 85 // <<1
 111              	    .equ TICKS_IDX, 86 // <<1
 112              	    .equ TIMER_IDX, 87 // <<1
 113              	    .equ TMROUT_IDX, 88 // <<1  //  TIMEOUT
 114              	    .equ TO_IDX, 89 // <<1
 115              	    .equ TONE_IDX, 90 // <<1
 116              	    .equ UBOUND_IDX, 91 // <<1
 117              	    .equ UFLASH_IDX, 92 // <<1
 118              	    .equ UNTIL_IDX, 93 // <<1
 119              	    .equ USR_IDX, 94 // <<1
 120              	    .equ WAIT_IDX, 95 // <<1
 121              	    .equ WORDS_IDX, 96 // <<1
 122              	    .equ WRITE_IDX, 97 // <<1
 123              	    .equ XOR_IDX, 98 // <<1 
 124              	    .equ XTRMT_IDX, 99 // <<1
 125              	    .equ XRCV_IDX, 100 // <<1
 126              	    .equ DUMP_IDX, 101 
 127              	    .equ THEN_IDX,102
  42              	
  43              	/* blue pill specific constants */ 
  44              	  .equ LED_GPIO, GPIOC_BASE_ADR
  45              	  .equ LED_PIN, 13
  46              	  .equ UART, USART1_BASE_ADR 
  47              	
  48              	
  49              	/*************************************
  50              	*   interrupt service vectors table 
  51              	**************************************/
  52              	   .section  .isr_vector,"a",%progbits
  53              	  .type  isr_vectors, %object
  54              	
  55              	isr_vectors:
  56 0000 00000000 	  .word    _mstack          /* main return stack address */
ARM GAS  stm32-tbi.s 			page 13


  57 0004 00000000 	  .word    reset_handler    /* startup address */
  58              	/* core interrupts || exceptions */
  59 0008 00000000 	  .word    default_handler  /*  -14 NMI */
  60 000c 00000000 	  .word    default_handler  /*  -13 HardFault */
  61 0010 00000000 	  .word    default_handler  /*  -12 Memory Management */
  62 0014 00000000 	  .word    default_handler  /* -11 Bus fault */
  63 0018 00000000 	  .word    default_handler  /* -10 Usage fault */
  64 001c 00000000 	  .word    0 /* -9 */
  65 0020 00000000 	  .word    0 /* -8 */ 
  66 0024 00000000 	  .word    0 /* -7 */
  67 0028 00000000 	  .word    0	/* -6 */
  68 002c 00000000 	  .word    default_handler  /* -5 SWI instruction */
  69 0030 00000000 	  .word    default_handler  /* -4 Debug monitor */
  70 0034 00000000 	  .word    0 /* -3 */
  71 0038 00000000 	  .word    default_handler  /* -2 PendSV */
  72 003c 00000000 	  .word    systick_handler  /* -1 Systick */
  73              	 irq0:  
  74              	  /* External Interrupts */
  75 0040 00000000 	  .word      default_handler /* IRQ0, Window WatchDog  */                                        
  76 0044 00000000 	  .word      default_handler /* IRQ1, PVD_VDM */                        
  77 0048 00000000 	  .word      default_handler /* IRQ2, TAMPER */            
  78 004c 00000000 	  .word      default_handler /* IRQ3, RTC  */                      
  79 0050 00000000 	  .word      default_handler /* IRQ4, FLASH */                                          
  80 0054 00000000 	  .word      default_handler /* IRQ5, RCC */                                            
  81 0058 00000000 	  .word      default_handler /* IRQ6, EXTI Line0 */                        
  82 005c 00000000 	  .word      default_handler /* IRQ7, EXTI Line1  */                          
  83 0060 00000000 	  .word      default_handler /* IRQ8, EXTI Line2 */                          
  84 0064 00000000 	  .word      default_handler /* IRQ9, EXTI Line3 */                          
  85 0068 00000000 	  .word      default_handler /* IRQ10, EXTI Line4 */                          
  86 006c 00000000 	  .word      default_handler /* IRQ11, DMA1 CH1 */                  
  87 0070 00000000 	  .word      default_handler /* IRQ12, DMA1 CH2 */                   
  88 0074 00000000 	  .word      default_handler /* IRQ13, DMA1 CH3 */                   
  89 0078 00000000 	  .word      default_handler /* IRQ14, DMA1 CH4  */                   
  90 007c 00000000 	  .word      default_handler /* IRQ15, DMA1 CH5 */                   
  91 0080 00000000 	  .word      default_handler /* IRQ16, DMA1 CH6 */                   
  92 0084 00000000 	  .word      default_handler /* IRQ17, DMA1 CH7 */                   
  93 0088 00000000 	  .word      default_handler /* IRQ18, ADC1, ADC2 global interrupt */                   
  94 008c 00000000 	  .word      default_handler /* IRQ19, USB High priority */                         
  95 0090 00000000 	  .word      default_handler /* IRQ20, USB low priority */                          
  96 0094 00000000 	  .word      default_handler /* IRQ21, CAN_RX1 */                          
  97 0098 00000000 	  .word      default_handler /* IRQ22, CAN1_SCE */                          
  98 009c 00000000 	  .word      default_handler /* IRQ23, External Line[9:5]s */                          
  99 00a0 00000000 	  .word      default_handler /* IRQ24, TIM1 Break and TIM15 global */         
 100 00a4 00000000 	  .word      default_handler /* IRQ25, TIM1 Update and TIM16 global */         
 101 00a8 00000000 	  .word      default_handler /* IRQ26, TIM1 Trigger and Commutation and TIM17 */
 102 00ac 00000000 	  .word      default_handler /* IRQ27, TIM1 Capture Compare */                          
 103 00b0 00000000 	  .word      default_handler /* IRQ28, TIM2 */                   
 104 00b4 00000000 	  .word      default_handler /* IRQ29, TIM3 */                   
 105 00b8 00000000 	  .word      default_handler /* IRQ30, TIM4 */                   
 106 00bc 00000000 	  .word      default_handler /* IRQ31, I2C1 Event and exti line 23 */                          
 107 00c0 00000000 	  .word      default_handler /* IRQ32, I2C1 Error */                          
 108 00c4 00000000 	  .word      default_handler /* IRQ33, I2C2 Event and exti line 24 */                          
 109 00c8 00000000 	  .word      default_handler /* IRQ34, I2C2 Error */                            
 110 00cc 00000000 	  .word      default_handler /* IRQ35, SPI1 */                   
 111 00d0 00000000 	  .word      default_handler /* IRQ36, SPI2 */                   
 112 00d4 00000000 	  .word      uart_rx_handler /* IRQ37, USART1 */                   
 113 00d8 00000000 	  .word      default_handler /* IRQ38, USART2 */                   
ARM GAS  stm32-tbi.s 			page 14


 114 00dc 00000000 	  .word      default_handler /* IRQ39, USART3 */                   
 115 00e0 00000000 	  .word      default_handler /* IRQ40, External Line[15:10]s */                          
 116 00e4 00000000 	  .word      default_handler /* IRQ41, RTC Alarm */                 
 117 00e8 00000000 	  .word      default_handler /* IRQ42, USB Wakeup*/                       
 118 00ec 00000000 	  .word      default_handler /* IRQ43, TIM8 Break */         
 119 00f0 00000000 	  .word      default_handler /* IRQ44, TIM8 Update*/         
 120 00f4 00000000 	  .word      default_handler /* IRQ45, TIM8 Trigger and Commutation */
 121 00f8 00000000 	  .word      default_handler /* IRQ46, TIM8 Capture Compare */                          
 122 00fc 00000000 	  .word      default_handler /* IRQ47, ADC3 global */                          
 123 0100 00000000 	  .word      default_handler /* IRQ48, FSMC */                   
 124 0104 00000000 	  .word      default_handler /* IRQ49, SDIO */                   
 125 0108 00000000 	  .word      default_handler /* IRQ50, TIM5 */                   
 126 010c 00000000 	  .word      default_handler /* IRQ51, SPI3 */                   
 127 0110 00000000 	  .word      default_handler /* IRQ52, UART4 */                   
 128 0114 00000000 	  .word      default_handler /* IRQ53, UART5 */                   
 129 0118 00000000 	  .word      default_handler /* IRQ54, TIM6 */                   
 130 011c 00000000 	  .word      default_handler /* IRQ55, TIM7 */
 131 0120 00000000 	  .word      default_handler /* IRQ56, DMA2 CH1 */                   
 132 0124 00000000 	  .word      default_handler /* IRQ57, DMA2 CH2 */                   
 133 0128 00000000 	  .word      default_handler /* IRQ58, DMA2 CH3 */                   
 134 012c 00000000 	  .word      default_handler /* IRQ59, DMA2 CH4 & CH5 */                   
 135              	isr_end:
 136              	  .global vectors_size 
 137 0130 30010000 	vectors_size: .word isr_end - isr_vectors 
 138              	
 139              	
 140              	/*************************************
 141              	    EXCEPTIONS & INTERRUPTS HANDLERS 
 142              	*************************************/
 143              	
 144              	/*****************************************************
 145              	  default isr handler called on unexpected interrupt
 146              	*****************************************************/
 147              	   .section  .text , "ax", %progbits 
 148              	    _GBL_FUNC default_handler 
 149 0000 DFF80C04 	    ldr r0,=exception_msg 
 150 0004 00B5FFF7 	    _CALL uart_puts 
 150      FEFF5DF8 
 150      04EB
 151              	// delay
 152 000e 4FF40040 	    mov r0,#0x8000
 153 0012 0138     	    1: subs r0,#1 
 154 0014 FDD1     	    bne 1b 
 155 0016 43E0     	    b reset_mcu    
 156              	    .p2align 2 
 157              	exception_msg:
 158 0018 0A657865 	  	.asciz "\nexeption reboot!\n"
 158      7074696F 
 158      6E207265 
 158      626F6F74 
 158      210A00
 159              	
 160              	/*********************************
 161              		system milliseconds counter
 162              	*********************************/	
 163 002b 00       	    _GBL_FUNC systick_handler
 164 002c E069     	  ldr r0,[UPP,#TICKS]  
ARM GAS  stm32-tbi.s 			page 15


 165 002e 00F10100 	  add r0,#1
 166 0032 E061     	  str r0,[UPP,#TICKS]
 167 0034 206A     	  ldr r0,[UPP,#TIMER]
 168 0036 10B1     	  cbz r0, 9f
 169 0038 A0F10100 	  sub r0,#1
 170 003c 2062     	  str r0,[UPP,#TIMER]
 171              	9: 
 172 003e 7047     	  _RET 
 173              	
 174              	/**************************
 175              		UART RX handler
 176              	**************************/
 177              	    _GBL_FUNC uart_rx_handler
 178 0040 4FF46050 	    _MOV32 r0,UART 
 178      C4F20100 
 179 0048 0168     	    ldr r1,[r0,#USART_SR]
 180 004a 8288     	    ldrh r2,[r0,#USART_DR]
 181 004c 11F0200F 	    tst r1,#(1<<5) // RXNE 
 182 0050 0DD0     	    beq 2f // no char received 
 183 0052 032A     	    cmp r2,#3 // CTRL_C // cold restart
 184 0054 3FF4FEAF 	    beq user_reboot // received CTRL-C then reboot MCU 
 185 0058 022A     	    cmp r2,#2 // CTRL_B  break program
 186 005a 09D0     	    beq 3f   
 187 005c 04F15000 	    add r0,UPP,#RX_QUEUE
 188 0060 E16C     	    ldr r1,[UPP,#RX_TAIL]
 189 0062 4254     	    strb r2,[r0,r1]
 190 0064 01F10101 	    add r1,#1 
 191 0068 01F00F01 	    and r1,#(RX_QUEUE_SIZE-1)
 192 006c E164     	    str r1,[UPP,#RX_TAIL]
 193              	2:
 194 006e 7047     	  	_RET 
 195 0070 00B5FFF7 	3:  _CALL uart_flush_queue
 195      FEFF5DF8 
 195      04EB
 196 007a D4F804A0 	    ldr IN,[UPP,#COUNT]
 197 007e 206C     	    ldr r0,[UPP,#FLAGS]
 198 0080 6FF00101 	    mvn r1,#FRUN 
 199 0084 00EA0100 	    and r0,r1
 200 0088 2064     	    str r0,[UPP,#FLAGS]
 201 008a 7047     	    _RET 
 202              	     
 203              	
 204              	    _GBL_FUNC user_reboot   
 205 008c E148     	    ldr r0,=user_reboot_msg
 206 008e 00B5FFF7 	    _CALL uart_puts 
 206      FEFF5DF8 
 206      04EB
 207              	// delay 
 208 0098 4FF40040 	    mov r0,#0x8000
 209 009c 0138     	1: subs r0,#1  
 210 009e FDD1     	    bne 1b 
 211              	reset_mcu: 
 212 00a0 0348     	    ldr r0,scb_adr 
 213 00a2 C168     	    ldr r1,[r0,#SCB_AIRCR]
 214 00a4 41F00401 	    orr r1,#(1<<2)
 215 00a8 C0F2FA51 	    movt r1,#SCB_VECTKEY
 216 00ac C160     	    str r1,[r0,#SCB_AIRCR]
ARM GAS  stm32-tbi.s 			page 16


 217 00ae FEE7     	    b . 
 218              	    .p2align 2 
 219              	scb_adr:
 220 00b0 00ED00E0 	  	.word SCB_BASE_ADR 
 221              	user_reboot_msg:
 222 00b4 0A757365 		  .asciz "\nuser reboot!\n"
 222      72207265 
 222      626F6F74 
 222      210A00
 223 00c3 00       		  .p2align 2 
 224              	
 225              	/**************************************
 226              	  reset_handler execute at MCU reset
 227              	***************************************/
 228              	    _GBL_FUNC reset_handler
 229 00c4 4FF4A040 	    _MOV32 r0,RAM_END 
 229      C2F20000 
 230 00cc 8546     	    mov sp,r0 
 231 00ce 00F02FF8 	    bl remap  
 232 00d2 00F045F8 	    bl	init_devices	 	/* RCC, GPIOs */
 233 00d6 00F093F8 	    bl  uart_init
 234 00da FFF7FEFF 	    bl  cold_start  /* initialize BASIC SYSTEM */ 
 235 00de 00F001F8 	    bl  test 
 236 00e2 FEE7     	    b .  
 237              	
 238              	    _FUNC test
 239 00e4 4FF00004 	  _MOV32 UPP,RAM_ADR
 239      C2F20004 
 240 00ec 04F59874 	  add UPP,#0x130
 241 00f0 00B5FFF7 	  _CALL get_curpos 
 241      FEFF5DF8 
 241      04EB
 242 00fa 02B4     	  push {r1} 
 243 00fc 4FF00A01 	  mov r1,#10 
 244 0100 00B5FFF7 	  _CALL print_int 
 244      FEFF5DF8 
 244      04EB
 245 010a 4FF02C00 	  mov r0,#','
 246 010e 00B5FFF7 	  _CALL uart_putc 
 246      FEFF5DF8 
 246      04EB
 247 0118 01BC     	  pop {r0}
 248 011a 4FF00A01 	  mov r1,#10  
 249 011e 00B5FFF7 	  _CALL print_int 
 249      FEFF5DF8 
 249      04EB
 250 0128 7047     	  _RET 
 251              	
 252              	  tib_addr: 
 253 012a 00000000 	    .word _tib
 254              	
 255              	
 256              	// tranfert isr_vector to RAM at 0x20000000
 257 012e 00BF     	    _FUNC remap 
 258 0130 80EA0000 		eor r0,r0 // src 
 259 0134 4FF00001 		_MOV32 r1,RAM_ADR // dest 
 259      C2F20001 
ARM GAS  stm32-tbi.s 			page 17


 260 013c 4FF49872 		mov r2,#(isr_end-isr_vectors) // count 
 261 0140 00B5FFF7 	  _CALL cmove  
 261      FEFF5DF8 
 261      04EB
 262              	// set new vector table address
 263 014a 4FF46D40 		_MOV32 r0,SCB_BASE_ADR
 263      CEF20000 
 264 0152 4FF00001 		_MOV32 r1,RAM_ADR 
 264      C2F20001 
 265 015a 8160     		str r1,[r0,#SCB_VTOR]
 266 015c 7047     	  _RET 
 267              	
 268              	// initialize hardware devices 
 269 015e 00BF     	  _FUNC init_devices
 270              	/* init clock to HSE 72 Mhz */
 271              	/* set 2 wait states in FLASH_ACR_LATENCY */
 272 0160 4FF40050 	  _MOV32 R0,FLASH_BASE_ADR 
 272      C4F20200 
 273 0168 4FF01202 	  mov r2,#0x12
 274 016c 0260     	  str r2,[r0,#FLASH_ACR]
 275              	/* configure clock for HSE, 8 Mhz crystal */
 276              	/* enable HSE in RCC_CR */
 277 016e 4FF48050 	  _MOV32 R0,RCC_BASE_ADR 
 277      C4F20200 
 278 0176 0168     	  ldr r1,[r0,#RCC_CR]
 279 0178 41F48031 	  orr r1,r1,#(1<<16) /* HSEON bit */
 280 017c 0160     	  str r1,[r0,#RCC_CR] /* enable HSE */
 281              	/* wait HSERDY loop */
 282              	wait_hserdy:
 283 017e 0168     	  ldr r1,[r0,#RCC_CR]
 284 0180 11F4003F 	  tst r1,#(1<<17)
 285 0184 FBD0     	  beq wait_hserdy
 286              	
 287              	/************************************************* 
 288              	   configure PLL mul factor and source 
 289              	   SYSCLOCK,72 Mhz
 290              	   select HSE as  PLL source clock
 291              	   multiply frequency by 9 
 292              	   APB1 clock is limited to 36 Mhz so divide by 2 
 293              	****************************************************/
 294 0186 4FF48061 	  mov r1,#(4<<8) /* PLLMUL,7|PLLSCR,HSE|PPRE1,HCLK/2| */
 295 018a C0F21D01 	  movt r1,#(7<<2)|1
 296 018e 4160     	  str r1,[r0,#RCC_CFGR]
 297              	  /* enable PLL */
 298 0190 0168     	  ldr r1,[r0,#RCC_CR]
 299 0192 41F08071 	  orr r1, #1<<24 
 300 0196 0160     	  str r1,[r0,#RCC_CR]
 301              	/* wait for PLLRDY */
 302              	wait_pllrdy:
 303 0198 0168     	  ldr r1,[r0,#RCC_CR]
 304 019a 11F0007F 	  tst r1,#(1<<25)
 305 019e FBD0     	  beq wait_pllrdy 
 306              	/* select PLL as sysclock */
 307 01a0 4168     	  ldr r1,[r0,#RCC_CFGR]
 308 01a2 4FF6FC72 	  _MOV32 r2,0xfffffffc
 308      CFF6FF72 
 309 01aa 01EA0201 	  and r1,r1,r2 
ARM GAS  stm32-tbi.s 			page 18


 310 01ae 4FF00202 	  mov r2,#2
 311 01b2 41EA0201 	  orr r1,r1,r2
 312 01b6 4160     	  str r1,[r0,#RCC_CFGR] /* PLL selected as sysclock */
 313              	/* wait for SWS,,2 */
 314              	wait_sws:
 315 01b8 4168     	  ldr r1,[r0,#RCC_CFGR]
 316 01ba 11F0080F 	  tst r1,#(2<<2)
 317 01be FBD0     	  beq wait_sws
 318              	/* now sysclock is 72 Mhz */
 319              	
 320              	/* enable peripheral clock for GPIOA, GPIOC and USART1 */
 321 01c0 4FF48050 	  _MOV32 r0,RCC_BASE_ADR
 321      C4F20200 
 322 01c8 44F21401 	  mov	r1, #(1<<2)|(1<<4)|(1<<14)		/* GPIOAEN|GPIOCEN|USART1EN */
 323 01cc 8161     	  str	r1, [r0, #RCC_APB2ENR]
 324              	
 325              	/* configure GPIOC:13 as output for user LED */
 326 01ce 4FF48050 	  _MOV32 r0,GPIOC_BASE_ADR 
 326      C4F20100 
 327 01d6 4168     	  ldr r1,[r0,#GPIO_CRH]
 328 01d8 6FF47002 	  mvn r2,#(15<<20)
 329 01dc 01EA0201 	  and r1,r1,r2
 330 01e0 4FF4C002 	  mov r2,#(6<<20)
 331 01e4 41EA0201 	  orr r1,r1,r2
 332 01e8 4160     	  str r1,[r0,#GPIO_CRH]
 333              	
 334              	/* configure systicks for 1msec ticks */
 335 01ea 4EF21000 	  _MOV32 r0,STK_BASE_ADR 
 335      CEF20000 
 336 01f2 42F22831 	  mov r1,#9000 /* reload value for 1msec */
 337 01f6 4160     	  str r1,[r0,#STK_LOAD]
 338 01f8 4FF00301 	  mov r1,#3
 339 01fc 0160     	  str r1,[r0,STK_CTL]
 340 01fe 7047     	  _RET  
 341              	
 342              	/*******************************
 343              	  initialize UART peripheral 
 344              	********************************/
 345              		_FUNC uart_init
 346              	/* set GPIOA PIN 9, uart TX  */
 347 0200 4FF40060 	  _MOV32 r0,GPIOA_BASE_ADR
 347      C4F20100 
 348 0208 4168     	  ldr r1,[r0,#GPIO_CRH]
 349 020a 6FF0F002 	  mvn r2,#(15<<4)
 350 020e 01EA0201 	  and r1,r1,r2
 351 0212 4FF0A002 	  mov r2,#(0xA<<4)
 352 0216 41EA0201 	  orr r1,r1,r2 
 353 021a 4160     	  str r1,[r0,#GPIO_CRH]
 354 021c 4FF46050 	  _MOV32 r0,UART 
 354      C4F20100 
 355              	/* BAUD rate */
 356 0224 40F27121 	  mov r1,#(39<<4)+1  /* (72Mhz/16)/115200,39,0625, quotient,39, reste,0,0625*16,1 */
 357 0228 8160     	  str r1,[r0,#USART_BRR]
 358 022a 42F22C01 	  mov r1,#(3<<2)+(1<<13)+(1<<5) // TE+RE+UE+RXNEIE
 359 022e C160     	  str r1,[r0,#USART_CR1] /*enable usart*/
 360              	/* enable interrupt in NVIC */
 361 0230 4FF46140 	  _MOV32 r0,NVIC_BASE_ADR
ARM GAS  stm32-tbi.s 			page 19


 361      CEF20000 
 362 0238 4168     	  ldr r1,[r0,#NVIC_ISER1]
 363 023a 41F02001 	  orr r1,#32   
 364 023e 4160     	  str r1,[r0,#NVIC_ISER1]
 365 0240 7047     	  bx lr 
 366              	
 367              	/***************************
 368              	    uart_flush_queue
 369              	    flush rx queue
 370              	  input:
 371              	    none
 372              	  output:
 373              	    none 
 374              	  use:
 375              	    T1 temp
 376              	***************************/
 377 0242 00BF     	    _GBL_FUNC uart_flush_queue
 378 0244 4DF8048D 	    push {T1}
 379 0248 88EA0808 	    eor T1,T1 
 380 024c C4F84880 	    str T1,[UPP,#RX_HEAD]
 381 0250 C4F84C80 	    str T1,[UPP,#RX_TAIL]
 382 0254 5DF8048B 	    pop {T1}
 383 0258 7047     	    _RET 
 384              	
 385              	/****************************
 386              	    UART_PUTC
 387              	  send character to uart
 388              	  input: 
 389              	    R0 character to send 
 390              	  use:
 391              	    T1 status  
 392              	    T2 UART address
 393              	*****************************/
 394 025a 00BF     	    _GBL_FUNC uart_putc
 395 025c 2DE90003 	    push {T1,T2}
 396 0260 4FF46059 	    _MOV32 T2,UART
 396      C4F20109 
 397              	1: 
 398 0268 D9F80080 	    ldr T1,[T2,#USART_SR]
 399 026c 18F08008 	    ands T1,#0x80
 400 0270 FAD0     	    beq 1b // UART_DR full,wait  
 401 0272 89F80400 	    strb r0,[T2,#USART_DR]
 402 0276 BDE80003 	    pop {T1,T2}
 403 027a 7047     	    _RET  
 404              	
 405              	
 406              	/**********************************
 407              	  UART_QKEY
 408              	  check if character available in 
 409              	  rx1_qeue
 410              	  input:
 411              	    none
 412              	  output:
 413              	    r0 flag = RX_HEAD^REX_TAIL 
 414              	    flags 
 415              	  use:
 416              	    r0  RX_HEAD  
ARM GAS  stm32-tbi.s 			page 20


 417              	    r1  RX_TAIL   
 418              	***********************************/
 419              	    _GBL_FUNC uart_qkey
 420 027c 02B4     	    push {r1}
 421 027e A06C     	    ldr r0,[UPP,#RX_HEAD]
 422 0280 E16C     	    ldr r1,[UPP,#RX_TAIL]
 423 0282 4840     	    eors r0,r1
 424 0284 02BC     	    pop {r1} 
 425 0286 7047     	    _RET 
 426              	
 427              	/**********************************
 428              	  UART_GETC 
 429              	  wait a character from uart 
 430              	  input:
 431              	    none
 432              	  output:
 433              	    r0  character 
 434              	  use:
 435              	    T1  rx_queue 
 436              	    T2  rx_head  
 437              	**********************************/
 438              	    _GBL_FUNC uart_getc
 439 0288 2DE90003 	    push {T1,T2}
 440              	1:
 441 028c 00B5FFF7 	    _CALL uart_qkey 
 441      FEFF5DF8 
 441      04EB
 442 0296 F9D0     	    beq 1b  
 443 0298 04F15008 	    add T1,UPP,#RX_QUEUE
 444 029c D4F84890 	    ldr T2, [UPP,#RX_HEAD]
 445 02a0 18F80900 	    ldrb r0,[T1,T2]
 446 02a4 09F10109 	    add T2,#1
 447 02a8 09F00F09 	    and T2,#(RX_QUEUE_SIZE-1)
 448 02ac C4F84890 	    str T2,[UPP,#RX_HEAD]
 449 02b0 BDE80003 	    pop {T1,T2}
 450 02b4 7047     	    _RET  
 451              	
 452              	
 453              	/***************************
 454              	  Flash memory interface
 455              	***************************/
 456              	
 457              	/***********************************
 458              	  unlock 
 459              	  unlock flash memory for writing
 460              	  input:
 461              	    r0    0 lock, 1 unlock 
 462              	  output:
 463              	    none
 464              	  use: 
 465              	    r6     temp  
 466              	***********************************/
 467 02b6 00BF     	    _GBL_FUNC unlock  
 468 02b8 40B4     	    push {r6}
 469 02ba 0040     	    ands r0,r0 
 470 02bc 15D0     	    beq lock 
 471 02be 4FF40050 	    _MOV32 r0,FLASH_BASE_ADR
ARM GAS  stm32-tbi.s 			page 21


 471      C4F20200 
 472 02c6 4FF03406 	    mov r6,#(0xD<<2) // clear EOP|WRPRTERR|PGERR bits 
 473 02ca C660     	    str r6,[r0,#FLASH_SR]
 474 02cc 0669     	    ldr r6,[r0,#FLASH_CR]
 475 02ce 16F0800F 	    tst r6,#(1<<7)
 476 02d2 11D0     	    beq 9f
 477 02d4 40F22316 	    _MOV32 r6,FLASH_KEY1  
 477      C4F26756 
 478 02dc 4660     	    str	r6, [r0, #FLASH_KEYR]
 479 02de 48F6AB16 	    _MOV32 r6,FLASH_KEY2
 479      CCF6EF56 
 480 02e6 4660     	    str	r6, [r0, #FLASH_KEYR]
 481 02e8 06E0     	    b 9f 
 482              	// lock flash memory
 483              	lock: 
 484 02ea 4FF40050 	    _MOV32 r0,FLASH_BASE_ADR
 484      C4F20200 
 485 02f2 4FF08006 	    mov r6,#(1<<7)
 486 02f6 0661     	    str r6,[r0,#FLASH_CR]
 487 02f8 40BC     	9:  pop {r6}
 488 02fa 7047     	  	_RET  
 489              	
 490              	
 491              	/*********************************
 492              	   wait_busy 
 493              	   wait until busy flag is cleared 
 494              	   input:
 495              	    none
 496              	   output:
 497              	    none 
 498              	   use:
 499              	     r0    flash registers address 
 500              	     r1    temp 
 501              	***********************************/
 502              	    _FUNC wait_busy 
 503 02fc 03B4     	    push {r0,r1}
 504 02fe 4FF40050 	    _MOV32	r0,FLASH_BASE_ADR
 504      C4F20200 
 505              	1:
 506 0306 C168     	    ldr	r1, [r0, #FLASH_SR]	//  FLASH_SR
 507 0308 11F00101 	    ands r1, #0x1	//  BSY
 508 030c FBD1     	    bne	1b 
 509 030e 03BC     	    pop {r0,r1}
 510 0310 7047     	    _RET
 511              	
 512              	/***************************************
 513              	   hword_write
 514              	   write 16 bits value to flash memory 
 515              	   input:
 516              	    r0  data 
 517              	    r1  address 
 518              	   output:
 519              	     none 
 520              	   use: 
 521              	     r6    flash control regs base address 
 522              	     r7    temp  
 523              	***************************************/
ARM GAS  stm32-tbi.s 			page 22


 524 0312 00BF     	    _FUNC hword_write 
 525 0314 C0B4     	    push {r6,r7}
 526 0316 4FF40056 	    _MOV32 r6,FLASH_BASE_ADR
 526      C4F20206 
 527 031e 4FF00107 	    mov r7,#1 // set PG 
 528 0322 3761     	    str r7,[r6,#FLASH_CR]
 529 0324 0880     	    strh r0,[r1] 
 530 0326 00B5FFF7 	    _CALL wait_busy  
 530      E8FF5DF8 
 530      04EB
 531 0330 F768     	    ldr r7,[r6,#FLASH_SR]
 532 0332 17F01407 	    ands r7,r7,#(5<<2) 
 533 0336 05D0     	    beq 9f
 534 0338 3748     	    ldr r0,=write_error
 535 033a 00B5FFF7 	    _CALL uart_puts   
 535      FEFF5DF8 
 535      04EB
 536 0344 C0BC     	9:	pop {r6,r7}
 537 0346 7047     	    _RET  
 538              	write_error:	
 539 0348 20777269 	    .asciz " write error!"
 539      74652065 
 539      72726F72 
 539      2100
 540 0356 00BF     	    .p2align 2
 541              	
 542              	/****************************************
 543              	    flash_store
 544              	    Write one word into flash memory
 545              	    address must even
 546              	    input:
 547              	      r0    data 
 548              	      r1    adr 
 549              	    output: 
 550              	      none 
 551              	    use:
 552              	      T1 data 
 553              	      T2 adr 
 554              	*****************************************/ 
 555              	    _GBL_FUNC flash_store 
 556 0358 2DE90003 	    push {T1,T2}
 557 035c 8046     	    mov T1,r0
 558 035e 8946     	    mov T2,r1  
 559 0360 4FF00100 	    mov r0,#1
 560 0364 00B5FFF7 	    _CALL unlock 
 560      FEFF5DF8 
 560      04EB
 561 036e 4046     	    mov r0,T1 
 562 0370 4946     	    mov r1,T2 
 563 0372 00B5FFF7 	    _CALL hword_write
 563      CEFF5DF8 
 563      04EB
 564 037c 4FEA1840 	    mov r0,T1,lsr #16 
 565 0380 09F10201 	    add r1,T2,#2
 566 0384 00B5FFF7 	    _CALL hword_write
 566      C5FF5DF8 
 566      04EB
ARM GAS  stm32-tbi.s 			page 23


 567 038e 80EA0000 	    eor r0,r0 
 568 0392 00B5FFF7 	    _CALL unlock  
 568      FEFF5DF8 
 568      04EB
 569 039c BDE80003 	    pop {T1,T2}
 570 03a0 7047     	    _RET 
 571              	
 572              	/********************************************
 573              	    erase_page 
 574              	    erase 1024 bytes flash page 
 575              	    input:
 576              	       r0    adr 
 577              	    output:
 578              	       None 
 579              	    use:
 580              	      T1    adr
 581              	      T2    temp   
 582              	**********************************************/
 583 03a2 00BF     	    _GBL_FUNC erase_page 
 584 03a4 2DE90003 	    push {T1,T2}
 585 03a8 8046     	    mov T1,r0 
 586 03aa 4FF00100 	    mov r0,#1 
 587 03ae 00B5FFF7 	    _CALL unlock 
 587      FEFF5DF8 
 587      04EB
 588 03b8 4FF40050 	    _MOV32 r0,FLASH_BASE_ADR
 588      C4F20200 
 589 03c0 4FF00209 	    mov T2,#2 // PER bit in FLASH_CR 
 590 03c4 C0F81090 	    str T2,[r0,#FLASH_CR]
 591 03c8 C0F81480 	    str T1,[r0,#FLASH_AR]
 592 03cc 49F04009 	    orr T2,#0x40 
 593 03d0 C0F81090 	    str T2,[r0,#FLASH_CR]
 594 03d4 D0F80C90 	    ldr T2,[r0,#FLASH_SR]
 595 03d8 19F01409 	    ands T2,#(5<<2)
 596 03dc 06D0     	    beq 9f
 597 03de DFF82000 	    ldr r0,erase_error
 598 03e2 00B5FFF7 	    _CALL uart_puts 
 598      FEFF5DF8 
 598      04EB
 599 03ec 80EA0000 	9:  eor r0,r0 
 600 03f0 00B5FFF7 	    _CALL unlock 
 600      FEFF5DF8 
 600      04EB
 601 03fa BDE80003 	    pop {T1,T2}
 602 03fe 7047     	    _RET 
 603              	erase_error:
 604 0400 20657261 	    .asciz " erase error!\r"
 604      73652065 
 604      72726F72 
 604      210D00
 605 040f 00       	    .p2align 2
 606              	
 607              	
 608              	
 609 0410 18000000 	
 609      B4000000 
 609      48030000 
ARM GAS  stm32-tbi.s 			page 24


ARM GAS  stm32-tbi.s 			page 25


DEFINED SYMBOLS
       stm32f103.inc:5      *ABS*:0000000020000000 RAM_ADR
       stm32f103.inc:6      *ABS*:0000000000005000 RAM_SIZE
       stm32f103.inc:7      *ABS*:0000000020005000 RAM_END
       stm32f103.inc:10     *ABS*:0000000022000000 RAM_BIT_ALIAS
       stm32f103.inc:14     *ABS*:0000000008000000 FLASH_ADR
       stm32f103.inc:15     *ABS*:0000000000010000 FLASH_SIZE
       stm32f103.inc:16     *ABS*:0000000008010000 FLASH_END
       stm32f103.inc:18     *ABS*:0000000008010000 FLASH_HIDDEN_ADR
       stm32f103.inc:19     *ABS*:0000000000010000 FLASH_HIDDEN_SIZE
       stm32f103.inc:20     *ABS*:0000000008020000 FLASH_HIDDEN_END
       stm32f103.inc:21     *ABS*:0000000000000400 PAGE_SIZE
       stm32f103.inc:24     *ABS*:000000001ffff000 SYS_MEM
       stm32f103.inc:25     *ABS*:0000000000000800 SYS_MEM_SIZE
       stm32f103.inc:28     *ABS*:000000001ffff800 OPTION
       stm32f103.inc:29     *ABS*:0000000000000010 OPT_SIZE
       stm32f103.inc:33     *ABS*:0000000040000000 PER_BASE_ADR
       stm32f103.inc:35     *ABS*:0000000042000000 PER_BIT_ALIAS
       stm32f103.inc:39     *ABS*:0000000040021000 RCC_BASE_ADR
       stm32f103.inc:41     *ABS*:0000000000000000 RCC_CR
       stm32f103.inc:42     *ABS*:0000000000000004 RCC_CFGR
       stm32f103.inc:43     *ABS*:0000000000000008 RCC_CIR
       stm32f103.inc:44     *ABS*:000000000000000c RCC_APB2RSTR
       stm32f103.inc:45     *ABS*:0000000000000010 RCC_APB1RSTR
       stm32f103.inc:46     *ABS*:0000000000000014 RCC_AHBENR
       stm32f103.inc:47     *ABS*:0000000000000018 RCC_APB2ENR
       stm32f103.inc:48     *ABS*:000000000000001c RCC_APB1ENR
       stm32f103.inc:49     *ABS*:0000000000000020 RCC_BDCR
       stm32f103.inc:50     *ABS*:0000000000000024 RCC_CSR
       stm32f103.inc:53     *ABS*:0000000040022000 FLASH_BASE_ADR
       stm32f103.inc:55     *ABS*:0000000000000000 FLASH_ACR
       stm32f103.inc:56     *ABS*:0000000000000004 FLASH_KEYR
       stm32f103.inc:57     *ABS*:0000000000000008 FLASH_OPTKEYR
       stm32f103.inc:58     *ABS*:000000000000000c FLASH_SR
       stm32f103.inc:59     *ABS*:0000000000000010 FLASH_CR
       stm32f103.inc:60     *ABS*:0000000000000014 FLASH_AR
       stm32f103.inc:61     *ABS*:000000000000001c FLASH_OBR
       stm32f103.inc:62     *ABS*:0000000000000020 FLASH_WRPR
       stm32f103.inc:63     *ABS*:00000000000000a5 RDPRT_KEY
       stm32f103.inc:64     *ABS*:0000000045670123 FLASH_KEY1
       stm32f103.inc:65     *ABS*:00000000cdef89ab FLASH_KEY2
       stm32f103.inc:68     *ABS*:0000000040010800 GPIOA_BASE_ADR
       stm32f103.inc:69     *ABS*:0000000040010c00 GPIOB_BASE_ADR
       stm32f103.inc:70     *ABS*:0000000040011000 GPIOC_BASE_ADR
       stm32f103.inc:71     *ABS*:0000000040011400 GPIOD_BASE_ADR
       stm32f103.inc:72     *ABS*:0000000040011800 GPIOE_BASE_ADR
       stm32f103.inc:73     *ABS*:0000000040018c00 GPIOF_BASE_ADR
       stm32f103.inc:74     *ABS*:0000000040012000 GPIOG_BASE_ADR
       stm32f103.inc:77     *ABS*:0000000000000000 GPIO_CRL
       stm32f103.inc:78     *ABS*:0000000000000004 GPIO_CRH
       stm32f103.inc:79     *ABS*:0000000000000008 GPIO_IDR
       stm32f103.inc:80     *ABS*:000000000000000c GPIO_ODR
       stm32f103.inc:81     *ABS*:0000000000000010 GPIO_BSRR
       stm32f103.inc:82     *ABS*:0000000000000014 GPIO_BRR
       stm32f103.inc:83     *ABS*:0000000000000018 GPIO_LOCKR
       stm32f103.inc:87     *ABS*:0000000040013800 USART1_BASE_ADR
       stm32f103.inc:89     *ABS*:0000000000000000 USART_SR
ARM GAS  stm32-tbi.s 			page 26


       stm32f103.inc:90     *ABS*:0000000000000004 USART_DR
       stm32f103.inc:91     *ABS*:0000000000000008 USART_BRR
       stm32f103.inc:92     *ABS*:000000000000000c USART_CR1
       stm32f103.inc:93     *ABS*:0000000000000010 USART_CR2
       stm32f103.inc:94     *ABS*:0000000000000014 USART_CR3
       stm32f103.inc:95     *ABS*:0000000000000018 USART_GTPR
       stm32f103.inc:98     *ABS*:00000000e000e010 STK_BASE_ADR
       stm32f103.inc:100    *ABS*:0000000000000000 STK_CTL
       stm32f103.inc:101    *ABS*:0000000000000004 STK_LOAD
       stm32f103.inc:102    *ABS*:0000000000000008 STK_VAL
       stm32f103.inc:103    *ABS*:000000000000000c STK_CALIB
       stm32f103.inc:106    *ABS*:00000000e000ed00 SCB_BASE_ADR
       stm32f103.inc:108    *ABS*:0000000000000000 SCB_CPUID
       stm32f103.inc:109    *ABS*:0000000000000004 SCB_ICSR
       stm32f103.inc:110    *ABS*:0000000000000008 SCB_VTOR
       stm32f103.inc:111    *ABS*:000000000000000c SCB_AIRCR
       stm32f103.inc:112    *ABS*:0000000000000010 SCB_SCR
       stm32f103.inc:113    *ABS*:0000000000000014 SCB_CCR
       stm32f103.inc:114    *ABS*:0000000000000018 SCB_SHPR1
       stm32f103.inc:115    *ABS*:000000000000001c SCB_SHPR2
       stm32f103.inc:116    *ABS*:0000000000000020 SCB_SHPR3
       stm32f103.inc:117    *ABS*:0000000000000024 SCB_SHCRS
       stm32f103.inc:118    *ABS*:0000000000000028 SCB_CFSR
       stm32f103.inc:119    *ABS*:000000000000002c SCB_HFSR
       stm32f103.inc:120    *ABS*:0000000000000034 SCB_MMAR
       stm32f103.inc:121    *ABS*:0000000000000038 SCB_BFAR
       stm32f103.inc:123    *ABS*:00000000000005fa SCB_VECTKEY
       stm32f103.inc:126    *ABS*:00000000e000e100 NVIC_BASE_ADR
       stm32f103.inc:127    *ABS*:0000000000000000 NVIC_ISER0
       stm32f103.inc:128    *ABS*:0000000000000004 NVIC_ISER1
       stm32f103.inc:129    *ABS*:0000000000000008 NVIC_ISER2
       stm32f103.inc:130    *ABS*:0000000000000080 NVIC_ICER0
       stm32f103.inc:131    *ABS*:0000000000000084 NVIC_ICER1
       stm32f103.inc:132    *ABS*:0000000000000088 NVIC_ICER2
       stm32f103.inc:133    *ABS*:0000000000000100 NVIC_ISPR0
       stm32f103.inc:134    *ABS*:0000000000000104 NVIC_ISPR1
       stm32f103.inc:135    *ABS*:0000000000000108 NVIC_ISPR2
       stm32f103.inc:136    *ABS*:0000000000000180 NVIC_ICPR0
       stm32f103.inc:137    *ABS*:0000000000000184 NVIC_ICPR1
       stm32f103.inc:138    *ABS*:0000000000000188 NVIC_ICPR2
       stm32f103.inc:139    *ABS*:0000000000000200 NVIC_IABR0
       stm32f103.inc:140    *ABS*:0000000000000204 NVIC_IABR1
       stm32f103.inc:141    *ABS*:0000000000000208 NVIC_IABR2
       stm32f103.inc:142    *ABS*:0000000000000300 NVIC_IPR_BASE
           ascii.inc:24     *ABS*:0000000000000001 CTRL_A
           ascii.inc:25     *ABS*:0000000000000001 SOH
           ascii.inc:26     *ABS*:0000000000000002 CTRL_B
           ascii.inc:27     *ABS*:0000000000000002 STX
           ascii.inc:28     *ABS*:0000000000000003 CTRL_C
           ascii.inc:29     *ABS*:0000000000000003 ETX
           ascii.inc:30     *ABS*:0000000000000004 CTRL_D
           ascii.inc:31     *ABS*:0000000000000004 EOT
           ascii.inc:32     *ABS*:0000000000000005 CTRL_E
           ascii.inc:33     *ABS*:0000000000000005 ENQ
           ascii.inc:34     *ABS*:0000000000000006 CTRL_F
           ascii.inc:35     *ABS*:0000000000000006 ACK
           ascii.inc:36     *ABS*:0000000000000007 CTRL_G
ARM GAS  stm32-tbi.s 			page 27


           ascii.inc:37     *ABS*:0000000000000007 BELL
           ascii.inc:38     *ABS*:0000000000000008 CTRL_H
           ascii.inc:39     *ABS*:0000000000000008 BS
           ascii.inc:40     *ABS*:0000000000000009 CTRL_I
           ascii.inc:41     *ABS*:0000000000000009 TAB
           ascii.inc:42     *ABS*:000000000000000a CTRL_J
           ascii.inc:43     *ABS*:000000000000000a LF
           ascii.inc:44     *ABS*:000000000000000b CTRL_K
           ascii.inc:45     *ABS*:000000000000000b VT
           ascii.inc:46     *ABS*:000000000000000c CTRL_L
           ascii.inc:47     *ABS*:000000000000000c FF
           ascii.inc:48     *ABS*:000000000000000d CTRL_M
           ascii.inc:49     *ABS*:000000000000000d CR
           ascii.inc:50     *ABS*:000000000000000e CTRL_N
           ascii.inc:51     *ABS*:000000000000000e SO
           ascii.inc:52     *ABS*:000000000000000f CTRL_O
           ascii.inc:53     *ABS*:000000000000000f SI
           ascii.inc:54     *ABS*:0000000000000010 CTRL_P
           ascii.inc:55     *ABS*:0000000000000010 DLE
           ascii.inc:56     *ABS*:0000000000000011 CTRL_Q
           ascii.inc:57     *ABS*:0000000000000011 DC1
           ascii.inc:58     *ABS*:0000000000000011 XON
           ascii.inc:59     *ABS*:0000000000000012 CTRL_R
           ascii.inc:60     *ABS*:0000000000000012 DC2
           ascii.inc:61     *ABS*:0000000000000013 CTRL_S
           ascii.inc:62     *ABS*:0000000000000013 DC3
           ascii.inc:63     *ABS*:0000000000000013 XOFF
           ascii.inc:64     *ABS*:0000000000000014 CTRL_T
           ascii.inc:65     *ABS*:0000000000000014 DC4
           ascii.inc:66     *ABS*:0000000000000015 CTRL_U
           ascii.inc:67     *ABS*:0000000000000015 NAK
           ascii.inc:68     *ABS*:0000000000000016 CTRL_V
           ascii.inc:69     *ABS*:0000000000000016 SYN
           ascii.inc:70     *ABS*:0000000000000017 CTRL_W
           ascii.inc:71     *ABS*:0000000000000017 ETB
           ascii.inc:72     *ABS*:0000000000000018 CTRL_X
           ascii.inc:73     *ABS*:0000000000000018 CAN
           ascii.inc:74     *ABS*:0000000000000019 CTRL_Y
           ascii.inc:75     *ABS*:0000000000000019 EM
           ascii.inc:76     *ABS*:000000000000001a CTRL_Z
           ascii.inc:77     *ABS*:000000000000001a SUB
           ascii.inc:78     *ABS*:00000000000000ff EOF
           ascii.inc:79     *ABS*:000000000000001b ESC
           ascii.inc:80     *ABS*:000000000000001c FS
           ascii.inc:81     *ABS*:000000000000001d GS
           ascii.inc:82     *ABS*:000000000000001e RS
           ascii.inc:83     *ABS*:000000000000001f US
           ascii.inc:84     *ABS*:0000000000000020 SPACE
           ascii.inc:85     *ABS*:000000000000002c COMMA
           ascii.inc:86     *ABS*:0000000000000023 SHARP
           ascii.inc:87     *ABS*:0000000000000027 TICK
      tbi_macros.inc:20     *ABS*:0000000000000100 STACK_SIZE
      tbi_macros.inc:21     *ABS*:0000000020005000 STACK_EMPTY
      tbi_macros.inc:22     *ABS*:0000000020004f00 STACK_FULL
      tbi_macros.inc:23     *ABS*:0000000000000050 TIB_SIZE
      tbi_macros.inc:24     *ABS*:0000000000000080 PAD_SIZE
      tbi_macros.inc:25     *ABS*:0000000000000010 RX_QUEUE_SIZE
ARM GAS  stm32-tbi.s 			page 28


      tbi_macros.inc:27     *ABS*:0000000000000004 DEFAULT_TAB_WIDTH
      tbi_macros.inc:34     *ABS*:0000000000000000 INP
      tbi_macros.inc:35     *ABS*:0000000000000001 OUTP
      tbi_macros.inc:45     *ABS*:0000000000000000 TK_NONE
      tbi_macros.inc:46     *ABS*:0000000000000001 TK_COLON
      tbi_macros.inc:47     *ABS*:0000000000000002 TK_QSTR
      tbi_macros.inc:48     *ABS*:0000000000000003 TK_CHAR
      tbi_macros.inc:49     *ABS*:0000000000000004 TK_VAR
      tbi_macros.inc:50     *ABS*:0000000000000005 TK_ARRAY
      tbi_macros.inc:51     *ABS*:0000000000000006 TK_LPAREN
      tbi_macros.inc:52     *ABS*:0000000000000007 TK_RPAREN
      tbi_macros.inc:53     *ABS*:0000000000000008 TK_COMMA
      tbi_macros.inc:54     *ABS*:0000000000000009 TK_SHARP
      tbi_macros.inc:55     *ABS*:000000000000000a TK_CMD
      tbi_macros.inc:56     *ABS*:000000000000000b TK_IFUNC
      tbi_macros.inc:57     *ABS*:000000000000000c TK_CFUNC
      tbi_macros.inc:58     *ABS*:000000000000000d TK_CONST
      tbi_macros.inc:59     *ABS*:000000000000000e TK_INTGR
      tbi_macros.inc:60     *ABS*:000000000000000f TK_BAD
      tbi_macros.inc:61     *ABS*:0000000000000010 TK_PLUS
      tbi_macros.inc:62     *ABS*:0000000000000011 TK_MINUS
      tbi_macros.inc:63     *ABS*:0000000000000020 TK_MULT
      tbi_macros.inc:64     *ABS*:0000000000000021 TK_DIV
      tbi_macros.inc:65     *ABS*:0000000000000022 TK_MOD
      tbi_macros.inc:73     *ABS*:0000000000000031 TK_GT
      tbi_macros.inc:74     *ABS*:0000000000000032 TK_EQUAL
      tbi_macros.inc:75     *ABS*:0000000000000033 TK_GE
      tbi_macros.inc:76     *ABS*:0000000000000034 TK_LT
      tbi_macros.inc:77     *ABS*:0000000000000036 TK_LE
      tbi_macros.inc:78     *ABS*:0000000000000035 TK_NE
      tbi_macros.inc:80     *ABS*:0000000000000030 TK_GRP_MASK
      tbi_macros.inc:81     *ABS*:0000000000000000 TK_GRP_MISC
      tbi_macros.inc:82     *ABS*:0000000000000010 TK_GRP_ADD
      tbi_macros.inc:83     *ABS*:0000000000000020 TK_GRP_MULT
      tbi_macros.inc:84     *ABS*:0000000000000030 TK_GRP_RELOP
      tbi_macros.inc:85     *ABS*:0000000000000002 CMD_END
      tbi_macros.inc:90     *ABS*:0000000000000000 ERR_NONE
      tbi_macros.inc:91     *ABS*:0000000000000001 ERR_MEM_FULL
      tbi_macros.inc:92     *ABS*:0000000000000002 ERR_SYNTAX
      tbi_macros.inc:93     *ABS*:0000000000000003 ERR_MATH_OVF
      tbi_macros.inc:94     *ABS*:0000000000000004 ERR_DIV0
      tbi_macros.inc:95     *ABS*:0000000000000005 ERR_NO_LINE
      tbi_macros.inc:96     *ABS*:0000000000000006 ERR_RUN_ONLY
      tbi_macros.inc:97     *ABS*:0000000000000007 ERR_CMD_ONLY
      tbi_macros.inc:98     *ABS*:0000000000000008 ERR_DUPLICATE
      tbi_macros.inc:99     *ABS*:0000000000000009 ERR_NOT_FILE
      tbi_macros.inc:100    *ABS*:000000000000000a ERR_BAD_VALUE
      tbi_macros.inc:101    *ABS*:000000000000000b ERR_NO_ACCESS
      tbi_macros.inc:102    *ABS*:000000000000000c ERR_NO_DATA
      tbi_macros.inc:103    *ABS*:000000000000000d ERR_NO_PROG
      tbi_macros.inc:104    *ABS*:000000000000000e ERR_NO_FSPACE
      tbi_macros.inc:105    *ABS*:000000000000000f ERR_BUF_FULL
      tbi_macros.inc:110    *ABS*:0000000000000000 MATH_OVF
      tbi_macros.inc:112    *ABS*:0000000000000004 CELL_SIZE
      tbi_macros.inc:118    *ABS*:0000000000000000 DEBUG
      tbi_macros.inc:135    *ABS*:0000000000000000 IN_SAVED
      tbi_macros.inc:136    *ABS*:0000000000000004 COUNT
ARM GAS  stm32-tbi.s 			page 29


      tbi_macros.inc:137    *ABS*:0000000000000008 BASICPTR
      tbi_macros.inc:138    *ABS*:000000000000000c DATAPTR
      tbi_macros.inc:139    *ABS*:0000000000000010 DATA
      tbi_macros.inc:140    *ABS*:0000000000000014 DATALEN
      tbi_macros.inc:141    *ABS*:0000000000000018 BASE
      tbi_macros.inc:142    *ABS*:000000000000001c TICKS
      tbi_macros.inc:143    *ABS*:0000000000000020 TIMER
      tbi_macros.inc:144    *ABS*:0000000000000024 SEED
      tbi_macros.inc:145    *ABS*:0000000000000028 FSPTR
      tbi_macros.inc:146    *ABS*:000000000000002c FFREE
      tbi_macros.inc:147    *ABS*:0000000000000030 TXTBGN
      tbi_macros.inc:148    *ABS*:0000000000000034 TXTEND
      tbi_macros.inc:149    *ABS*:0000000000000038 LOOP_DEPTH
      tbi_macros.inc:150    *ABS*:000000000000003c ARRAY_SIZE
      tbi_macros.inc:151    *ABS*:0000000000000040 FLAGS
      tbi_macros.inc:152    *ABS*:0000000000000044 TAB_WIDTH
      tbi_macros.inc:153    *ABS*:0000000000000048 RX_HEAD
      tbi_macros.inc:154    *ABS*:000000000000004c RX_TAIL
      tbi_macros.inc:155    *ABS*:0000000000000050 RX_QUEUE
      tbi_macros.inc:156    *ABS*:0000000000000060 VARS
      tbi_macros.inc:157    *ABS*:0000000000000068 VARS_SIZE
      tbi_macros.inc:158    *ABS*:00000000000000c8 ARRAY_ADR
      tbi_macros.inc:159    *ABS*:00000000000000cc BASIC_START
      tbi_macros.inc:162    *ABS*:0000000000000001 FRUN
      tbi_macros.inc:163    *ABS*:0000000000000002 FTRAP
      tbi_macros.inc:164    *ABS*:0000000000000004 FLOOP
      tbi_macros.inc:165    *ABS*:0000000000000008 FSLEEP
      tbi_macros.inc:166    *ABS*:0000000000000010 FBREAK
      tbi_macros.inc:167    *ABS*:0000000000000020 FCOMP
      tbi_macros.inc:168    *ABS*:0000000000000040 FAUTORUN
      tbi_macros.inc:170    *ABS*:0000000008001c00 AUTORUN_NAME
      tbi_macros.inc:172    *ABS*:0000000000000006 FIRST_DATA_ITEM
      tbi_macros.inc:173    *ABS*:0000000000007fff MAX_LINENO
       cmd_index.inc:25     *ABS*:0000000000000000 ABS_IDX
       cmd_index.inc:26     *ABS*:0000000000000001 ADCON_IDX
       cmd_index.inc:27     *ABS*:0000000000000002 ADCREAD_IDX
       cmd_index.inc:28     *ABS*:0000000000000003 AND_IDX
       cmd_index.inc:29     *ABS*:0000000000000004 ASC_IDX
       cmd_index.inc:30     *ABS*:0000000000000005 AUTORUN_IDX
       cmd_index.inc:31     *ABS*:0000000000000006 AWU_IDX
       cmd_index.inc:32     *ABS*:0000000000000007 BIT_IDX
       cmd_index.inc:33     *ABS*:0000000000000008 BRES_IDX
       cmd_index.inc:34     *ABS*:0000000000000009 BSET_IDX
       cmd_index.inc:35     *ABS*:000000000000000a BTEST_IDX
       cmd_index.inc:36     *ABS*:000000000000000b BTOGL_IDX
       cmd_index.inc:37     *ABS*:000000000000000c BYE_IDX
       cmd_index.inc:38     *ABS*:000000000000000d CHAR_IDX
       cmd_index.inc:39     *ABS*:000000000000000e CRH_IDX
       cmd_index.inc:40     *ABS*:000000000000000f CRL_IDX
       cmd_index.inc:41     *ABS*:0000000000000010 DATA_IDX
       cmd_index.inc:42     *ABS*:0000000000000011 DATALN_IDX
       cmd_index.inc:43     *ABS*:0000000000000012 DDR_IDX
       cmd_index.inc:44     *ABS*:0000000000000013 DEC_IDX
       cmd_index.inc:45     *ABS*:0000000000000014 DIR_IDX
       cmd_index.inc:46     *ABS*:0000000000000015 DO_IDX
       cmd_index.inc:47     *ABS*:0000000000000016 DREAD_IDX
       cmd_index.inc:48     *ABS*:0000000000000017 DWRITE_IDX
ARM GAS  stm32-tbi.s 			page 30


       cmd_index.inc:49     *ABS*:0000000000000018 END_IDX
       cmd_index.inc:50     *ABS*:0000000000000019 EEPROM_IDX
       cmd_index.inc:51     *ABS*:000000000000001a FCPU_IDX
       cmd_index.inc:52     *ABS*:000000000000001b FOR_IDX
       cmd_index.inc:53     *ABS*:000000000000001c FORGET_IDX
       cmd_index.inc:54     *ABS*:000000000000001d GOSUB_IDX
       cmd_index.inc:55     *ABS*:000000000000001e GOTO_IDX
       cmd_index.inc:56     *ABS*:000000000000001f GPIO_IDX
       cmd_index.inc:57     *ABS*:0000000000000020 HEX_IDX
       cmd_index.inc:58     *ABS*:0000000000000021 IDR_IDX
       cmd_index.inc:59     *ABS*:0000000000000022 IF_IDX
       cmd_index.inc:60     *ABS*:0000000000000023 INPUT_IDX
       cmd_index.inc:61     *ABS*:0000000000000024 INVERT_IDX
       cmd_index.inc:62     *ABS*:0000000000000025 IWDGEN_IDX
       cmd_index.inc:63     *ABS*:0000000000000026 IWDGREF_IDX
       cmd_index.inc:64     *ABS*:0000000000000027 KEY_IDX
       cmd_index.inc:65     *ABS*:0000000000000028 LET_IDX
       cmd_index.inc:66     *ABS*:0000000000000029 LIST_IDX
       cmd_index.inc:67     *ABS*:000000000000002a LOAD_IDX
       cmd_index.inc:68     *ABS*:000000000000002b LOG2_IDX
       cmd_index.inc:69     *ABS*:000000000000002c LSHIFT_IDX
       cmd_index.inc:70     *ABS*:000000000000002d NEXT_IDX
       cmd_index.inc:71     *ABS*:000000000000002e NEW_IDX
       cmd_index.inc:72     *ABS*:000000000000002f NOT_IDX
       cmd_index.inc:73     *ABS*:0000000000000030 ODR_IDX
       cmd_index.inc:74     *ABS*:0000000000000031 OR_IDX
       cmd_index.inc:75     *ABS*:0000000000000032 PAD_IDX
       cmd_index.inc:76     *ABS*:0000000000000033 PAUSE_IDX
       cmd_index.inc:77     *ABS*:0000000000000034 PMODE_IDX
       cmd_index.inc:78     *ABS*:0000000000000035 PEEK_IDX
       cmd_index.inc:79     *ABS*:0000000000000036 PINP_IDX
       cmd_index.inc:80     *ABS*:0000000000000037 POKE_IDX
       cmd_index.inc:81     *ABS*:0000000000000038 POUT_IDX
       cmd_index.inc:82     *ABS*:0000000000000039 PRT_IDX
       cmd_index.inc:83     *ABS*:000000000000003a PRTA_IDX
       cmd_index.inc:84     *ABS*:000000000000003b PRTB_IDX
       cmd_index.inc:85     *ABS*:000000000000003c PRTC_IDX
       cmd_index.inc:86     *ABS*:000000000000003d PRTD_IDX
       cmd_index.inc:87     *ABS*:000000000000003e PRTE_IDX
       cmd_index.inc:88     *ABS*:000000000000003f PRTF_IDX
       cmd_index.inc:89     *ABS*:0000000000000040 PRTG_IDX
       cmd_index.inc:90     *ABS*:0000000000000041 PRTH_IDX
       cmd_index.inc:91     *ABS*:0000000000000042 PRTI_IDX
       cmd_index.inc:92     *ABS*:0000000000000043 QKEY_IDX
       cmd_index.inc:93     *ABS*:0000000000000044 READ_IDX
       cmd_index.inc:94     *ABS*:0000000000000045 RBT_IDX
       cmd_index.inc:95     *ABS*:0000000000000046 REM_IDX
       cmd_index.inc:96     *ABS*:0000000000000047 REST_IDX
       cmd_index.inc:97     *ABS*:0000000000000048 RET_IDX
       cmd_index.inc:98     *ABS*:0000000000000049 RND_IDX
       cmd_index.inc:99     *ABS*:000000000000004a RSHIFT_IDX
       cmd_index.inc:100    *ABS*:000000000000004b RUN_IDX
       cmd_index.inc:101    *ABS*:000000000000004c SAVE_IDX
       cmd_index.inc:102    *ABS*:000000000000004d SHOW_IDX
       cmd_index.inc:103    *ABS*:000000000000004e SIZE_IDX
       cmd_index.inc:104    *ABS*:000000000000004f SLEEP_IDX
       cmd_index.inc:105    *ABS*:0000000000000050 SPIRD_IDX
ARM GAS  stm32-tbi.s 			page 31


       cmd_index.inc:106    *ABS*:0000000000000051 SPIEN_IDX
       cmd_index.inc:107    *ABS*:0000000000000052 SPISEL_IDX
       cmd_index.inc:108    *ABS*:0000000000000053 SPIWR_IDX
       cmd_index.inc:109    *ABS*:0000000000000054 STEP_IDX
       cmd_index.inc:110    *ABS*:0000000000000055 STOP_IDX
       cmd_index.inc:111    *ABS*:0000000000000056 TICKS_IDX
       cmd_index.inc:112    *ABS*:0000000000000057 TIMER_IDX
       cmd_index.inc:113    *ABS*:0000000000000058 TMROUT_IDX
       cmd_index.inc:114    *ABS*:0000000000000059 TO_IDX
       cmd_index.inc:115    *ABS*:000000000000005a TONE_IDX
       cmd_index.inc:116    *ABS*:000000000000005b UBOUND_IDX
       cmd_index.inc:117    *ABS*:000000000000005c UFLASH_IDX
       cmd_index.inc:118    *ABS*:000000000000005d UNTIL_IDX
       cmd_index.inc:119    *ABS*:000000000000005e USR_IDX
       cmd_index.inc:120    *ABS*:000000000000005f WAIT_IDX
       cmd_index.inc:121    *ABS*:0000000000000060 WORDS_IDX
       cmd_index.inc:122    *ABS*:0000000000000061 WRITE_IDX
       cmd_index.inc:123    *ABS*:0000000000000062 XOR_IDX
       cmd_index.inc:124    *ABS*:0000000000000063 XTRMT_IDX
       cmd_index.inc:125    *ABS*:0000000000000064 XRCV_IDX
       cmd_index.inc:126    *ABS*:0000000000000065 DUMP_IDX
       cmd_index.inc:127    *ABS*:0000000000000066 THEN_IDX
         stm32-tbi.s:44     *ABS*:0000000040011000 LED_GPIO
         stm32-tbi.s:45     *ABS*:000000000000000d LED_PIN
         stm32-tbi.s:46     *ABS*:0000000040013800 UART
         stm32-tbi.s:55     .isr_vector:0000000000000000 isr_vectors
         stm32-tbi.s:228    .text:00000000000000c4 reset_handler
         stm32-tbi.s:148    .text:0000000000000000 default_handler
         stm32-tbi.s:163    .text:000000000000002c systick_handler
         stm32-tbi.s:73     .isr_vector:0000000000000040 irq0
         stm32-tbi.s:177    .text:0000000000000040 uart_rx_handler
         stm32-tbi.s:135    .isr_vector:0000000000000130 isr_end
         stm32-tbi.s:137    .isr_vector:0000000000000130 vectors_size
         stm32-tbi.s:148    .text:0000000000000000 $t
         stm32-tbi.s:157    .text:0000000000000018 exception_msg
         stm32-tbi.s:211    .text:00000000000000a0 reset_mcu
         stm32-tbi.s:158    .text:0000000000000018 $d
         stm32-tbi.s:204    .text:000000000000008c user_reboot
         stm32-tbi.s:377    .text:0000000000000244 uart_flush_queue
         stm32-tbi.s:221    .text:00000000000000b4 user_reboot_msg
         stm32-tbi.s:219    .text:00000000000000b0 scb_adr
         stm32-tbi.s:220    .text:00000000000000b0 $d
         stm32-tbi.s:257    .text:0000000000000130 remap
         stm32-tbi.s:269    .text:0000000000000160 init_devices
         stm32-tbi.s:345    .text:0000000000000200 uart_init
         stm32-tbi.s:238    .text:00000000000000e4 test
         stm32-tbi.s:394    .text:000000000000025c uart_putc
         stm32-tbi.s:252    .text:000000000000012a tib_addr
         stm32-tbi.s:253    .text:000000000000012a $d
         stm32-tbi.s:257    .text:000000000000012e $t
         stm32-tbi.s:282    .text:000000000000017e wait_hserdy
         stm32-tbi.s:302    .text:0000000000000198 wait_pllrdy
         stm32-tbi.s:314    .text:00000000000001b8 wait_sws
         stm32-tbi.s:419    .text:000000000000027c uart_qkey
         stm32-tbi.s:438    .text:0000000000000288 uart_getc
         stm32-tbi.s:467    .text:00000000000002b8 unlock
         stm32-tbi.s:483    .text:00000000000002ea lock
ARM GAS  stm32-tbi.s 			page 32


         stm32-tbi.s:502    .text:00000000000002fc wait_busy
         stm32-tbi.s:524    .text:0000000000000314 hword_write
         stm32-tbi.s:538    .text:0000000000000348 write_error
         stm32-tbi.s:539    .text:0000000000000348 $d
         stm32-tbi.s:540    .text:0000000000000356 $t
         stm32-tbi.s:555    .text:0000000000000358 flash_store
         stm32-tbi.s:583    .text:00000000000003a4 erase_page
         stm32-tbi.s:603    .text:0000000000000400 erase_error
         stm32-tbi.s:604    .text:0000000000000400 $d
         stm32-tbi.s:609    .text:0000000000000410 $d
         stm32-tbi.s:163    .text:000000000000002b $d
         stm32-tbi.s:163    .text:000000000000002c $t
         stm32-tbi.s:223    .text:00000000000000c3 $d
         stm32-tbi.s:223    .text:00000000000000c4 $t
         stm32-tbi.s:605    .text:000000000000040f $d

UNDEFINED SYMBOLS
_mstack
uart_puts
cold_start
get_curpos
print_int
_tib
cmove
